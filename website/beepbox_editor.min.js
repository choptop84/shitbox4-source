var beepbox=function(t){"use strict";
/*!
    Copyright (c) 2012-2022 John Nesky and contributing authors

    Permission is hereby granted, free of charge, to any person obtaining a copy of
    this software and associated documentation files (the "Software"), to deal in
    the Software without restriction, including without limitation the rights to
    use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
    of the Software, and to permit persons to whom the Software is furnished to do
    so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.
    */class e{}function s(t){let e=0;for(let s=0;s<t.length;s++)e+=t[s];const s=e/t.length;for(let e=0;e<t.length;e++)t[e]-=s;return i(t),t.push(0),new Float32Array(t)}function i(t){let e=0;for(let s=0;s<t.length;s++){const i=t[s];t[s]=e,e+=i}}function n(t){return.5*Math.pow(.5,(e.pulseWidthRange-1-t)*e.pulseWidthStepPower)}function h(t,s,i){let n=e.chipNoises[t].samples;if(null==n){if(n=new Float32Array(e.chipNoiseLength+1),e.chipNoises[t].samples=n,0==t){let t=1;for(let s=0;s<e.chipNoiseLength;s++){n[s]=2*(1&t)-1;let e=t>>1;1==(t+e&1)&&(e+=16384),t=e}}else if(1==t)for(let t=0;t<e.chipNoiseLength;t++)n[t]=2*Math.random()-1;else if(2==t){let t=1;for(let s=0;s<e.chipNoiseLength;s++){n[s]=2*(1&t)-1;let e=t>>1;1==(t+e&1)&&(e+=32768),t=e}}else if(3==t){let t=1;for(let s=0;s<e.chipNoiseLength;s++){n[s]=2*(1&t)-1;let e=t>>1;1==(t+e&1)&&(e+=40),t=e}}else{if(4!=t)throw new Error("Unrecognized drum index: "+t);o(n,e.chipNoiseLength,10,11,1,1,0),o(n,e.chipNoiseLength,11,14,.6578,.6578,0),s(n,e.chipNoiseLength),i(n,1/Math.sqrt(e.chipNoiseLength))}n[e.chipNoiseLength]=n[0]}return n}function o(t,e,s,i,n,o,r){const a=0|Math.pow(2,s),l=Math.min(e>>1,0|Math.pow(2,i)),c=h(0,null,null);let u=0;for(let h=a;h<l;h++){let a=n+(o-n)*(Math.log2(h)-s)/(i-s),l=Math.pow(2,7*(a-1)+1)*a;l*=Math.pow(h/2048,r),u+=l,l*=c[h];const p=.61803398875*h*h*Math.PI*2;t[h]=Math.cos(p)*l,t[e-h]=Math.sin(p)*l}return u}function r(t,s,i){const n=e.rhythms[s].arpeggioPatterns[t-1];return null!=n?n[i%n.length]:i%t}function a(t){const e={};for(let s=0;s<t.length;s++){const i=t[s];i.index=s,e[i.name]=i}const s=t;return s.dictionary=e,s}function l(t){return 0!=(1024&t)}function c(t){return 0!=(2048&t)}function u(t){return 0!=(128&t)}function p(t){return 0!=(256&t)}function d(t){return 0!=(512&t)}function f(t){return 0!=(32&t)}function m(t){return 0!=(8&t)}function y(t){return 0!=(16&t)}function b(t){return 0!=(4&t)}function w(t){return 0!=(2&t)}function g(t){return 0!=(64&t)}function v(t){return 0!=(1&t)}e.scales=a([{name:"easy :)",realName:"pentatonic major",flags:[!0,!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!1]},{name:"easy :(",realName:"pentatonic minor",flags:[!0,!1,!1,!0,!1,!0,!1,!0,!1,!1,!0,!1]},{name:"island :)",realName:"ryukyu",flags:[!0,!1,!1,!1,!0,!0,!1,!0,!1,!1,!1,!0]},{name:"island :(",realName:"pelog selisir",flags:[!0,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!1]},{name:"blues :)",realName:"blues major",flags:[!0,!1,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1]},{name:"blues :(",realName:"blues",flags:[!0,!1,!1,!0,!1,!0,!0,!0,!1,!1,!0,!1]},{name:"normal :)",realName:"ionian",flags:[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0]},{name:"normal :(",realName:"aeolian",flags:[!0,!1,!0,!0,!1,!0,!1,!0,!0,!1,!0,!1]},{name:"double harmonic :)",realName:"double harmonic major",flags:[!0,!0,!1,!1,!0,!0,!1,!0,!0,!1,!1,!0]},{name:"double harmonic :(",realName:"double harmonic minor",flags:[!0,!1,!0,!0,!1,!1,!0,!0,!0,!1,!1,!0]},{name:"strange",realName:"whole tone",flags:[!0,!1,!0,!1,!0,!1,!0,!1,!0,!1,!0,!1]},{name:"expert",realName:"chromatic",flags:[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]}]),e.keys=a([{name:"C",isWhiteKey:!0,basePitch:12},{name:"C♯",isWhiteKey:!1,basePitch:13},{name:"D",isWhiteKey:!0,basePitch:14},{name:"D♯",isWhiteKey:!1,basePitch:15},{name:"E",isWhiteKey:!0,basePitch:16},{name:"F",isWhiteKey:!0,basePitch:17},{name:"F♯",isWhiteKey:!1,basePitch:18},{name:"G",isWhiteKey:!0,basePitch:19},{name:"G♯",isWhiteKey:!1,basePitch:20},{name:"A",isWhiteKey:!0,basePitch:21},{name:"A♯",isWhiteKey:!1,basePitch:22},{name:"B",isWhiteKey:!0,basePitch:23}]),e.blackKeyNameParents=[-1,1,-1,1,-1,1,-1,-1,1,-1,1,-1],e.tempoMin=30,e.tempoMax=300,e.echoDelayRange=24,e.echoDelayStepTicks=4,e.echoSustainRange=8,e.echoShelfHz=4e3,e.echoShelfGain=Math.pow(2,-.5),e.reverbShelfHz=8e3,e.reverbShelfGain=Math.pow(2,-1.5),e.reverbRange=4,e.reverbDelayBufferSize=16384,e.reverbDelayBufferMask=e.reverbDelayBufferSize-1,e.beatsPerBarMin=3,e.beatsPerBarMax=16,e.barCountMin=1,e.barCountMax=128,e.instrumentCountMin=1,e.layeredInstrumentCountMax=4,e.patternInstrumentCountMax=10,e.partsPerBeat=24,e.ticksPerPart=2,e.rhythms=a([{name:"÷3 (triplets)",stepsPerBeat:3,ticksPerArpeggio:4,arpeggioPatterns:[[0],[0,0,1,1],[0,1,2,1]],roundUpThresholds:[5,12,18]},{name:"÷4 (standard)",stepsPerBeat:4,ticksPerArpeggio:3,arpeggioPatterns:[[0],[0,0,1,1],[0,1,2,1]],roundUpThresholds:[3,9,17,21]},{name:"÷6",stepsPerBeat:6,ticksPerArpeggio:4,arpeggioPatterns:[[0],[0,1],[0,1,2,1]],roundUpThresholds:null},{name:"÷8",stepsPerBeat:8,ticksPerArpeggio:3,arpeggioPatterns:[[0],[0,1],[0,1,2,1]],roundUpThresholds:null},{name:"freehand",stepsPerBeat:24,ticksPerArpeggio:3,arpeggioPatterns:[[0],[0,1],[0,1,2,1]],roundUpThresholds:null}]),e.instrumentTypeNames=["chip","FM","noise","spectrum","drumset","harmonics","PWM","Picked String","supersaw"],e.instrumentTypeHasSpecialInterval=[!0,!0,!1,!1,!1,!0,!1,!1,!1],e.chipBaseExpression=.03375,e.fmBaseExpression=.03,e.noiseBaseExpression=.19,e.spectrumBaseExpression=.3,e.drumsetBaseExpression=.45,e.harmonicsBaseExpression=.025,e.pwmBaseExpression=.04725,e.supersawBaseExpression=.061425,e.pickedStringBaseExpression=.025,e.distortionBaseVolume=.011,e.bitcrusherBaseVolume=.01,e.chipWaves=a([{name:"rounded",expression:.94,samples:s([0,.2,.4,.5,.6,.7,.8,.85,.9,.95,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,.95,.9,.85,.8,.7,.6,.5,.4,.2,0,-.2,-.4,-.5,-.6,-.7,-.8,-.85,-.9,-.95,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-.95,-.9,-.85,-.8,-.7,-.6,-.5,-.4,-.2])},{name:"triangle",expression:1,samples:s([1/15,.2,5/15,7/15,.6,11/15,13/15,1,1,13/15,11/15,.6,7/15,5/15,.2,1/15,-1/15,-.2,-5/15,-7/15,-.6,-11/15,-13/15,-1,-1,-13/15,-11/15,-.6,-7/15,-5/15,-.2,-1/15])},{name:"square",expression:.5,samples:s([1,-1])},{name:"1/4 pulse",expression:.5,samples:s([1,-1,-1,-1])},{name:"1/8 pulse",expression:.5,samples:s([1,-1,-1,-1,-1,-1,-1,-1])},{name:"sawtooth",expression:.65,samples:s([1/31,3/31,5/31,7/31,9/31,11/31,13/31,15/31,17/31,19/31,21/31,23/31,25/31,27/31,29/31,1,-1,-29/31,-27/31,-25/31,-23/31,-21/31,-19/31,-17/31,-15/31,-13/31,-11/31,-9/31,-7/31,-5/31,-3/31,-1/31])},{name:"double saw",expression:.5,samples:s([0,-.2,-.4,-.6,-.8,-1,1,-.8,-.6,-.4,-.2,1,.8,.6,.4,.2])},{name:"double pulse",expression:.4,samples:s([1,1,1,1,1,-1,-1,-1,1,1,1,1,-1,-1,-1,-1])},{name:"spiky",expression:.4,samples:s([1,-1,1,-1,1,0])}]),e.chipNoises=a([{name:"retro",expression:.25,basePitch:69,pitchFilterMult:1024,isSoft:!1,samples:null},{name:"white",expression:1,basePitch:69,pitchFilterMult:8,isSoft:!0,samples:null},{name:"clang",expression:.4,basePitch:69,pitchFilterMult:1024,isSoft:!1,samples:null},{name:"buzz",expression:.3,basePitch:69,pitchFilterMult:1024,isSoft:!1,samples:null},{name:"hollow",expression:1.5,basePitch:96,pitchFilterMult:1,isSoft:!0,samples:null}]),e.filterFreqStep=1/4,e.filterFreqRange=34,e.filterFreqReferenceSetting=28,e.filterFreqReferenceHz=8e3,e.filterFreqMaxHz=e.filterFreqReferenceHz*Math.pow(2,e.filterFreqStep*(e.filterFreqRange-1-e.filterFreqReferenceSetting)),e.filterFreqMinHz=8,e.filterGainRange=15,e.filterGainCenter=7,e.filterGainStep=.5,e.filterMaxPoints=8,e.filterTypeNames=["low-pass","high-pass","peak"],e.fadeInRange=10,e.fadeOutTicks=[-24,-12,-6,-3,-1,6,12,24,48,72,96],e.fadeOutNeutral=4,e.drumsetFadeOutTicks=48,e.transitions=a([{name:"normal",isSeamless:!1,continues:!1,slides:!1,slideTicks:3,includeAdjacentPatterns:!1},{name:"interrupt",isSeamless:!0,continues:!1,slides:!1,slideTicks:3,includeAdjacentPatterns:!0},{name:"continue",isSeamless:!0,continues:!0,slides:!1,slideTicks:3,includeAdjacentPatterns:!0},{name:"slide",isSeamless:!0,continues:!1,slides:!0,slideTicks:3,includeAdjacentPatterns:!0},{name:"slide in pattern",isSeamless:!0,continues:!1,slides:!0,slideTicks:3,includeAdjacentPatterns:!1}]),e.vibratos=a([{name:"none",amplitude:0,periodsSeconds:[.14],delayTicks:0},{name:"light",amplitude:.15,periodsSeconds:[.14],delayTicks:0},{name:"delayed",amplitude:.3,periodsSeconds:[.14],delayTicks:37},{name:"heavy",amplitude:.45,periodsSeconds:[.14],delayTicks:0},{name:"shaky",amplitude:.1,periodsSeconds:[.11,.17798,.33],delayTicks:0}]),e.unisons=a([{name:"none",voices:1,spread:0,offset:0,expression:1.4,sign:1},{name:"shimmer",voices:2,spread:.018,offset:0,expression:.8,sign:1},{name:"hum",voices:2,spread:.045,offset:0,expression:1,sign:1},{name:"honky tonk",voices:2,spread:.09,offset:0,expression:1,sign:1},{name:"dissonant",voices:2,spread:.25,offset:0,expression:.9,sign:1},{name:"fifth",voices:2,spread:3.5,offset:3.5,expression:.9,sign:1},{name:"octave",voices:2,spread:6,offset:6,expression:.8,sign:1},{name:"bowed",voices:2,spread:.02,offset:0,expression:1,sign:-1},{name:"piano",voices:2,spread:.01,offset:0,expression:1,sign:.7}]),e.effectNames=["reverb","chorus","panning","distortion","bitcrusher","note filter","echo","pitch shift","detune","vibrato","transition type","chord type"],e.effectOrder=[10,11,7,8,9,5,3,4,2,1,6,0],e.noteSizeMax=3,e.volumeRange=8,e.volumeLogScale=-.5,e.panCenter=4,e.panMax=2*e.panCenter,e.panDelaySecondsMax=5e-4,e.chorusRange=4,e.chorusPeriodSeconds=2,e.chorusDelayRange=.0034,e.chorusDelayOffsets=[[1.51,2.1,3.35],[1.47,2.15,3.25]],e.chorusPhaseOffsets=[[0,2.1,4.2],[3.2,5.3,1]],e.chorusMaxDelay=e.chorusDelayRange*(1+e.chorusDelayOffsets[0].concat(e.chorusDelayOffsets[1]).reduce(((t,e)=>Math.max(t,e)))),e.chords=a([{name:"simultaneous",customInterval:!1,arpeggiates:!1,strumParts:0,singleTone:!1},{name:"strum",customInterval:!1,arpeggiates:!1,strumParts:1,singleTone:!1},{name:"arpeggio",customInterval:!1,arpeggiates:!0,strumParts:0,singleTone:!0},{name:"custom interval",customInterval:!0,arpeggiates:!1,strumParts:0,singleTone:!0}]),e.maxChordSize=4,e.operatorCount=4,e.maxPitchOrOperatorCount=Math.max(e.maxChordSize,e.operatorCount),e.algorithms=a([{name:"1←(2 3 4)",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2,3,4],[],[],[]]},{name:"1←(2 3←4)",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2,3],[],[4],[]]},{name:"1←2←(3 4)",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2],[3,4],[],[]]},{name:"1←(2 3)←4",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2,3],[4],[4],[]]},{name:"1←2←3←4",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2],[3],[4],[]]},{name:"1←3 2←4",carrierCount:2,associatedCarrier:[1,2,1,2],modulatedBy:[[3],[4],[],[]]},{name:"1 2←(3 4)",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[],[3,4],[],[]]},{name:"1 2←3←4",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[],[3],[4],[]]},{name:"(1 2)←3←4",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[3],[3],[4],[]]},{name:"(1 2)←(3 4)",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[3,4],[3,4],[],[]]},{name:"1 2 3←4",carrierCount:3,associatedCarrier:[1,2,3,3],modulatedBy:[[],[],[4],[]]},{name:"(1 2 3)←4",carrierCount:3,associatedCarrier:[1,2,3,3],modulatedBy:[[4],[4],[4],[]]},{name:"1 2 3 4",carrierCount:4,associatedCarrier:[1,2,3,4],modulatedBy:[[],[],[],[]]}]),e.operatorCarrierInterval=[0,.04,-.073,.091],e.operatorAmplitudeMax=15,e.operatorFrequencies=a([{name:"1×",mult:1,hzOffset:0,amplitudeSign:1},{name:"~1×",mult:1,hzOffset:1.5,amplitudeSign:-1},{name:"2×",mult:2,hzOffset:0,amplitudeSign:1},{name:"~2×",mult:2,hzOffset:-1.3,amplitudeSign:-1},{name:"3×",mult:3,hzOffset:0,amplitudeSign:1},{name:"4×",mult:4,hzOffset:0,amplitudeSign:1},{name:"5×",mult:5,hzOffset:0,amplitudeSign:1},{name:"6×",mult:6,hzOffset:0,amplitudeSign:1},{name:"7×",mult:7,hzOffset:0,amplitudeSign:1},{name:"8×",mult:8,hzOffset:0,amplitudeSign:1},{name:"9×",mult:9,hzOffset:0,amplitudeSign:1},{name:"11×",mult:11,hzOffset:0,amplitudeSign:1},{name:"13×",mult:13,hzOffset:0,amplitudeSign:1},{name:"16×",mult:16,hzOffset:0,amplitudeSign:1},{name:"20×",mult:20,hzOffset:0,amplitudeSign:1}]),e.envelopes=a([{name:"none",type:1,speed:0},{name:"note size",type:0,speed:0},{name:"punch",type:2,speed:0},{name:"flare 1",type:3,speed:32},{name:"flare 2",type:3,speed:8},{name:"flare 3",type:3,speed:2},{name:"twang 1",type:4,speed:32},{name:"twang 2",type:4,speed:8},{name:"twang 3",type:4,speed:2},{name:"swell 1",type:5,speed:32},{name:"swell 2",type:5,speed:8},{name:"swell 3",type:5,speed:2},{name:"tremolo1",type:6,speed:4},{name:"tremolo2",type:6,speed:2},{name:"tremolo3",type:6,speed:1},{name:"tremolo4",type:7,speed:4},{name:"tremolo5",type:7,speed:2},{name:"tremolo6",type:7,speed:1},{name:"decay 1",type:8,speed:10},{name:"decay 2",type:8,speed:7},{name:"decay 3",type:8,speed:4}]),e.feedbacks=a([{name:"1⟲",indices:[[1],[],[],[]]},{name:"2⟲",indices:[[],[2],[],[]]},{name:"3⟲",indices:[[],[],[3],[]]},{name:"4⟲",indices:[[],[],[],[4]]},{name:"1⟲ 2⟲",indices:[[1],[2],[],[]]},{name:"3⟲ 4⟲",indices:[[],[],[3],[4]]},{name:"1⟲ 2⟲ 3⟲",indices:[[1],[2],[3],[]]},{name:"2⟲ 3⟲ 4⟲",indices:[[],[2],[3],[4]]},{name:"1⟲ 2⟲ 3⟲ 4⟲",indices:[[1],[2],[3],[4]]},{name:"1→2",indices:[[],[1],[],[]]},{name:"1→3",indices:[[],[],[1],[]]},{name:"1→4",indices:[[],[],[],[1]]},{name:"2→3",indices:[[],[],[2],[]]},{name:"2→4",indices:[[],[],[],[2]]},{name:"3→4",indices:[[],[],[],[3]]},{name:"1→3 2→4",indices:[[],[],[1],[2]]},{name:"1→4 2→3",indices:[[],[],[2],[1]]},{name:"1→2→3→4",indices:[[],[1],[2],[3]]}]),e.chipNoiseLength=32768,e.spectrumNoiseLength=32768,e.spectrumBasePitch=24,e.spectrumControlPoints=30,e.spectrumControlPointsPerOctave=7,e.spectrumControlPointBits=3,e.spectrumMax=(1<<e.spectrumControlPointBits)-1,e.harmonicsControlPoints=28,e.harmonicsRendered=64,e.harmonicsRenderedForPickedString=256,e.harmonicsControlPointBits=3,e.harmonicsMax=(1<<e.harmonicsControlPointBits)-1,e.harmonicsWavelength=2048,e.pulseWidthRange=8,e.pulseWidthStepPower=.5,e.supersawVoiceCount=7,e.supersawDynamismMax=6,e.supersawSpreadMax=12,e.supersawShapeMax=6,e.pitchChannelCountMin=1,e.pitchChannelCountMax=10,e.noiseChannelCountMin=0,e.noiseChannelCountMax=5,e.noiseInterval=6,e.pitchesPerOctave=12,e.drumCount=12,e.pitchOctaves=7,e.maxPitch=e.pitchOctaves*e.pitchesPerOctave,e.maximumTonesPerChannel=2*e.maxChordSize,e.justIntonationSemitones=[.5,8/15,9/16,.6,5/8,2/3,32/45,3/4,.8,5/6,8/9,15/16,1,16/15,9/8,1.2,5/4,4/3,45/32,1.5,1.6,5/3,16/9,15/8,2].map((t=>Math.log2(t)*e.pitchesPerOctave)),e.pitchShiftRange=e.justIntonationSemitones.length,e.pitchShiftCenter=e.pitchShiftRange>>1,e.detuneCenter=9,e.detuneMax=2*e.detuneCenter,e.sineWaveLength=256,e.sineWaveMask=e.sineWaveLength-1,e.sineWave=function(){const t=new Float32Array(e.sineWaveLength+1);for(let s=0;s<e.sineWaveLength+1;s++)t[s]=Math.sin(s*Math.PI*2/e.sineWaveLength);return t}(),e.pickedStringDispersionCenterFreq=6e3,e.pickedStringDispersionFreqScale=.3,e.pickedStringDispersionFreqMult=4,e.pickedStringShelfHz=4e3,e.stringSustainRange=15,e.stringDecayRate=.12,e.enableAcousticSustain=!1,e.sustainTypeNames=["bright","acoustic"],e.distortionRange=8,e.bitcrusherFreqRange=14,e.bitcrusherOctaveStep=.5,e.bitcrusherQuantizationRange=8,e.maxEnvelopeCount=12,e.defaultAutomationRange=13,e.instrumentAutomationTargets=a([{name:"none",computeIndex:null,displayName:"none",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:null},{name:"noteVolume",computeIndex:0,displayName:"note volume",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:null},{name:"pulseWidth",computeIndex:2,displayName:"pulse width",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:[6,8]},{name:"stringSustain",computeIndex:3,displayName:"sustain",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:[7]},{name:"unison",computeIndex:4,displayName:"unison",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:[0,5,7]},{name:"operatorFrequency",computeIndex:5,displayName:"fm# freq",interleave:!0,isFilter:!1,maxCount:e.operatorCount,effect:null,compatibleInstruments:[1]},{name:"operatorAmplitude",computeIndex:9,displayName:"fm# volume",interleave:!1,isFilter:!1,maxCount:e.operatorCount,effect:null,compatibleInstruments:[1]},{name:"feedbackAmplitude",computeIndex:13,displayName:"fm feedback",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:[1]},{name:"pitchShift",computeIndex:14,displayName:"pitch shift",interleave:!1,isFilter:!1,maxCount:1,effect:7,compatibleInstruments:null},{name:"detune",computeIndex:15,displayName:"detune",interleave:!1,isFilter:!1,maxCount:1,effect:8,compatibleInstruments:null},{name:"vibratoDepth",computeIndex:16,displayName:"vibrato range",interleave:!1,isFilter:!1,maxCount:1,effect:9,compatibleInstruments:null},{name:"noteFilterAllFreqs",computeIndex:1,displayName:"n. filter freqs",interleave:!1,isFilter:!0,maxCount:1,effect:5,compatibleInstruments:null},{name:"noteFilterFreq",computeIndex:17,displayName:"n. filter # freq",interleave:!1,isFilter:!0,maxCount:e.filterMaxPoints,effect:5,compatibleInstruments:null},{name:"noteFilterGain",computeIndex:null,displayName:"n. filter # vol",interleave:!1,isFilter:!0,maxCount:e.filterMaxPoints,effect:5,compatibleInstruments:null},{name:"supersawDynamism",computeIndex:33,displayName:"dynamism",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:[8]},{name:"supersawSpread",computeIndex:34,displayName:"spread",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:[8]},{name:"supersawShape",computeIndex:35,displayName:"saw↔pulse",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:[8]}]);const x=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|android|ipad|playbook|silk/i.test(navigator.userAgent);function k(t){return t.toFixed(2).replace(/\.?0*$/,"")}class M{static valueToPreset(t){const e=t>>6,s=63&t;return M.presetCategories[e].presets[s]}static midiProgramToPresetValue(t){for(let e=0;e<M.presetCategories.length;e++){const s=M.presetCategories[e];for(let i=0;i<s.presets.length;i++){const n=s.presets[i];if(n.generalMidi&&n.midiProgram==t)return(e<<6)+i}}return null}static nameToPresetValue(t){for(let e=0;e<M.presetCategories.length;e++){const s=M.presetCategories[e];for(let i=0;i<s.presets.length;i++){if(s.presets[i].name==t)return(e<<6)+i}}return null}}M.version="",M.releaseNotesURL="https://github.com/johnnesky/beepbox/releases/tag/v"+M.version,M.isOnMac=/^Mac/i.test(navigator.platform)||/Mac OS X/i.test(navigator.userAgent)||/^(iPhone|iPad|iPod)/i.test(navigator.platform)||/(iPhone|iPad|iPod)/i.test(navigator.userAgent),M.ctrlSymbol=M.isOnMac?"⌘":"Ctrl+",M.ctrlName=M.isOnMac?"command":"control",M.presetCategories=a([{name:"Custom Instruments",presets:a([{name:"chip wave",customType:0},{name:"FM (expert)",customType:1},{name:"basic noise",customType:2},{name:"spectrum",customType:3},{name:"drumset",customType:4},{name:"harmonics",customType:5},{name:"pulse width",customType:6},{name:"picked string",customType:7},{name:"supersaw",customType:8}])},{name:"Presets? Fuck you get creative",presets:a([{name:"shit",midiProgram:80,settings:{type:"chip",eqFilter:[],effects:["transition type","chord type","pitch shift","detune","vibrato","note filter","distortion","bitcrusher","chorus","echo","reverb"],transition:"slide in pattern",chord:"arpeggio",pitchShiftSemitones:24,detuneCents:45,vibrato:"heavy",noteFilter:[{type:"low-pass",cutoffHz:8e3,linearGain:11.3137},{type:"peak",cutoffHz:2378.41,linearGain:.125},{type:"peak",cutoffHz:3363.59,linearGain:.25},{type:"peak",cutoffHz:1189.21,linearGain:.3536},{type:"peak",cutoffHz:297.3,linearGain:.3536},{type:"peak",cutoffHz:148.65,linearGain:11.3137},{type:"low-pass",cutoffHz:16e3,linearGain:11.3137}],distortion:100,bitcrusherOctave:0,bitcrusherQuantization:100,chorus:100,echoSustain:100,echoDelayBeats:2,reverb:100,fadeInSeconds:0,fadeOutTicks:-1,wave:"spiky",unison:"piano",envelopes:[]}}])}]);var S=t&&t.t||function(t){var e="function"==typeof Symbol&&Symbol.iterator,s=e&&t[e],i=0;if(s)return s.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},P=t&&t.i||function(t,e){var s="function"==typeof Symbol&&t[Symbol.iterator];if(!s)return t;var i,n,h=s.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(i=h.next()).done;)o.push(i.value)}catch(t){n={error:t}}finally{try{i&&!i.done&&(s=h.return)&&s.call(h)}finally{if(n)throw n.error}}return o},I=t&&t.h||function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(P(arguments[e]));return t};function F(t,e){var s,i,n,h,o,r;try{for(var a=S(e),l=a.next();!l.done;l=a.next()){var c=l.value;if(c instanceof Node)t.appendChild(c);else if("string"==typeof c)t.appendChild(document.createTextNode(c));else if("function"==typeof c)F(t,[c()]);else if(Array.isArray(c))F(t,c);else if(c&&"undefined"!=typeof Symbol&&"function"==typeof c[Symbol.iterator])F(t,I(c));else if(c&&c.constructor===Object&&t instanceof Element)try{for(var u=(n=void 0,S(Object.keys(c))),p=u.next();!p.done;p=u.next()){var d=p.value,f=c[d];if("class"===d)"string"==typeof f?t.setAttribute("class",f):Array.isArray(c)||f&&"undefined"!=typeof Symbol&&"function"==typeof f[Symbol.iterator]?t.setAttribute("class",I(f).join(" ")):console.warn("Invalid "+d+' value "'+f+'" on '+t.tagName+" element.");else if("style"===d)if(f&&f.constructor===Object)try{for(var m=(o=void 0,S(Object.keys(f))),y=m.next();!y.done;y=m.next()){var b=y.value;b in t.style?t.style[b]=f[b]:t.style.setProperty(b,f[b])}}catch(t){o={error:t}}finally{try{y&&!y.done&&(r=m.return)&&r.call(m)}finally{if(o)throw o.error}}else t.setAttribute(d,f);else"function"==typeof f?t[d]=f:"boolean"==typeof f?f?t.setAttribute(d,""):t.removeAttribute(d):t.setAttribute(d,f)}}catch(t){n={error:t}}finally{try{p&&!p.done&&(h=u.return)&&h.call(u)}finally{if(n)throw n.error}}else t.appendChild(document.createTextNode(c))}}catch(t){s={error:t}}finally{try{l&&!l.done&&(i=a.return)&&i.call(a)}finally{if(s)throw s.error}}return t}var B="http://www.w3.org/2000/svg";var L,C,D,T,E=t&&t.t||function(t){var e="function"==typeof Symbol&&Symbol.iterator,s=e&&t[e],i=0;if(s)return s.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},N=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return document.createRange().createContextualFragment(t.join())},O=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var s=document.createDocumentFragment(),i=(new DOMParser).parseFromString('<svg xmlns="http://www.w3.org/2000/svg">'+t.join()+"</svg>","image/svg+xml").documentElement;null!==i.firstChild;)document.importNode(i.firstChild,!0),s.appendChild(i.firstChild);return s},z=function(t){N[t]=function(){for(var e=[],s=0;s<arguments.length;s++)e[s]=arguments[s];return F(document.createElement(t),e)}};try{for(var R=E("a abbr address area article aside audio b base bdi bdo blockquote br button canvas caption cite code col colgroup datalist dd del details dfn dialog div dl dt em embed fieldset figcaption figure footer form h1 h2 h3 h4 h5 h6 header hr i iframe img input ins kbd label legend li link main map mark menu menuitem meta meter nav noscript object ol optgroup option output p param picture pre progress q rp rt ruby s samp script section select small source span strong style sub summary sup table tbody td template textarea tfoot th thead time title tr track u ul var video wbr".split(" ")),A=R.next();!A.done;A=R.next()){z(A.value)}}catch(Bo){L={error:Bo}}finally{try{A&&!A.done&&(C=R.return)&&C.call(R)}finally{if(L)throw L.error}}var $=function(t){if(O[t]=function(){for(var e=[],s=0;s<arguments.length;s++)e[s]=arguments[s];return F(document.createElementNS(B,t),e)},/-/.test(t)){var e=t.replace(/-/g,"_");O[e]=function(){for(var e=[],s=0;s<arguments.length;s++)e[s]=arguments[s];return F(document.createElementNS(B,t),e)}}};try{for(var U=E("a altGlyph altGlyphDef altGlyphItem animate animateMotion animateTransform circle clipPath color-profile cursor defs desc discard ellipse feBlend feColorMatrix feComponentTransfer feComposite feConvolveMatrix feDiffuseLighting feDisplacementMap feDistantLight feDropShadow feFlood feFuncA feFuncB feFuncG feFuncR feGaussianBlur feImage feMerge feMergeNode feMorphology feOffset fePointLight feSpecularLighting feSpotLight feTile feTurbulence filter font font-face font-face-format font-face-name font-face-src font-face-uri foreignObject g glyph glyphRef hkern image line linearGradient marker mask metadata missing-glyph mpath path pattern polygon polyline radialGradient rect script set stop style svg switch symbol text textPath title tref tspan use view vkern".split(" ")),q=U.next();!q.done;q=U.next()){$(q.value)}}catch(Lo){D={error:Lo}}finally{try{q&&!q.done&&(T=U.return)&&T.call(U)}finally{if(D)throw D.error}}class _{static getChannelColor(t,e){return e<t.pitchChannelCount?_.pitchChannels[e%_.pitchChannels.length]:_.noiseChannels[(e-t.pitchChannelCount)%_.noiseChannels.length]}static setTheme(t){let e=this.themes[t];null==e&&(e=this.themes["dark classic"]),this.o.textContent=e;const s=document.querySelector("meta[name='theme-color']");null!=s&&s.setAttribute("content",getComputedStyle(document.documentElement).getPropertyValue("--ui-widget-background"))}}_.themes={"shitbox4 classic":'\n\t\t:root {\n\t\t\t--page-margin: #252525;\n\t\t\t--editor-background: #252525;\n\t\t\t--hover-preview: white;\n\t\t\t--playhead: white;\n\t\t\t--primary-text: #C8C8C8;\n\t\t\t--secondary-text: #999;\n\t\t\t--inverted-text: black;\n\t\t\t--text-selection: rgba(119,68,255,0.99);\n\t\t\t--box-selection-fill: rgba(255,255,255,0.2);\n\t\t\t--loop-accent: #74f;\n\t\t\t--link-accent: #945800;\n\t\t\t--ui-widget-background: #444;\n\t\t\t--ui-widget-focus: #777;\n\t\t\t--pitch-background: #444;\n\t\t\t--tonic: #864;\n\t\t\t--fifth-note: #468;\n\t\t\t--white-piano-key: #bbb;\n\t\t\t--black-piano-key: #444;\n\t\t\t--pitch1-secondary-channel: #0099A1;\n\t\t\t--pitch1-primary-channel:   #25F3FF;\n\t\t\t--pitch1-secondary-note:    #00BDC7;\n\t\t\t--pitch1-primary-note:      #92F9FF;\n\t\t\t--pitch2-secondary-channel: #A1A100;\n\t\t\t--pitch2-primary-channel:   #FFFF25;\n\t\t\t--pitch2-secondary-note:    #C7C700;\n\t\t\t--pitch2-primary-note:      #FFFF92;\n\t\t\t--pitch3-secondary-channel: #C75000;\n\t\t\t--pitch3-primary-channel:   #FF9752;\n\t\t\t--pitch3-secondary-note:    #FF771C;\n\t\t\t--pitch3-primary-note:      #FFCDAB;\n\t\t\t--pitch4-secondary-channel: #00A100;\n\t\t\t--pitch4-primary-channel:   #50FF50;\n\t\t\t--pitch4-secondary-note:    #00C700;\n\t\t\t--pitch4-primary-note:      #A0FFA0;\n\t\t\t--pitch5-secondary-channel: #D020D0;\n\t\t\t--pitch5-primary-channel:   #FF90FF;\n\t\t\t--pitch5-secondary-note:    #E040E0;\n\t\t\t--pitch5-primary-note:      #FFC0FF;\n\t\t\t--pitch6-secondary-channel: #7777B0;\n\t\t\t--pitch6-primary-channel:   #A0A0FF;\n\t\t\t--pitch6-secondary-note:    #8888D0;\n\t\t\t--pitch6-primary-note:      #D0D0FF;\n\t\t\t--pitch7-secondary-channel: #8AA100;\n\t\t\t--pitch7-primary-channel:   #DEFF25;\n\t\t\t--pitch7-secondary-note:    #AAC700;\n\t\t\t--pitch7-primary-note:      #E6FF92;\n\t\t\t--pitch8-secondary-channel: #DF0019;\n\t\t\t--pitch8-primary-channel:   #FF98A4;\n\t\t\t--pitch8-secondary-note:    #FF4E63;\n\t\t\t--pitch8-primary-note:      #FFB2BB;\n\t\t\t--pitch9-secondary-channel: #00A170;\n\t\t\t--pitch9-primary-channel:   #50FFC9;\n\t\t\t--pitch9-secondary-note:    #00C78A;\n\t\t\t--pitch9-primary-note:      #83FFD9;\n\t\t\t--pitch10-secondary-channel:#A11FFF;\n\t\t\t--pitch10-primary-channel:  #CE8BFF;\n\t\t\t--pitch10-secondary-note:   #B757FF;\n\t\t\t--pitch10-primary-note:     #DFACFF;\n\t\t\t--noise1-secondary-channel: #6F6F6F;\n\t\t\t--noise1-primary-channel:   #AAAAAA;\n\t\t\t--noise1-secondary-note:    #A7A7A7;\n\t\t\t--noise1-primary-note:      #E0E0E0;\n\t\t\t--noise2-secondary-channel: #996633;\n\t\t\t--noise2-primary-channel:   #DDAA77;\n\t\t\t--noise2-secondary-note:    #CC9966;\n\t\t\t--noise2-primary-note:      #F0D0BB;\n\t\t\t--noise3-secondary-channel: #4A6D8F;\n\t\t\t--noise3-primary-channel:   #77AADD;\n\t\t\t--noise3-secondary-note:    #6F9FCF;\n\t\t\t--noise3-primary-note:      #BBD7FF;\n\t\t\t--noise4-secondary-channel: #7A4F9A;\n\t\t\t--noise4-primary-channel:   #AF82D2;\n\t\t\t--noise4-secondary-note:    #9E71C1;\n\t\t\t--noise4-primary-note:      #D4C1EA;\n\t\t\t--noise5-secondary-channel: #607837;\n\t\t\t--noise5-primary-channel:   #A2BB77;\n\t\t\t--noise5-secondary-note:    #91AA66;\n\t\t\t--noise5-primary-note:      #C5E2B2;\n\t\t\t\t--disabled-note-primary:    #999;\n\t\t\t\t--disabled-note-secondary:  #666;\n\t\t\t}\n\n\t\t\t.beepboxEditor input[type="range"]::-moz-range-thumb {\n\t\t\t\twidth: 8px !important;\n\t\t\t  }\n\n\t\t\tbutton.playButton,\n\t\t\tbutton.pauseButton,\n\t\t\tbutton.recordButton {\n\t\t\t\twidth: 80px;\n\t\t\t}\n\t\t\tbutton.prevBarButton {\n\t\t\t\twidth: 40px;\n\t\t\t\tleft:-5px;\n\t\t\t}\n\t\t\tbutton.nextBarButton {\n\t\t\t\twidth: 40px;\n\t\t\t}\n\n\t\t\tinput, \n\t\t\tdiv.harmonics svg,\n\t\t\tdiv.spectrum svg,\n\t\t\tdiv.filterEditor svg,\n\t\t\tdiv.fadeInOut svg,\n\t\t\tdiv.loopEditor svg\n\t\t\t{\n\t\t\t\tbackground: black !important;\n\t\t\t}\n\n\t\t\tdiv.pattern-area div div svg {\n\t\t\t\tbackground: black !important;\n\t\t\t}\n\n\t\t\tdiv.trackContainer div.noSelection div {\n\t\t\t\t--editor-background: black !important;\n\t\t\t}\n\n\t\t\t.beepboxEditor {\n\t\t\t\tline-height: 1.25;\n\t\t\t}\n\n\t\t\t#text-content {\n\t\t\t\tfont-size: 32px;\n\t\t\t\tline-height: 40px;\n\t\t\t}\n\n\t\t\t#text-content > section > h1 {\n\t\t\t\tcolor: #C8C8C8;\n\t\t\t\t}\n\t\t',shitbox2:'\n\t\t:root {\n\t\t\t--page-margin: maroon;\n\t\t\t\t\t--editor-background: black;\n\t\t\t\t\t--hover-preview: white;\n\t\t\t\t\t--playhead: firebrick;\n\t\t\t\t\t--primary-text: silver;\n\t\t\t\t\t--secondary-text: #999;\n\t\t\t\t\t--inverted-text: black;\n\t\t\t\t--text-selection: rgba(139,69,19,0.99);\n\t\t\t\t\t--box-selection-fill: rgba(220,20,60,0.2);\n\t\t\t\t\t--loop-accent: #841;\n\t\t\t\t\t--link-accent: #841;\n\t\t\t\t\t--ui-widget-background: #800;\n\t\t\t\t\t--ui-widget-focus: #a00;\n\t\t\t\t\t--pitch-background: #700;\n\t\t\t\t\t--tonic: #522;\n\t\t\t\t\t--fifth-note: #f75;\n\t\t\t\t\t--third-note: #9d3535;\n\t\t\t\t\t--white-piano-key: #bbb;\n\t\t\t\t\t--black-piano-key: #444;\n\t\t\t\t--pitch1-secondary-channel: #7e4a35;\n\t\t\t\t\t--pitch1-primary-channel:   #c27251;\n\t\t\t\t\t--pitch1-secondary-note:    #7e4a35;\n\t\t\t\t\t--pitch1-primary-note:      #f09571;\n\t\t\t\t\t--pitch2-secondary-channel: #998a5c;\n\t\t\t\t\t--pitch2-primary-channel:   #d9c27c;\n\t\t\t\t\t--pitch2-secondary-note:    #998a5c;\n\t\t\t\t\t--pitch2-primary-note:      #fae196;\n\t\t\t\t\t--pitch3-secondary-channel: #9c927c;\n\t\t\t\t\t--pitch3-primary-channel:   #dbceb0;\n\t\t\t\t\t--pitch3-secondary-note:    #9c927c;\n\t\t\t\t\t--pitch3-primary-note:      #eddebb;\n\t\t\t\t\t--pitch4-secondary-channel: #838060;\n\t\t\t\t\t--pitch4-primary-channel:   #ccc795;\n\t\t\t\t\t--pitch4-secondary-note:    #838060;\n\t\t\t\t\t--pitch4-primary-note:      #f2ecb1;\n\t\t\t\t\t--pitch5-secondary-channel: #8b6f47;\n\t\t\t\t\t--pitch5-primary-channel:   #d1a76b;\n\t\t\t\t\t--pitch5-secondary-note:    #8b6f47;\n\t\t\t\t\t--pitch5-primary-note:      #ffcc82;\n\t\t\t\t\t--pitch6-secondary-channel: #a96e5b;\n\t\t\t\t\t--pitch6-primary-channel:   #e3967d;\n\t\t\t\t\t--pitch6-secondary-note:    #a96e5b;\n\t\t\t\t\t--pitch6-primary-note:      #ffa68a;\n\t\t\t\t\t\t--pitch7-secondary-channel: #7e4a35;\n\t\t\t\t\t--pitch7-primary-channel:   #c27251;\n\t\t\t\t\t--pitch7-secondary-note:    #7e4a35;\n\t\t\t\t\t--pitch7-primary-note:      #f09571;\n\t\t\t\t\t--pitch8-secondary-channel: #998a5c;\n\t\t\t\t\t--pitch8-primary-channel:   #d9c27c;\n\t\t\t\t\t--pitch8-secondary-note:    #998a5c;\n\t\t\t\t\t--pitch8-primary-note:      #fae196;\n\t\t\t\t\t--pitch9-secondary-channel: #9c927c;\n\t\t\t\t\t--pitch9-primary-channel:   #dbceb0;\n\t\t\t\t\t--pitch9-secondary-note:    #9c927c;\n\t\t\t\t\t--pitch9-primary-note:      #eddebb;\n\t\t\t\t\t--pitch10-secondary-channel: #838060;\n\t\t\t\t\t--pitch10-primary-channel:   #ccc795;\n\t\t\t\t\t--pitch10-secondary-note:    #838060;\n\t\t\t\t\t--pitch10-primary-note:      #f2ecb1;\n\t\t\t\t\t--noise1-secondary-channel: #6f6f6f;\n\t\t\t\t\t--noise1-primary-channel:   #aaaaaa;\n\t\t\t\t\t--noise1-secondary-note:    #a7a7a7;\n\t\t\t\t\t--noise1-primary-note:      #e0e0e0;\n\t\t\t\t\t--noise2-secondary-channel: #996633;\n\t\t\t\t\t--noise2-primary-channel:   #ddaa77;\n\t\t\t\t\t--noise2-secondary-note:    #cc9966;\n\t\t\t\t\t--noise2-primary-note:      #f0d0bb;\n\t\t\t\t\t--noise3-secondary-channel: #4a6d8f;\n\t\t\t\t\t--noise3-primary-channel:   #77aadd;\n\t\t\t\t\t--noise3-secondary-note:    #6f9fcf;\n\t\t\t\t\t--noise3-primary-note:      #bbd7ff;\n\t\t\t\t\t--noise4-secondary-channel: #6f6f6f;\n\t\t\t\t\t--noise4-primary-channel:   #aaaaaa;\n\t\t\t\t\t--noise4-secondary-note:    #a7a7a7;\n\t\t\t\t\t--noise4-primary-note:      #e0e0e0;\n\t\t\t\t\t--noise5-secondary-channel: #996633;\n\t\t\t\t\t--noise5-primary-channel:   #ddaa77;\n\t\t\t\t\t--noise5-secondary-note:    #cc9966;\n\t\t\t\t\t--noise5-primary-note:      #f0d0bb;\n\t\t\t\t}\n\n\t\t\t.beepboxEditor input[type="range"]::-moz-range-thumb {\n\t\t\t\twidth: 8px !important;\n\t\t\t  }\n\n\t\t\tbutton.playButton,\n\t\t\tbutton.pauseButton,\n\t\t\tbutton.recordButton {\n\t\t\t\twidth: 80px;\n\t\t\t}\n\t\t\tbutton.prevBarButton {\n\t\t\t\twidth: 40px;\n\t\t\t\tleft:-5px;\n\t\t\t}\n\t\t\tbutton.nextBarButton {\n\t\t\t\twidth: 40px;\n\t\t\t}\n\n\t\t\t.beepboxEditor {\n\t\t\t\tline-height: 1.25;\n\t\t\t}\n\n\t\t\t#text-content {\n\t\t\t\tfont-size: 32px;\n\t\t\t\tline-height: 40px;\n\t\t\t}\n\n\t\t\t#text-content > section > h1 {\n\t\t\t\tcolor: #C8C8C8;\n\t\t\t\t}\n\t\t',realm:'\n\t\t:root {\n\t\t\t--page-margin: #252525;\n\t\t\t--editor-background: #252525;\n\t\t\t--hover-preview: white;\n\t\t\t--playhead: white;\n\t\t\t--primary-text: #6e6e6e;\n\t\t\t--secondary-text: #999;\n\t\t\t--inverted-text: black;\n\t\t\t--text-selection: rgba(119,68,255,0.99);\n\t\t\t--box-selection-fill: rgba(255,255,255,0.2);\n\t\t\t--loop-accent: #673daf;\n\t\t\t--link-accent: #945800;\n\t\t\t--ui-widget-background: #444;\n\t\t\t--ui-widget-focus: #565656;\n\t\t\t--pitch-background:  #673daf;\n\t\t\t--tonic: #673daf;\n\t\t\t--fifth-note: #673daf;\n\t\t\t--octave-scrollbar: #673daf;\n\t\t\t--white-piano-key: #bbb;\n\t\t\t--black-piano-key: #444;\n\t\t\t --pitch1-secondary-channel: #0099a1;\n\t\t\t --pitch1-primary-channel:   #25f3ff;\n\t\t\t --pitch1-secondary-note:    #0099a1;\n\t\t\t --pitch1-primary-note:      #25f3ff;\n\t\t\t --pitch2-secondary-channel: #439143;\n\t\t\t --pitch2-primary-channel:   #44ff44;\n\t\t\t --pitch2-secondary-note:    #439143;\n\t\t\t --pitch2-primary-note:      #44ff44;\n\t\t\t --pitch3-secondary-channel: #a1a100;\n\t\t\t --pitch3-primary-channel:   #ffff25;\n\t\t\t --pitch3-secondary-note:    #a1a100;\n\t\t\t --pitch3-primary-note:      #ffff25;\n\t\t\t --pitch4-secondary-channel: #c75000;\n\t\t\t --pitch4-primary-channel:   #ff9752;\n\t\t\t --pitch4-secondary-note:    #c75000;\n\t\t\t --pitch4-primary-note:      #ff9752;\n\t\t\t --pitch5-secondary-channel: #d020d0;\n\t\t\t --pitch5-primary-channel:   #FF90FF;\n\t\t\t --pitch5-secondary-note:    #d020d0;\n\t\t\t --pitch5-primary-note:      #ff90ff;\n\t\t\t --pitch6-secondary-channel: #552377;\n\t\t\t --pitch6-primary-channel:   #9f31ea;\n\t\t\t --pitch6-secondary-note:    #552377;\n\t\t\t --pitch6-primary-note:      #9f31ea;\n\t\t\t --pitch7-secondary-channel: #221b89;\n\t\t\t --pitch7-primary-channel:   #2b6aff;\n\t\t\t --pitch7-secondary-note:    #221b89;\n\t\t\t --pitch7-primary-note:      #2b6aff;\n\t\t\t --pitch8-secondary-channel: #00995f;\n\t\t\t --pitch8-primary-channel:   #00ff9f;\n\t\t\t --pitch8-secondary-note:    #00995f;\n\t\t\t --pitch8-primary-note:      #00ff9f;\n\t\t\t --pitch9-secondary-channel: #d6b03e;\n\t\t\t --pitch9-primary-channel:   #ffbf00;\n\t\t\t --pitch9-secondary-note:    #d6b03e;\n\t\t\t --pitch9-primary-note:      #ffbf00;\n\t\t\t --pitch10-secondary-channel:#b25915;\n\t\t\t --pitch10-primary-channel:  #d85d00;\n\t\t\t --pitch10-secondary-note:   #b25915;\n\t\t\t --pitch10-primary-note:     #d85d00;\n\t\t\t --pitch11-secondary-channel:#891a60;\n\t\t\t --pitch11-primary-channel:  #ff00a1;\n\t\t\t --pitch11-secondary-note:   #891a60;\n\t\t\t --pitch11-primary-note:     #ff00a1;\n\t\t\t --pitch12-secondary-channel:#965cbc;\n\t\t\t --pitch12-primary-channel:  #c26afc;\n\t\t\t --pitch12-secondary-note:   #965cbc;\n\t\t\t --pitch12-primary-note:     #c26afc;\n\t\t\t --noise1-secondary-channel: #991010;\n\t\t\t --noise1-primary-channel:   #ff1616;\n\t\t\t --noise1-secondary-note:    #991010;\n\t\t\t --noise1-primary-note:      #ff1616;\n\t\t\t --noise2-secondary-channel: #aaaaaa;\n\t\t\t --noise2-primary-channel:   #ffffff;\n\t\t\t --noise2-secondary-note:    #aaaaaa;\n\t\t\t --noise2-primary-note:      #ffffff;\n\t\t\t --noise3-secondary-channel: #5869BD;\n\t\t\t --noise3-primary-channel:   #768dfc;\n\t\t\t --noise3-secondary-note:    #5869BD;\n\t\t\t --noise3-primary-note:      #768dfc;\n\t\t\t --noise4-secondary-channel: #7c9b42;\n\t\t\t --noise4-primary-channel:   #a5ff00;\n\t\t\t --noise4-secondary-note:    #7c9b42;\n\t\t\t --noise4-primary-note:      #a5ff00;\n\t\t\t --noise5-secondary-channel: #7c9b42;\n\t\t\t --noise5-primary-channel:   #A2BB77;\n\t\t\t --noise5-secondary-note:    #91AA66;\n\t\t\t --noise5-primary-note:      #C5E2B2;\n\t\t\t}\n\n\t\t\t.beepboxEditor input[type="range"]::-moz-range-thumb {\n\t\t\t\twidth: 8px !important;\n\t\t\t  }\n\n\t\t\tbutton.playButton {\n\t\t\t\twidth: 80px;\n\t\t\t}\n\t\t\tbutton.prevBarButton {\n\t\t\t\twidth: 40px;\n\t\t\t\tleft:-5px;\n\t\t\t}\n\t\t\tbutton.nextBarButton {\n\t\t\t\twidth: 40px;\n\t\t\t}\n\n\t\t\tspan input, \n\t\t\tdiv.harmonics svg,\n\t\t\tdiv.spectrum svg,\n\t\t\tdiv.filterEditor svg,\n\t\t\tdiv.fadeInOut svg,\n\t\t\tdiv.loopEditor svg,\n\t\t\tsvg#firstImage \n\t\t\t{\n\t\t\t\tbackground: black !important;\n\t\t\t}\n\n\t\t\t.beepboxEditor {\n\t\t\t\tline-height: 1.25;\n\t\t\t}\n\n\t\t\t #octaveScrollBarContainer {\n\t\t\t background-color: black;\n\t\t\t }\n\n\t\t\t#text-content {\n\t\t\t\tfont-size: 32px;\n\t\t\t\tline-height: 40px;\n\t\t\t}\n\n\t\t\t#text-content > section > h1 {\n\t\t\t\tcolor: #C8C8C8;\n\t\t\t\t}\n\n\t\t\thtml {\n\t\t\t\tfont: monospace !important;\n\t\t\t\t}\n\t\t\t\t'},_.pageMargin="var(--page-margin)",_.editorBackground="var(--editor-background)",_.hoverPreview="var(--hover-preview)",_.playhead="var(--playhead)",_.primaryText="var(--primary-text)",_.secondaryText="var(--secondary-text)",_.invertedText="var(--inverted-text)",_.textSelection="var(--text-selection)",_.boxSelectionFill="var(--box-selection-fill)",_.loopAccent="var(--loop-accent)",_.linkAccent="var(--link-accent)",_.uiWidgetBackground="var(--ui-widget-background)",_.uiWidgetFocus="var(--ui-widget-focus)",_.pitchBackground="var(--pitch-background)",_.tonic="var(--tonic)",_.fifthNote="var(--fifth-note)",_.whitePianoKey="var(--white-piano-key)",_.blackPianoKey="var(--black-piano-key)",_.pitchChannels=a([{name:"pitch1",secondaryChannel:"var(--pitch1-secondary-channel)",primaryChannel:"var(--pitch1-primary-channel)",secondaryNote:"var(--pitch1-secondary-note)",primaryNote:"var(--pitch1-primary-note)"},{name:"pitch2",secondaryChannel:"var(--pitch2-secondary-channel)",primaryChannel:"var(--pitch2-primary-channel)",secondaryNote:"var(--pitch2-secondary-note)",primaryNote:"var(--pitch2-primary-note)"},{name:"pitch3",secondaryChannel:"var(--pitch3-secondary-channel)",primaryChannel:"var(--pitch3-primary-channel)",secondaryNote:"var(--pitch3-secondary-note)",primaryNote:"var(--pitch3-primary-note)"},{name:"pitch4",secondaryChannel:"var(--pitch4-secondary-channel)",primaryChannel:"var(--pitch4-primary-channel)",secondaryNote:"var(--pitch4-secondary-note)",primaryNote:"var(--pitch4-primary-note)"},{name:"pitch5",secondaryChannel:"var(--pitch5-secondary-channel)",primaryChannel:"var(--pitch5-primary-channel)",secondaryNote:"var(--pitch5-secondary-note)",primaryNote:"var(--pitch5-primary-note)"},{name:"pitch6",secondaryChannel:"var(--pitch6-secondary-channel)",primaryChannel:"var(--pitch6-primary-channel)",secondaryNote:"var(--pitch6-secondary-note)",primaryNote:"var(--pitch6-primary-note)"},{name:"pitch7",secondaryChannel:"var(--pitch7-secondary-channel)",primaryChannel:"var(--pitch7-primary-channel)",secondaryNote:"var(--pitch7-secondary-note)",primaryNote:"var(--pitch7-primary-note)"},{name:"pitch8",secondaryChannel:"var(--pitch8-secondary-channel)",primaryChannel:"var(--pitch8-primary-channel)",secondaryNote:"var(--pitch8-secondary-note)",primaryNote:"var(--pitch8-primary-note)"},{name:"pitch9",secondaryChannel:"var(--pitch9-secondary-channel)",primaryChannel:"var(--pitch9-primary-channel)",secondaryNote:"var(--pitch9-secondary-note)",primaryNote:"var(--pitch9-primary-note)"},{name:"pitch10",secondaryChannel:"var(--pitch10-secondary-channel)",primaryChannel:"var(--pitch10-primary-channel)",secondaryNote:"var(--pitch10-secondary-note)",primaryNote:"var(--pitch10-primary-note)"}]),_.noiseChannels=a([{name:"noise1",secondaryChannel:"var(--noise1-secondary-channel)",primaryChannel:"var(--noise1-primary-channel)",secondaryNote:"var(--noise1-secondary-note)",primaryNote:"var(--noise1-primary-note)"},{name:"noise2",secondaryChannel:"var(--noise2-secondary-channel)",primaryChannel:"var(--noise2-primary-channel)",secondaryNote:"var(--noise2-secondary-note)",primaryNote:"var(--noise2-primary-note)"},{name:"noise3",secondaryChannel:"var(--noise3-secondary-channel)",primaryChannel:"var(--noise3-primary-channel)",secondaryNote:"var(--noise3-secondary-note)",primaryNote:"var(--noise3-primary-note)"},{name:"noise4",secondaryChannel:"var(--noise4-secondary-channel)",primaryChannel:"var(--noise4-primary-channel)",secondaryNote:"var(--noise4-secondary-note)",primaryNote:"var(--noise4-primary-note)"},{name:"noise5",secondaryChannel:"var(--noise5-secondary-channel)",primaryChannel:"var(--noise5-primary-channel)",secondaryNote:"var(--noise5-secondary-note)",primaryNote:"var(--noise5-primary-note)"}]),_.o=document.head.appendChild(N.style({type:"text/css"}));const V=document.body.appendChild(N.div({style:"width:30px; height:30px; overflow: auto;"},N.div({style:"width:100%;height:40px"})));V.firstChild.clientWidth<30&&document.documentElement.classList.add("obtrusive-scrollbars"),document.body.removeChild(V),document.head.appendChild(N.style({type:"text/css"},`\n\n/* Note: "#" symbols need to be encoded as "%23" in SVG data urls, otherwise they are interpreted as fragment identifiers! */\n:root {\n\t--button-size: 26px;\n\t--settings-area-width: 192px;\n\t--play-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M -5 -8 L -5 8 L 8 0 z" fill="gray"/></svg>');\n\t--pause-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="-5" y="-7" width="4" height="14" fill="gray"/><rect x="3" y="-7" width="4" height="14" fill="gray"/></svg>');\n\t--record-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><circle cx="0" cy="0" r="6" fill="gray"/></svg>');\n\t--stop-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="-6" y="-6" width="12" height="12" fill="gray"/></svg>');\n\t--prev-bar-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="-6" y="-6" width="2" height="12" fill="gray"/><path d="M 6 -6 L 6 6 L -3 0 z" fill="gray"/></svg>');\n\t--next-bar-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="4" y="-6" width="2" height="12" fill="gray"/><path d="M -6 -6 L -6 6 L 3 0 z" fill="gray"/></svg>');\n\t--volume-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"><path d="M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z" fill="gray"/></svg>');\n\t--unmuted-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="3 3 20 20"><path d="M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z" fill="gray"/></svg>');\n\t--muted-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="3 3 20 20"><path d="M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z" fill="gray"/></svg>');\n\t--menu-down-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M -4 -2 L 4 -2 L 0 3 z" fill="gray"/></svg>');\n\t--select-arrows-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M -4 -3 L 4 -3 L 0 -8 z M -4 3 L 4 3 L 0 8 z" fill="gray"/></svg>');\n\t--file-page-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-5 -21 26 26"><path d="M 2 0 L 2 -16 L 10 -16 L 14 -12 L 14 0 z M 3 -1 L 13 -1 L 13 -11 L 9 -11 L 9 -15 L 3 -15 z" fill="gray"/></svg>');\n\t--edit-pencil-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-5 -21 26 26"><path d="M 0 0 L 1 -4 L 4 -1 z M 2 -5 L 10 -13 L 13 -10 L 5 -2 zM 11 -14 L 13 -16 L 14 -16 L 16 -14 L 16 -13 L 14 -11 z" fill="gray"/></svg>');\n\t--preferences-gear-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M 5.78 -1.6 L 7.93 -0.94 L 7.93 0.94 L 5.78 1.6 L 4.85 3.53 L 5.68 5.61 L 4.21 6.78 L 2.36 5.52 L 0.27 5.99 L -0.85 7.94 L -2.68 7.52 L -2.84 5.28 L -4.52 3.95 L -6.73 4.28 L -7.55 2.59 L -5.9 1.07 L -5.9 -1.07 L -7.55 -2.59 L -6.73 -4.28 L -4.52 -3.95 L -2.84 -5.28 L -2.68 -7.52 L -0.85 -7.94 L 0.27 -5.99 L 2.36 -5.52 L 4.21 -6.78 L 5.68 -5.61 L 4.85 -3.53 M 2.92 0.67 L 2.92 -0.67 L 2.35 -1.87 L 1.3 -2.7 L 0 -3 L -1.3 -2.7 L -2.35 -1.87 L -2.92 -0.67 L -2.92 0.67 L -2.35 1.87 L -1.3 2.7 L -0 3 L 1.3 2.7 L 2.35 1.87 z" fill="gray"/></svg>');\n\t--customize-dial-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"> \t\t\t<g transform="translate(0,1)" fill="gray"> \t\t\t\t<circle cx="0" cy="0" r="6.5" stroke="gray" stroke-width="1" fill="none"/> \t\t\t\t<rect x="-1" y="-5" width="2" height="4" transform="rotate(30)"/> \t\t\t\t<circle cx="-7.79" cy="4.5" r="0.75"/> \t\t\t\t<circle cx="-9" cy="0" r="0.75"/> \t\t\t\t<circle cx="-7.79" cy="-4.5" r="0.75"/> \t\t\t\t<circle cx="-4.5" cy="-7.79" r="0.75"/> \t\t\t\t<circle cx="0" cy="-9" r="0.75"/> \t\t\t\t<circle cx="4.5" cy="-7.79" r="0.75"/> \t\t\t\t<circle cx="7.79" cy="-4.5" r="0.75"/> \t\t\t\t<circle cx="9" cy="0" r="0.75"/> \t\t\t\t<circle cx="7.79" cy="4.5" r="0.75"/> \t\t\t</g> \t\t</svg>');\n\t--instrument-copy-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-5 -21 26 26"><path d="M 0 -15 L 1 -15 L 1 0 L 13 0 L 13 1 L 0 1 L 0 -15 z M 2 -1 L 2 -17 L 10 -17 L 14 -13 L 14 -1 z M 3 -2 L 13 -2 L 13 -12 L 9 -12 L 9 -16 L 3 -16 z" fill="currentColor"></path></svg>');\n\t--instrument-paste-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"><path d="M 8 18 L 6 18 L 6 5 L 17 5 L 17 7 M 9 8 L 16 8 L 20 12 L 20 22 L 9 22 z" stroke="currentColor" fill="none"></path><path d="M 9 3 L 14 3 L 14 6 L 9 6 L 9 3 z M 16 8 L 20 12 L 16 12 L 16 8 z" fill="currentColor"></path></svg>');\n\t--export-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -8 3 L -8 8 L 8 8 L 8 3 L 6 3 L 6 6 L -6 6 L -6 3 z M 0 2 L -4 -2 L -1 -2 L -1 -8 L 1 -8 L 1 -2 L 4 -2 z"/></svg>');\n\t--close-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -7.07 -5.66 L -5.66 -7.07 L 0 -1.4 L 5.66 -7.07 L 7.07 -5.66 L 1.4 0 L 7.07 5.66 L 5.66 7.07 L 0 1.4 L -5.66 7.07 L -7.07 5.66 L -1.4 0 z"/></svg>');\n\t--add-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -8 -1 L -1 -1 L -1 -8  L 1 -8 L 1 -1 L 8 -1 L 8 1 L 1 1 L 1 8 L -1 8 L -1 1 L -8 1 z"/></svg>');\n\t--zoom-in-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="-10 -10 20 20"><circle cx="-1" cy="-1" r="6" stroke-width="2" stroke="gray" fill="none"></circle><path stroke="gray" stroke-width="2" d="M 3 3 L 7 7 M -1 -4 L -1 2 M -4 -1 L 2 -1" fill="none"></path></svg>');\n\t--zoom-out-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="-10 -10 20 20"><circle cx="-1" cy="-1" r="6" stroke-width="2" stroke="gray" fill="none"></circle><path stroke="gray" stroke-width="2" d="M 3 3 L 7 7 M -4 -1 L 2 -1" fill="none"></path></svg>');\n\t--checkmark-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -9 -2 L -8 -3 L -3 2 L 9 -8 L 10 -7 L -3 8 z"/></svg>');\n\t--drum-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 32 40"> \t\t\t<defs> \t\t\t\t<linearGradient id="gold1" x1="0%" y1="0%" x2="100%" y2="0%"> \t\t\t\t\t<stop offset="0%" stop-color="%237e3302"/> \t\t\t\t\t<stop offset="40%" stop-color="%23ffec6b"/> \t\t\t\t\t<stop offset="100%" stop-color="%237e3302"/> \t\t\t\t</linearGradient> \t\t\t\t<linearGradient id="gold2" x1="0%" y1="0%" x2="100%" y2="0%"> \t\t\t\t\t<stop offset="0%" stop-color="%23faaf7d"/> \t\t\t\t\t<stop offset="15%" stop-color="%23fffba9"/> \t\t\t\t\t<stop offset="40%" stop-color="%23ffffe3"/> \t\t\t\t\t<stop offset="65%" stop-color="%23fffba9"/> \t\t\t\t\t<stop offset="100%" stop-color="%23faaf7d"/> \t\t\t\t</linearGradient> \t\t\t\t<radialGradient id="gold3" cx="0%" cy="0%" r="100%"> \t\t\t\t\t<stop offset="0%" stop-color="%23ffffe3"/> \t\t\t\t\t<stop offset="50%" stop-color="%23ffec6b"/> \t\t\t\t\t<stop offset="100%" stop-color="%237e3302"/> \t\t\t\t</radialGradient> \t\t\t\t<linearGradient id="red" x1="0%" y1="0%" x2="100%" y2="0%"> \t\t\t\t\t<stop offset="0%" stop-color="%23641919"/> \t\t\t\t\t<stop offset="40%" stop-color="%23cd2c2c"/> \t\t\t\t\t<stop offset="100%" stop-color="%23641919"/> \t\t\t\t</linearGradient> \t\t\t\t<radialGradient id="membrane"> \t\t\t\t\t<stop offset="10%" stop-color="%23cccccc" /> \t\t\t\t\t<stop offset="90%" stop-color="%23f6f6f7" /> \t\t\t\t\t<stop offset="100%" stop-color="%23999" /> \t\t\t\t</radialGradient> \t\t\t</defs> \t\t\t<ellipse cx="16" cy="26" rx="16" ry="14" fill="rgba(0,0,0,0.5)"/> \t\t\t<ellipse cx="16" cy="25" rx="16" ry="14" fill="url(%23gold1)"/> \t\t\t<rect x="0" y="23" width="32" height="2" fill="url(%23gold1)"/> \t\t\t<ellipse cx="16" cy="23" rx="16" ry="14" fill="url(%23gold2)"/> \t\t\t<ellipse cx="16" cy="23" rx="15" ry="13" fill="url(%23red)"/> \t\t\t<rect x="1" y="17" width="30" height="6" fill="url(%23red)"/> \t\t\t<rect x="5" y="27" width="1" height="5" rx="0.5" fill="rgba(0,0,0,0.5)"/> \t\t\t<rect x="15" y="31" width="2" height="5" rx="1" fill="rgba(0,0,0,0.5)"/> \t\t\t<rect x="26" y="27" width="1" height="5" rx="0.5" fill="rgba(0,0,0,0.5)"/> \t\t\t<rect x="5" y="26" width="1" height="5" rx="0.5" fill="url(%23gold3)"/> \t\t\t<rect x="15" y="30" width="2" height="5" rx="1" fill="url(%23gold3)"/> \t\t\t<rect x="26" y="26" width="1" height="5" rx="0.5" fill="url(%23gold3)"/> \t\t\t<ellipse cx="16" cy="18" rx="15" ry="13" fill="rgba(0,0,0,0.5)"/> \t\t\t<ellipse cx="16" cy="16" rx="16" ry="14" fill="url(%23gold1)"/> \t\t\t<rect x="0" y="14" width="32" height="2" fill="url(%23gold1)"/> \t\t\t<ellipse cx="16" cy="14" rx="16" ry="14" fill="url(%23gold2)"/> \t\t\t<ellipse cx="16" cy="14" rx="15" ry="13" fill="url(%23membrane)"/> \t\t</svg>');\n\t--piano-key-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="15" preserveAspectRatio="none" viewBox="0 -1 32 15"> \t\t\t<defs> \t\t\t\t<linearGradient id="shadow" x1="0%" y1="0%" x2="100%" y2="0%"> \t\t\t\t\t<stop offset="0%" stop-color="rgba(0,0,0,0.5)"/> \t\t\t\t\t<stop offset="100%" stop-color="transparent"/> \t\t\t\t</linearGradient> \t\t\t</defs> \t\t\t<rect x="-1" y="1" width="31" height="1" rx="0.6" fill="rgba(255,255,255,0.4)"/> \t\t\t<path d="M -1 11 L 30 11 L 30 2 L 33 -1 L 33 14 L -1 14 z" fill="rgba(0,0,0,0.7)"/> \t\t\t<rect x="-1" y="-1" width="19" height="15" fill="url(%23shadow)"/> \t\t</svg>');\n}\n\n\n.obtrusive-scrollbars, .obtrusive-scrollbars * {\n\tscrollbar-width: thin;\n\tscrollbar-color: ${_.uiWidgetBackground} ${_.editorBackground};\n}\n.obtrusive-scrollbars::-webkit-scrollbar, .obtrusive-scrollbars *::-webkit-scrollbar {\n\twidth: 12px;\n}\n.obtrusive-scrollbars::-webkit-scrollbar-track, .obtrusive-scrollbars *::-webkit-scrollbar-track {\n\tbackground: ${_.editorBackground};\n}\n.obtrusive-scrollbars::-webkit-scrollbar-thumb, .obtrusive-scrollbars *::-webkit-scrollbar-thumb {\n\tbackground-color: ${_.uiWidgetBackground};\n\tborder: 3px solid ${_.editorBackground};\n}\n\n\n.beepboxEditor {\n\tdisplay: grid;\n    grid-template-columns: minmax(0, 1fr) max-content;\n    grid-template-rows: max-content 1fr; /* max-content minmax(0, 1fr); Chrome 80 grid layout regression. https://bugs.chromium.org/p/chromium/issues/detail?id=1050307 */\n    grid-template-areas: "pattern-area settings-area" "track-area settings-area";\n\tgrid-column-gap: 6px;\n\tgrid-row-gap: 6px;\n\tposition: relative;\n\ttouch-action: manipulation;\n\tcursor: default;\n\tfont-size: 13px;\n\toverflow: hidden;\n\tcolor: ${_.primaryText};\n\tbackground: ${_.editorBackground};\n}\n\n.beepboxEditor .noSelection {\n\t-webkit-touch-callout: none;\n\t-webkit-user-select: none;\n\t-moz-user-select: none;\n\t-ms-user-select: none;\n\tuser-select: none;\n}\n\n.beepboxEditor div {\n\tmargin: 0;\n\tpadding: 0;\n}\n\n.beepboxEditor .pattern-area {\n\tgrid-area: pattern-area;\n\theight: 481px;\n\tdisplay: flex;\n\tflex-direction: row;\n\tposition: relative;\n}\n\n.beepboxEditor .track-area {\n\tgrid-area: track-area;\n}\n\n.beepboxEditor .loopEditor {\n\theight: 20px;\n\tposition: sticky;\n\tbottom: 0;\n\tpadding: 5px 0;\n\tbackground-color: ${_.editorBackground};\n}\n\n.beepboxEditor .settings-area {\n\tgrid-area: settings-area;\n\tdisplay: grid;\n    grid-template-columns: auto;\n    grid-template-rows: min-content min-content min-content min-content min-content;\n    grid-template-areas: "version-area" "play-pause-area" "menu-area" "song-settings-area" "instrument-settings-area";\n\tgrid-column-gap: 6px;\n}\n\n.beepboxEditor .version-area{ grid-area: version-area; }\n.beepboxEditor .play-pause-area{ grid-area: play-pause-area; }\n.beepboxEditor .menu-area{ grid-area: menu-area; }\n.beepboxEditor .song-settings-area{ grid-area: song-settings-area; }\n.beepboxEditor .instrument-settings-area{ grid-area: instrument-settings-area; }\n\n.beepboxEditor .tip {\n\tcursor: help;\n\tcolor: ${_.secondaryText};\n\ttext-decoration: none;\n}\n\n.beepboxEditor .tip:hover {\n\tcolor: ${_.linkAccent};\n\ttext-decoration: underline;\n}\n.beepboxEditor .tip:active {\n\tcolor: ${_.primaryText};\n}\n\n.beepboxEditor .volume-speaker {\n\tflex-shrink: 0;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: ${_.secondaryText};\n\t-webkit-mask-image: var(--volume-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--volume-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .drum-button {\n\tflex: 1;\n\tbackground-color: transparent;\n\tbackground-image: var(--drum-symbol);\n\tbackground-repeat: no-repeat;\n\tbackground-position: center;\n}\n\n.beepboxEditor .piano-button {\n\tflex: 1;\n\tposition: relative;\n\tdisplay: flex;\n\talign-items: center;\n}\n.beepboxEditor .piano-button::before {\n\tcontent: "";\n\tposition: absolute;\n\tleft: 0;\n\ttop: 0;\n\twidth: 100%;\n\theight: 100%;\n\tpointer-events: none;\n\tbackground-image: var(--piano-key-symbol);\n\tbackground-repeat: no-repeat;\n\tbackground-position: center;\n\tbackground-size: 100% 115.38%;\n}\n.beepboxEditor .piano-button.disabled::after {\n\tcontent: "";\n\tposition: absolute;\n\tright: 0;\n\ttop: 0;\n\twidth: 70%;\n\theight: 100%;\n\tpointer-events: none;\n\tbackground: ${_.editorBackground};\n\t-webkit-mask-image: linear-gradient(90deg, transparent 0%, gray 70%, gray 100%);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: linear-gradient(90deg, transparent 0%, gray 70%, gray 100%);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .piano-button.pressed, .beepboxEditor .drum-button.pressed {\n\tfilter: brightness(0.5);\n}\n\n.beepboxEditor .customize-instrument {\n\tmargin: 2px 0;\n}\n.beepboxEditor .customize-instrument::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--customize-dial-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--customize-dial-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .instrumentCopyPasteRow {\n\tgap: 2px;\n}\n\n.beepboxEditor .copy-instrument {\n\tmargin: 2px 0;\n\tflex-grow: 1;\n}\n.beepboxEditor .copy-instrument::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--instrument-copy-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--instrument-copy-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .paste-instrument {\n\tmargin: 2px 0;\n\tflex-grow: 1;\n}\n.beepboxEditor .paste-instrument::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--instrument-paste-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--instrument-paste-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .envelopeEditor {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .envelope-row {\n\tdisplay: flex;\n\tmargin: 2px 0;\n\tgap: 2px;\n}\n\n.beepboxEditor .add-envelope {\n\twidth: var(--button-size);\n}\n.beepboxEditor .add-envelope::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--add-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--add-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n.beepboxEditor .add-envelope:disabled {\n\tvisibility: hidden;\n}\n\n.beepboxEditor .effects-menu {\n\twidth: var(--button-size);\n\tposition: relative;\n}\n.beepboxEditor .effects-menu::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--menu-down-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--menu-down-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor .zoomInButton, .beepboxEditor .zoomOutButton {\n\twidth: var(--button-size);\n\tposition: absolute;\n\tright: 10px;\n}\n.beepboxEditor .zoomInButton {\n\ttop: 10px;\n}\n.beepboxEditor .zoomOutButton {\n\ttop: 50px;\n}\n.beepboxEditor .zoomInButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--zoom-in-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--zoom-in-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n.beepboxEditor .zoomOutButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--zoom-out-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--zoom-out-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor .delete-envelope {\n\twidth: var(--button-size);\n\tflex-shrink: 0;\n\tflex-grow: 0;\n}\n.beepboxEditor .delete-envelope::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--close-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--close-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n.beepboxEditor .delete-envelope:disabled {\n\tvisibility: hidden;\n}\n\n.beepboxEditor .menu.file::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--file-page-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--file-page-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .menu.edit::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--edit-pencil-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--edit-pencil-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .menu.preferences::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--preferences-gear-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--preferences-gear-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .mute-button::before {\n\tcontent: "";\n\tpointer-events: none;\n\twidth: 100%;\n\theight: 100%;\n\tbackground: ${_.primaryText};\n\tdisplay: inline-block;\n\t-webkit-mask-image: var(--unmuted-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\t-webkit-mask-size: contain;\n\tmask-image: var(--unmuted-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\tmask-size: contain;\n}\n\n.beepboxEditor .mute-button.muted::before {\n\tbackground: ${_.editorBackground};\n\t-webkit-mask-image: var(--muted-symbol);\n\tmask-image: var(--muted-symbol);\n}\n\n.beepboxEditor .promptContainer {\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\twidth: 100%;\n\theight: 100%;\n\tdisplay: flex;\n\tjustify-content: center;\n\talign-items: center;\n\tz-index: 100;\n}\n\n.beepboxEditor .promptContainer::before {\n\tcontent: "";\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\twidth: 100%;\n\theight: 100%;\n\tbackground: ${_.editorBackground};\n\topacity: 0.5;\n\tdisplay: flex;\n}\n\n.beepboxEditor .prompt {\n\tmargin: auto;\n\ttext-align: center;\n\tbackground: ${_.editorBackground};\n\tborder-radius: 15px;\n\tborder: 4px solid ${_.uiWidgetBackground};\n\tcolor: ${_.primaryText};\n\tpadding: 20px;\n\tdisplay: flex;\n\tflex-direction: column;\n\tposition: relative;\n\tbox-shadow: 5px 5px 20px 10px rgba(0,0,0,0.5);\n}\n\n.beepboxEditor .prompt > *:not(:first-child):not(.cancelButton) {\n\tmargin-top: 1.5em;\n}\n\n.beepboxEditor .prompt h2 {\n\tfont-size: 2em;\n\tmargin: 0 16px;\n\tfont-weight: normal;\n}\n\n.beepboxEditor .prompt p {\n\ttext-align: left;\n\tmargin: 1em 0;\n}\n\n.beepboxEditor .prompt label {\n\tcursor: pointer;\n}\n\n.beepboxEditor .prompt.recordingSetupPrompt p {\n\tmargin-top: 0.75em;\n\tmargin-bottom: 0;\n}\n\n.beepboxEditor .prompt.recordingSetupPrompt > label:not(:first-child):not(.cancelButton) {\n\tmargin: 2px 0;\n}\n\n.beepboxEditor .layout-option {\n\tdisplay: flex;\n\tflex-direction: column;\n\tflex: 1;\n\tcursor: pointer;\n\tcolor: ${_.secondaryText};\n}\n\n.beepboxEditor .layout-option input {\n\tdisplay: none;\n}\n\n.beepboxEditor .layout-option input:checked ~ * {\n\tcolor: ${_.primaryText};\n}\n\n.beepboxEditor .selectContainer {\n\tposition: relative;\n}\n.beepboxEditor .selectContainer:not(.menu)::after {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tright: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: 14px;\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--select-arrows-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--select-arrows-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n.beepboxEditor .selectContainer.menu::after {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tright: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--menu-down-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--menu-down-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n.beepboxEditor select {\n\tmargin: 0;\n\tpadding: 0 4px;\n\tdisplay: block;\n\theight: var(--button-size);\n\tborder: none;\n\tborder-radius: 5px;\n\tbackground: ${_.uiWidgetBackground};\n\tcolor: inherit;\n\tfont-size: inherit;\n\tcursor: pointer;\n\tfont-family: inherit;\n\tfont-weight: inherit;\n\n\t-webkit-appearance:none;\n\t-moz-appearance: none;\n\tappearance: none;\n}\n.beepboxEditor .menu select {\n\tpadding: 0 var(--button-size);\n}\n.beepboxEditor select:focus {\n\tbackground: ${_.uiWidgetFocus};\n\toutline: none;\n}\n.beepboxEditor .menu select {\n\ttext-align: center;\n\ttext-align-last: center;\n}\n.beepboxEditor .settings-area select {\n       width: 100%;\n}\n\n/* This makes it look better in firefox on my computer... What about others?\n@-moz-document url-prefix() {\n\t.beepboxEditor select { padding: 0 2px; }\n}\n*/\n.beepboxEditor button {\n\tmargin: 0;\n\tposition: relative;\n\theight: var(--button-size);\n\tborder: none;\n\tborder-radius: 5px;\n\tbackground: ${_.uiWidgetBackground};\n\tcolor: inherit;\n\tfont-size: inherit;\n\tfont-family: inherit;\n\tfont-weight: inherit;\n\tcursor: pointer;\n}\n.beepboxEditor button:focus {\n\tbackground: ${_.uiWidgetFocus};\n\toutline: none;\n}\n\n.beepboxEditor button.cancelButton {\n\tfloat: right;\n\twidth: var(--button-size);\n\tposition: absolute;\n\ttop: 8px;\n\tright: 8px;\n}\n\n.beepboxEditor .playback-bar-controls {\n\tdisplay: grid;\n\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr);\n\tgrid-template-rows: min-content;\n\tgrid-column-gap: 4px;\n}\n\n.beepboxEditor button.playButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--play-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--play-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n.beepboxEditor button.pauseButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--pause-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--pause-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n.beepboxEditor button.recordButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--record-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--record-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n.beepboxEditor button.stopButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--stop-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--stop-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor button.prevBarButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 50%;\n\ttop: 50%;\n\ttransform: translate(-50%, -50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--prev-bar-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--prev-bar-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor button.nextBarButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 50%;\n\ttop: 50%;\n\ttransform: translate(-50%, -50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--next-bar-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--next-bar-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor button.playButton, .beepboxEditor button.pauseButton, .beepboxEditor button.recordButton, .beepboxEditor button.stopButton, .beepboxEditor button.okayButton, .beepboxEditor button.exportButton {\n\tpadding-left: var(--button-size);\n}\n.beepboxEditor button.playButton, .beepboxEditor button.pauseButton, .beepboxEditor button.recordButton {\n\tgrid-column-start: 1;\n\tgrid-column-end: 3;\n}\n.beepboxEditor button.stopButton {\n\tgrid-column-start: 1;\n\tgrid-column-end: 5;\n}\n.beepboxEditor button.prevBarButton {\n\tgrid-column-start: 3;\n\tgrid-column-end: 4;\n}\n.beepboxEditor button.nextBarButton {\n\tgrid-column-start: 4;\n\tgrid-column-end: 5;\n}\n\n.beepboxEditor button.playButton.shrunk, .beepboxEditor button.recordButton.shrunk {\n\tpadding: 0;\n}\n.beepboxEditor button.playButton.shrunk::before, .beepboxEditor button.recordButton.shrunk::before {\n\tleft: 50%;\n\ttop: 50%;\n\ttransform: translate(-50%, -50%);\n}\n.beepboxEditor button.playButton.shrunk span, .beepboxEditor button.recordButton.shrunk span {\n\tdisplay: none;\n}\n.beepboxEditor button.playButton.shrunk {\n\tgrid-column-start: 1;\n\tgrid-column-end: 2;\n}\n.beepboxEditor button.recordButton.shrunk {\n\tgrid-column-start: 2;\n\tgrid-column-end: 3;\n}\n\n.beepboxEditor button.cancelButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--close-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--close-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor button.okayButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--checkmark-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--checkmark-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor button.exportButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--export-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--export-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor .instrument-bar {\n\tdisplay: flex;\n\tgap: 2px;\n}\n\n.beepboxEditor .instrument-bar button {\n\tflex-grow: 1;\n\tmin-width: 0;\n\tpadding: 0;\n\tflex-basis: 0;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\tcolor: var(--text-color-lit);\n}\n\n.beepboxEditor .instrument-bar .remove-instrument, .beepboxEditor .instrument-bar .add-instrument {\n\tmax-width: var(--button-size);\n}\n\n.beepboxEditor .instrument-bar > :not(:first-child) {\n\tborder-top-left-radius: 0;\n\tborder-bottom-left-radius: 0;\n}\n\n.beepboxEditor .instrument-bar > :not(.last-button) {\n\tborder-top-right-radius: 0;\n\tborder-bottom-right-radius: 0;\n}\n\n.beepboxEditor .instrument-bar .selected-instrument {\n\tbackground: var(--background-color-lit);\n\tcolor: ${_.invertedText};\n}\n\n.beepboxEditor .instrument-bar .deactivated {\n\tbackground: ${_.editorBackground};\n\tcolor: var(--text-color-dim);\n}\n\n.beepboxEditor .instrument-bar .deactivated.selected-instrument {\n\tbackground: var(--background-color-dim);\n\tcolor: ${_.invertedText};\n}\n\n.beepboxEditor .instrument-bar .remove-instrument::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: 100%;\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--close-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--close-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor .instrument-bar .add-instrument::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: 100%;\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--add-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--add-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor canvas {\n\toverflow: hidden;\n\tposition: absolute;\n\tdisplay: block;\n}\n\n.beepboxEditor .trackContainer {\n\tflex-grow: 1;\n}\n\n.beepboxEditor .trackAndMuteContainer {\n\tdisplay: flex;\n\talign-items: flex-start;\n\twidth: 100%;\n\tmin-height: 0;\n\tflex: 1;\n\toverflow-x: hidden;\n\tposition: relative;\n}\n\n.beepboxEditor .channelRow {\n\tdisplay: flex;\n}\n\n.beepboxEditor .channelBox {\n\tdisplay: flex;\n\ttext-align: center;\n\talign-items: center;\n\tjustify-content: center;\n\tbox-sizing: border-box;\n\tpadding-top: 1px;\n}\n\n.beepboxEditor .channelBoxLabel {\n\tfont-size: 20px;\n\tfont-family: sans-serif;\n\tfont-weight: bold;\n}\n\n.beepboxEditor .muteEditor {\n\twidth: 32px;\n\tflex-shrink: 0;\n\tdisplay: flex;\n\tflex-direction: column;\n\talign-items: stretch;\n\tposition: sticky;\n\tleft: 0;\n\tz-index: 1;\n\tbackground: ${_.editorBackground};\n}\n\n.beepboxEditor .selectRow, .beepboxEditor .instrumentCopyPasteRow {\n\tmargin: 2px 0;\n\theight: var(--button-size);\n\tdisplay: flex;\n\tflex-direction: row;\n\talign-items: center;\n\tjustify-content: space-between;\n}\n\n.beepboxEditor .selectRow > :last-child {\n\twidth: 62.5%;\n\tflex-shrink: 0;\n}\n\n.beepboxEditor .menu-area {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n.beepboxEditor .menu-area > * {\n\tmargin: 2px 0;\n}\n.beepboxEditor .menu-area > button {\n\tpadding: 0 var(--button-size);\n\twhite-space: nowrap;\n}\n\n.beepboxEditor .song-settings-area {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .editor-controls {\n\tflex-shrink: 0;\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .instrument-settings-area {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .editor-right-side-top > *, .beepboxEditor .editor-right-side-bottom > * {\n\tflex-shrink: 0;\n}\n\n.beepboxEditor .pitchShiftMarkerContainer {\n\tbox-sizing: border-box;\n\tdisplay: flex;\n\theight: 100%;\n\tleft: 3px;\n\tright: 3px;\n\tposition: absolute;\n\talign-items: center;\n\tpointer-events: none;\n}\n\n.beepboxEditor .pitchShiftMarker {\n\twidth: 0;\n\theight: 0;\n\tposition: absolute;\n}\n\n.beepboxEditor .pitchShiftMarker::before {\n\tcontent: "";\n\twidth: 2px;\n\theight: 20px;\n\ttransform: translate(-50%, -50%);\n\tposition: absolute;\n\tbackground: currentColor;\n\tborder-radius: 3px;\n}\n\n.beepboxEditor input[type=text], .beepboxEditor input[type=number] {\n\tfont-size: inherit;\n\tfont-weight: inherit;\n\tfont-family: inherit;\n\tbackground: transparent;\n\tborder: 1px solid ${_.uiWidgetFocus};\n\tcolor: ${_.primaryText};\n}\n\n.beepboxEditor input[type=text]::selection, .beepboxEditor input[type=number]::selection {\n\tbackground-color: ${_.textSelection};\n\tcolor: ${_.primaryText};\n}\n\n.beepboxEditor input[type=checkbox] {\n  transform: scale(1.5);\n}\n\n.beepboxEditor input[type=range] {\n\t-webkit-appearance: none;\n\tcolor: inherit;\n\twidth: 100%;\n\theight: var(--button-size);\n\tfont-size: inherit;\n\tmargin: 0;\n\tcursor: pointer;\n\tbackground: none;\n\ttouch-action: pan-y;\n}\n.beepboxEditor input[type=range]:focus {\n\toutline: none;\n}\n.beepboxEditor input[type=range]::-webkit-slider-runnable-track {\n\twidth: 100%;\n\theight: 6px;\n\tcursor: pointer;\n\tbackground: ${_.uiWidgetBackground};\n}\n.beepboxEditor input[type=range]::-webkit-slider-thumb {\n\theight: var(--button-size);\n\twidth: 6px;\n\tborder-radius: 3px;\n\tbackground: currentColor;\n\tcursor: pointer;\n\t-webkit-appearance: none;\n\tmargin-top: -10px;\n}\n.beepboxEditor input[type=range]:focus::-webkit-slider-runnable-track {\n\tbackground: ${_.uiWidgetFocus};\n}\n.beepboxEditor input[type=range]::-moz-range-track {\n\twidth: 100%;\n\theight: 6px;\n\tcursor: pointer;\n\tbackground: ${_.uiWidgetBackground};\n}\n.beepboxEditor input[type=range]:focus::-moz-range-track {\n\tbackground: ${_.uiWidgetFocus};\n}\n.beepboxEditor input[type=range]::-moz-range-thumb {\n\theight: var(--button-size);\n\twidth: 6px;\n\tborder-radius: 3px;\n\tborder: none;\n\tbackground: currentColor;\n\tcursor: pointer;\n}\n.beepboxEditor input[type=range]::-ms-track {\n\twidth: 100%;\n\theight: 6px;\n\tcursor: pointer;\n\tbackground: ${_.uiWidgetBackground};\n\tborder-color: transparent;\n}\n.beepboxEditor input[type=range]:focus::-ms-track {\n\tbackground: ${_.uiWidgetFocus};\n}\n.beepboxEditor input[type=range]::-ms-thumb {\n\theight: var(--button-size);\n\twidth: 6px;\n\tborder-radius: 3px;\n\tbackground: currentColor;\n\tcursor: pointer;\n}\n\n/* wide screen */\n@media (min-width: 711px) {\n\t#beepboxEditorContainer {\n\t\tdisplay: table;\n\t}\n\t.beepboxEditor {\n\t\tflex-direction: row;\n\t}\n\t.beepboxEditor:focus-within {\n\t\toutline: 3px solid ${_.uiWidgetBackground};\n\t}\n\t.beepboxEditor .trackAndMuteContainer {\n\t\twidth: 512px;\n\t}\n\t.beepboxEditor .play-pause-area {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t}\n\t.beepboxEditor .playback-bar-controls {\n\t\tmargin: 2px 0;\n\t}\n\t.beepboxEditor .playback-volume-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tmargin: 2px 0;\n\t\talign-items: center;\n\t}\n\t.beepboxEditor .settings-area {\n\t\twidth: var(--settings-area-width);\n\t}\n}\n\n/* narrow screen */\n@media (max-width: 710px) {\n\t.beepboxEditor {\n\t\tgrid-template-columns: minmax(0, 1fr);\n\t\tgrid-template-rows: min-content 6px min-content min-content;\n\t\tgrid-template-areas: "pattern-area" "." "track-area" "settings-area";\n\t\tgrid-row-gap: 0;\n\t}\n\t.beepboxEditor .settings-area {\n\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\n\t\tgrid-template-rows: min-content min-content 1fr min-content;\n\t\tgrid-template-areas:\n\t\t\t"play-pause-area play-pause-area"\n\t\t\t"menu-area instrument-settings-area"\n\t\t\t"song-settings-area instrument-settings-area"\n\t\t\t"version-area version-area";\n\t\tgrid-column-gap: 8px;\n\t\tmargin: 0 4px;\n\t}\n\t.beepboxEditor:focus-within {\n\t\toutline: none;\n\t}\n\t.beepboxEditor .pattern-area {\n\t\tmax-height: 75vh;\n\t}\n\t.beepboxEditor .trackAndMuteContainer {\n\t\toverflow-x: auto;\n\t}\n\t.beepboxEditor .barScrollBar {\n\t\tdisplay: none;\n\t}\n\t.beepboxEditor .play-pause-area {\n\t\tdisplay: grid;\n\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\n\t\tgrid-column-gap: 8px;\n\t\tmargin: 2px 0;\n\t}\n\t.beepboxEditor .playback-bar-controls {\n\t\tflex-grow: 1;\n\t}\n\t.beepboxEditor .playback-volume-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\talign-items: center;\n\t\tflex-grow: 1;\n\t}\n}\n\n`));class j{static setLayout(t){this.o.textContent=this.l[t]}}j.l={small:"",long:`\t\t\t/* long layout */\n\t\t\t@media (min-width: 711px) {\n\t\t\t\t#beepboxEditorContainer {\n\t\t\t\t\tmax-width: initial;\n\t\t\t\t\theight: 100vh;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100vh;\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) 390px; /* minmax(0, 1fr) min-content; Chrome 80 grid layout regression. https://bugs.chromium.org/p/chromium/issues/detail?id=1050307 */\n\t\t\t\t\tgrid-template-rows: minmax(481px, 1fr) minmax(0, min-content);\n\t\t\t\t\tgrid-template-areas: "pattern-area settings-area" "track-area track-area";\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .pattern-area {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100%;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .track-area {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\tflex-direction: column;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\tmin-height: 0;\n\t\t\t\t\tflex: 1;\n\t\t\t\t\toverflow: auto;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .instrument-settings-area {\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t\tposition: relative;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .instrument-settings-area > .editor-controls {\n\t\t\t\t\tposition: absolute;\n\t\t\t\t\twidth: 100%;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .song-settings-area {\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.beepboxEditor .settings-area {\n\t\t\t\t\twidth: 390px;\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\n\t\t\t\t\tgrid-template-rows: auto auto auto minmax(0, 1fr);\n\t\t\t\t\tgrid-template-areas:\n\t\t\t\t\t\t"instrument-settings-area version-area"\n\t\t\t\t\t\t"instrument-settings-area play-pause-area"\n\t\t\t\t\t\t"instrument-settings-area menu-area"\n\t\t\t\t\t\t"instrument-settings-area song-settings-area";\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.beepboxEditor .barScrollBar {\n\t\t\t\t\tdisplay: none;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackContainer {\n\t\t\t\t\toverflow: visible;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\n\t\t\t\t\tscrollbar-width: auto;\n\t\t\t\t\tscrollbar-color: ${_.uiWidgetBackground} ${_.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar {\n\t\t\t\t\twidth: 20px;\n\t\t\t\t\theight: 20px;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-track {\n\t\t\t\t\tbackground: ${_.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-thumb {\n\t\t\t\t\tbackground-color: ${_.uiWidgetBackground};\n\t\t\t\t\tborder: 3px solid ${_.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-corner {\n\t\t\t\t\tbackground-color: ${_.editorBackground};\n\t\t\t\t}\n\t\t\t}\n\t\t`,tall:`\t\t\t/* tall layout */\n\t\t\t@media (min-width: 711px) {\n\t\t\t\t#beepboxEditorContainer {\n\t\t\t\t\tmax-width: initial;\n\t\t\t\t\theight: 100vh;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100vh;\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr) 192px;\n\t\t\t\t\tgrid-template-rows: 1fr;\n\t\t\t\t\tgrid-template-areas: "track-area pattern-area settings-area";\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .pattern-area {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100%;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .track-area {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100%;\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\tflex-direction: column;\n\t\t\t\t\tjustify-content: center;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\tmin-height: 0;\n\t\t\t\t\tflex: 0;\n\t\t\t\t\toverflow: auto;\n\t\t\t\t\tflex-basis: initial;\n\t\t\t\t\tflex-grow: 0;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .instrument-settings-area > .editor-controls {\n\t\t\t\t\tposition: absolute;\n\t\t\t\t\twidth: 100%;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.beepboxEditor .settings-area {\n\t\t\t\t\twidth: 192px;\n\t\t\t\t\tposition: relative;\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr);\n\t\t\t\t\tgrid-template-rows: auto auto auto auto minmax(0, 1fr);\n\t\t\t\t\tgrid-template-areas:\n\t\t\t\t\t\t"version-area"\n\t\t\t\t\t\t"play-pause-area"\n\t\t\t\t\t\t"menu-area"\n\t\t\t\t\t\t"song-settings-area"\n\t\t\t\t\t\t"instrument-settings-area";\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .version-area {\n\t\t\t\t\tposition: sticky;\n\t\t\t\t\ttop: 0;\n\t\t\t\t\tz-index: 1;\n\t\t\t\t\tbackground: ${_.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .play-pause-area {\n\t\t\t\t\tposition: sticky;\n\t\t\t\t\ttop: 22px;\n\t\t\t\t\tz-index: 1;\n\t\t\t\t\tbackground: ${_.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .menu-area {\n\t\t\t\t\tposition: sticky;\n\t\t\t\t\ttop: 82px;\n\t\t\t\t\tz-index: 1;\n\t\t\t\t\tbackground: ${_.editorBackground};\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.beepboxEditor .barScrollBar {\n\t\t\t\t\tdisplay: none;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackContainer {\n\t\t\t\t\toverflow: visible;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\n\t\t\t\t\tscrollbar-width: auto;\n\t\t\t\t\tscrollbar-color: ${_.uiWidgetBackground} ${_.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar {\n\t\t\t\t\twidth: 20px;\n\t\t\t\t\theight: 20px;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-track {\n\t\t\t\t\tbackground: ${_.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-thumb {\n\t\t\t\t\tbackground-color: ${_.uiWidgetBackground};\n\t\t\t\t\tborder: 3px solid ${_.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-corner {\n\t\t\t\t\tbackground-color: ${_.editorBackground};\n\t\t\t\t}\n\t\t\t}\n\t\t`},j.o=document.head.appendChild(N.style({type:"text/css"}));const{div:G,button:W}=N;let H=parseInt(window.localStorage.getItem("money")||"0",10),K=parseInt(window.localStorage.getItem("gems")||"0",10);const Y=document.getElementById("shopButtons"),J=document.getElementById("shopPage"),Q=["choptop84","Just a Toad"],X=["Fauxx","Yuck31","Lenny","Keiiphobix","yOph","Grandnands"],Z=["Bluto","Hogbrainrot","Hailey","Nintari","Lognes","Smerg the Dragon","Chuck"],tt=["Answearing","Soshu","Main","TheSeasOfEnvy","Geli","Nobonoko","Okayxairen","BrodTsumi","Impasaurus","TheGubbys","Em (O^O)","Scoob"],et=["Jummbus","Neptendo","LeoV","Chippy"],st=["Shaktool"];var it=new Array,nt=localStorage.getItem("inventory"),ht=new Array,ot=localStorage.getItem("bought");null!=nt&&(it=JSON.parse(nt)),null!=ot&&(ht=JSON.parse(ot));let rt=G({style:"top:0; left:0; position:fixed; pointer-events: none; z-index: 15;"},"shitcoins: "+H),at=G({style:"top:32px; left:0; position:fixed; pointer-events: none; z-index: 15;"},"gems: "+K),lt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"songPlayerOption",onclick:()=>le("songPlayer",2500,lt)},"Song Player"),G({style:"font-size: 16px"},"2500 shitcoins"));ht.includes("songPlayer")&&(lt.style.display="none");let ct=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"shortenUrlOption",onclick:()=>le("shortenUrl",1e3,ct)},"Shorten Url"),G({style:"font-size: 16px"},"1000 shitcoins"));ht.includes("shortenUrl")&&(ct.style.display="none");let ut=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"importOption",onclick:()=>le("import",2500,ut)},"Import Prompt"),G({style:"font-size: 16px"},"2500 shitcoins"));ht.includes("import")&&(ut.style.display="none");let pt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"exportOption",onclick:()=>le("export",2500,pt)},"Export Prompt"),G({style:"font-size: 16px"},"2500 shitcoins"));ht.includes("export")&&(pt.style.display="none");let dt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"recoveryOption",onclick:()=>le("recovery",2500,dt)},"Recovery Prompt"),G({style:"font-size: 16px"},"2500 shitcoins"));ht.includes("recovery")&&(pt.style.display="none");let ft=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"copyUrlOption",onclick:()=>le("copyUrl",1500,ft)},"Copy Url"),G({style:"font-size: 16px"},"1500 shitcoins"));ht.includes("copyUrl")&&(ft.style.display="none");let mt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"beatsPerBarOption",onclick:()=>le("beatsPerBar",2500,mt)},"BPM Prompt"),G({style:"font-size: 16px"},"2500 shitcoins"));ht.includes("beatsPerBar")&&(mt.style.display="none");let yt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"showScrollBarOption",onclick:()=>le("showScrollBar",1500,yt)},"Octave ScrollBar"),G({style:"font-size: 16px"},"1500 shitcoins"));ht.includes("showScrollBar")&&(ct.style.display="none");let bt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"showLettersOption",onclick:()=>le("showLetters",1500,bt)},"Piano Keys"),G({style:"font-size: 16px"},"1500 shitcoins"));ht.includes("showLetters")&&(bt.style.display="none");let wt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"autoPlayOption",onclick:()=>le("autoPlay",500,wt)},"Auto Play"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("autoPlay")&&(wt.style.display="none");let gt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"autoFollowOption",onclick:()=>le("autoFollow",500,gt)},"Auto Follow"),G({style:"font-size: 16px"},"1000 shitcoins"));ht.includes("autoFollow")&&(gt.style.display="none");let vt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"enableNotePreviewOption",onclick:()=>le("enableNotePreview",2e3,vt)},"Preview Notes"),G({style:"font-size: 16px"},"2000 shitcoins"));ht.includes("enableNotePreview")&&(vt.style.display="none");let xt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"fifthNoteOption",onclick:()=>le("fifthNote",2500,xt)},"Fifth Note"),G({style:"font-size: 16px"},"2500 shitcoins"));ht.includes("fifthNote")&&(xt.style.display="none");let kt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"notesOutsideScaleOption",onclick:()=>le("notesOutsideScale",1e3,kt)},"Notes Outside Scale"),G({style:"font-size: 16px"},"1000 shitcoins"));ht.includes("notesOutsideScale")&&(kt.style.display="none");let Mt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"showChannelsOption",onclick:()=>le("showChannels",2500,Mt)},"Show Channels"),G({style:"font-size: 16px"},"2500 shitcoins"));ht.includes("showChannels")&&(Mt.style.display="none");let St=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"instrumentCopyPasteOption",onclick:()=>le("instrumentCopyPaste",1e3,St)},"Copy/Paste Buttons"),G({style:"font-size: 16px"},"1000 shitcoins"));ht.includes("showChannels")&&(Mt.style.display="none");let Pt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"enableChannelMutingOption",onclick:()=>le("enableChannelMuting",3e3,Pt)},"Channel Muting"),G({style:"font-size: 16px"},"3000 shitcoins"));ht.includes("enableChannelMuting")&&(Pt.style.display="none");let It=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"displayBrowserUrlOption",onclick:()=>le("displayBrowserUrl",3e3,It)},"Show URL"),G({style:"font-size: 16px"},"3000 shitcoins"));ht.includes("displayBrowserUrl")&&(Pt.style.display="none");let Ft=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"recordingSetupOption",onclick:()=>le("recordingSetup",1500,Ft)},"Midi setup"),G({style:"font-size: 16px"},"1500 shitcoins"));ht.includes("recordingSetup")&&(Ft.style.display="none");let Bt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"keyCSharpOption",onclick:()=>le("keyCSharp",500,Bt)},"C#"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("keyCSharp")&&(Bt.style.display="none");let Lt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"keyDOption",onclick:()=>le("keyD",500,Lt)},"D"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("keyD")&&(Lt.style.display="none");let Ct=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"keyDSharpOption",onclick:()=>le("keyDSharp",500,Ct)},"D#"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("keyDSharp")&&(Ct.style.display="none");let Dt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"keyEOption",onclick:()=>le("keyE",500,Dt)},"E"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("keyE")&&(Dt.style.display="none");let Tt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"keyFOption",onclick:()=>le("keyF",500,Tt)},"F"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("keyF")&&(Tt.style.display="none");let Et=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"keyFSharpOption",onclick:()=>le("keyFSharp",500,Et)},"F#"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("keyFSharp")&&(Et.style.display="none");let Nt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"keyGOption",onclick:()=>le("keyG",500,Nt)},"G"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("keyG")&&(Nt.style.display="none");let Ot=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"keyGSharpOption",onclick:()=>le("keyGSharp",500,Ot)},"G#"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("keyGSharp")&&(Ot.style.display="none");let zt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"keyAOption",onclick:()=>le("keyA",500,zt)},"A"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("keyA")&&(zt.style.display="none");let Rt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"keyASharpOption",onclick:()=>le("keyASharp",500,Rt)},"A#"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("keyASharp")&&(Rt.style.display="none");let At=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"keyBOption",onclick:()=>le("keyB",500,At)},"B"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("keyB")&&(At.style.display="none");let $t=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"easySadOption",onclick:()=>le("easySad",500,$t)},"Easy :("),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("easySad")&&($t.style.display="none");let Ut=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"islandHappyOption",onclick:()=>le("islandHappy",500,Ut)},"Island :)"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("islandHappy")&&(Ut.style.display="none");let qt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"islandSadOption",onclick:()=>le("islandSad",500,qt)},"Island :("),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("islandSad")&&(qt.style.display="none");let _t=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"bluesHappyOption",onclick:()=>le("bluesHappy",500,_t)},"Blues :)"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("bluesHappy")&&(_t.style.display="none");let Vt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"bluesSadOption",onclick:()=>le("bluesSad",500,Vt)},"Blues :("),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("bluesSad")&&(Vt.style.display="none");let jt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"normalHappyOption",onclick:()=>le("normalHappy",500,jt)},"Normal :)"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("normalHappy")&&(jt.style.display="none");let Gt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"normalSadOption",onclick:()=>le("normalSad",500,Gt)},"Normal :("),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("NormalSad")&&(Gt.style.display="none");let Wt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"dblHappyOption",onclick:()=>le("dblHappy",500,Wt)},"DblH :)"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("dblHappy")&&(Wt.style.display="none");let Ht=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"dblSadOption",onclick:()=>le("dblSad",500,Ht)},"DblH :("),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("dblSad")&&(Ht.style.display="none");let Kt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"strangeOption",onclick:()=>le("strange",500,Kt)},"Strange"),G({style:"font-size: 16px"},"500 shitcoins"));ht.includes("strange")&&(Kt.style.display="none");let Yt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"expertOption",onclick:()=>le("expert",5e3,Yt)},"Expert"),G({style:"font-size: 16px"},"5000 shitcoins"));ht.includes("expert")&&(Yt.style.display="none");let Jt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"shitbox2Option",onclick:()=>le("shitbox2",2e3,Jt)},"ShitBox 2.0"),G({style:"font-size: 16px"},"2000 shitcoins"));ht.includes("shitbox2")&&(Jt.style.display="none");let Qt=G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em; text-align: center;"},W({class:"shopButton",id:"realmOption",onclick:()=>le("realm",2e3,Qt)},"Realm"),G({style:"font-size: 16px"},"2000 shitcoins"));ht.includes("realm")&&(Qt.style.display="none");let Xt=W({class:"shopButton",id:"gachaButton",onclick:()=>ce("gacha")},"Gacha"),Zt=W({class:"shopButton",id:"buyButton",onclick:()=>ce("items")},"Buy"),te=W({class:"shopButton",id:"closeButton",onclick:()=>{document.getElementById("shop").style.display="none"}},"Close"),ee=G({id:"fileMenuStuff"},G({style:"font-size: 16px"},"File Menu Shit:"),G({style:"display: flex; max-width: 35vw; overflow-x: scroll;"},ut,pt,ft,lt,ct,dt)),se=G({id:"editMenuStuff"},G({style:"font-size: 16px"},"Edit Menu Shit:"),G({style:"display: flex; max-width: 35vw; overflow-x: scroll;"},mt)),ie=G({id:"prefMenuStuff"},G({style:"font-size: 16px"},"Preferences Menu Shit:"),G({style:"display: flex; max-width: 35vw; overflow-x: scroll;"},wt,gt,vt,bt,xt,kt,Mt,yt,St,Pt,It,Ft)),ne=G({id:"keys"},G({style:"font-size: 16px"},"Keys:"),G({style:"display: flex; max-width: 35vw; overflow-x: scroll;"},Bt,Lt,Ct,Dt,Tt,Et,Nt,Ot,zt,Rt,At)),he=G({id:"scales"},G({style:"font-size: 16px"},"Scales:"),G({style:"display: flex; max-width: 35vw; overflow-x: scroll;"},$t,Ut,qt,_t,Vt,jt,Gt,Wt,Ht,Kt,Yt)),oe=G({id:"themeMenuStuff"},G({style:"font-size: 16px"},"Themes:"),G({style:"display: flex; max-width: 35vw; overflow-x: scroll;"},Jt,Qt)),re=G({class:"itemsDiv",id:"itemsDiv",style:"display:none; position:absolute; left:10vw; bottom: 20vw; background: #531619; border: #ff7a87; border-style: solid;"},G({style:"margin: 0.5em;"},"Stupid Shit"),G({style:"display: flex; flex-direction: column;max-height: 270px; overflow-y: scroll;"},ee,se,ie,ne,he,oe),W({class:"shopButton",id:"closeButton",onclick:()=>ue("items")},"Close"));ht.includes("songPlayer")&&ht.includes("shortenUrl")&&ht.includes("import")&&ht.includes("export")&&ht.includes("recovery")&&ht.includes("copyUrl")&&(ee.style.display="none"),ht.includes("beatsPerBar")&&(se.style.display="none"),ht.includes("showScrollBar")&&ht.includes("showLetters")&&(ie.style.display="none"),ht.includes("keyCSharp")&&ht.includes("keyCSharp")&&ht.includes("keyD")&&ht.includes("keyDSharp")&&ht.includes("keyE")&&ht.includes("keyF")&&ht.includes("keyFSharp")&&ht.includes("keyG")&&ht.includes("keyGSharp")&&ht.includes("keyA")&&ht.includes("keyASharp")&&ht.includes("keyB")&&(ne.style.display="none"),ht.includes("easySad")&&ht.includes("islandHappy")&&ht.includes("islandSad")&&ht.includes("bluesHappy")&&ht.includes("bluesSad")&&ht.includes("normalHappy")&&ht.includes("normalSad")&&ht.includes("dblHappy")&&ht.includes("dblSad")&&ht.includes("strange")&&ht.includes("expert")&&(he.style.display="none");let ae=G({class:"gachaDiv",id:"gachaDiv",style:"display:none; position:absolute; left:7vw; bottom: 20vw; background: #531619; border: #ff7a87; border-style: solid;"},G({style:"margin-bottom: 0.5em; font-size: 64px;"},"Gacha"),G({style:""},"Roll for awesome rewards:"),G({style:"display: flex; "},G({style:"display:flex; flex-direction: column; align-items: center; margin: 0.5em;"},W({class:"shopButton",id:"gachaButton",onclick:()=>{var t;K>=50?(function(){let t=Math.floor(100*Math.random()),e="";const s=document.getElementById("gachaResult"),i=document.getElementById("gachaRarity");t>=0&&t<65&&(e=Q[Math.floor(Math.random()*Q.length)],null!=i&&(i.innerHTML=" (Common)")),t>=65&&t<85&&(e=X[Math.floor(Math.random()*X.length)],null!=i&&(i.innerHTML=" (Rare)")),t>=85&&t<95&&(e=Z[Math.floor(Math.random()*Z.length)],null!=i&&(i.innerHTML=" (Epic)")),t>=95&&t<98&&(e=tt[Math.floor(Math.random()*tt.length)],null!=i&&(i.innerHTML=" (SR)")),t>=98&&t<99&&(e=et[Math.floor(Math.random()*et.length)],null!=i&&(i.innerHTML=" (UR)")),t>=99&&(e=st[Math.floor(Math.random()*st.length)],null!=i&&(i.innerHTML=" (UR)")),it.push(e),null!=s&&(s.innerHTML="You just got: "+e),null!=it&&localStorage.setItem("inventory",JSON.stringify(it))}(),K-(t=50)>=0?(K-=t,localStorage.setItem("gems",String(K))):alert("You don't have enough gems bitch!"),at.innerHTML="gems: "+K):alert("damn you're broke")}},"Roll 1x"),G({style:"font-size: 16px"},"50 Gems"))),G({class:"result",id:"gachaResult",style:"display: flex;"},"You haven't rolled yet",G({class:"result",id:"gachaRarity"},"!")),W({class:"shopButton",id:"closeButton",onclick:()=>ue("gacha")},"close"));function le(t,e,s){const i=new Audio("sfx/buy.mp3"),n=new Audio("sfx/nuh_uh.mp3");var h;ht.includes(t)?(n.play(),H>=e?alert("You can't buy this! You already own it!"):alert("Even though you don't have enough, you still own this. Meaning you don't need to buy it again.")):H>=e?(H-(h=e)>=0?(H-=h,localStorage.setItem("money",String(H))):alert("You don't have enough shitcoins bitch!"),ht.push(t),null!=ht&&localStorage.setItem("bought",JSON.stringify(ht)),rt.innerHTML="shitcoins: "+H,s.style.display="none",i.play()):(n.play(),alert("You cannot buy that rn! Get more moneys!!!"))}function ce(t){if(null!=t&&null!=t){let e=document.getElementById(t+"Div");null!=e?(e.style.display="unset",null!=Y&&(Y.style.display="none")):console.log("how the fuck? Somehow the "+t+" div isn't real! Did you spell it right dumbass?"),null!=J?J.style.display="unset":console.log("how the fuck? Somehow the shop page isn't real!")}}function ue(t){if(null!=t&&null!=t){let e=document.getElementById(t+"Div");null!=e?(e.style.display="none",null!=Y&&(Y.style.display="")):console.log("how the fuck? Somehow the "+t+" div isn't real! Did you spell it right dumbass?"),null!=J?J.style.display="none":console.log("how the fuck? Somehow the shop page isn't real!")}}document.body.appendChild(rt),document.body.appendChild(at),null==Y||Y.appendChild(Xt),null==Y||Y.appendChild(Zt),null==Y||Y.appendChild(te),null==J||J.appendChild(re),null==J||J.appendChild(ae);const{button:pe,div:de,h2:fe,select:me,option:ye}=N;class be{constructor(t){this.u=t,this.m=me({style:"width: 100%;",id:"themeSelect"},ye({value:"shitbox4 classic"},"shitbox4"),ye({value:"shitbox2"},"ShitBox 2.0"),ye({value:"realm"},"Realm")),this.g=pe({class:"cancelButton"}),this.v=pe({class:"okayButton",style:"width:45%;"},"Okay"),this.container=de({class:"prompt noSelection",style:"width: 220px;"},fe("Set Theme"),de({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},de({class:"selectContainer",style:"width: 100%;"},this.m)),de({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.v),this.g),this.lastTheme=window.localStorage.getItem("colorTheme"),this.k=()=>{null!=this.lastTheme?_.setTheme(this.lastTheme):_.setTheme("shitbox4 classic"),this.u.undo()},this.M=()=>{if(ht.includes("shitbox2")){this.m.querySelector('[value="shitbox2"]').disabled=!1}else{this.m.querySelector('[value="shitbox2"]').disabled=!0}if(ht.includes("realm")){this.m.querySelector('[value="realm"]').disabled=!1}else{this.m.querySelector('[value="realm"]').disabled=!0}},this.cleanUp=()=>{this.v.removeEventListener("click",this.S),this.g.removeEventListener("click",this.k),this.container.removeEventListener("keydown",this.P)},this.P=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.S()},this.S=()=>{window.localStorage.setItem("colorTheme",this.m.value),this.u.prompt=null,this.u.prefs.shitbox4colorTheme=this.m.value,this.u.undo()},this.I=()=>{_.setTheme(this.m.value),this.u.notifier.changed()},null!=this.lastTheme&&(this.m.value=this.lastTheme),this.v.addEventListener("click",this.S),this.g.addEventListener("click",this.k),this.container.addEventListener("keydown",this.P),this.m.addEventListener("change",this.I),this.m.addEventListener("focus",this.M)}}function we(t,e){for(let s=0;s<t.length;s++)t[s]*=e}function ge(t){if(!function(t){return!(!t||t&t-1)}(t))throw new Error("FFT array length must be a power of 2.");return Math.round(Math.log(t)/Math.log(2))}function ve(t,e){const s=ge(e);if(e<4)throw new Error("FFT array length must be at least 4.");for(let i=s-1;i>=2;i--){const s=1<<i,n=s>>1,h=s<<1,o=2*Math.PI/h,r=Math.cos(o),a=Math.sin(o),l=2*r;for(let i=0;i<e;i+=h){const e=i,h=e+n,o=e+s,c=o+n,u=o+s,p=t[e],d=t[o];t[e]=p+d,t[h]*=2,t[o]=p-d,t[c]*=2;let f=r,m=-a,y=1,b=0;for(let s=1;s<n;s++){const i=e+s,n=o-s,h=o+s,r=u-s,a=t[i],c=t[n],p=t[h],d=t[r],w=a-c,g=p+d;t[i]=a+c,t[n]=d-p,t[h]=w*f-g*m,t[r]=g*f+w*m;const v=l*f-y,x=l*m-b;y=f,b=m,f=v,m=x}}}for(let s=0;s<e;s+=4){const e=s+1,i=s+2,n=s+3,h=t[s],o=2*t[e],r=t[i],a=2*t[n],l=h+r,c=h-r;t[s]=l+o,t[e]=l-o,t[i]=c+a,t[n]=c-a}!function(t,e){const s=ge(e);if(s>16)throw new Error("FFT array length must not be greater than 2^16.");const i=16-s;for(let s=0;s<e;s++){let e;if(e=(43690&s)>>1|(21845&s)<<1,e=(52428&e)>>2|(13107&e)<<2,e=(61680&e)>>4|(3855&e)<<4,e=(e>>8|(255&e)<<8)>>i,e>s){let i=t[s];t[s]=t[e],t[e]=i}}}(t,e)}class xe{constructor(){this.L=1,this.T=[void 0],this.N=0,this.O=0,this.R=0}pushFront(t){this.R>=this.L&&this.$(),this.O=this.O-1&this.N,this.T[this.O]=t,this.R++}pushBack(t){this.R>=this.L&&this.$(),this.T[this.O+this.R&this.N]=t,this.R++}popFront(){if(this.R<=0)throw new Error("No elements left to pop.");const t=this.T[this.O];return this.T[this.O]=void 0,this.O=this.O+1&this.N,this.R--,t}popBack(){if(this.R<=0)throw new Error("No elements left to pop.");this.R--;const t=this.O+this.R&this.N,e=this.T[t];return this.T[t]=void 0,e}peakFront(){if(this.R<=0)throw new Error("No elements left to pop.");return this.T[this.O]}peakBack(){if(this.R<=0)throw new Error("No elements left to pop.");return this.T[this.O+this.R-1&this.N]}count(){return this.R}set(t,e){if(t<0||t>=this.R)throw new Error("Invalid index");this.T[this.O+t&this.N]=e}get(t){if(t<0||t>=this.R)throw new Error("Invalid index");return this.T[this.O+t&this.N]}remove(t){if(t<0||t>=this.R)throw new Error("Invalid index");if(t<=this.R>>1){for(;t>0;)this.set(t,this.get(t-1)),t--;this.popFront()}else{for(t++;t<this.R;)this.set(t-1,this.get(t)),t++;this.popBack()}}$(){if(this.L>=1073741824)throw new Error("Capacity too big.");this.L=this.L<<1;const t=this.T,e=new Array(this.L),s=0|this.R,i=0|this.O;for(let n=0;n<s;n++)e[n]=t[i+n&this.N];for(let t=s;t<this.L;t++)e[t]=void 0;this.O=0,this.T=e,this.N=this.L-1}}class ke{constructor(){this.a=[1],this.b=[1],this.order=0}linearGain0thOrder(t){this.b[0]=t,this.order=0}lowPass1stOrderButterworth(t){const e=1/Math.tan(.5*t),s=1+e;this.a[1]=(1-e)/s,this.b[1]=this.b[0]=1/s,this.order=1}lowPass1stOrderSimplified(t){const e=2*Math.sin(.5*t);this.a[1]=e-1,this.b[0]=e,this.b[1]=0,this.order=1}highPass1stOrderButterworth(t){const e=1/Math.tan(.5*t),s=1+e;this.a[1]=(1-e)/s,this.b[0]=e/s,this.b[1]=-e/s,this.order=1}highShelf1stOrder(t,e){const s=Math.tan(.5*t),i=Math.sqrt(e),n=(s*i-1)/(s*i+1);this.a[1]=n/1,this.b[0]=(1+n+e*(1-n))/2,this.b[1]=(1+n-e*(1-n))/2,this.order=1}allPass1stOrderInvertPhaseAbove(t){const e=(Math.sin(t)-1)/Math.cos(t);this.a[1]=e,this.b[0]=e,this.b[1]=1,this.order=1}allPass1stOrderFractionalDelay(t){const e=(1-t)/(1+t);this.a[1]=e,this.b[0]=e,this.b[1]=1,this.order=1}lowPass2ndOrderButterworth(t,e){const s=Math.sin(t)/(2*e),i=Math.cos(t),n=1+s;this.a[1]=-2*i/n,this.a[2]=(1-s)/n,this.b[2]=this.b[0]=(1-i)/(2*n),this.b[1]=(1-i)/n,this.order=2}lowPass2ndOrderSimplified(t,e){const s=2*Math.sin(t/2),i=1-1/(2*e),n=i+i/(1-s);this.a[1]=2*s+(s-1)*s*n-2,this.a[2]=(s-1)*(s-s*n-1),this.b[0]=s*s,this.b[1]=0,this.b[2]=0,this.order=2}highPass2ndOrderButterworth(t,e){const s=Math.sin(t)/(2*e),i=Math.cos(t),n=1+s;this.a[1]=-2*i/n,this.a[2]=(1-s)/n,this.b[2]=this.b[0]=(1+i)/(2*n),this.b[1]=-(1+i)/n,this.order=2}highShelf2ndOrder(t,e,s){const i=Math.sqrt(e),n=Math.cos(t),h=i+1,o=i-1,r=.5*Math.sin(t)*Math.sqrt(h/i*(1/s-1)+2),a=2*Math.sqrt(i)*r,l=h-o*n+a;this.a[1]=2*(o-h*n)/l,this.a[2]=(h-o*n-a)/l,this.b[0]=i*(h+o*n+a)/l,this.b[1]=-2*i*(o+h*n)/l,this.b[2]=i*(h+o*n-a)/l,this.order=2}peak2ndOrder(t,e,s){const i=Math.sqrt(e),n=s*t/(i>=1?i:1/i),h=Math.tan(.5*n),o=1+h/i;this.b[0]=(1+h*i)/o,this.b[1]=this.a[1]=-2*Math.cos(t)/o,this.b[2]=(1-h*i)/o,this.a[2]=(1-h/i)/o,this.order=2}}class Me{constructor(){this.real=0,this.imag=0,this.denom=1}analyze(t,e){this.analyzeComplex(t,Math.cos(e),Math.sin(e))}analyzeComplex(t,e,s){const i=t.a,n=t.b,h=e,o=-s;let r=n[0]+n[1]*h,a=n[1]*o,l=1+i[1]*h,c=i[1]*o,u=h,p=o;for(let e=2;e<=t.order;e++){const t=u*o+p*h;u=u*h-p*o,p=t,r+=n[e]*u,a+=n[e]*p,l+=i[e]*u,c+=i[e]*p}this.denom=l*l+c*c,this.real=r*l+a*c,this.imag=a*l-r*c}magnitude(){return Math.sqrt(this.real*this.real+this.imag*this.imag)/this.denom}angle(){return Math.atan2(this.imag,this.real)}}class Se{constructor(){this.a1=0,this.a2=0,this.b0=1,this.b1=0,this.b2=0,this.a1Delta=0,this.a2Delta=0,this.b0Delta=0,this.b1Delta=0,this.b2Delta=0,this.output1=0,this.output2=0,this.useMultiplicativeInputCoefficients=!1}resetOutput(){this.output1=0,this.output2=0}loadCoefficientsWithGradient(t,e,s,i){if(2!=t.order||2!=e.order)throw new Error;this.a1=t.a[1],this.a2=t.a[2],this.b0=t.b[0],this.b1=t.b[1],this.b2=t.b[2],this.a1Delta=(e.a[1]-t.a[1])*s,this.a2Delta=(e.a[2]-t.a[2])*s,i?(this.b0Delta=Math.pow(e.b[0]/t.b[0],s),this.b1Delta=Math.pow(e.b[1]/t.b[1],s),this.b2Delta=Math.pow(e.b[2]/t.b[2],s)):(this.b0Delta=(e.b[0]-t.b[0])*s,this.b1Delta=(e.b[1]-t.b[1])*s,this.b2Delta=(e.b[2]-t.b[2])*s),this.useMultiplicativeInputCoefficients=i}}function Pe(t){return 2*Math.atan(.5*t)}const Ie=1e-24;function Fe(t,e,s){return s<=(e-=1)?s>=t?s:t:e}function Be(t,e,s){if(t<=s&&s<=e)return s;throw new Error(`Value ${s} not in range [${t}, ${e}]`)}const Le=[48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,45,95],Ce=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,62,0,0,1,2,3,4,5,6,7,8,9,0,0,0,0,0,0,0,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,0,0,0,0,63,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,0,0,0,0,0];class De{constructor(t,e,s){this.U=[],this.q=0;for(let i=e;i<s;i++){const e=Ce[t.charCodeAt(i)];this.U.push(e>>5&1),this.U.push(e>>4&1),this.U.push(e>>3&1),this.U.push(e>>2&1),this.U.push(e>>1&1),this.U.push(1&e)}}read(t){let e=0;for(;t>0;)e<<=1,e+=this.U[this.q++],t--;return e}readLongTail(t,e){let s=t,i=e;for(;this.U[this.q++];)s+=1<<i,i++;for(;i>0;)i--,this.U[this.q++]&&(s+=1<<i);return s}readPartDuration(){return this.readLongTail(1,3)}readLegacyPartDuration(){return this.readLongTail(1,2)}readPinCount(){return this.readLongTail(1,0)}readPitchInterval(){return this.read(1)?-this.readLongTail(1,3):this.readLongTail(1,3)}}class Te{constructor(){this._=0,this.U=[]}clear(){this._=0}write(t,e){for(t--;t>=0;)this.U[this._++]=e>>>t&1,t--}writeLongTail(t,e,s){if(s<t)throw new Error("value out of bounds");s-=t;let i=e;for(;s>=1<<i;)this.U[this._++]=1,s-=1<<i,i++;for(this.U[this._++]=0;i>0;)i--,this.U[this._++]=s>>>i&1}writePartDuration(t){this.writeLongTail(1,3,t)}writePinCount(t){this.writeLongTail(1,0,t)}writePitchInterval(t){t<0?(this.write(1,1),this.writeLongTail(1,3,-t)):(this.write(1,0),this.writeLongTail(1,3,t))}concat(t){for(let e=0;e<t._;e++)this.U[this._++]=t.U[e]}encodeBase64(t){for(let e=0;e<this._;e+=6){const s=this.U[e]<<5|this.U[e+1]<<4|this.U[e+2]<<3|this.U[e+3]<<2|this.U[e+4]<<1|this.U[e+5];t.push(Le[s])}return t}lengthBase64(){return Math.ceil(this._/6)}}function Ee(t,e,s){return{interval:t,time:e,size:s}}class Ne{constructor(t,e,s,i,n=!1){this.pitches=[t],this.pins=[Ee(0,0,i),Ee(0,s-e,n?0:i)],this.start=e,this.end=s,this.continuesLastPattern=!1}pickMainInterval(){let t=0,e=0;for(let s=1;s<this.pins.length;s++){const i=this.pins[s-1],n=this.pins[s];if(i.interval==n.interval){const s=n.time-i.time;t<s&&(t=s,e=i.interval)}}if(0==t){let t=0;for(let s=0;s<this.pins.length;s++){const i=this.pins[s];t<i.size&&(t=i.size,e=i.interval)}}return e}clone(){const t=new Ne(-1,this.start,this.end,e.noteSizeMax);t.pitches=this.pitches.concat(),t.pins=[];for(const e of this.pins)t.pins.push(Ee(e.interval,e.time,e.size));return t.continuesLastPattern=this.continuesLastPattern,t}getEndPinIndex(t){let e;for(e=1;e<this.pins.length-1&&!(this.pins[e].time+this.start>t);e++);return e}}class Oe{constructor(){this.notes=[],this.instruments=[0]}cloneNotes(){const t=[];for(const e of this.notes)t.push(e.clone());return t}reset(){this.notes.length=0,this.instruments[0]=0,this.instruments.length=1}toJsonObject(t){const s=[];for(const i of this.notes){const n=[];for(const s of i.pins)n.push({tick:(s.time+i.start)*e.rhythms[t.rhythm].stepsPerBeat/e.partsPerBeat,pitchBend:s.interval,volume:Math.round(100*s.size/3)});const h={pitches:i.pitches,points:n};0==i.start&&(h.continuesLastPattern=i.continuesLastPattern),s.push(h)}const i={notes:s};return t.patternInstruments&&(i.instruments=this.instruments.map((t=>t+1))),i}fromJsonObject(t,s,i,n,h){if(s.patternInstruments)if(Array.isArray(t.instruments)){const n=t.instruments,h=Fe(e.instrumentCountMin,s.getMaxInstrumentsPerPatternForChannel(i)+1,n.length);for(let t=0;t<h;t++)this.instruments[t]=Fe(0,i.instruments.length,(0|n[t])-1);this.instruments.length=h}else this.instruments[0]=Fe(0,i.instruments.length,(0|t.instrument)-1),this.instruments.length=1;if(t.notes&&t.notes.length>0){const i=Math.min(s.beatsPerBar*e.partsPerBeat,t.notes.length>>>0);let o=0;for(let r=0;r<t.notes.length&&!(r>=i);r++){const i=t.notes[r];if(!(i&&i.pitches&&i.pitches.length>=1&&i.points&&i.points.length>=2))continue;const a=new Ne(0,0,0,0);a.pitches=[],a.pins=[];for(let t=0;t<i.pitches.length;t++){const s=0|i.pitches[t];if(-1==a.pitches.indexOf(s)&&(a.pitches.push(s),a.pitches.length>=e.maxChordSize))break}if(a.pitches.length<1)continue;let l=o,c=0;for(let t=0;t<i.points.length;t++){const h=i.points[t];if(null==h||null==h.tick)continue;const o=null==h.pitchBend?0:0|h.pitchBend,r=Math.round(+h.tick*e.partsPerBeat/n),u=null==h.volume?3:Math.max(0,Math.min(3,Math.round(3*(0|h.volume)/100)));if(!(r>s.beatsPerBar*e.partsPerBeat)){if(0==a.pins.length){if(r<l)continue;a.start=r,c=o}else if(r<=l)continue;l=r,a.pins.push(Ee(o-c,r-a.start,u))}}if(a.pins.length<2)continue;a.end=a.pins[a.pins.length-1].time+a.start;const u=h?e.drumCount-1:e.maxPitch;let p=u,d=0;for(let t=0;t<a.pitches.length;t++)a.pitches[t]+=c,(a.pitches[t]<0||a.pitches[t]>u)&&(a.pitches.splice(t,1),t--),a.pitches[t]<p&&(p=a.pitches[t]),a.pitches[t]>d&&(d=a.pitches[t]);if(!(a.pitches.length<1)){for(let t=0;t<a.pins.length;t++){const e=a.pins[t];e.interval+p<0&&(e.interval=-p),e.interval+d>u&&(e.interval=u-d),t>=2&&e.interval==a.pins[t-1].interval&&e.interval==a.pins[t-2].interval&&e.size==a.pins[t-1].size&&e.size==a.pins[t-2].size&&(a.pins.splice(t-1,1),t--)}0==a.start?a.continuesLastPattern=!0===i.continuesLastPattern:a.continuesLastPattern=!1,this.notes.push(a),o=a.end}}}}}class ze{constructor(t){this.frequency=0,this.amplitude=0,this.reset(t)}reset(t){this.frequency=0,this.amplitude=t<=1?e.operatorAmplitudeMax:0}}class Re{constructor(t){this.spectrum=[],this.hash=-1,this.reset(t)}reset(t){for(let s=0;s<e.spectrumControlPoints;s++)if(t)this.spectrum[s]=Math.round(e.spectrumMax*(1/Math.sqrt(1+s/3)));else{const t=0==s||7==s||11==s||14==s||16==s||18==s||21==s||23==s||s>=25;this.spectrum[s]=t?Math.max(0,Math.round(e.spectrumMax*(1-s/30))):0}this.markCustomWaveDirty()}markCustomWaveDirty(){const t=Xe.fittingPowerOfTwo(e.spectrumMax+2)-1;let s=0;for(const e of this.spectrum)s=s*t+e>>>0;this.hash=s}}class Ae{constructor(){this.wave=null,this.V=-1}getCustomWave(t,s){if(this.V==t.hash)return this.wave;this.V=t.hash;const i=e.spectrumNoiseLength;null!=this.wave&&this.wave.length==i+1||(this.wave=new Float32Array(i+1));const n=this.wave;for(let t=0;t<i;t++)n[t]=0;const h=[0,1/7,Math.log2(5/4),3/7,Math.log2(1.5),5/7,6/7];function r(t){return s+Math.floor(t/e.spectrumControlPointsPerOctave)+h[(t+e.spectrumControlPointsPerOctave)%e.spectrumControlPointsPerOctave]}let a=1;for(let s=0;s<e.spectrumControlPoints+1;s++){const h=s<=0?0:t.spectrum[s-1],l=s>=e.spectrumControlPoints?t.spectrum[e.spectrumControlPoints-1]:t.spectrum[s],c=r(s-1);let u=r(s);s>=e.spectrumControlPoints&&(u=14+.25*(u-14)),0==h&&0==l||(a+=.02*o(n,i,c,u,h/e.spectrumMax,l/e.spectrumMax,-.5))}return t.spectrum[e.spectrumControlPoints-1]>0&&(a+=.02*o(n,i,14+.25*(r(e.spectrumControlPoints)-14),14,t.spectrum[e.spectrumControlPoints-1]/e.spectrumMax,0,-.5)),ve(n,i),we(n,5/(Math.sqrt(i)*Math.pow(a,.75))),n[i]=n[0],n}}class $e{constructor(){this.harmonics=[],this.hash=-1,this.reset()}reset(){for(let t=0;t<e.harmonicsControlPoints;t++)this.harmonics[t]=0;this.harmonics[0]=e.harmonicsMax,this.harmonics[3]=e.harmonicsMax,this.harmonics[6]=e.harmonicsMax,this.markCustomWaveDirty()}markCustomWaveDirty(){const t=Xe.fittingPowerOfTwo(e.harmonicsMax+2)-1;let s=0;for(const e of this.harmonics)s=s*t+e>>>0;this.hash=s}}class Ue{constructor(){this.wave=null,this.V=-1}getCustomWave(t,s){if(this.V==t.hash&&this.j==s)return this.wave;this.V=t.hash,this.j=s;const n=7==s?e.harmonicsRenderedForPickedString:e.harmonicsRendered,o=e.harmonicsWavelength,r=h(0,null,null);null!=this.wave&&this.wave.length==o+1||(this.wave=new Float32Array(o+1));const a=this.wave;for(let t=0;t<o;t++)a[t]=0;let l=1;for(let s=0;s<n;s++){const i=s+1;let h=s<e.harmonicsControlPoints?t.harmonics[s]:t.harmonics[e.harmonicsControlPoints-1];s>=e.harmonicsControlPoints&&(h*=1-(s-e.harmonicsControlPoints)/(n-e.harmonicsControlPoints));const c=h/e.harmonicsMax;let u=Math.pow(2,h-e.harmonicsMax+1)*Math.sqrt(c);s<e.harmonicsControlPoints&&(l+=u),u*=Math.pow(i,-.25),u*=r[s+589],a[o-i]=u}ve(a,o);const c=1/Math.pow(l,.7);for(let t=0;t<a.length;t++)a[t]*=c;return i(a),a[o]=a[0],a}}class qe{constructor(){this.freq=0,this.gain=e.filterGainCenter,this.type=2}set(t,e){this.freq=t,this.gain=e}getHz(){return qe.getHzFromSettingValue(this.freq)}static getHzFromSettingValue(t){return e.filterFreqReferenceHz*Math.pow(2,(t-e.filterFreqReferenceSetting)*e.filterFreqStep)}static getSettingValueFromHz(t){return Math.log2(t/e.filterFreqReferenceHz)/e.filterFreqStep+e.filterFreqReferenceSetting}static getRoundedSettingValueFromHz(t){return Math.max(0,Math.min(e.filterFreqRange-1,Math.round(qe.getSettingValueFromHz(t))))}getLinearGain(t=1){const s=(this.gain-e.filterGainCenter)*e.filterGainStep,i=2==this.type?0:-.5,n=i+(s-i)*t;return Math.pow(2,n)}static getRoundedSettingValueFromLinearGain(t){return Math.max(0,Math.min(e.filterGainRange-1,Math.round(Math.log2(t)/e.filterGainStep+e.filterGainCenter)))}toCoefficients(t,s,i=1,n=1){const h=2*Math.PI*Math.max(e.filterFreqMinHz,Math.min(e.filterFreqMaxHz,i*this.getHz()))/s,o=this.getLinearGain(n);switch(this.type){case 0:t.lowPass2ndOrderButterworth(h,o);break;case 1:t.highPass2ndOrderButterworth(h,o);break;case 2:t.peak2ndOrder(h,o,1);break;default:throw new Error}}getVolumeCompensationMult(){const t=(this.freq-e.filterFreqReferenceSetting)*e.filterFreqStep,s=(this.gain-e.filterGainCenter)*e.filterGainStep;switch(this.type){case 0:const i=Math.pow(2,t)*e.filterFreqReferenceHz/8e3,n=(Math.sqrt(1+4*i)-1)/2,h=Math.log2(n);return Math.pow(.5,.2*Math.max(0,s+1)+Math.min(0,Math.max(-3,.595*h+.35*Math.min(0,s+1))));case 1:return Math.pow(.5,.125*Math.max(0,s+1)+Math.min(0,.3*(-t-Math.log2(e.filterFreqReferenceHz/125))+.2*Math.min(0,s+1)));case 2:const o=t+Math.log2(e.filterFreqReferenceHz/2e3),r=Math.pow(1/(1+Math.pow(o/3,2)),2);return Math.pow(.5,.125*Math.max(0,s)+.1*r*Math.min(0,s));default:throw new Error}}}class _e{constructor(){this.controlPoints=[],this.controlPointCount=0,this.reset()}reset(){this.controlPointCount=0}addPoint(t,e,s){let i;this.controlPoints.length<=this.controlPointCount?(i=new qe,this.controlPoints[this.controlPointCount]=i):i=this.controlPoints[this.controlPointCount],this.controlPointCount++,i.type=t,i.set(e,s)}toJsonObject(){const t=[];for(let s=0;s<this.controlPointCount;s++){const i=this.controlPoints[s];t.push({type:e.filterTypeNames[i.type],cutoffHz:Math.round(100*i.getHz())/100,linearGain:Math.round(1e4*i.getLinearGain())/1e4})}return t}fromJsonObject(t){if(this.controlPoints.length=0,t)for(const s of t){const t=new qe;t.type=e.filterTypeNames.indexOf(s.type),-1==t.type&&(t.type=2),null!=s.cutoffHz?t.freq=qe.getRoundedSettingValueFromHz(s.cutoffHz):t.freq=0,null!=s.linearGain?t.gain=qe.getRoundedSettingValueFromLinearGain(s.linearGain):t.gain=e.filterGainCenter,this.controlPoints.push(t)}this.controlPointCount=this.controlPoints.length}convertLegacySettings(t,e,s){this.reset();const i=2*Math.asin(.475),n=e>1,h=0==e,o=10==t,r=3==s.type||4==s.type||8==s.type||0==s.type,a=48e3,l=8e3*Math.pow(2,.5*(t-10)),c=Math.min(i,2*Math.PI*l/a);if(1==s.type&&!n&&o);else if(h){const t=3.5,e=c*Math.pow(2,t),s=a*(e/(1+e/Math.PI))/(2*Math.PI),i=qe.getRoundedSettingValueFromHz(s),n=qe.getHzFromSettingValue(i),h=2*Math.PI*n/a,o=new ke;o.lowPass1stOrderSimplified(c);const l=new Me;l.analyze(o,h);const u=l.magnitude();let p=Math.log2(u);p=.82*(p+t)-t,r&&(p=Math.min(p,-1));const d=Math.pow(2,p),f=qe.getRoundedSettingValueFromLinearGain(d);this.addPoint(0,i,f)}else{const t=.5/(1-.95*Math.sqrt(Math.max(0,e-1)/6)),s=.5/t,i=c+(c*(c/(2*Math.PI*8e3/a)*Math.pow(s,.9)+1)-c)*s;let h;h=r?a*Math.min(i,c*Math.pow(2,.25))/(2*Math.PI):a*i/(2*Math.PI);const o=qe.getRoundedSettingValueFromHz(h);let l;if(r)l=t;else{const e=new ke;e.lowPass2ndOrderSimplified(c,t);const s=new Me;s.analyze(e,i),l=s.magnitude()}n||(l=Math.min(l,Math.sqrt(.5)));const u=qe.getRoundedSettingValueFromLinearGain(l);this.addPoint(0,o,u)}}}class Ve{constructor(){this.target=0,this.index=0,this.envelope=0,this.reset()}reset(){this.target=0,this.index=0,this.envelope=0}toJsonObject(){const t={target:e.instrumentAutomationTargets[this.target].name,envelope:e.envelopes[this.envelope].name};return e.instrumentAutomationTargets[this.target].maxCount>1&&(t.index=this.index),t}fromJsonObject(t){this.reset();let s=e.instrumentAutomationTargets.dictionary[t.target];null==s&&(s=e.instrumentAutomationTargets.dictionary.noteVolume),this.target=s.index;let i=e.envelopes.dictionary[t.envelope];null==i&&(i=e.envelopes.dictionary.none),this.envelope=i.index,null!=t.index?this.index=Fe(0,e.instrumentAutomationTargets[this.target].maxCount,0|t.index):this.index=0}}class je{constructor(t){this.type=0,this.preset=0,this.chipWave=2,this.chipNoise=1,this.eqFilter=new _e,this.noteFilter=new _e,this.envelopes=[],this.envelopeCount=0,this.fadeIn=0,this.fadeOut=e.fadeOutNeutral,this.transition=e.transitions.dictionary.normal.index,this.pitchShift=0,this.detune=0,this.vibrato=0,this.unison=0,this.effects=0,this.chord=1,this.volume=0,this.pan=e.panCenter,this.pulseWidth=e.pulseWidthRange-1,this.supersawDynamism=e.supersawDynamismMax,this.supersawSpread=Math.ceil(e.supersawSpreadMax/2),this.supersawShape=0,this.stringSustain=10,this.stringSustainType=1,this.distortion=0,this.bitcrusherFreq=0,this.bitcrusherQuantization=0,this.chorus=0,this.reverb=0,this.echoSustain=0,this.echoDelay=0,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.operators=[],this.harmonicsWave=new $e,this.drumsetEnvelopes=[],this.drumsetSpectrumWaves=[],this.spectrumWave=new Re(t);for(let t=0;t<e.operatorCount;t++)this.operators[t]=new ze(t);for(let t=0;t<e.drumCount;t++)this.drumsetEnvelopes[t]=e.envelopes.dictionary["twang 2"].index,this.drumsetSpectrumWaves[t]=new Re(!0)}setTypeAndReset(t,s){switch(this.type=t,this.preset=t,this.volume=0,this.effects=0,this.chorus=e.chorusRange-1,this.reverb=2,this.echoSustain=Math.floor(.5*(e.echoSustainRange-1)),this.echoDelay=Math.floor(.5*(e.echoDelayRange-1)),this.eqFilter.reset(),this.noteFilter.reset(),this.distortion=Math.floor(.75*(e.distortionRange-1)),this.bitcrusherFreq=Math.floor(.5*(e.bitcrusherFreqRange-1)),this.bitcrusherQuantization=Math.floor(.5*(e.bitcrusherQuantizationRange-1)),this.pan=e.panCenter,this.pitchShift=e.pitchShiftCenter,this.detune=e.detuneCenter,this.vibrato=0,this.unison=0,this.stringSustain=10,this.stringSustainType=e.enableAcousticSustain?1:0,this.fadeIn=0,this.fadeOut=e.fadeOutNeutral,this.transition=e.transitions.dictionary.normal.index,this.envelopeCount=0,t){case 0:this.chipWave=2,this.chord=e.chords.dictionary.arpeggio.index;break;case 1:this.chord=e.chords.dictionary["custom interval"].index,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0;for(let t=0;t<this.operators.length;t++)this.operators[t].reset(t);break;case 2:this.chipNoise=1,this.chord=e.chords.dictionary.arpeggio.index;break;case 3:this.chord=e.chords.dictionary.simultaneous.index,this.spectrumWave.reset(s);break;case 4:this.chord=e.chords.dictionary.simultaneous.index;for(let t=0;t<e.drumCount;t++)this.drumsetEnvelopes[t]=e.envelopes.dictionary["twang 2"].index,this.drumsetSpectrumWaves[t].reset(s);break;case 5:this.chord=e.chords.dictionary.simultaneous.index,this.harmonicsWave.reset();break;case 6:this.chord=e.chords.dictionary.arpeggio.index,this.pulseWidth=e.pulseWidthRange-1;break;case 7:this.chord=e.chords.dictionary.strum.index,this.harmonicsWave.reset();break;case 8:this.chord=e.chords.dictionary.arpeggio.index,this.supersawDynamism=e.supersawDynamismMax,this.supersawSpread=Math.ceil(e.supersawSpreadMax/2),this.supersawShape=0,this.pulseWidth=e.pulseWidthRange-1;break;default:throw new Error("Unrecognized instrument type: "+t)}this.chord!=e.chords.dictionary.simultaneous.index&&(this.effects=2048|this.effects)}convertLegacySettings(t){let s=t.filterCutoff,i=t.filterResonance,n=t.filterEnvelope,h=t.pulseEnvelope,o=t.operatorEnvelopes,r=t.feedbackEnvelope;null==s&&(s=0==this.type?6:10),null==i&&(i=0),null==n&&(n=e.envelopes.dictionary.none),null==h&&(h=e.envelopes.dictionary[6==this.type?"twang 2":"none"]),null==o&&(o=[e.envelopes.dictionary[1==this.type?"note size":"none"],e.envelopes.dictionary.none,e.envelopes.dictionary.none,e.envelopes.dictionary.none]),null==r&&(r=e.envelopes.dictionary.none);10==s&&2==n.type&&(n=e.envelopes.dictionary.none);const a=e.algorithms[this.algorithm].carrierCount;let l=!0,c=!0,u=0==n.type||0==h.type;if(1==this.type){u=u||0==r.type;for(let t=0;t<o.length;t++)t<a?0!=o[t].type?c=!1:l=!1:u=u||0==o[t].type}this.envelopeCount=0,1==this.type&&(c&&u?this.addEnvelope(e.instrumentAutomationTargets.dictionary.noteVolume.index,0,e.envelopes.dictionary["note size"].index):l&&!u&&this.addEnvelope(e.instrumentAutomationTargets.dictionary.none.index,0,e.envelopes.dictionary["note size"].index)),1==n.type?(this.noteFilter.reset(),this.eqFilter.convertLegacySettings(s,i,n),this.effects&=-33):(this.eqFilter.reset(),this.noteFilter.convertLegacySettings(s,i,n),this.effects|=32,this.addEnvelope(e.instrumentAutomationTargets.dictionary.noteFilterAllFreqs.index,0,n.index)),1!=h.type&&this.addEnvelope(e.instrumentAutomationTargets.dictionary.pulseWidth.index,0,h.index);for(let t=0;t<o.length;t++)t<a&&c||1!=o[t].type&&this.addEnvelope(e.instrumentAutomationTargets.dictionary.operatorAmplitude.index,t,o[t].index);1!=r.type&&this.addEnvelope(e.instrumentAutomationTargets.dictionary.feedbackAmplitude.index,0,r.index)}toJsonObject(){const t={type:e.instrumentTypeNames[this.type],volume:20*(5-this.volume),eqFilter:this.eqFilter.toJsonObject()};this.preset!=this.type&&(t.preset=this.preset);const s=[];for(const t of e.effectOrder)this.effects&1<<t&&s.push(e.effectNames[t]);if(t.effects=s,l(this.effects)&&(t.transition=e.transitions[this.transition].name),c(this.effects)&&(t.chord=this.getChord().name),u(this.effects)&&(t.pitchShiftSemitones=this.pitchShift),p(this.effects)&&(t.detuneCents=Xe.detuneToCents(this.detune-e.detuneCenter)),d(this.effects)&&(t.vibrato=e.vibratos[this.vibrato].name),f(this.effects)&&(t.noteFilter=this.noteFilter.toJsonObject()),m(this.effects)&&(t.distortion=Math.round(100*this.distortion/(e.distortionRange-1))),y(this.effects)&&(t.bitcrusherOctave=(e.bitcrusherFreqRange-1-this.bitcrusherFreq)*e.bitcrusherOctaveStep,t.bitcrusherQuantization=Math.round(100*this.bitcrusherQuantization/(e.bitcrusherQuantizationRange-1))),b(this.effects)&&(t.pan=Math.round(100*(this.pan-e.panCenter)/e.panCenter)),w(this.effects)&&(t.chorus=Math.round(100*this.chorus/(e.chorusRange-1))),g(this.effects)&&(t.echoSustain=Math.round(100*this.echoSustain/(e.echoSustainRange-1)),t.echoDelayBeats=Math.round(1e3*(this.echoDelay+1)*e.echoDelayStepTicks/(e.ticksPerPart*e.partsPerBeat))/1e3),v(this.effects)&&(t.reverb=Math.round(100*this.reverb/(e.reverbRange-1))),4!=this.type&&(t.fadeInSeconds=Math.round(1e4*Xe.fadeInSettingToSeconds(this.fadeIn))/1e4,t.fadeOutTicks=Xe.fadeOutSettingToTicks(this.fadeOut)),5==this.type||7==this.type){t.harmonics=[];for(let s=0;s<e.harmonicsControlPoints;s++)t.harmonics[s]=Math.round(100*this.harmonicsWave.harmonics[s]/e.harmonicsMax)}if(2==this.type)t.wave=e.chipNoises[this.chipNoise].name;else if(3==this.type){t.spectrum=[];for(let s=0;s<e.spectrumControlPoints;s++)t.spectrum[s]=Math.round(100*this.spectrumWave.spectrum[s]/e.spectrumMax)}else if(4==this.type){t.drums=[];for(let s=0;s<e.drumCount;s++){const i=[];for(let t=0;t<e.spectrumControlPoints;t++)i[t]=Math.round(100*this.drumsetSpectrumWaves[s].spectrum[t]/e.spectrumMax);t.drums[s]={filterEnvelope:this.getDrumsetEnvelope(s).name,spectrum:i}}}else if(0==this.type)t.wave=e.chipWaves[this.chipWave].name,t.unison=e.unisons[this.unison].name;else if(6==this.type)t.pulseWidth=Math.round(100*n(this.pulseWidth)*1e5)/1e5;else if(8==this.type)t.pulseWidth=Math.round(100*n(this.pulseWidth)*1e5)/1e5,t.dynamism=Math.round(100*this.supersawDynamism/e.supersawDynamismMax),t.spread=Math.round(100*this.supersawSpread/e.supersawSpreadMax),t.shape=Math.round(100*this.supersawShape/e.supersawShapeMax);else if(7==this.type)t.unison=e.unisons[this.unison].name,t.stringSustain=Math.round(100*this.stringSustain/(e.stringSustainRange-1)),e.enableAcousticSustain&&(t.stringSustainType=e.sustainTypeNames[this.stringSustainType]);else if(5==this.type)t.unison=e.unisons[this.unison].name;else{if(1!=this.type)throw new Error("Unrecognized instrument type");{const s=[];for(const t of this.operators)s.push({frequency:e.operatorFrequencies[t.frequency].name,amplitude:t.amplitude});t.algorithm=e.algorithms[this.algorithm].name,t.feedbackType=e.feedbacks[this.feedbackType].name,t.feedbackAmplitude=this.feedbackAmplitude,t.operators=s}}const i=[];for(let t=0;t<this.envelopeCount;t++)i.push(this.envelopes[t].toJsonObject());return t.envelopes=i,t}fromJsonObject(t,s,i=0){null==t&&(t={});let n=e.instrumentTypeNames.indexOf(t.type);if(-1==n&&(n=s?2:0),this.setTypeAndReset(n,s),null!=t.preset&&(this.preset=t.preset>>>0),null!=t.volume?this.volume=Fe(0,e.volumeRange,Math.round(5-(0|t.volume)/20)):this.volume=0,Array.isArray(t.effects)){let s=0;for(let i=0;i<t.effects.length;i++)s|=1<<e.effectNames.indexOf(t.effects[i]);this.effects=4095&s}else{const e=["none","reverb","chorus","chorus & reverb"];this.effects=e.indexOf(t.effects),-1==this.effects&&(this.effects=2==this.type?0:1)}this.transition=e.transitions.dictionary.normal.index;const h=t.transition||t.envelope;if(null!=h){let s=e.transitions.dictionary[h];if(null==t.fadeInSeconds||null==t.fadeOutTicks){const t={binary:{transition:"interrupt",fadeInSeconds:0,fadeOutTicks:-1},seamless:{transition:"interrupt",fadeInSeconds:0,fadeOutTicks:-1},sudden:{transition:"normal",fadeInSeconds:0,fadeOutTicks:-3},hard:{transition:"normal",fadeInSeconds:0,fadeOutTicks:-3},smooth:{transition:"normal",fadeInSeconds:.025,fadeOutTicks:-3},soft:{transition:"normal",fadeInSeconds:.025,fadeOutTicks:-3},slide:{transition:"slide in pattern",fadeInSeconds:.025,fadeOutTicks:-3},"cross fade":{transition:"normal",fadeInSeconds:.04,fadeOutTicks:6},"hard fade":{transition:"normal",fadeInSeconds:0,fadeOutTicks:48},"medium fade":{transition:"normal",fadeInSeconds:.0125,fadeOutTicks:72},"soft fade":{transition:"normal",fadeInSeconds:.06,fadeOutTicks:96}}[h];null!=t&&(s=e.transitions.dictionary[t.transition],this.fadeIn=Xe.secondsToFadeInSetting(t.fadeInSeconds),this.fadeOut=Xe.ticksToFadeOutSetting(t.fadeOutTicks))}null!=s&&(this.transition=s.index),this.transition!=e.transitions.dictionary.normal.index&&(this.effects=1024|this.effects)}null!=t.fadeInSeconds&&(this.fadeIn=Xe.secondsToFadeInSetting(+t.fadeInSeconds)),null!=t.fadeOutTicks&&(this.fadeOut=Xe.ticksToFadeOutSetting(+t.fadeOutTicks));{const s=t.chord,i={harmony:"simultaneous"},n=e.chords.dictionary[i[s]]||e.chords.dictionary[s];null!=n?this.chord=n.index:2==this.type?this.chord=e.chords.dictionary.arpeggio.index:7==this.type?this.chord=e.chords.dictionary.strum.index:0==this.type?this.chord=e.chords.dictionary.arpeggio.index:1==this.type?this.chord=e.chords.dictionary["custom interval"].index:this.chord=e.chords.dictionary.simultaneous.index}this.unison=e.unisons.dictionary.none.index;const o=t.unison||t.interval||t.chorus;if(null!=o){const t={union:"none",fifths:"fifth",octaves:"octave"},s=e.unisons.dictionary[t[o]]||e.unisons.dictionary[o];null!=s&&(this.unison=s.index)}"custom harmony"==t.chorus&&(this.unison=e.unisons.dictionary.hum.index,this.chord=e.chords.dictionary["custom interval"].index),this.chord==e.chords.dictionary.simultaneous.index||Array.isArray(t.effects)||(this.effects=2048|this.effects),null!=t.pitchShiftSemitones&&(this.pitchShift=Fe(0,e.pitchShiftRange,Math.round(+t.pitchShiftSemitones))),null!=t.detuneCents&&(this.detune=Fe(0,e.detuneMax+1,Math.round(e.detuneCenter+Xe.centsToDetune(+t.detuneCents)))),this.vibrato=e.vibratos.dictionary.none.index;const r=t.vibrato||t.effect;if(null!=r){const t={"vibrato light":"light","vibrato delayed":"delayed","vibrato heavy":"heavy"},s=e.vibratos.dictionary[t[o]]||e.vibratos.dictionary[r];null!=s&&(this.vibrato=s.index),s!=e.vibratos.dictionary.none&&(this.effects=512|this.effects)}if(null!=t.pan?(this.pan=Fe(0,e.panMax+1,Math.round(e.panCenter+(0|t.pan)*e.panCenter/100)),this.pan!=e.panCenter&&(this.effects=4|this.effects)):this.pan=e.panCenter,null!=t.distortion&&(this.distortion=Fe(0,e.distortionRange,Math.round((e.distortionRange-1)*(0|t.distortion)/100))),null!=t.bitcrusherOctave&&(this.bitcrusherFreq=e.bitcrusherFreqRange-1-+t.bitcrusherOctave/e.bitcrusherOctaveStep),null!=t.bitcrusherQuantization&&(this.bitcrusherQuantization=Fe(0,e.bitcrusherQuantizationRange,Math.round((e.bitcrusherQuantizationRange-1)*(0|t.bitcrusherQuantization)/100))),null!=t.echoSustain&&(this.echoSustain=Fe(0,e.echoSustainRange,Math.round((e.echoSustainRange-1)*(0|t.echoSustain)/100))),null!=t.echoDelayBeats&&(this.echoDelay=Fe(0,e.echoDelayRange,Math.round(+t.echoDelayBeats*(e.ticksPerPart*e.partsPerBeat)/e.echoDelayStepTicks-1))),isNaN(t.chorus)||(this.chorus=Fe(0,e.chorusRange,Math.round((e.chorusRange-1)*(0|t.chorus)/100))),null!=t.reverb?this.reverb=Fe(0,e.reverbRange,Math.round((e.reverbRange-1)*(0|t.reverb)/100)):0==i?this.effects=-2&this.effects:this.reverb=i,null!=t.pulseWidth?this.pulseWidth=Fe(0,e.pulseWidthRange,Math.round(Math.log2(+t.pulseWidth/50)/.5-1+8)):this.pulseWidth=e.pulseWidthRange-1,null!=t.dynamism?this.supersawDynamism=Fe(0,e.supersawDynamismMax+1,Math.round(e.supersawDynamismMax*(0|t.dynamism)/100)):this.supersawDynamism=e.supersawDynamismMax,null!=t.spread?this.supersawSpread=Fe(0,e.supersawSpreadMax+1,Math.round(e.supersawSpreadMax*(0|t.spread)/100)):this.supersawSpread=Math.ceil(e.supersawSpreadMax/2),null!=t.shape?this.supersawShape=Fe(0,e.supersawShapeMax+1,Math.round(e.supersawShapeMax*(0|t.shape)/100)):this.supersawShape=0,null!=t.harmonics){for(let s=0;s<e.harmonicsControlPoints;s++)this.harmonicsWave.harmonics[s]=Math.max(0,Math.min(e.harmonicsMax,Math.round(e.harmonicsMax*+t.harmonics[s]/100)));this.harmonicsWave.markCustomWaveDirty()}else this.harmonicsWave.reset();if(null!=t.spectrum){for(let s=0;s<e.spectrumControlPoints;s++)this.spectrumWave.spectrum[s]=Math.max(0,Math.min(e.spectrumMax,Math.round(e.spectrumMax*+t.spectrum[s]/100)));this.spectrumWave.markCustomWaveDirty()}else this.spectrumWave.reset(s);null!=t.stringSustain?this.stringSustain=Fe(0,e.stringSustainRange,Math.round((e.stringSustainRange-1)*(0|t.stringSustain)/100)):this.stringSustain=10,this.stringSustainType=e.enableAcousticSustain?e.sustainTypeNames.indexOf(t.stringSustainType):0,-1==this.stringSustainType&&(this.stringSustainType=0),2==this.type&&(this.chipNoise=e.chipNoises.findIndex((e=>e.name==t.wave)),-1==this.chipNoise&&(this.chipNoise=1));const a={custom:"note size",steady:"none","pluck 1":"twang 1","pluck 2":"twang 2","pluck 3":"twang 3"},l=t=>null!=a[t]?e.envelopes.dictionary[a[t]]:e.envelopes.dictionary[t];if(4==this.type&&null!=t.drums)for(let s=0;s<e.drumCount;s++){const i=t.drums[s];if(null!=i){if(this.drumsetEnvelopes[s]=e.envelopes.dictionary["twang 2"].index,null!=i.filterEnvelope){const t=l(i.filterEnvelope);null!=t&&(this.drumsetEnvelopes[s]=t.index)}if(null!=i.spectrum)for(let t=0;t<e.spectrumControlPoints;t++)this.drumsetSpectrumWaves[s].spectrum[t]=Math.max(0,Math.min(e.spectrumMax,Math.round(e.spectrumMax*+i.spectrum[t]/100)))}}if(0==this.type){const s={triangle:1,square:2,"pulse wide":3,"pulse narrow":4,sawtooth:5,"double saw":6,"double pulse":7,spiky:8,plateau:0};this.chipWave=null!=s[t.wave]?s[t.wave]:e.chipWaves.findIndex((e=>e.name==t.wave)),-1==this.chipWave&&(this.chipWave=1)}if(1==this.type){this.algorithm=e.algorithms.findIndex((e=>e.name==t.algorithm)),-1==this.algorithm&&(this.algorithm=0),this.feedbackType=e.feedbacks.findIndex((e=>e.name==t.feedbackType)),-1==this.feedbackType&&(this.feedbackType=0),null!=t.feedbackAmplitude?this.feedbackAmplitude=Fe(0,e.operatorAmplitudeMax+1,0|t.feedbackAmplitude):this.feedbackAmplitude=0;for(let s=0;s<e.operatorCount;s++){const i=this.operators[s];let n;null!=t.operators&&(n=t.operators[s]),null==n&&(n={}),i.frequency=e.operatorFrequencies.findIndex((t=>t.name==n.frequency)),-1==i.frequency&&(i.frequency=0),null!=n.amplitude?i.amplitude=Fe(0,e.operatorAmplitudeMax+1,0|n.amplitude):i.amplitude=0}}if(null!=t.noteFilter?this.noteFilter.fromJsonObject(t.noteFilter):this.noteFilter.reset(),Array.isArray(t.eqFilter))this.eqFilter.fromJsonObject(t.eqFilter);else{this.eqFilter.reset();const s={},i=8e3,n=11,h=8;if(null!=t.filterCutoffHz?s.filterCutoff=Fe(0,n,Math.round(n-1+2*Math.log((0|t.filterCutoffHz)/i)/Math.LN2)):s.filterCutoff=0==this.type?6:10,null!=t.filterResonance?s.filterResonance=Fe(0,h,Math.round((h-1)*(0|t.filterResonance)/100)):s.filterResonance=0,s.filterEnvelope=l(t.filterEnvelope),s.pulseEnvelope=l(t.pulseEnvelope),s.feedbackEnvelope=l(t.feedbackEnvelope),Array.isArray(t.operators)){s.operatorEnvelopes=[];for(let i=0;i<e.operatorCount;i++){let n;null!=t.operators[i]&&(n=l(t.operators[i].envelope)),s.operatorEnvelopes[i]=null!=n?n:e.envelopes.dictionary.none}}if(null!=t.filter){const e=[10,6,3,0,8,5,2],i=["none","none","none","none","decay 1","decay 2","decay 3"],n=["none","bright","medium","soft","decay bright","decay medium","decay soft"],h={"sustain sharp":1,"sustain medium":2,"sustain soft":3,"decay sharp":4};let o=null!=h[t.filter]?h[t.filter]:n.indexOf(t.filter);-1==o&&(o=0),s.filterCutoff=e[o],s.filterEnvelope=l(i[o]),s.filterResonance=0}this.convertLegacySettings(s)}if(Array.isArray(t.envelopes)){const s=t.envelopes;for(let t=0;t<s.length&&!(this.envelopeCount>=e.maxEnvelopeCount);t++){const e=new Ve;e.fromJsonObject(s[t]),this.addEnvelope(e.target,e.index,e.envelope)}}}static frequencyFromPitch(t){return 440*Math.pow(2,(t-69)/12)}addEnvelope(t,s,i){if(!this.supportsEnvelopeTarget(t,s))throw new Error;if(this.envelopeCount>=e.maxEnvelopeCount)throw new Error;for(;this.envelopes.length<=this.envelopeCount;)this.envelopes[this.envelopes.length]=new Ve;const n=this.envelopes[this.envelopeCount];n.target=t,n.index=s,n.envelope=i,this.envelopeCount++}supportsEnvelopeTarget(t,s){const i=e.instrumentAutomationTargets[t];return(null!=i.computeIndex||"none"==i.name)&&(!(s>=i.maxCount)&&((null==i.compatibleInstruments||-1!=i.compatibleInstruments.indexOf(this.type))&&((null==i.effect||0!=(this.effects&1<<i.effect))&&!(i.isFilter&&s>=this.noteFilter.controlPointCount))))}clearInvalidEnvelopeTargets(){for(let t=0;t<this.envelopeCount;t++){const s=this.envelopes[t].target,i=this.envelopes[t].index;this.supportsEnvelopeTarget(s,i)||(this.envelopes[t].target=e.instrumentAutomationTargets.dictionary.none.index,this.envelopes[t].index=0)}}getTransition(){return l(this.effects)?e.transitions[this.transition]:e.transitions.dictionary.normal}getFadeInSeconds(){return 4==this.type?0:Xe.fadeInSettingToSeconds(this.fadeIn)}getFadeOutTicks(){return 4==this.type?e.drumsetFadeOutTicks:Xe.fadeOutSettingToTicks(this.fadeOut)}getChord(){return c(this.effects)?e.chords[this.chord]:e.chords.dictionary.simultaneous}getDrumsetEnvelope(t){if(4!=this.type)throw new Error("Can't getDrumsetEnvelope() for non-drumset.");return e.envelopes[this.drumsetEnvelopes[t]]}}class Ge{constructor(){this.octave=0,this.instruments=[],this.patterns=[],this.bars=[],this.muted=!1}}class We{constructor(t){this.channels=[],null!=t?this.fromBase64String(t):this.initToDefault(!0)}getChannelCount(){return this.pitchChannelCount+this.noiseChannelCount}getMaxInstrumentsPerChannel(){return Math.max(this.layeredInstruments?e.layeredInstrumentCountMax:e.instrumentCountMin,this.patternInstruments?e.patternInstrumentCountMax:e.instrumentCountMin)}getMaxInstrumentsPerPattern(t){return this.getMaxInstrumentsPerPatternForChannel(this.channels[t])}getMaxInstrumentsPerPatternForChannel(t){return this.layeredInstruments?Math.min(e.layeredInstrumentCountMax,t.instruments.length):1}getChannelIsNoise(t){return t>=this.pitchChannelCount}initToDefault(t=!0){if(this.scale=0,this.key=0,this.loopStart=0,this.loopLength=4,this.tempo=150,this.beatsPerBar=8,this.barCount=16,this.patternsPerChannel=8,this.rhythm=1,this.layeredInstruments=!1,this.patternInstruments=!1,t){this.pitchChannelCount=3,this.noiseChannelCount=1;for(let t=0;t<this.getChannelCount();t++){const s=t>=this.pitchChannelCount;this.channels.length<=t&&(this.channels[t]=new Ge);const i=this.channels[t];i.octave=s?0:4-t;for(let t=0;t<this.patternsPerChannel;t++)i.patterns.length<=t?i.patterns[t]=new Oe:i.patterns[t].reset();i.patterns.length=this.patternsPerChannel;for(let t=0;t<e.instrumentCountMin;t++)i.instruments.length<=t&&(i.instruments[t]=new je(s)),i.instruments[t].setTypeAndReset(s?2:0,s);i.instruments.length=e.instrumentCountMin;for(let t=0;t<this.barCount;t++)i.bars[t]=t<4?1:0;i.bars.length=this.barCount}this.channels.length=this.getChannelCount()}}toBase64String(){let t,s=[];if(s.push(Le[We.W]),s.push(110,Le[this.pitchChannelCount],Le[this.noiseChannelCount]),s.push(115,Le[this.scale]),s.push(107,Le[this.key]),s.push(108,Le[this.loopStart>>6],Le[63&this.loopStart]),s.push(101,Le[this.loopLength-1>>6],Le[this.loopLength-1&63]),s.push(116,Le[this.tempo>>6],Le[63&this.tempo]),s.push(97,Le[this.beatsPerBar-1]),s.push(103,Le[this.barCount-1>>6],Le[this.barCount-1&63]),s.push(106,Le[this.patternsPerChannel-1>>6],Le[this.patternsPerChannel-1&63]),s.push(114,Le[this.rhythm]),s.push(105,Le[this.layeredInstruments<<1|this.patternInstruments]),this.layeredInstruments||this.patternInstruments)for(let t=0;t<this.getChannelCount();t++)s.push(Le[this.channels[t].instruments.length-e.instrumentCountMin]);s.push(111);for(let t=0;t<this.pitchChannelCount;t++)s.push(Le[this.channels[t].octave]);for(let t=0;t<this.getChannelCount();t++)for(let i=0;i<this.channels[t].instruments.length;i++){const n=this.channels[t].instruments[i];s.push(84,Le[n.type]),s.push(118,Le[n.volume]),s.push(117,Le[n.preset>>6],Le[63&n.preset]),s.push(102,Le[n.eqFilter.controlPointCount]);for(let t=0;t<n.eqFilter.controlPointCount;t++){const e=n.eqFilter.controlPoints[t];s.push(Le[e.type],Le[e.freq],Le[e.gain])}if(s.push(113,Le[n.effects>>6],Le[63&n.effects]),f(n.effects)){s.push(Le[n.noteFilter.controlPointCount]);for(let t=0;t<n.noteFilter.controlPointCount;t++){const e=n.noteFilter.controlPoints[t];s.push(Le[e.type],Le[e.freq],Le[e.gain])}}if(l(n.effects)&&s.push(Le[n.transition]),c(n.effects)&&s.push(Le[n.chord]),u(n.effects)&&s.push(Le[n.pitchShift]),p(n.effects)&&s.push(Le[n.detune]),d(n.effects)&&s.push(Le[n.vibrato]),m(n.effects)&&s.push(Le[n.distortion]),y(n.effects)&&s.push(Le[n.bitcrusherFreq],Le[n.bitcrusherQuantization]),b(n.effects)&&s.push(Le[n.pan]),w(n.effects)&&s.push(Le[n.chorus]),g(n.effects)&&s.push(Le[n.echoSustain],Le[n.echoDelay]),v(n.effects)&&s.push(Le[n.reverb]),4!=n.type&&s.push(100,Le[n.fadeIn],Le[n.fadeOut]),5==n.type||7==n.type){s.push(72);const t=new Te;for(let s=0;s<e.harmonicsControlPoints;s++)t.write(e.harmonicsControlPointBits,n.harmonicsWave.harmonics[s]);t.encodeBase64(s)}if(0==n.type)s.push(119,Le[n.chipWave]),s.push(104,Le[n.unison]);else if(1==n.type){s.push(65,Le[n.algorithm]),s.push(70,Le[n.feedbackType]),s.push(66,Le[n.feedbackAmplitude]),s.push(81);for(let t=0;t<e.operatorCount;t++)s.push(Le[n.operators[t].frequency]);s.push(80);for(let t=0;t<e.operatorCount;t++)s.push(Le[n.operators[t].amplitude])}else if(2==n.type)s.push(119,Le[n.chipNoise]);else if(3==n.type){s.push(83);const t=new Te;for(let s=0;s<e.spectrumControlPoints;s++)t.write(e.spectrumControlPointBits,n.spectrumWave.spectrum[s]);t.encodeBase64(s)}else if(4==n.type){s.push(122);for(let t=0;t<e.drumCount;t++)s.push(Le[n.drumsetEnvelopes[t]]);s.push(83);const t=new Te;for(let s=0;s<e.drumCount;s++)for(let i=0;i<e.spectrumControlPoints;i++)t.write(e.spectrumControlPointBits,n.drumsetSpectrumWaves[s].spectrum[i]);t.encodeBase64(s)}else if(5==n.type)s.push(104,Le[n.unison]);else if(6==n.type)s.push(87,Le[n.pulseWidth]);else if(8==n.type)s.push(120,Le[n.supersawDynamism],Le[n.supersawSpread],Le[n.supersawShape]),s.push(87,Le[n.pulseWidth]);else{if(7!=n.type)throw new Error("Unknown instrument type.");if(s.push(104,Le[n.unison]),e.stringSustainRange>32)throw new Error("Not enough bits to represent sustain value and type in same base64 character.");s.push(73,Le[n.stringSustain|n.stringSustainType<<5])}s.push(69,Le[n.envelopeCount]);for(let t=0;t<n.envelopeCount;t++)s.push(Le[n.envelopes[t].target]),e.instrumentAutomationTargets[n.envelopes[t].target].maxCount>1&&s.push(Le[n.envelopes[t].index]),s.push(Le[n.envelopes[t].envelope])}s.push(98),t=new Te;let i=0;for(;1<<i<this.patternsPerChannel+1;)i++;for(let e=0;e<this.getChannelCount();e++)for(let s=0;s<this.barCount;s++)t.write(i,this.channels[e].bars[s]);t.encodeBase64(s),s.push(112),t=new Te;const n=new Te,h=We.getNeededBits(e.noteSizeMax);for(let s=0;s<this.getChannelCount();s++){const i=this.channels[s],o=this.getMaxInstrumentsPerPattern(s),r=We.getNeededBits(o-e.instrumentCountMin),a=We.getNeededBits(i.instruments.length-1),l=this.getChannelIsNoise(s),c=l?0:i.octave*e.pitchesPerOctave;let u=l?4:c;const p=l?[4,6,7,2,3,8,0,10]:[0,7,12,19,24,-5,-12],d=[];for(let t=0;t<p.length;t++)p[t]+=c;for(const s of i.patterns){if(this.patternInstruments){const i=Be(e.instrumentCountMin,o,s.instruments.length);t.write(r,i-e.instrumentCountMin);for(let e=0;e<i;e++)t.write(a,s.instruments[e])}if(s.notes.length>0){t.write(1,1);let i=0;for(const o of s.notes){o.start>i&&(t.write(2,0),t.writePartDuration(o.start-i)),n.clear();for(let t=1;t<o.pitches.length;t++)n.write(1,1);o.pitches.length<e.maxChordSize&&n.write(1,0),n.writePinCount(o.pins.length-1),n.write(h,o.pins[0].size);let s=0,r=o.pitches[0],a=r;const l=[];for(let t=1;t<o.pins.length;t++){const e=o.pins[t],i=r+e.interval;a!=i?(n.write(1,1),l.push(i),a=i):n.write(1,0),n.writePartDuration(e.time-s),s=e.time,n.write(h,e.size)}const c=String.fromCharCode.apply(null,n.encodeBase64([])),f=d.indexOf(c);-1==f?(t.write(2,1),t.concat(n)):(t.write(1,1),t.writeLongTail(0,0,f),d.splice(f,1)),d.unshift(c),d.length>10&&d.pop();const m=o.pitches.concat(l);for(let e=0;e<m.length;e++){const s=m[e],i=p.indexOf(s);if(-1==i){let e=0,i=u;if(i<s)for(;i!=s;)i++,-1==p.indexOf(i)&&e++;else for(;i!=s;)i--,-1==p.indexOf(i)&&e--;t.write(1,0),t.writePitchInterval(e)}else t.write(1,1),t.write(3,i),p.splice(i,1);p.unshift(s),p.length>8&&p.pop(),u=e==o.pitches.length-1?o.pitches[0]:s}0==o.start&&t.write(1,o.continuesLastPattern?1:0),i=o.end}i<this.beatsPerBar*e.partsPerBeat&&(t.write(2,0),t.writePartDuration(this.beatsPerBar*e.partsPerBeat-i))}else t.write(1,0)}}let o=t.lengthBase64(),r=[];for(;o>0;)r.unshift(Le[63&o]),o>>=6;s.push(Le[r.length]),Array.prototype.push.apply(s,r),t.encodeBase64(s);const a=64e3;if(s.length<a)return String.fromCharCode.apply(null,s);{let t="";for(let e=0;e<s.length;e+=a)t+=String.fromCharCode.apply(null,s.slice(e,e+a));return t}}static H(t){return 0==t?t=1:1==t&&(t=0),e.envelopes[Fe(0,e.envelopes.length,t)]}fromBase64String(t){if(null==t||""==t)return void this.initToDefault(!0);let s=0;for(;t.charCodeAt(s)<=32;)s++;if(35==t.charCodeAt(s)&&s++,123==t.charCodeAt(s))return void this.fromJsonObject(JSON.parse(0==s?t:t.substring(s)));const i=Ce[t.charCodeAt(s++)];if(-1==i||i>We.W||i<We.K)return;const n=i<3,h=i<4,o=i<5,r=i<6,a=i<7,x=i<8,k=i<9;if(this.initToDefault(k),n){for(const t of this.channels)t.instruments[0].transition=e.transitions.dictionary.interrupt.index,t.instruments[0].effects|=1024;this.channels[3].instruments[0].chipNoise=0}let M=null;if(k){M=[];for(let t=M.length;t<this.getChannelCount();t++){M[t]=[];for(let s=0;s<e.instrumentCountMin;s++)M[t][s]={}}}let S,P=0,I=0,F=-1;for(;s<t.length;)switch(S=t.charCodeAt(s++)){case 110:this.pitchChannelCount=Ce[t.charCodeAt(s++)],this.noiseChannelCount=Ce[t.charCodeAt(s++)],this.pitchChannelCount=Be(e.pitchChannelCountMin,e.pitchChannelCountMax,this.pitchChannelCount),this.noiseChannelCount=Be(e.noiseChannelCountMin,e.noiseChannelCountMax,this.noiseChannelCount);for(let t=this.channels.length;t<this.getChannelCount();t++)this.channels[t]=new Ge;if(this.channels.length=this.getChannelCount(),k)for(let t=M.length;t<this.getChannelCount();t++){M[t]=[];for(let s=0;s<e.instrumentCountMin;s++)M[t][s]={}}break;case 115:this.scale=Ce[t.charCodeAt(s++)],n&&10==this.scale&&(this.scale=11);break;case 107:this.key=Fe(0,e.keys.length,a?11-Ce[t.charCodeAt(s++)]:Ce[t.charCodeAt(s++)]);break;case 108:this.loopStart=o?Ce[t.charCodeAt(s++)]:(Ce[t.charCodeAt(s++)]<<6)+Ce[t.charCodeAt(s++)];break;case 101:this.loopLength=o?Ce[t.charCodeAt(s++)]:(Ce[t.charCodeAt(s++)]<<6)+Ce[t.charCodeAt(s++)]+1;break;case 116:this.tempo=h?[95,120,151,190][Ce[t.charCodeAt(s++)]]:a?[88,95,103,111,120,130,140,151,163,176,190,206,222,240,259][Ce[t.charCodeAt(s++)]]:Ce[t.charCodeAt(s++)]<<6|Ce[t.charCodeAt(s++)],this.tempo=Fe(e.tempoMin,e.tempoMax+1,this.tempo);break;case 109:k&&(P=Ce[t.charCodeAt(s++)],P=Fe(0,4,P));break;case 97:this.beatsPerBar=n?[6,7,8,9,10][Ce[t.charCodeAt(s++)]]:Ce[t.charCodeAt(s++)]+1,this.beatsPerBar=Math.max(e.beatsPerBarMin,Math.min(e.beatsPerBarMax,this.beatsPerBar));break;case 103:{const i=(Ce[t.charCodeAt(s++)]<<6)+Ce[t.charCodeAt(s++)]+1;this.barCount=Be(e.barCountMin,e.barCountMax,i);for(let t=0;t<this.getChannelCount();t++){for(let e=this.channels[t].bars.length;e<this.barCount;e++)this.channels[t].bars[e]=1;this.channels[t].bars.length=this.barCount}}break;case 106:{let i;i=x?Ce[t.charCodeAt(s++)]+1:(Ce[t.charCodeAt(s++)]<<6)+Ce[t.charCodeAt(s++)]+1,this.patternsPerChannel=Be(1,e.barCountMax,i);const n=this.getChannelCount();for(let t=0;t<n;t++){const e=this.channels[t].patterns;for(let t=e.length;t<this.patternsPerChannel;t++)e[t]=new Oe;e.length=this.patternsPerChannel}}break;case 105:if(k){const i=Be(e.instrumentCountMin,e.patternInstrumentCountMax,Ce[t.charCodeAt(s++)]+e.instrumentCountMin);this.layeredInstruments=!1,this.patternInstruments=i>1;for(let t=0;t<this.getChannelCount();t++){const e=t>=this.pitchChannelCount;for(let s=this.channels[t].instruments.length;s<i;s++)this.channels[t].instruments[s]=new je(e);if(this.channels[t].instruments.length=i,r)for(let s=0;s<i;s++)this.channels[t].instruments[s].setTypeAndReset(e?2:0,e);for(let e=M[t].length;e<i;e++)M[t][e]={}}}else{const i=Ce[t.charCodeAt(s++)];this.layeredInstruments=0!=(2&i),this.patternInstruments=0!=(1&i);for(let i=0;i<this.getChannelCount();i++){let n=1;(this.layeredInstruments||this.patternInstruments)&&(n=Be(e.instrumentCountMin,this.getMaxInstrumentsPerChannel(),Ce[t.charCodeAt(s++)]+e.instrumentCountMin));const h=this.channels[i],o=this.getChannelIsNoise(i);for(let t=h.instruments.length;t<n;t++)h.instruments[t]=new je(o);h.instruments.length=n}}break;case 114:this.rhythm=Ce[t.charCodeAt(s++)];break;case 111:if(n){const i=Ce[t.charCodeAt(s++)];this.channels[i].octave=Fe(0,e.pitchOctaves,Ce[t.charCodeAt(s++)]+1),i>=this.pitchChannelCount&&(this.channels[i].octave=0)}else if(k)for(let i=0;i<this.getChannelCount();i++)this.channels[i].octave=Fe(0,e.pitchOctaves,Ce[t.charCodeAt(s++)]+1),i>=this.pitchChannelCount&&(this.channels[i].octave=0);else{for(let i=0;i<this.pitchChannelCount;i++)this.channels[i].octave=Fe(0,e.pitchOctaves,Ce[t.charCodeAt(s++)]);for(let t=this.pitchChannelCount;t<this.getChannelCount();t++)this.channels[t].octave=0}break;case 84:{F++,F>=this.channels[I].instruments.length&&(I++,F=0),Be(0,this.channels.length-1,I);const i=this.channels[I].instruments[F],n=Be(0,8,Ce[t.charCodeAt(s++)]);i.setTypeAndReset(n,I>=this.pitchChannelCount),a&&(i.effects=0,P>0&&!this.getChannelIsNoise(I)&&(i.reverb=P,i.effects|=1),i.chord!=e.chords.dictionary.simultaneous.index&&(i.effects|=2048))}break;case 117:{const e=Ce[t.charCodeAt(s++)]<<6|Ce[t.charCodeAt(s++)];this.channels[I].instruments[F].preset=e}break;case 119:if(n){const i=[1,2,3,4,5,6,7,8,0],n=Ce[t.charCodeAt(s++)],h=this.channels[n].instruments[0];h.chipWave=Fe(0,e.chipWaves.length,0|i[Ce[t.charCodeAt(s++)]]),h.convertLegacySettings(M[n][0])}else if(r){const i=[1,2,3,4,5,6,7,8,0];for(let n=0;n<this.getChannelCount();n++)for(const h of this.channels[n].instruments)n>=this.pitchChannelCount?h.chipNoise=Fe(0,e.chipNoises.length,Ce[t.charCodeAt(s++)]):h.chipWave=Fe(0,e.chipWaves.length,0|i[Ce[t.charCodeAt(s++)]])}else if(a){const i=[1,2,3,4,5,6,7,8,0];I>=this.pitchChannelCount?this.channels[I].instruments[F].chipNoise=Fe(0,e.chipNoises.length,Ce[t.charCodeAt(s++)]):this.channels[I].instruments[F].chipWave=Fe(0,e.chipWaves.length,0|i[Ce[t.charCodeAt(s++)]])}else I>=this.pitchChannelCount?this.channels[I].instruments[F].chipNoise=Fe(0,e.chipNoises.length,Ce[t.charCodeAt(s++)]):this.channels[I].instruments[F].chipWave=Fe(0,e.chipWaves.length,Ce[t.charCodeAt(s++)]);break;case 102:if(k)if(a){const i=[10,6,3,0,8,5,2],h=["none","none","none","none","decay 1","decay 2","decay 3"];if(n){const n=Ce[t.charCodeAt(s++)],o=this.channels[n].instruments[0],r=M[n][0],a=[1,3,4,5][Fe(0,i.length,Ce[t.charCodeAt(s++)])];r.filterCutoff=i[a],r.filterResonance=0,r.filterEnvelope=e.envelopes.dictionary[h[a]],o.convertLegacySettings(r)}else if(r)for(let n=0;n<this.getChannelCount();n++)for(let o=0;o<this.channels[n].instruments.length;o++){const r=this.channels[n].instruments[o],a=M[n][o],l=Fe(0,i.length,Ce[t.charCodeAt(s++)]+1);n<this.pitchChannelCount?(a.filterCutoff=i[l],a.filterResonance=0,a.filterEnvelope=e.envelopes.dictionary[h[l]]):(a.filterCutoff=10,a.filterResonance=0,a.filterEnvelope=e.envelopes.dictionary.none),r.convertLegacySettings(a)}else{const n=Fe(0,i.length,Ce[t.charCodeAt(s++)]),o=this.channels[I].instruments[F],r=M[I][F];r.filterCutoff=i[n],r.filterResonance=0,r.filterEnvelope=e.envelopes.dictionary[h[n]],o.convertLegacySettings(r)}}else{const e=11,i=this.channels[I].instruments[F],n=M[I][F];n.filterCutoff=Fe(0,e,Ce[t.charCodeAt(s++)]),i.convertLegacySettings(n)}else{const i=this.channels[I].instruments[F],n=Ce[t.charCodeAt(s++)];i.eqFilter.controlPointCount=Fe(0,e.filterMaxPoints+1,n);for(let t=i.eqFilter.controlPoints.length;t<i.eqFilter.controlPointCount;t++)i.eqFilter.controlPoints[t]=new qe;for(let n=0;n<i.eqFilter.controlPointCount;n++){const h=i.eqFilter.controlPoints[n];h.type=Fe(0,3,Ce[t.charCodeAt(s++)]),h.freq=Fe(0,e.filterFreqRange,Ce[t.charCodeAt(s++)]),h.gain=Fe(0,e.filterGainRange,Ce[t.charCodeAt(s++)])}for(let t=i.eqFilter.controlPointCount;t<n;t++)s+=3}break;case 121:if(k){const e=8,i=this.channels[I].instruments[F],n=M[I][F];n.filterResonance=Fe(0,e,Ce[t.charCodeAt(s++)]),i.convertLegacySettings(n)}break;case 122:{const i=this.channels[I].instruments[F];if(k)if(4==i.type)for(let n=0;n<e.drumCount;n++)i.drumsetEnvelopes[n]=We.H(Ce[t.charCodeAt(s++)]).index;else{const e=M[I][F];e.filterEnvelope=We.H(Ce[t.charCodeAt(s++)]),i.convertLegacySettings(e)}else for(let n=0;n<e.drumCount;n++)i.drumsetEnvelopes[n]=Fe(0,e.envelopes.length,Ce[t.charCodeAt(s++)])}break;case 87:{const i=this.channels[I].instruments[F];if(i.pulseWidth=Fe(0,e.pulseWidthRange,Ce[t.charCodeAt(s++)]),k){const e=M[I][F];e.pulseEnvelope=We.H(Ce[t.charCodeAt(s++)]),i.convertLegacySettings(e)}}break;case 120:{const i=this.channels[I].instruments[F];i.supersawDynamism=Fe(0,e.supersawDynamismMax+1,Ce[t.charCodeAt(s++)]),i.supersawSpread=Fe(0,e.supersawSpreadMax+1,Ce[t.charCodeAt(s++)]),i.supersawShape=Fe(0,e.supersawShapeMax+1,Ce[t.charCodeAt(s++)])}break;case 73:{const i=this.channels[I].instruments[F],n=Ce[t.charCodeAt(s++)];i.stringSustain=Fe(0,e.stringSustainRange,31&n),i.stringSustainType=e.enableAcousticSustain?Fe(0,2,n>>5):0}break;case 100:if(k){const i=[{transition:"interrupt",fadeInSeconds:0,fadeOutTicks:-1},{transition:"normal",fadeInSeconds:0,fadeOutTicks:-3},{transition:"normal",fadeInSeconds:.025,fadeOutTicks:-3},{transition:"slide in pattern",fadeInSeconds:.025,fadeOutTicks:-3},{transition:"normal",fadeInSeconds:.04,fadeOutTicks:6},{transition:"normal",fadeInSeconds:0,fadeOutTicks:48},{transition:"normal",fadeInSeconds:.0125,fadeOutTicks:72},{transition:"normal",fadeInSeconds:.06,fadeOutTicks:96}];if(n){const n=Ce[t.charCodeAt(s++)],h=i[Fe(0,i.length,Ce[t.charCodeAt(s++)])],o=this.channels[n].instruments[0];o.fadeIn=Xe.secondsToFadeInSetting(h.fadeInSeconds),o.fadeOut=Xe.ticksToFadeOutSetting(h.fadeOutTicks),o.transition=e.transitions.dictionary[h.transition].index,o.transition!=e.transitions.dictionary.normal.index&&(o.effects|=1024)}else if(r)for(let n=0;n<this.getChannelCount();n++)for(const h of this.channels[n].instruments){const n=i[Fe(0,i.length,Ce[t.charCodeAt(s++)])];h.fadeIn=Xe.secondsToFadeInSetting(n.fadeInSeconds),h.fadeOut=Xe.ticksToFadeOutSetting(n.fadeOutTicks),h.transition=e.transitions.dictionary[n.transition].index,h.transition!=e.transitions.dictionary.normal.index&&(h.effects|=1024)}else{const n=i[Fe(0,i.length,Ce[t.charCodeAt(s++)])],h=this.channels[I].instruments[F];h.fadeIn=Xe.secondsToFadeInSetting(n.fadeInSeconds),h.fadeOut=Xe.ticksToFadeOutSetting(n.fadeOutTicks),h.transition=e.transitions.dictionary[n.transition].index,h.transition!=e.transitions.dictionary.normal.index&&(h.effects|=1024)}}else{const i=this.channels[I].instruments[F];i.fadeIn=Fe(0,e.fadeInRange,Ce[t.charCodeAt(s++)]),i.fadeOut=Fe(0,e.fadeOutTicks.length,Ce[t.charCodeAt(s++)])}break;case 99:if(k)if(a)if(n){const i=[0,3,2,0],n=["none","none","none","tremolo2"],h=Ce[t.charCodeAt(s++)],o=Fe(0,i.length,Ce[t.charCodeAt(s++)]),r=this.channels[h].instruments[0],a=M[h][0];r.vibrato=i[o],null!=a.filterEnvelope&&1!=a.filterEnvelope.type||(a.filterEnvelope=e.envelopes.dictionary[n[o]],r.convertLegacySettings(a)),r.vibrato!=e.vibratos.dictionary.none.index&&(r.effects|=512)}else if(r){const i=[0,1,2,3,0,0],n=["none","none","none","none","tremolo5","tremolo2"];for(let h=0;h<this.getChannelCount();h++)for(let o=0;o<this.channels[h].instruments.length;o++){const r=Fe(0,i.length,Ce[t.charCodeAt(s++)]),a=this.channels[h].instruments[o],l=M[h][o];a.vibrato=i[r],null!=l.filterEnvelope&&1!=l.filterEnvelope.type||(l.filterEnvelope=e.envelopes.dictionary[n[r]],a.convertLegacySettings(l)),a.vibrato!=e.vibratos.dictionary.none.index&&(a.effects|=512),0==P||this.getChannelIsNoise(h)||(a.effects|=1,a.reverb=P)}}else{const i=[0,1,2,3,0,0],n=["none","none","none","none","tremolo5","tremolo2"],h=Fe(0,i.length,Ce[t.charCodeAt(s++)]),o=this.channels[I].instruments[F],r=M[I][F];o.vibrato=i[h],null!=r.filterEnvelope&&1!=r.filterEnvelope.type||(r.filterEnvelope=e.envelopes.dictionary[n[h]],o.convertLegacySettings(r)),o.vibrato!=e.vibratos.dictionary.none.index&&(o.effects|=512),0!=P&&(o.effects|=1,o.reverb=P)}else{const i=this.channels[I].instruments[F],n=Fe(0,e.vibratos.length,Ce[t.charCodeAt(s++)]);i.vibrato=n,i.vibrato!=e.vibratos.dictionary.none.index&&(i.effects|=512)}break;case 104:if(n){const i=Ce[t.charCodeAt(s++)];this.channels[i].instruments[0].unison=Fe(0,e.unisons.length,Ce[t.charCodeAt(s++)])}else if(r)for(let i=0;i<this.getChannelCount();i++)for(const n of this.channels[i].instruments){const i=Ce[t.charCodeAt(s++)];let h=Fe(0,e.unisons.length,i);8==i&&(h=2,n.chord=3),n.unison=h}else if(a){const i=Ce[t.charCodeAt(s++)];let n=Fe(0,e.unisons.length,i);8==i&&(n=2,this.channels[I].instruments[F].chord=3),this.channels[I].instruments[F].unison=n}else this.channels[I].instruments[F].unison=Fe(0,e.unisons.length,Ce[t.charCodeAt(s++)]);break;case 67:if(k){const i=this.channels[I].instruments[F];i.chord=Fe(0,e.chords.length,Ce[t.charCodeAt(s++)]),i.chord!=e.chords.dictionary.simultaneous.index&&(i.effects|=2048)}break;case 113:{const i=this.channels[I].instruments[F];if(k){i.effects=4095&Ce[t.charCodeAt(s++)],0==P?i.effects&=-2:v(i.effects)&&(i.reverb=P),i.pan!=e.panCenter&&(i.effects|=4),i.vibrato!=e.vibratos.dictionary.none.index&&(i.effects|=4);const n=M[I][F];i.convertLegacySettings(n)}else{if(i.effects=Ce[t.charCodeAt(s++)]<<6|Ce[t.charCodeAt(s++)],f(i.effects)){const n=Ce[t.charCodeAt(s++)];i.noteFilter.controlPointCount=Fe(0,e.filterMaxPoints+1,n);for(let t=i.noteFilter.controlPoints.length;t<i.noteFilter.controlPointCount;t++)i.noteFilter.controlPoints[t]=new qe;for(let n=0;n<i.noteFilter.controlPointCount;n++){const h=i.noteFilter.controlPoints[n];h.type=Fe(0,3,Ce[t.charCodeAt(s++)]),h.freq=Fe(0,e.filterFreqRange,Ce[t.charCodeAt(s++)]),h.gain=Fe(0,e.filterGainRange,Ce[t.charCodeAt(s++)])}for(let t=i.noteFilter.controlPointCount;t<n;t++)s+=3}l(i.effects)&&(i.transition=Fe(0,e.transitions.length,Ce[t.charCodeAt(s++)])),c(i.effects)&&(i.chord=Fe(0,e.chords.length,Ce[t.charCodeAt(s++)])),u(i.effects)&&(i.pitchShift=Fe(0,e.pitchShiftRange,Ce[t.charCodeAt(s++)])),p(i.effects)&&(i.detune=Fe(0,e.detuneMax+1,Ce[t.charCodeAt(s++)])),d(i.effects)&&(i.vibrato=Fe(0,e.vibratos.length,Ce[t.charCodeAt(s++)])),m(i.effects)&&(i.distortion=Fe(0,e.distortionRange,Ce[t.charCodeAt(s++)])),y(i.effects)&&(i.bitcrusherFreq=Fe(0,e.bitcrusherFreqRange,Ce[t.charCodeAt(s++)]),i.bitcrusherQuantization=Fe(0,e.bitcrusherQuantizationRange,Ce[t.charCodeAt(s++)])),b(i.effects)&&(i.pan=Fe(0,e.panMax+1,Ce[t.charCodeAt(s++)])),w(i.effects)&&(i.chorus=Fe(0,e.chorusRange,Ce[t.charCodeAt(s++)])),g(i.effects)&&(i.echoSustain=Fe(0,e.echoSustainRange,Ce[t.charCodeAt(s++)]),i.echoDelay=Fe(0,e.echoDelayRange,Ce[t.charCodeAt(s++)])),v(i.effects)&&(i.reverb=Fe(0,e.reverbRange,Ce[t.charCodeAt(s++)]))}i.effects&=4095}break;case 118:if(n){const i=Ce[t.charCodeAt(s++)],n=this.channels[i].instruments[0];n.volume=Fe(0,e.volumeRange,Ce[t.charCodeAt(s++)]),5==n.volume&&(n.volume=e.volumeRange-1)}else if(r)for(let i=0;i<this.getChannelCount();i++)for(const n of this.channels[i].instruments)n.volume=Fe(0,e.volumeRange,Ce[t.charCodeAt(s++)]),5==n.volume&&(n.volume=e.volumeRange-1);else if(a){const i=this.channels[I].instruments[F];i.volume=Fe(0,e.volumeRange,Ce[t.charCodeAt(s++)]),5==i.volume&&(i.volume=e.volumeRange-1)}else{this.channels[I].instruments[F].volume=Fe(0,e.volumeRange,Ce[t.charCodeAt(s++)])}break;case 76:if(k){this.channels[I].instruments[F].pan=Fe(0,e.panMax+1,Ce[t.charCodeAt(s++)])}break;case 65:{const i=this.channels[I].instruments[F];if(i.algorithm=Fe(0,e.algorithms.length,Ce[t.charCodeAt(s++)]),k){const t=M[I][F];i.convertLegacySettings(t)}}break;case 70:this.channels[I].instruments[F].feedbackType=Fe(0,e.feedbacks.length,Ce[t.charCodeAt(s++)]);break;case 66:this.channels[I].instruments[F].feedbackAmplitude=Fe(0,e.operatorAmplitudeMax+1,Ce[t.charCodeAt(s++)]);break;case 86:if(k){const e=this.channels[I].instruments[F],i=M[I][F];i.feedbackEnvelope=We.H(Ce[t.charCodeAt(s++)]),e.convertLegacySettings(i)}break;case 81:for(let i=0;i<e.operatorCount;i++)this.channels[I].instruments[F].operators[i].frequency=Fe(0,e.operatorFrequencies.length,Ce[t.charCodeAt(s++)]);break;case 80:for(let i=0;i<e.operatorCount;i++)this.channels[I].instruments[F].operators[i].amplitude=Fe(0,e.operatorAmplitudeMax+1,Ce[t.charCodeAt(s++)]);break;case 69:{const i=this.channels[I].instruments[F];if(k){const n=M[I][F];n.operatorEnvelopes=[];for(let i=0;i<e.operatorCount;i++)n.operatorEnvelopes[i]=We.H(Ce[t.charCodeAt(s++)]);i.convertLegacySettings(n)}else{const n=Fe(0,e.maxEnvelopeCount+1,Ce[t.charCodeAt(s++)]);for(let h=0;h<n;h++){const n=Fe(0,e.instrumentAutomationTargets.length,Ce[t.charCodeAt(s++)]);let h=0;const o=e.instrumentAutomationTargets[n].maxCount;o>1&&(h=Fe(0,o,Ce[t.charCodeAt(s++)]));const r=Fe(0,e.envelopes.length,Ce[t.charCodeAt(s++)]);i.addEnvelope(n,h,r)}}}break;case 83:{const i=this.channels[I].instruments[F];if(3==i.type){const n=Math.ceil(e.spectrumControlPoints*e.spectrumControlPointBits/6),h=new De(t,s,s+n);for(let t=0;t<e.spectrumControlPoints;t++)i.spectrumWave.spectrum[t]=h.read(e.spectrumControlPointBits);i.spectrumWave.markCustomWaveDirty(),s+=n}else{if(4!=i.type)throw new Error("Unhandled instrument type for spectrum song tag code.");{const n=Math.ceil(e.drumCount*e.spectrumControlPoints*e.spectrumControlPointBits/6),h=new De(t,s,s+n);for(let t=0;t<e.drumCount;t++){for(let s=0;s<e.spectrumControlPoints;s++)i.drumsetSpectrumWaves[t].spectrum[s]=h.read(e.spectrumControlPointBits);i.drumsetSpectrumWaves[t].markCustomWaveDirty()}s+=n}}}break;case 72:{const i=this.channels[I].instruments[F],n=Math.ceil(e.harmonicsControlPoints*e.harmonicsControlPointBits/6),h=new De(t,s,s+n);for(let t=0;t<e.harmonicsControlPoints;t++)i.harmonicsWave.harmonics[t]=h.read(e.harmonicsControlPointBits);i.harmonicsWave.markCustomWaveDirty(),s+=n}break;case 98:{let e;if(n){const i=Ce[t.charCodeAt(s++)],n=Ce[t.charCodeAt(s++)];e=Math.ceil(.5*n);const h=new De(t,s,s+e);for(let t=0;t<n;t++)this.channels[i].bars[t]=h.read(3)+1}else if(o){let i=0;for(;1<<i<this.patternsPerChannel;)i++;e=Math.ceil(this.getChannelCount()*this.barCount*i/6);const n=new De(t,s,s+e);for(let t=0;t<this.getChannelCount();t++)for(let e=0;e<this.barCount;e++)this.channels[t].bars[e]=n.read(i)+1}else{let i=0;for(;1<<i<this.patternsPerChannel+1;)i++;e=Math.ceil(this.getChannelCount()*this.barCount*i/6);const n=new De(t,s,s+e);for(let t=0;t<this.getChannelCount();t++)for(let e=0;e<this.barCount;e++)this.channels[t].bars[e]=n.read(i)}s+=e}break;case 112:{let i,h=0;if(n)i=Ce[t.charCodeAt(s++)],s++,h=Ce[t.charCodeAt(s++)],h<<=6,h+=Ce[t.charCodeAt(s++)];else{i=0;let e=Be(1,4,Ce[t.charCodeAt(s++)]);for(;e>0;)h<<=6,h+=Ce[t.charCodeAt(s++)],e--}const o=new De(t,s,s+h);s+=h;const r=We.getNeededBits(e.noteSizeMax);for(;;){const t=this.channels[i],s=this.getChannelIsNoise(i),h=this.getMaxInstrumentsPerPattern(i),l=We.getNeededBits(h-e.instrumentCountMin),c=We.getNeededBits(t.instruments.length-1),u=s?0:12*t.octave;let p=s?4:u;const d=s?[4,6,7,2,3,8,0,10]:[0,7,12,19,24,-5,-12],f=[];for(let t=0;t<d.length;t++)d[t]+=u;for(let s=0;s<this.patternsPerChannel;s++){const i=t.patterns[s];if(k)i.instruments[0]=Be(0,t.instruments.length-1,o.read(c)),i.instruments.length=1;else if(this.patternInstruments){const s=Be(e.instrumentCountMin,h,o.read(l)+e.instrumentCountMin);for(let e=0;e<s;e++)i.instruments[e]=Be(0,t.instruments.length-1,o.read(c));i.instruments.length=s}else i.instruments[0]=0,i.instruments.length=e.instrumentCountMin;if(!n&&0==o.read(1)){i.notes.length=0;continue}let u=0;const m=i.notes;let y=0;for(;u<this.beatsPerBar*e.partsPerBeat;){const t=1==o.read(1);let s=!1,i=0;if(t?i=Be(0,f.length-1,o.readLongTail(0,0)):s=1==o.read(1),t||s){let s,n,h;if(t)s=f[i],f.splice(i,1);else{for(s={},s.pitchCount=1;s.pitchCount<e.maxChordSize&&1==o.read(1);)s.pitchCount++;s.pinCount=o.readPinCount(),s.initialSize=o.read(r),s.pins=[],s.length=0,s.bendCount=0;for(let t=0;t<s.pinCount;t++){let t={};t.pitchBend=1==o.read(1),t.pitchBend&&s.bendCount++,s.length+=a?o.readLegacyPartDuration()*e.partsPerBeat/e.rhythms[this.rhythm].stepsPerBeat:o.readPartDuration(),t.time=s.length,t.size=o.read(r),s.pins.push(t)}}f.unshift(s),f.length>10&&f.pop(),m.length<=y?(n=new Ne(0,u,u+s.length,s.initialSize),m[y++]=n):(n=m[y++],n.start=u,n.end=u+s.length,n.pins[0].size=s.initialSize);let l=0;const c=[];for(let t=0;t<s.pitchCount+s.bendCount;t++){if(1==o.read(1)){const t=Be(0,d.length-1,o.read(3));h=d[t],d.splice(t,1)}else{h=p;let t=o.readPitchInterval();for(;t>0;){for(h++;-1!=d.indexOf(h);)h++;t--}for(;t<0;){for(h--;-1!=d.indexOf(h);)h--;t++}}d.unshift(h),d.length>8&&d.pop(),t<s.pitchCount?n.pitches[l++]=h:c.push(h),p=t==s.pitchCount-1?n.pitches[0]:h}n.pitches.length=l,c.unshift(n.pitches[0]);let b=1;for(const t of s.pins){t.pitchBend&&c.shift();const e=c[0]-n.pitches[0];if(n.pins.length<=b)n.pins[b++]=Ee(e,t.time,t.size);else{const s=n.pins[b++];s.interval=e,s.time=t.time,s.size=t.size}}n.pins.length=b,0!=n.start||k?n.continuesLastPattern=!1:n.continuesLastPattern=1==o.read(1),u=Be(0,this.beatsPerBar*e.partsPerBeat,n.end)}else{u+=a?o.readLegacyPartDuration()*e.partsPerBeat/e.rhythms[this.rhythm].stepsPerBeat:o.readPartDuration()}}m.length=y}if(n)break;if(i++,i>=this.getChannelCount())break}}break;default:throw new Error("Unrecognized song tag code "+String.fromCharCode(S)+" at index "+(s-1))}}toJsonObject(t=!0,s=1,i=!0){const n=[];for(let e=0;e<this.getChannelCount();e++){const h=this.channels[e],o=[],r=this.getChannelIsNoise(e);for(const t of h.instruments)o.push(t.toJsonObject());const a=[];for(const t of h.patterns)a.push(t.toJsonObject(this));const l=[];if(t)for(let t=0;t<this.loopStart;t++)l.push(h.bars[t]);for(let t=0;t<s;t++)for(let t=this.loopStart;t<this.loopStart+this.loopLength;t++)l.push(h.bars[t]);if(i)for(let t=this.loopStart+this.loopLength;t<this.barCount;t++)l.push(h.bars[t]);const c={type:r?"drum":"pitch",instruments:o,patterns:a,sequence:l};r||(c.octaveScrollBar=h.octave-1),n.push(c)}return{format:We.Y,version:We.W,scale:e.scales[this.scale].name,key:e.keys[this.key].name,introBars:this.loopStart,loopBars:this.loopLength,beatsPerBar:this.beatsPerBar,ticksPerBeat:e.rhythms[this.rhythm].stepsPerBeat,beatsPerMinute:this.tempo,layeredInstruments:this.layeredInstruments,patternInstruments:this.patternInstruments,channels:n}}fromJsonObject(t){if(this.initToDefault(!0),!t)return;if(this.scale=11,null!=t.scale){const s={"romani :)":"double harmonic :)","romani :(":"double harmonic :(","dbl harmonic :)":"double harmonic :)","dbl harmonic :(":"double harmonic :(",enigma:"strange"},i=null!=s[t.scale]?s[t.scale]:t.scale,n=e.scales.findIndex((t=>t.name==i));-1!=n&&(this.scale=n)}if(null!=t.key)if("number"==typeof t.key)this.key=(t.key+1200>>>0)%e.keys.length;else if("string"==typeof t.key){const e=t.key,s=e.charAt(0).toUpperCase(),i=e.charAt(1).toLowerCase();let n={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[s];const h={"#":1,"♯":1,b:-1,"♭":-1}[i];null!=n&&(null!=h&&(n+=h),n<0&&(n+=12),n%=12,this.key=n)}null!=t.beatsPerMinute&&(this.tempo=Fe(e.tempoMin,e.tempoMax+1,0|t.beatsPerMinute));let s=0;null!=t.reverb&&(s=Fe(0,4,0|t.reverb)),null!=t.beatsPerBar&&(this.beatsPerBar=Math.max(e.beatsPerBarMin,Math.min(e.beatsPerBarMax,0|t.beatsPerBar)));let i=4;null!=t.ticksPerBeat&&(i=0|t.ticksPerBeat||4,this.rhythm=e.rhythms.findIndex((t=>t.stepsPerBeat==i)),-1==this.rhythm&&(this.rhythm=1));let n=1,h=1,o=1;if(null!=t.channels)for(const e of t.channels)e.instruments&&(n=Math.max(n,0|e.instruments.length)),e.patterns&&(h=Math.max(h,0|e.patterns.length)),e.sequence&&(o=Math.max(o,0|e.sequence.length));null!=t.layeredInstruments?this.layeredInstruments=!!t.layeredInstruments:this.layeredInstruments=!1,null!=t.patternInstruments?this.patternInstruments=!!t.patternInstruments:this.patternInstruments=n>1,this.patternsPerChannel=Math.min(h,e.barCountMax),this.barCount=Math.min(o,e.barCountMax),null!=t.introBars&&(this.loopStart=Fe(0,this.barCount,0|t.introBars)),null!=t.loopBars&&(this.loopLength=Fe(1,this.barCount-this.loopStart+1,0|t.loopBars));const r=[],a=[];if(null!=t.channels)for(let n=0;n<t.channels.length;n++){let h=t.channels[n];const o=new Ge;let l=!1;if(l=null!=h.type?"drum"==h.type:n>=3,l?a.push(o):r.push(o),null!=h.octaveScrollBar&&(o.octave=Fe(0,e.pitchOctaves,1+(0|h.octaveScrollBar)),l&&(o.octave=0)),Array.isArray(h.instruments)){const t=h.instruments;for(let e=0;e<t.length&&!(e>=this.getMaxInstrumentsPerChannel());e++){const i=new je(l);o.instruments[e]=i,i.fromJsonObject(t[e],l,s)}}for(let t=0;t<this.patternsPerChannel;t++){const e=new Oe;let s;o.patterns[t]=e,h.patterns&&(s=h.patterns[t]),null!=s&&e.fromJsonObject(s,this,o,i,l)}o.patterns.length=this.patternsPerChannel;for(let t=0;t<this.barCount;t++)o.bars[t]=null!=h.sequence?Math.min(this.patternsPerChannel,h.sequence[t]>>>0):0;o.bars.length=this.barCount}r.length>e.pitchChannelCountMax&&(r.length=e.pitchChannelCountMax),a.length>e.noiseChannelCountMax&&(a.length=e.noiseChannelCountMax),this.pitchChannelCount=r.length,this.noiseChannelCount=a.length,this.channels.length=0,Array.prototype.push.apply(this.channels,r),Array.prototype.push.apply(this.channels,a)}getPattern(t,e){if(e<0||e>=this.barCount)return null;const s=this.channels[t].bars[e];return 0==s?null:this.channels[t].patterns[s-1]}getBeatsPerMinute(){return this.tempo}static getNeededBits(t){return 32-Math.clz32(Math.ceil(t+1)-1)}}We.Y="BeepBox",We.K=2,We.W=9;class He{constructor(){this.delayLine=null,this.allPassG=0,this.allPassGDelta=0,this.sustainFilterA1=0,this.sustainFilterA1Delta=0,this.sustainFilterA2=0,this.sustainFilterA2Delta=0,this.sustainFilterB0=0,this.sustainFilterB0Delta=0,this.sustainFilterB1=0,this.sustainFilterB1Delta=0,this.sustainFilterB2=0,this.sustainFilterB2Delta=0,this.reset()}reset(){this.delayIndex=-1,this.allPassSample=0,this.allPassPrevInput=0,this.sustainFilterSample=0,this.sustainFilterPrevOutput2=0,this.sustainFilterPrevInput1=0,this.sustainFilterPrevInput2=0,this.fractionalDelaySample=0,this.prevDelayLength=-1,this.delayResetOffset=0}update(t,s,i,n,h,o,r,a){const l=2*Math.PI*e.pickedStringDispersionCenterFreq/t.samplesPerSecond,c=this.prevDelayLength,u=i.phaseDeltas[n],p=i.phaseDeltaScales[n],d=u*Math.pow(p,h),f=2*Math.PI*u,m=2*Math.PI*d,y=2*f,b=2*m,w=Math.min(Math.PI,f*e.pickedStringDispersionFreqMult*Math.pow(l/f,e.pickedStringDispersionFreqScale)),g=Math.min(Math.PI,m*e.pickedStringDispersionFreqMult*Math.pow(l/m,e.pickedStringDispersionFreqScale)),v=2*Math.PI*e.pickedStringShelfHz/t.samplesPerSecond,x=(Math.pow(100,o)-1)/99,k=(Math.pow(100,r)-1)/99,M=1==a?.25:0,S=15.6,P=3*t.samplesPerSecond/48e3,I=Math.pow(.5,x*Math.pow(v/(f*S),1+2*M)*S),F=Math.pow(.5,k*Math.pow(v/(m*S),1+2*M)*S),B=Math.pow(I,.002),L=Math.pow(F,.002);Xe.tempFilterStartCoefficients.allPass1stOrderInvertPhaseAbove(w),t.tempFrequencyResponse.analyze(Xe.tempFilterStartCoefficients,y);const C=Xe.tempFilterStartCoefficients.b[0],D=-t.tempFrequencyResponse.angle()/y;Xe.tempFilterEndCoefficients.allPass1stOrderInvertPhaseAbove(g),t.tempFrequencyResponse.analyze(Xe.tempFilterEndCoefficients,b);const T=Xe.tempFilterEndCoefficients.b[0],E=-t.tempFrequencyResponse.angle()/b,N=0==a?0:1;if(0==N){const t=Math.pow(I,e.stringDecayRate),s=Math.pow(F,e.stringDecayRate);Xe.tempFilterStartCoefficients.highShelf2ndOrder(v,t,.5),Xe.tempFilterEndCoefficients.highShelf2ndOrder(v,s,.5)}else{const e=Math.pow(1==N?0:1,.25),s=Math.pow(P*P*f*3.3*48e3/t.samplesPerSecond,.5+M)/P/Math.pow(x,.5),i=Math.pow(P*P*m*3.3*48e3/t.samplesPerSecond,.5+M)/P/Math.pow(k,.5),n=s*Math.pow(2,.5-1.75*(1-Math.pow(1-e,.85))),h=i*Math.pow(2,.5-1.75*(1-Math.pow(1-e,.85))),o=Math.pow(2,-Math.pow(2,-Math.pow(e,.9))),r=Math.pow(2,-Math.pow(2,-Math.pow(e,.9)));Xe.tempFilterStartCoefficients.lowPass2ndOrderButterworth(Pe(n),o),Xe.tempFilterEndCoefficients.lowPass2ndOrderButterworth(Pe(h),r)}t.tempFrequencyResponse.analyze(Xe.tempFilterStartCoefficients,y);const O=Xe.tempFilterStartCoefficients.a[1],z=Xe.tempFilterStartCoefficients.a[2],R=Xe.tempFilterStartCoefficients.b[0]*B,A=Xe.tempFilterStartCoefficients.b[1]*B,$=Xe.tempFilterStartCoefficients.b[2]*B,U=-t.tempFrequencyResponse.angle()/y;t.tempFrequencyResponse.analyze(Xe.tempFilterEndCoefficients,b);const q=Xe.tempFilterEndCoefficients.a[1],_=Xe.tempFilterEndCoefficients.a[2],V=Xe.tempFilterEndCoefficients.b[0]*L,j=Xe.tempFilterEndCoefficients.b[1]*L,G=Xe.tempFilterEndCoefficients.b[2]*L,W=-t.tempFrequencyResponse.angle()/b,H=1/u,K=1/d,Y=Math.ceil(2*Math.max(H,K)),J=H-D-U,Q=K-E-W;this.prevDelayLength=J,this.delayLengthDelta=(Q-J)/h,this.allPassG=C,this.sustainFilterA1=O,this.sustainFilterA2=z,this.sustainFilterB0=R,this.sustainFilterB1=A,this.sustainFilterB2=$,this.allPassGDelta=(T-C)/h,this.sustainFilterA1Delta=(q-O)/h,this.sustainFilterA2Delta=(_-z)/h,this.sustainFilterB0Delta=(V-R)/h,this.sustainFilterB1Delta=(j-A)/h,this.sustainFilterB2Delta=(G-$)/h;const X=Math.abs(Math.log2(J/c))>.01,Z=-1==this.delayIndex||X;if(null==this.delayLine||this.delayLine.length<=Y){const e=Math.ceil(2*t.samplesPerSecond/je.frequencyFromPitch(12)),s=new Float32Array(Xe.fittingPowerOfTwo(Math.max(e,Y)));if(!Z&&null!=this.delayLine){const t=this.delayLine.length-1>>0,e=this.delayIndex+this.delayResetOffset;this.delayIndex=this.delayLine.length-this.delayResetOffset;for(let i=0;i<this.delayLine.length;i++)s[i]=this.delayLine[e+i&t]}this.delayLine=s}const tt=this.delayLine,et=tt.length-1>>0;if(Z){this.delayIndex=0,this.allPassSample=0,this.allPassPrevInput=0,this.sustainFilterSample=0,this.sustainFilterPrevOutput2=0,this.sustainFilterPrevInput1=0,this.sustainFilterPrevInput2=0,this.fractionalDelaySample=0;const e=-J,i=Math.floor(e-H/2),n=Math.ceil(i+2*H);this.delayResetOffset=n;for(let t=i;t<=n;t++)tt[t&et]=0;const h=s.wave,o=h.length-1,r=o/H,a=Math.min(.2*H,.003*t.samplesPerSecond),l=Math.ceil(e),c=e+H+a,u=c;let p=(l-e)*r,d=0;for(let t=l;t<=u;t++){const s=0|p,i=s%o;let n=h[i];const l=p-s;n+=(h[i+1]-n)*l;const u=(n-d)/r,f=Math.min(1,(t-e)/a)*Math.min(1,(c-t)/a),m=f*f*(3-2*f);tt[t&et]+=u*m,d=n,p+=r}}}}class Ke{constructor(){this.noteSecondsStart=0,this.noteSecondsEnd=0,this.noteTicksStart=0,this.noteTicksEnd=0,this.noteSizeStart=e.noteSizeMax,this.noteSizeEnd=e.noteSizeMax,this.prevNoteSize=e.noteSizeMax,this.nextNoteSize=e.noteSizeMax,this.J=e.noteSizeMax,this.prevNoteSecondsStart=0,this.prevNoteSecondsEnd=0,this.prevNoteTicksStart=0,this.prevNoteTicksEnd=0,this.X=e.noteSizeMax,this.prevSlideStart=!1,this.prevSlideEnd=!1,this.nextSlideStart=!1,this.nextSlideEnd=!1,this.prevSlideRatioStart=0,this.prevSlideRatioEnd=0,this.nextSlideRatioStart=0,this.nextSlideRatioEnd=0,this.envelopeStarts=[],this.envelopeEnds=[],this.Z=[],this.tt=0,this.lowpassCutoffDecayVolumeCompensation=1;for(let t=0;t<36;t++)this.envelopeStarts[t]=1,this.envelopeEnds[t]=1;this.reset()}reset(){this.noteSecondsEnd=0,this.noteTicksEnd=0,this.J=e.noteSizeMax,this.prevNoteSecondsEnd=0,this.prevNoteTicksEnd=0,this.X=e.noteSizeMax,this.tt=0}computeEnvelopes(t,s,i,n,h){const o=t.getTransition();null==h||!h.atNoteStart||o.continues||h.forceContinueAtStart||(this.prevNoteSecondsEnd=this.noteSecondsEnd,this.prevNoteTicksEnd=this.noteTicksEnd,this.X=this.J,this.noteSecondsEnd=0,this.noteTicksEnd=0),null!=h&&(null!=h.note?this.J=h.note.pins[h.note.pins.length-1].size:this.J=e.noteSizeMax);const r=i+1,a=this.noteSecondsEnd,l=a+n,c=this.noteTicksEnd,u=c+1,p=this.prevNoteSecondsEnd,d=p+n,f=this.prevNoteTicksEnd,m=f+1,y=1/(e.ticksPerPart*e.partsPerBeat),b=y*i,w=y*r;let g=this.J,v=this.J,x=this.X,k=0,M=!1,S=!1,P=!1,I=!1,F=0,B=0,L=0,C=0;if(null!=h&&null!=h.note&&!h.passedEndOfNote){const t=h.note.getEndPinIndex(s),n=h.note.pins[t-1],a=h.note.pins[t],l=(h.note.start+n.time)*e.ticksPerPart,c=(h.note.start+a.time)*e.ticksPerPart,u=(i-l)/(c-l),p=(r-l)/(c-l);if(g=n.size+(a.size-n.size)*u,v=n.size+(a.size-n.size)*p,o.slides){const t=h.noteStartPart*e.ticksPerPart,s=h.noteEndPart*e.ticksPerPart,n=.5*(s-t),a=Math.min(n,o.slideTicks);null==h.prevNote||h.forceContinueAtStart||(i-t<a&&(M=!0,F=.5*(1-(i-t)/a)),r-t<a&&(S=!0,B=.5*(1-(r-t)/a))),null==h.nextNote||h.forceContinueAtEnd||(k=h.nextNote.pins[0].size,s-i<a&&(P=!0,L=.5*(1-(s-i)/a)),s-r<a&&(I=!0,C=.5*(1-(s-r)/a)))}}let D=1,T=!1;for(let s=0;s<=t.envelopeCount;s++){let i,n,h;if(s==t.envelopeCount){if(T)break;i=e.instrumentAutomationTargets.dictionary.noteVolume,n=0,h=e.envelopes.dictionary["note size"]}else{let o=t.envelopes[s];i=e.instrumentAutomationTargets[o.target],n=o.index,h=e.envelopes[o.envelope],0==h.type&&(T=!0)}if(null!=i.computeIndex){const e=i.computeIndex+n;let s=Ke.computeEnvelope(h,a,b,g),o=Ke.computeEnvelope(h,l,w,v);if(M){s+=(Ke.computeEnvelope(h,p,b,x)-s)*F}if(S){o+=(Ke.computeEnvelope(h,d,w,x)-o)*B}if(P){s+=(Ke.computeEnvelope(h,0,b,k)-s)*L}if(I){o+=(Ke.computeEnvelope(h,0,w,k)-o)*C}if(this.envelopeStarts[e]*=s,this.envelopeEnds[e]*=o,this.Z[this.tt++]=e,i.isFilter){const e=t.noteFilter;e.controlPointCount>n&&0==e.controlPoints[n].type&&(D=Math.max(D,Ke.getLowpassCutoffDecayVolumeCompensation(h)))}}}this.noteSecondsStart=a,this.noteSecondsEnd=l,this.noteTicksStart=c,this.noteTicksEnd=u,this.prevNoteSecondsStart=p,this.prevNoteSecondsEnd=d,this.prevNoteTicksStart=f,this.prevNoteTicksEnd=m,this.prevNoteSize=x,this.nextNoteSize=k,this.noteSizeStart=g,this.noteSizeEnd=v,this.prevSlideStart=M,this.prevSlideEnd=S,this.nextSlideStart=P,this.nextSlideEnd=I,this.prevSlideRatioStart=F,this.prevSlideRatioEnd=B,this.nextSlideRatioStart=L,this.nextSlideRatioEnd=C,this.lowpassCutoffDecayVolumeCompensation=D}clearEnvelopes(){for(let t=0;t<this.tt;t++){const e=this.Z[t];this.envelopeStarts[e]=1,this.envelopeEnds[e]=1}this.tt=0}static computeEnvelope(t,e,s,i){switch(t.type){case 0:return Xe.noteSizeToVolumeMult(i);case 1:return 1;case 4:return 1/(1+e*t.speed);case 5:return 1-1/(1+e*t.speed);case 6:return.5-.5*Math.cos(2*s*Math.PI*t.speed);case 7:return.75-.25*Math.cos(2*s*Math.PI*t.speed);case 2:return Math.max(1,2-10*e);case 3:const n=.25/Math.sqrt(t.speed);return e<n?e/n:1/(1+(e-n)*t.speed);case 8:return Math.pow(2,-t.speed*e);default:throw new Error("Unrecognized operator envelope type.")}}static getLowpassCutoffDecayVolumeCompensation(t){return 8==t.type?1.25+.025*t.speed:4==t.type?1+.02*t.speed:1}}class Ye{constructor(){this.pitches=Array(e.maxChordSize).fill(0),this.pitchCount=0,this.chordSize=0,this.drumsetPitch=null,this.note=null,this.prevNote=null,this.nextNote=null,this.prevNotePitchIndex=0,this.nextNotePitchIndex=0,this.freshlyAllocated=!0,this.atNoteStart=!1,this.isOnLastTick=!1,this.passedEndOfNote=!1,this.forceContinueAtStart=!1,this.forceContinueAtEnd=!1,this.noteStartPart=0,this.noteEndPart=0,this.ticksSinceReleased=0,this.liveInputSamplesHeld=0,this.lastInterval=0,this.noiseSample=0,this.phases=[],this.phaseDeltas=[],this.phaseDeltaScales=[],this.expression=0,this.expressionDelta=0,this.operatorExpressions=[],this.operatorExpressionDeltas=[],this.prevPitchExpressions=Array(e.maxPitchOrOperatorCount).fill(null),this.prevVibrato=null,this.prevStringDecay=null,this.pulseWidth=0,this.pulseWidthDelta=0,this.supersawDynamism=0,this.supersawDynamismDelta=0,this.supersawUnisonDetunes=[],this.supersawShape=0,this.supersawShapeDelta=0,this.supersawDelayLength=0,this.supersawDelayLengthDelta=0,this.supersawDelayLine=null,this.supersawDelayIndex=-1,this.supersawPrevPhaseDelta=null,this.pickedStrings=[],this.noteFilters=[],this.noteFilterCount=0,this.initialNoteFilterInput1=0,this.initialNoteFilterInput2=0,this.specialIntervalExpressionMult=1,this.feedbackOutputs=[],this.feedbackMult=0,this.feedbackDelta=0,this.envelopeComputer=new Ke,this.reset()}reset(){this.noiseSample=0;for(let t=0;t<e.maxPitchOrOperatorCount;t++)this.phases[t]=0,this.feedbackOutputs[t]=0,this.prevPitchExpressions[t]=null;for(let t=0;t<this.noteFilterCount;t++)this.noteFilters[t].resetOutput();this.noteFilterCount=0,this.initialNoteFilterInput1=0,this.initialNoteFilterInput2=0,this.liveInputSamplesHeld=0,this.supersawDelayIndex=-1;for(const t of this.pickedStrings)t.reset();this.envelopeComputer.reset(),this.prevVibrato=null,this.prevStringDecay=null,this.supersawPrevPhaseDelta=null,this.drumsetPitch=null}}class Je{constructor(){this.awake=!1,this.computed=!1,this.tonesAddedInThisTick=!1,this.flushingDelayLines=!1,this.deactivateAfterThisTick=!1,this.attentuationProgress=0,this.flushedSamples=0,this.activeTones=new xe,this.releasedTones=new xe,this.liveInputTones=new xe,this.type=0,this.synthesizer=null,this.wave=null,this.noisePitchFilterMult=1,this.unison=null,this.chord=null,this.effects=0,this.eqFilterVolume=1,this.eqFilterVolumeDelta=0,this.mixVolume=1,this.mixVolumeDelta=0,this.delayInputMult=0,this.delayInputMultDelta=0,this.distortion=0,this.distortionDelta=0,this.distortionDrive=0,this.distortionDriveDelta=0,this.distortionFractionalInput1=0,this.distortionFractionalInput2=0,this.distortionFractionalInput3=0,this.distortionPrevInput=0,this.distortionNextOutput=0,this.bitcrusherPrevInput=0,this.bitcrusherCurrentOutput=0,this.bitcrusherPhase=1,this.bitcrusherPhaseDelta=0,this.bitcrusherPhaseDeltaScale=1,this.bitcrusherScale=1,this.bitcrusherScaleScale=1,this.bitcrusherFoldLevel=1,this.bitcrusherFoldLevelScale=1,this.eqFilters=[],this.eqFilterCount=0,this.initialEqFilterInput1=0,this.initialEqFilterInput2=0,this.panningDelayLine=null,this.panningDelayPos=0,this.panningVolumeL=0,this.panningVolumeR=0,this.panningVolumeDeltaL=0,this.panningVolumeDeltaR=0,this.panningOffsetL=0,this.panningOffsetR=0,this.panningOffsetDeltaL=0,this.panningOffsetDeltaR=0,this.chorusDelayLineL=null,this.chorusDelayLineR=null,this.chorusDelayLineDirty=!1,this.chorusDelayPos=0,this.chorusPhase=0,this.chorusVoiceMult=0,this.chorusVoiceMultDelta=0,this.chorusCombinedMult=0,this.chorusCombinedMultDelta=0,this.echoDelayLineL=null,this.echoDelayLineR=null,this.echoDelayLineDirty=!1,this.echoDelayPos=0,this.echoDelayOffsetStart=0,this.echoDelayOffsetEnd=null,this.echoDelayOffsetRatio=0,this.echoDelayOffsetRatioDelta=0,this.echoMult=0,this.echoMultDelta=0,this.echoShelfA1=0,this.echoShelfB0=0,this.echoShelfB1=0,this.echoShelfSampleL=0,this.echoShelfSampleR=0,this.echoShelfPrevInputL=0,this.echoShelfPrevInputR=0,this.reverbDelayLine=null,this.reverbDelayLineDirty=!1,this.reverbDelayPos=0,this.reverbMult=0,this.reverbMultDelta=0,this.reverbShelfA1=0,this.reverbShelfB0=0,this.reverbShelfB1=0,this.reverbShelfSample0=0,this.reverbShelfSample1=0,this.reverbShelfSample2=0,this.reverbShelfSample3=0,this.reverbShelfPrevInput0=0,this.reverbShelfPrevInput1=0,this.reverbShelfPrevInput2=0,this.reverbShelfPrevInput3=0,this.spectrumWave=new Ae,this.harmonicsWave=new Ue,this.drumsetSpectrumWaves=[];for(let t=0;t<e.drumCount;t++)this.drumsetSpectrumWaves[t]=new Ae}allocateNecessaryBuffers(t,s,i){if(b(s.effects)&&(null==this.panningDelayLine||this.panningDelayLine.length<t.panningDelayBufferSize)&&(this.panningDelayLine=new Float32Array(t.panningDelayBufferSize)),w(s.effects)&&((null==this.chorusDelayLineL||this.chorusDelayLineL.length<t.chorusDelayBufferSize)&&(this.chorusDelayLineL=new Float32Array(t.chorusDelayBufferSize)),(null==this.chorusDelayLineR||this.chorusDelayLineR.length<t.chorusDelayBufferSize)&&(this.chorusDelayLineR=new Float32Array(t.chorusDelayBufferSize))),g(s.effects)){const t=Math.max(e.echoDelayRange>>1,s.echoDelay+1),n=2*Xe.fittingPowerOfTwo(t*e.echoDelayStepTicks*i);if(null==this.echoDelayLineL||null==this.echoDelayLineR)this.echoDelayLineL=new Float32Array(n),this.echoDelayLineR=new Float32Array(n);else if(this.echoDelayLineL.length<n||this.echoDelayLineR.length<n){const t=new Float32Array(n),e=new Float32Array(n),s=this.echoDelayLineL.length-1;for(let i=0;i<this.echoDelayLineL.length;i++)t[i]=this.echoDelayLineL[this.echoDelayPos+i&s],e[i]=this.echoDelayLineL[this.echoDelayPos+i&s];this.echoDelayPos=this.echoDelayLineL.length,this.echoDelayLineL=t,this.echoDelayLineR=e}}v(s.effects)&&null==this.reverbDelayLine&&(this.reverbDelayLine=new Float32Array(e.reverbDelayBufferSize))}deactivate(){this.bitcrusherPrevInput=0,this.bitcrusherCurrentOutput=0,this.bitcrusherPhase=1;for(let t=0;t<this.eqFilterCount;t++)this.eqFilters[t].resetOutput();if(this.eqFilterCount=0,this.initialEqFilterInput1=0,this.initialEqFilterInput2=0,this.distortionFractionalInput1=0,this.distortionFractionalInput2=0,this.distortionFractionalInput3=0,this.distortionPrevInput=0,this.distortionNextOutput=0,this.panningDelayPos=0,null!=this.panningDelayLine)for(let t=0;t<this.panningDelayLine.length;t++)this.panningDelayLine[t]=0;this.echoDelayOffsetEnd=null,this.echoShelfSampleL=0,this.echoShelfSampleR=0,this.echoShelfPrevInputL=0,this.echoShelfPrevInputR=0,this.reverbShelfSample0=0,this.reverbShelfSample1=0,this.reverbShelfSample2=0,this.reverbShelfSample3=0,this.reverbShelfPrevInput0=0,this.reverbShelfPrevInput1=0,this.reverbShelfPrevInput2=0,this.reverbShelfPrevInput3=0,this.awake=!1,this.flushingDelayLines=!1,this.deactivateAfterThisTick=!1,this.attentuationProgress=0,this.flushedSamples=0}resetAllEffects(){if(this.deactivate(),this.chorusDelayLineDirty){for(let t=0;t<this.chorusDelayLineL.length;t++)this.chorusDelayLineL[t]=0;for(let t=0;t<this.chorusDelayLineR.length;t++)this.chorusDelayLineR[t]=0}if(this.echoDelayLineDirty){for(let t=0;t<this.echoDelayLineL.length;t++)this.echoDelayLineL[t]=0;for(let t=0;t<this.echoDelayLineR.length;t++)this.echoDelayLineR[t]=0}if(this.reverbDelayLineDirty)for(let t=0;t<this.reverbDelayLine.length;t++)this.reverbDelayLine[t]=0;this.chorusPhase=0}compute(t,s,i,n,h){this.computed=!0,this.type=s.type,this.synthesizer=Xe.getInstrumentSynthFunction(s),this.unison=e.unisons[s.unison],this.chord=s.getChord(),this.noisePitchFilterMult=e.chipNoises[s.chipNoise].pitchFilterMult;let o=s.effects;0==s.distortion&&(o&=-9),s.pan==e.panCenter&&(o&=-5),0==s.chorus&&(o&=-3),0==s.echoSustain&&(o&=-65),0==s.reverb&&(o&=-2),this.effects=o,this.allocateNecessaryBuffers(t,s,i);const r=t.samplesPerSecond;this.updateWaves(s,r);const a=m(o),l=y(o),c=b(o),u=w(o),p=g(o),d=v(o);if(a){const t=Math.min(1,s.distortion/(e.distortionRange-1)),i=Math.min(1,s.distortion/(e.distortionRange-1)),h=Math.pow(1-.895*(Math.pow(20,t)-1)/19,2),o=Math.pow(1-.895*(Math.pow(20,i)-1)/19,2),r=(1+2*t)/e.distortionBaseVolume,a=(1+2*i)/e.distortionBaseVolume;this.distortion=h,this.distortionDelta=(o-h)/n,this.distortionDrive=r,this.distortionDriveDelta=(a-r)/n}if(l){const i=s.bitcrusherFreq,h=s.bitcrusherFreq,o=s.bitcrusherQuantization,a=s.bitcrusherQuantization,l=e.keys[t.song.key].basePitch,c=je.frequencyFromPitch(l+60)*Math.pow(2,(e.bitcrusherFreqRange-1-i)*e.bitcrusherOctaveStep),u=je.frequencyFromPitch(l+60)*Math.pow(2,(e.bitcrusherFreqRange-1-h)*e.bitcrusherOctaveStep),p=Math.min(1,c/r),d=Math.min(1,u/r);this.bitcrusherPhaseDelta=p,this.bitcrusherPhaseDeltaScale=Math.pow(d/p,1/n);const f=2*e.bitcrusherBaseVolume*Math.pow(2,1-Math.pow(2,.5*(e.bitcrusherQuantizationRange-1-o))),m=2*e.bitcrusherBaseVolume*Math.pow(2,1-Math.pow(2,.5*(e.bitcrusherQuantizationRange-1-a)));this.bitcrusherScale=f,this.bitcrusherScaleScale=Math.pow(m/f,1/n);const y=2*e.bitcrusherBaseVolume*Math.pow(1.5,e.bitcrusherQuantizationRange-1-o),b=2*e.bitcrusherBaseVolume*Math.pow(1.5,e.bitcrusherQuantizationRange-1-a);this.bitcrusherFoldLevel=y,this.bitcrusherFoldLevelScale=Math.pow(b/y,1/n)}let f=1;const x=s.eqFilter;for(let t=0;t<x.controlPointCount;t++){const e=x.controlPoints[t];e.toCoefficients(Xe.tempFilterStartCoefficients,r,1,1),e.toCoefficients(Xe.tempFilterEndCoefficients,r,1,1),this.eqFilters.length<=t&&(this.eqFilters[t]=new Se),this.eqFilters[t].loadCoefficientsWithGradient(Xe.tempFilterStartCoefficients,Xe.tempFilterEndCoefficients,1/n,0==e.type),f*=e.getVolumeCompensationMult()}this.eqFilterCount=x.controlPointCount,f=Math.min(3,f);const k=Xe.instrumentVolumeToVolumeMult(s.volume);this.mixVolume=k;const M=k;this.mixVolumeDelta=(M-this.mixVolume)/n;let S=f,P=f,I=1,F=1;if(c){const i=(s.pan-e.panCenter)/e.panCenter,h=Math.max(-1,Math.min(1,i)),o=Math.max(-1,Math.min(1,i)),a=1.414*Math.cos((1+h)*Math.PI*.25),l=1.414*Math.cos((1-h)*Math.PI*.25),c=1.414*Math.cos((1+o)*Math.PI*.25),u=1.414*Math.cos((1-o)*Math.PI*.25),p=r*e.panDelaySecondsMax,d=h*p,f=o*p,m=Math.max(0,d),y=Math.max(0,-d),b=Math.max(0,f),w=Math.max(0,-f);this.panningVolumeL=a,this.panningVolumeR=l,this.panningVolumeDeltaL=(c-a)/n,this.panningVolumeDeltaR=(u-l)/n,this.panningOffsetL=this.panningDelayPos-m+t.panningDelayBufferSize,this.panningOffsetR=this.panningDelayPos-y+t.panningDelayBufferSize,this.panningOffsetDeltaL=(b-m)/n,this.panningOffsetDeltaR=(w-y)/n}if(u){let t=Math.min(1,s.chorus/(e.chorusRange-1)),i=Math.min(1,s.chorus/(e.chorusRange-1));t=.6*t+.4*Math.pow(t,6),i=.6*i+.4*Math.pow(i,6);const h=1/Math.sqrt(3*t*t+1),o=1/Math.sqrt(3*i*i+1);this.chorusVoiceMult=t,this.chorusVoiceMultDelta=(i-t)/n,this.chorusCombinedMult=h,this.chorusCombinedMultDelta=(o-h)/n}let B=0,L=0;if(p){const h=.9*Math.min(1,Math.pow(s.echoSustain/e.echoSustainRange,1.1)),o=.9*Math.min(1,Math.pow(s.echoSustain/e.echoSustainRange,1.1));this.echoMult=h,this.echoMultDelta=(o-h)/n,B=Math.max(h,o);const a=Math.round((s.echoDelay+1)*e.echoDelayStepTicks*i);null!=this.echoDelayOffsetEnd?this.echoDelayOffsetStart=this.echoDelayOffsetEnd:this.echoDelayOffsetStart=a,this.echoDelayOffsetEnd=a,L=.5*(this.echoDelayOffsetStart+this.echoDelayOffsetEnd)/r,this.echoDelayOffsetRatio=0,this.echoDelayOffsetRatioDelta=1/n;const l=2*Math.PI*e.echoShelfHz/t.samplesPerSecond;Xe.tempFilterStartCoefficients.highShelf1stOrder(l,e.echoShelfGain),this.echoShelfA1=Xe.tempFilterStartCoefficients.a[1],this.echoShelfB0=Xe.tempFilterStartCoefficients.b[0],this.echoShelfB1=Xe.tempFilterStartCoefficients.b[1]}let C=0;if(d){const i=.425*Math.min(1,Math.pow(s.reverb/e.reverbRange,.667)),h=.425*Math.min(1,Math.pow(s.reverb/e.reverbRange,.667));this.reverbMult=i,this.reverbMultDelta=(h-i)/n,C=Math.max(i,h);const o=2*Math.PI*e.reverbShelfHz/t.samplesPerSecond;Xe.tempFilterStartCoefficients.highShelf1stOrder(o,e.reverbShelfGain),this.reverbShelfA1=Xe.tempFilterStartCoefficients.a[1],this.reverbShelfB0=Xe.tempFilterStartCoefficients.b[0],this.reverbShelfB1=Xe.tempFilterStartCoefficients.b[1]}if(this.tonesAddedInThisTick)this.attentuationProgress=0,this.flushedSamples=0,this.flushingDelayLines=!1;else if(this.flushingDelayLines){S=0,P=0,I=0,F=0;let s=0;u&&(s+=t.chorusDelayBufferSize),p&&(s+=this.echoDelayLineL.length),d&&(s+=e.reverbDelayBufferSize),this.flushedSamples+=n,this.flushedSamples>=s&&(this.deactivateAfterThisTick=!0)}else{0==this.attentuationProgress||(S=0),P=0;const t=1/256,s=-Math.log2(t);let n=0;if(u&&(n+=e.chorusMaxDelay),p){const t=Math.pow(B,1/L);n+=-1/Math.log2(t)*s}if(d){const t=2*C,i=e.reverbDelayBufferSize/4/r,h=Math.pow(t,1/i);n+=-1/Math.log2(h)*s}const h=i/r/n,o=this.attentuationProgress+h;o>=1&&(F=0),this.attentuationProgress=o,this.attentuationProgress>=1&&(this.flushingDelayLines=!0)}this.eqFilterVolume=S,this.eqFilterVolumeDelta=(P-S)/n,this.delayInputMult=I,this.delayInputMultDelta=(F-I)/n}updateWaves(t,s){if(0==t.type)this.wave=e.chipWaves[t.chipWave].samples;else if(2==t.type)this.wave=h(t.chipNoise,ve,we);else if(5==t.type)this.wave=this.harmonicsWave.getCustomWave(t.harmonicsWave,t.type);else if(7==t.type)this.wave=this.harmonicsWave.getCustomWave(t.harmonicsWave,t.type);else if(3==t.type)this.wave=this.spectrumWave.getCustomWave(t.spectrumWave,8);else if(4==t.type){for(let s=0;s<e.drumCount;s++)this.drumsetSpectrumWaves[s].getCustomWave(t.drumsetSpectrumWaves[s],Je.et(s));this.wave=null}else this.wave=null}getDrumsetWave(t){if(4==this.type)return this.drumsetSpectrumWaves[t].wave;throw new Error("Unhandled instrument type in getDrumsetWave")}static drumsetIndexReferenceDelta(t){return je.frequencyFromPitch(e.spectrumBasePitch+6*t)/44100}static et(t){return 15+Math.log2(Je.drumsetIndexReferenceDelta(t))}}class Qe{constructor(){this.instruments=[],this.muted=!1,this.singleSeamlessInstrument=null}}class Xe{syncSongState(){const t=this.song.getChannelCount();for(let e=this.channels.length;e<t;e++)this.channels[e]=new Qe;this.channels.length=t;for(let e=0;e<t;e++){const t=this.song.channels[e],s=this.channels[e];for(let e=s.instruments.length;e<t.instruments.length;e++)s.instruments[e]=new Je;if(s.instruments.length=t.instruments.length,s.muted!=t.muted&&(s.muted=t.muted,s.muted))for(const t of s.instruments)t.resetAllEffects()}}warmUpSynthesizer(t){if(null!=t){this.syncSongState();const e=this.getSamplesPerTick();for(let s=0;s<t.getChannelCount();s++)for(let i=0;i<t.channels[s].instruments.length;i++){const n=t.channels[s].instruments[i],h=this.channels[s].instruments[i];Xe.getInstrumentSynthFunction(n),h.updateWaves(n,this.samplesPerSecond),h.allocateNecessaryBuffers(this,n,e)}}}static operatorAmplitudeCurve(t){return(Math.pow(16,t/15)-1)/15}get playing(){return this.isPlayingSong}get recording(){return this.isRecording}get playhead(){return this.playheadInternal}set playhead(t){if(null!=this.song){this.playheadInternal=Math.max(0,Math.min(this.song.barCount,t));let s=this.playheadInternal;this.bar=Math.floor(s),s=this.song.beatsPerBar*(s-this.bar),this.beat=Math.floor(s),s=e.partsPerBeat*(s-this.beat),this.part=Math.floor(s),s=e.ticksPerPart*(s-this.part),this.tick=Math.floor(s),this.tickSampleCountdown=0,this.isAtStartOfTick=!0,this.prevBar=null}}getSamplesPerBar(){if(null==this.song)throw new Error;return this.getSamplesPerTick()*e.ticksPerPart*e.partsPerBeat*this.song.beatsPerBar}getTicksIntoBar(){return(this.beat*e.partsPerBeat+this.part)*e.ticksPerPart+this.tick}getCurrentPart(){return this.beat*e.partsPerBeat+this.part}getTotalBars(t,e){if(null==this.song)throw new Error;let s=this.song.loopLength*(this.loopRepeatCount+1);return t&&(s+=this.song.loopStart),e&&(s+=this.song.barCount-(this.song.loopStart+this.song.loopLength)),s}constructor(t=null){this.samplesPerSecond=44100,this.song=null,this.preferLowerLatency=!1,this.anticipatePoorPerformance=!1,this.liveInputDuration=0,this.liveInputStarted=!1,this.liveInputPitches=[],this.liveInputChannel=0,this.liveInputInstruments=[],this.loopRepeatCount=-1,this.volume=1,this.enableMetronome=!1,this.countInMetronome=!1,this.playheadInternal=0,this.bar=0,this.prevBar=null,this.nextBar=null,this.beat=0,this.part=0,this.tick=0,this.isAtStartOfTick=!0,this.tickSampleCountdown=0,this.isPlayingSong=!1,this.isRecording=!1,this.liveInputEndTime=0,this.browserAutomaticallyClearsAudioBuffer=!0,this.tempDrumSetControlPoint=new qe,this.tempFrequencyResponse=new Me,this.channels=[],this.tonePool=new xe,this.tempMatchedPitchTones=Array(e.maxChordSize).fill(null),this.startedMetronome=!1,this.metronomeSamplesRemaining=-1,this.metronomeAmplitude=0,this.metronomePrevAmplitude=0,this.metronomeFilter=0,this.limit=0,this.tempMonoInstrumentSampleBuffer=null,this.audioCtx=null,this.scriptNode=null,this.audioProcessCallback=t=>{const e=t.outputBuffer,s=e.getChannelData(0),i=e.getChannelData(1);if(!this.browserAutomaticallyClearsAudioBuffer||0==s[0]&&0==i[0]&&0==s[e.length-1]&&0==i[e.length-1]||(this.browserAutomaticallyClearsAudioBuffer=!1),!this.browserAutomaticallyClearsAudioBuffer){const t=e.length;for(let e=0;e<t;e++)s[e]=0,i[e]=0}!this.isPlayingSong&&performance.now()>=this.liveInputEndTime?this.deactivateAudio():this.synthesize(s,i,e.length,this.isPlayingSong)},this.computeDelayBufferSizes(),null!=t&&this.setSong(t)}setSong(t){"string"==typeof t?this.song=new We(t):t instanceof We&&(this.song=t),this.prevBar=null}computeDelayBufferSizes(){this.panningDelayBufferSize=Xe.fittingPowerOfTwo(this.samplesPerSecond*e.panDelaySecondsMax),this.panningDelayBufferMask=this.panningDelayBufferSize-1,this.chorusDelayBufferSize=Xe.fittingPowerOfTwo(this.samplesPerSecond*e.chorusMaxDelay),this.chorusDelayBufferMask=this.chorusDelayBufferSize-1}activateAudio(){const t=this.anticipatePoorPerformance?this.preferLowerLatency?2048:4096:this.preferLowerLatency?512:2048;if(null==this.audioCtx||null==this.scriptNode||this.scriptNode.bufferSize!=t){null!=this.scriptNode&&this.deactivateAudio();const e=this.anticipatePoorPerformance?this.preferLowerLatency?"balanced":"playback":this.preferLowerLatency?"interactive":"balanced";this.audioCtx=this.audioCtx||new(window.AudioContext||window.webkitAudioContext)({latencyHint:e}),this.samplesPerSecond=this.audioCtx.sampleRate,this.scriptNode=this.audioCtx.createScriptProcessor?this.audioCtx.createScriptProcessor(t,0,2):this.audioCtx.createJavaScriptNode(t,0,2),this.scriptNode.onaudioprocess=this.audioProcessCallback,this.scriptNode.channelCountMode="explicit",this.scriptNode.channelInterpretation="speakers",this.scriptNode.connect(this.audioCtx.destination),this.computeDelayBufferSizes()}this.audioCtx.resume()}deactivateAudio(){null!=this.audioCtx&&null!=this.scriptNode&&(this.scriptNode.disconnect(this.audioCtx.destination),this.scriptNode=null,this.audioCtx.close&&this.audioCtx.close(),this.audioCtx=null)}maintainLiveInput(){this.activateAudio(),this.liveInputEndTime=performance.now()+1e4}play(){this.isPlayingSong||(this.isPlayingSong=!0,this.warmUpSynthesizer(this.song),this.activateAudio())}pause(){this.isPlayingSong&&(this.isPlayingSong=!1,this.isRecording=!1)}startRecording(){this.preferLowerLatency=!0,this.isRecording=!0,this.play()}snapToStart(){this.bar=0,this.snapToBar()}goToBar(t){this.bar=t,this.playheadInternal=this.bar,this.prevBar=null}snapToBar(){this.playheadInternal=this.bar,this.beat=0,this.part=0,this.tick=0,this.tickSampleCountdown=0,this.isAtStartOfTick=!0,this.prevBar=null}resetEffects(){if(this.limit=0,this.freeAllTones(),null!=this.song)for(const t of this.channels)for(const e of t.instruments)e.resetAllEffects()}jumpIntoLoop(){if(this.song&&(this.bar<this.song.loopStart||this.bar>=this.song.loopStart+this.song.loopLength)){const t=this.bar;this.bar=this.song.loopStart,this.playheadInternal+=this.bar-t,this.prevBar=null}}goToNextBar(){if(!this.song)return;this.prevBar=this.bar;const t=this.bar;this.bar++,this.bar>=this.song.barCount&&(this.bar=0),this.playheadInternal+=this.bar-t}goToPrevBar(){if(!this.song)return;this.prevBar=null;const t=this.bar;this.bar--,(this.bar<0||this.bar>=this.song.barCount)&&(this.bar=this.song.barCount-1),this.playheadInternal+=this.bar-t}getNextBar(){let t=this.bar+1;return this.isRecording?t>=this.song.barCount&&(t=this.song.barCount-1):0!=this.loopRepeatCount&&t==this.song.loopStart+this.song.loopLength&&(t=this.song.loopStart),t}synthesize(t,s,i,n=!0){if(null==this.song){for(let e=0;e<i;e++)t[e]=0,s[e]=0;return void this.deactivateAudio()}const h=this.song,o=this.getSamplesPerTick();let r=!1;(this.tickSampleCountdown<=0||this.tickSampleCountdown>o)&&(this.tickSampleCountdown=o,this.isAtStartOfTick=!0),n&&(this.beat>=h.beatsPerBar&&(this.beat=0,this.part=0,this.tick=0,this.tickSampleCountdown=o,this.isAtStartOfTick=!0,this.prevBar=this.bar,this.bar=this.getNextBar(),this.bar<=this.prevBar&&this.loopRepeatCount>0&&this.loopRepeatCount--),this.bar>=h.barCount&&(this.bar=0,-1!=this.loopRepeatCount&&(r=!0,this.pause()))),this.syncSongState(),(null==this.tempMonoInstrumentSampleBuffer||this.tempMonoInstrumentSampleBuffer.length<i)&&(this.tempMonoInstrumentSampleBuffer=new Float32Array(i));const a=+this.volume,l=1-Math.pow(.5,4/this.samplesPerSecond),c=1-Math.pow(.5,4e3/this.samplesPerSecond);let u=+this.limit,p=0;for(;p<i&&!r;){this.nextBar=this.getNextBar(),this.nextBar>=h.barCount&&(this.nextBar=null);const d=i-p,f=Math.ceil(this.tickSampleCountdown),m=Math.min(f,d),y=p+m;for(let i=0;i<h.getChannelCount();i++){const r=h.channels[i],a=this.channels[i];this.isAtStartOfTick&&(this.determineCurrentActiveTones(h,i,o,n&&!this.countInMetronome),this.determineLiveInputTones(h,i,o));for(let n=0;n<r.instruments.length;n++){const l=r.instruments[n],c=a.instruments[n];if(this.isAtStartOfTick){let t=c.activeTones.count()+c.liveInputTones.count();for(let s=0;s<c.releasedTones.count();s++){const n=c.releasedTones.get(s);if(n.ticksSinceReleased>=Math.abs(l.getFadeOutTicks())){this.freeReleasedTone(c,s),s--;continue}const r=t>=e.maximumTonesPerChannel;this.computeTone(h,i,o,n,!0,r),t++}c.awake&&(c.computed||c.compute(this,l,o,Math.ceil(o),null),c.computed=!1)}for(let t=0;t<c.activeTones.count();t++){const e=c.activeTones.get(t);this.playTone(i,p,m,e)}for(let t=0;t<c.liveInputTones.count();t++){const e=c.liveInputTones.get(t);this.playTone(i,p,m,e)}for(let t=0;t<c.releasedTones.count();t++){const e=c.releasedTones.get(t);this.playTone(i,p,m,e)}c.awake&&Xe.effectsSynth(this,t,s,p,m,c)}}if(this.enableMetronome||this.countInMetronome)if(0==this.part){if(!this.startedMetronome){const t=h.beatsPerBar>4&&h.beatsPerBar%2==0&&this.beat==h.beatsPerBar/2,e=0==this.beat?8:t?6:4,s=0==this.beat?1600:t?1200:800,i=0==this.beat?.06:t?.05:.04,n=this.samplesPerSecond/s,o=2*Math.PI/n;this.metronomeSamplesRemaining=Math.floor(n*e),this.metronomeFilter=2*Math.cos(o),this.metronomeAmplitude=i*Math.sin(o),this.metronomePrevAmplitude=0,this.startedMetronome=!0}if(this.metronomeSamplesRemaining>0){const e=Math.min(y,p+this.metronomeSamplesRemaining);this.metronomeSamplesRemaining-=e-p;for(let i=p;i<e;i++){t[i]+=this.metronomeAmplitude,s[i]+=this.metronomeAmplitude;const e=this.metronomeFilter*this.metronomeAmplitude-this.metronomePrevAmplitude;this.metronomePrevAmplitude=this.metronomeAmplitude,this.metronomeAmplitude=e}}}else this.startedMetronome=!1;for(let e=p;e<y;e++){const i=t[e],n=s[e],h=Math.max(Math.abs(i),Math.abs(n));u+=(h-u)*(u<h?c:l*(1+u));const o=a/(u>=1?1.05*u:.8*u+.25);t[e]=i*o,s[e]=n*o}if(p+=m,this.isAtStartOfTick=!1,this.tickSampleCountdown-=m,this.tickSampleCountdown<=0){this.isAtStartOfTick=!0;for(const t of this.channels)for(const e of t.instruments){for(let t=0;t<e.releasedTones.count();t++){const s=e.releasedTones.get(t);s.isOnLastTick?(this.freeReleasedTone(e,t),t--):s.ticksSinceReleased++}e.deactivateAfterThisTick&&e.deactivate(),e.tonesAddedInThisTick=!1}this.tick++,this.tickSampleCountdown+=o,this.tick==e.ticksPerPart&&(this.tick=0,this.part++,this.liveInputDuration--,this.part==e.partsPerBeat&&(this.part=0,n&&(this.beat++,this.beat==h.beatsPerBar&&(this.beat=0,this.countInMetronome?this.countInMetronome=!1:(this.prevBar=this.bar,this.bar=this.getNextBar(),this.bar<=this.prevBar&&this.loopRepeatCount>0&&this.loopRepeatCount--,this.bar>=h.barCount&&(this.bar=0,-1!=this.loopRepeatCount&&(r=!0,this.resetEffects(),this.pause())))))))}}(!Number.isFinite(u)||Math.abs(u)<Ie)&&(u=0),this.limit=u,n&&!this.countInMetronome&&(this.playheadInternal=(((this.tick+1-this.tickSampleCountdown/o)/2+this.part)/e.partsPerBeat+this.beat)/h.beatsPerBar+this.bar)}freeTone(t){this.tonePool.pushBack(t)}newTone(){if(this.tonePool.count()>0){const t=this.tonePool.popBack();return t.freshlyAllocated=!0,t}return new Ye}releaseTone(t,e){t.releasedTones.pushFront(e),e.atNoteStart=!1,e.passedEndOfNote=!0}freeReleasedTone(t,e){this.freeTone(t.releasedTones.get(e)),t.releasedTones.remove(e)}freeAllTones(){for(const t of this.channels)for(const e of t.instruments){for(;e.activeTones.count()>0;)this.freeTone(e.activeTones.popBack());for(;e.releasedTones.count()>0;)this.freeTone(e.releasedTones.popBack());for(;e.liveInputTones.count()>0;)this.freeTone(e.liveInputTones.popBack())}}determineLiveInputTones(t,e,s){const i=t.channels[e],n=this.channels[e],h=this.liveInputPitches;for(let o=0;o<i.instruments.length;o++){const r=n.instruments[o],a=r.liveInputTones;let l=0;if(this.liveInputDuration>0&&e==this.liveInputChannel&&h.length>0&&-1!=this.liveInputInstruments.indexOf(o)){const n=i.instruments[o];if(n.getChord().singleTone){let i;a.count()<=l?(i=this.newTone(),a.pushBack(i)):!n.getTransition().isSeamless&&this.liveInputStarted?(this.releaseTone(r,a.get(l)),i=this.newTone(),a.set(l,i)):i=a.get(l),l++;for(let t=0;t<h.length;t++)i.pitches[t]=h[t];i.pitchCount=h.length,i.chordSize=1,i.instrumentIndex=o,i.note=i.prevNote=i.nextNote=null,i.atNoteStart=this.liveInputStarted,i.forceContinueAtStart=!1,i.forceContinueAtEnd=!1,this.computeTone(t,e,s,i,!1,!1)}else{this.moveTonesIntoOrderedTempMatchedList(a,h);for(let i=0;i<h.length;i++){let n;null!=this.tempMatchedPitchTones[l]?(n=this.tempMatchedPitchTones[l],this.tempMatchedPitchTones[l]=null,1==n.pitchCount&&n.pitches[0]==h[i]||(this.releaseTone(r,n),n=this.newTone()),a.pushBack(n)):(n=this.newTone(),a.pushBack(n)),l++,n.pitches[0]=h[i],n.pitchCount=1,n.chordSize=h.length,n.instrumentIndex=o,n.note=n.prevNote=n.nextNote=null,n.atNoteStart=this.liveInputStarted,n.forceContinueAtStart=!1,n.forceContinueAtEnd=!1,this.computeTone(t,e,s,n,!1,!1)}}}for(;a.count()>l;)this.releaseTone(r,a.popBack());this.clearTempMatchedPitchTones(l,r)}this.liveInputStarted=!1}adjacentPatternHasCompatibleInstrumentTransition(t,e,s,i,n,h,o,r,a,l){if(t.patternInstruments&&-1==i.instruments.indexOf(n)){if(s.instruments.length>1||i.instruments.length>1)return null;const t=e.instruments[i.instruments[0]];if(l)return t.getChord();const n=t.getTransition();return h.includeAdjacentPatterns&&n.includeAdjacentPatterns&&n.slides==h.slides?t.getChord():null}return l||h.includeAdjacentPatterns?o:null}static adjacentNotesHaveMatchingPitches(t,e){if(t.pitches.length!=e.pitches.length)return!1;const s=t.pins[t.pins.length-1].interval;for(const i of t.pitches)if(-1==e.pitches.indexOf(i+s))return!1;return!0}moveTonesIntoOrderedTempMatchedList(t,e){for(let s=0;s<t.count();s++){const i=t.get(s),n=i.pitches[0]+i.lastInterval;for(let h=0;h<e.length;h++)if(e[h]==n){this.tempMatchedPitchTones[h]=i,t.remove(s),s--;break}}for(;t.count()>0;){const e=t.popFront();for(let t=0;t<this.tempMatchedPitchTones.length;t++)if(null==this.tempMatchedPitchTones[t]){this.tempMatchedPitchTones[t]=e;break}}}determineCurrentActiveTones(t,s,i,n){const h=t.channels[s],o=this.channels[s],r=t.getPattern(s,this.bar),a=this.getCurrentPart(),l=this.tick+e.ticksPerPart*a;let c=null,u=null,p=null;if(n&&null!=r&&!h.muted&&(!this.isRecording||this.liveInputChannel!=s)){for(let t=0;t<r.notes.length;t++)if(r.notes[t].end<=a)u=r.notes[t];else if(r.notes[t].start<=a&&r.notes[t].end>a)c=r.notes[t];else if(r.notes[t].start>a){p=r.notes[t];break}null!=c&&(null!=u&&u.end!=c.start&&(u=null),null!=p&&p.start!=c.end&&(p=null))}if(null!=r&&(!t.layeredInstruments||1==h.instruments.length||t.patternInstruments&&1==r.instruments.length)){const e=t.patternInstruments?r.instruments[0]:0;if(null!=o.singleSeamlessInstrument&&o.singleSeamlessInstrument!=e&&o.singleSeamlessInstrument<o.instruments.length){const t=o.instruments[o.singleSeamlessInstrument],s=o.instruments[e];for(;t.activeTones.count()>0;)s.activeTones.pushFront(t.activeTones.popBack())}o.singleSeamlessInstrument=e}else o.singleSeamlessInstrument=null;for(let n=0;n<h.instruments.length;n++){const d=o.instruments[n],f=d.activeTones;let m=0;if(null!=c&&(!t.patternInstruments||-1!=r.instruments.indexOf(n))){const o=h.instruments[n];let y=u,b=p;const w=e.partsPerBeat*t.beatsPerBar,g=o.getTransition(),v=o.getChord();let x=!1,k=!1,M=0,S=0;if(0==c.start){let e=null==this.prevBar?null:t.getPattern(s,this.prevBar);if(null!=e){const s=e.notes.length<=0?null:e.notes[e.notes.length-1];if(null!=s&&s.end==w){const i=c.continuesLastPattern&&Xe.adjacentNotesHaveMatchingPitches(s,c),o=this.adjacentPatternHasCompatibleInstrumentTransition(t,h,r,e,n,g,v,c,s,i);null!=o&&(y=s,M=o.singleTone?1:y.pitches.length,x=i)}}}else null!=y&&(M=v.singleTone?1:y.pitches.length);if(c.end==w){let e=null==this.nextBar?null:t.getPattern(s,this.nextBar);if(null!=e){const s=e.notes.length<=0?null:e.notes[0];if(null!=s&&0==s.start){const i=s.continuesLastPattern&&Xe.adjacentNotesHaveMatchingPitches(c,s),o=this.adjacentPatternHasCompatibleInstrumentTransition(t,h,r,e,n,g,v,c,s,i);null!=o&&(b=s,S=o.singleTone?1:b.pitches.length,k=i)}}}else null!=b&&(S=v.singleTone?1:b.pitches.length);if(v.singleTone){const h=e.ticksPerPart*c.start==l;let o;if(f.count()<=m)o=this.newTone(),f.pushBack(o);else if(!h||(g.isSeamless||x)&&null!=y)o=f.get(m);else{const t=f.get(m);t.isOnLastTick?this.freeTone(t):this.releaseTone(d,t),o=this.newTone(),f.set(m,o)}m++;for(let t=0;t<c.pitches.length;t++)o.pitches[t]=c.pitches[t];o.pitchCount=c.pitches.length,o.chordSize=1,o.instrumentIndex=n,o.note=c,o.noteStartPart=c.start,o.noteEndPart=c.end,o.prevNote=y,o.nextNote=b,o.prevNotePitchIndex=0,o.nextNotePitchIndex=0,o.atNoteStart=h,o.passedEndOfNote=!1,o.forceContinueAtStart=x,o.forceContinueAtEnd=k,this.computeTone(t,s,i,o,!1,!1)}else{const h=o.getTransition();(h.isSeamless&&!h.slides&&0==v.strumParts||x)&&e.ticksPerPart*c.start==l&&null!=y&&this.moveTonesIntoOrderedTempMatchedList(f,c.pitches);let r=0;for(let o=0;o<c.pitches.length;o++){let u=M>o?y:null,p=c,w=S>o?b:null,g=p.start+r,P=!1;if(g>a){if(!(f.count()>o&&(h.isSeamless||x)&&null!=u))break;w=p,p=u,u=null,g=p.start+r,P=!0}let I=p.end;(h.isSeamless||x)&&null!=w&&(I=Math.min(e.partsPerBeat*this.song.beatsPerBar,I+r)),(h.continues||x)&&null!=u||(r+=v.strumParts);const F=e.ticksPerPart*g==l;let B;if(null!=this.tempMatchedPitchTones[m])B=this.tempMatchedPitchTones[m],this.tempMatchedPitchTones[m]=null,f.pushBack(B);else if(f.count()<=m)B=this.newTone(),f.pushBack(B);else if(!F||(h.isSeamless||x)&&null!=u)B=f.get(m);else{const t=f.get(m);t.isOnLastTick?this.freeTone(t):this.releaseTone(d,t),B=this.newTone(),f.set(m,B)}m++,B.pitches[0]=p.pitches[o],B.pitchCount=1,B.chordSize=p.pitches.length,B.instrumentIndex=n,B.note=p,B.noteStartPart=g,B.noteEndPart=I,B.prevNote=u,B.nextNote=w,B.prevNotePitchIndex=o,B.nextNotePitchIndex=o,B.atNoteStart=F,B.passedEndOfNote=P,B.forceContinueAtStart=x&&null!=u,B.forceContinueAtEnd=k&&null!=w,this.computeTone(t,s,i,B,!1,!1)}}}for(;f.count()>m;){const e=f.popBack(),i=t.channels[s];if(e.instrumentIndex<i.instruments.length&&!e.isOnLastTick){const t=o.instruments[e.instrumentIndex];this.releaseTone(t,e)}else this.freeTone(e)}this.clearTempMatchedPitchTones(m,d)}}clearTempMatchedPitchTones(t,e){for(let s=t;s<this.tempMatchedPitchTones.length;s++){const t=this.tempMatchedPitchTones[s];null!=t&&(t.isOnLastTick?this.freeTone(t):this.releaseTone(e,t),this.tempMatchedPitchTones[s]=null)}}playTone(t,e,s,i){const n=this.channels[t].instruments[i.instrumentIndex];n.synthesizer(this,e,s,i,n),i.envelopeComputer.clearEnvelopes()}static computeChordExpression(t){return 1/(.25*(t-1)+1)}computeTone(t,s,i,h,o,a){const l=Math.ceil(i),c=t.channels[s],m=this.channels[s],y=c.instruments[h.instrumentIndex],b=m.instruments[h.instrumentIndex];b.awake=!0,b.tonesAddedInThisTick=!0,b.computed||b.compute(this,y,i,l,h);const w=t.getChannelIsNoise(s),g=y.getTransition(),v=y.getChord(),x=v.singleTone?1:Xe.computeChordExpression(h.chordSize),k=w?e.noiseInterval:1,M=e.ticksPerPart*i/this.samplesPerSecond,S=1/this.samplesPerSecond,P=1/e.partsPerBeat,I=this.getTicksIntoBar(),F=I/e.ticksPerPart,B=(I+1)/e.ticksPerPart,L=this.getCurrentPart();let C=1;h.specialIntervalExpressionMult=1;let D=a,T=0,E=0,N=1,O=1,z=x,R=x,A=16,$=e.keys[t.key].basePitch,U=1,q=48;if(3==y.type)U=e.spectrumBaseExpression,w&&($=e.spectrumBasePitch,U*=2),A=e.spectrumBasePitch,q=28;else if(4==y.type)$=e.spectrumBasePitch,U=e.drumsetBaseExpression,A=$;else if(2==y.type)$=e.chipNoises[y.chipNoise].basePitch,U=e.noiseBaseExpression,A=$,q=e.chipNoises[y.chipNoise].isSoft?24:60;else if(1==y.type)U=e.fmBaseExpression;else if(0==y.type)U=e.chipBaseExpression;else if(5==y.type)U=e.harmonicsBaseExpression;else if(6==y.type)U=e.pwmBaseExpression;else if(8==y.type)U=e.supersawBaseExpression;else{if(7!=y.type)throw new Error("Unknown instrument type in computeTone.");U=e.pickedStringBaseExpression}(h.atNoteStart&&!g.isSeamless&&!h.forceContinueAtStart||h.freshlyAllocated)&&h.reset(),h.freshlyAllocated=!1;for(let t=0;t<e.maxPitchOrOperatorCount;t++)h.phaseDeltas[t]=0,h.phaseDeltaScales[t]=0,h.operatorExpressions[t]=0,h.operatorExpressionDeltas[t]=0;if(h.expression=0,h.expressionDelta=0,o){const t=h.ticksSinceReleased,s=h.ticksSinceReleased+1;T=E=h.lastInterval;const i=Math.abs(y.getFadeOutTicks());N=Xe.noteSizeToVolumeMult((1-t/i)*e.noteSizeMax),O=Xe.noteSizeToVolumeMult((1-s/i)*e.noteSizeMax),a&&(O=0),h.ticksSinceReleased+1>=i&&(D=!0)}else if(null==h.note)N=O=1,h.lastInterval=0,h.ticksSinceReleased=0,h.liveInputSamplesHeld+=l;else{const t=h.note,s=h.nextNote,i=h.noteStartPart,n=h.noteEndPart,o=t.getEndPinIndex(L),r=t.pins[o-1],a=t.pins[o],l=i*e.ticksPerPart,c=n*e.ticksPerPart,u=(t.start+r.time)*e.ticksPerPart,p=(t.start+a.time)*e.ticksPerPart;h.ticksSinceReleased=0;const d=L*e.ticksPerPart+this.tick,f=d+1,m=d-l,b=f-l,w=Math.min(1,(d-u)/(p-u)),v=Math.min(1,(f-u)/(p-u));if(N=1,O=1,T=r.interval+(a.interval-r.interval)*w,E=r.interval+(a.interval-r.interval)*v,h.lastInterval=E,!g.isSeamless&&!h.forceContinueAtEnd||null==s){const t=-y.getFadeOutTicks();if(t>0){const e=c-l;N*=Math.min(1,(e-m)/t),O*=Math.min(1,(e-b)/t),f>=l+e&&(D=!0)}}}h.isOnLastTick=D;const _=h.envelopeComputer;_.computeEnvelopes(y,L,e.ticksPerPart*F,i/this.samplesPerSecond,h);const V=h.envelopeComputer.envelopeStarts,j=h.envelopeComputer.envelopeEnds;if(null!=h.note&&g.slides){const t=h.prevNote,e=h.nextNote;if(null!=t){const e=t.pitches[h.prevNotePitchIndex]+t.pins[t.pins.length-1].interval-h.pitches[0];if(_.prevSlideStart&&(T+=e*_.prevSlideRatioStart),_.prevSlideEnd&&(E+=e*_.prevSlideRatioEnd),!v.singleTone){const e=t.pitches.length-h.chordSize;_.prevSlideStart&&(z=Xe.computeChordExpression(h.chordSize+e*_.prevSlideRatioStart)),_.prevSlideEnd&&(R=Xe.computeChordExpression(h.chordSize+e*_.prevSlideRatioEnd))}}if(null!=e){const t=e.pitches[h.nextNotePitchIndex]-(h.pitches[0]+h.note.pins[h.note.pins.length-1].interval);if(_.nextSlideStart&&(T+=t*_.nextSlideRatioStart),_.nextSlideEnd&&(E+=t*_.nextSlideRatioEnd),!v.singleTone){const t=e.pitches.length-h.chordSize;_.nextSlideStart&&(z=Xe.computeChordExpression(h.chordSize+t*_.nextSlideRatioStart)),_.nextSlideEnd&&(R=Xe.computeChordExpression(h.chordSize+t*_.nextSlideRatioEnd))}}}if(u(y.effects)){const t=e.justIntonationSemitones[y.pitchShift]/k;T+=t*V[14],E+=t*j[14]}if(p(y.effects)){const t=V[15],s=j[15];T+=Xe.detuneToCents((y.detune-e.detuneCenter)*t)*e.pitchesPerOctave/1200,E+=Xe.detuneToCents((y.detune-e.detuneCenter)*s)*e.pitchesPerOctave/1200}if(d(y.effects)){const t=e.vibratos[y.vibrato].delayTicks,s=e.vibratos[y.vibrato].amplitude;let i;if(null!=h.prevVibrato)i=h.prevVibrato;else{if(i=s*Xe.getLFOAmplitude(y,M*F)*V[16],t>0){const e=t-_.noteTicksStart;i*=Math.max(0,Math.min(1,1-e/2))}}let n=s*Xe.getLFOAmplitude(y,M*B)*j[16];if(t>0){const e=t-_.noteTicksEnd;n*=Math.max(0,Math.min(1,1-e/2))}h.prevVibrato=n,T+=i,E+=n}if(!g.isSeamless&&!h.forceContinueAtStart||null==h.prevNote){const t=y.getFadeInSeconds();t>0&&(N*=Math.min(1,_.noteSecondsStart/t),O*=Math.min(1,_.noteSecondsEnd/t))}4==y.type&&null==h.drumsetPitch&&(h.drumsetPitch=h.pitches[0],null!=h.note&&(h.drumsetPitch+=h.note.pickMainInterval()),h.drumsetPitch=Math.max(0,Math.min(e.drumCount-1,h.drumsetPitch)));let G=_.lowpassCutoffDecayVolumeCompensation;if(f(y.effects)){const t=y.noteFilter,e=V[1],s=j[1];for(let i=0;i<t.controlPointCount;i++){const n=V[17+i],o=j[17+i],r=V[25+i],a=j[25+i],c=t.controlPoints[i];c.toCoefficients(Xe.tempFilterStartCoefficients,this.samplesPerSecond,e*n,r),c.toCoefficients(Xe.tempFilterEndCoefficients,this.samplesPerSecond,s*o,a),h.noteFilters.length<=i&&(h.noteFilters[i]=new Se),h.noteFilters[i].loadCoefficientsWithGradient(Xe.tempFilterStartCoefficients,Xe.tempFilterEndCoefficients,1/l,0==c.type),G*=c.getVolumeCompensationMult()}h.noteFilterCount=t.controlPointCount}else h.noteFilterCount=0;if(4==y.type){const t=y.getDrumsetEnvelope(h.drumsetPitch);G*=Ke.getLowpassCutoffDecayVolumeCompensation(t);let e=Ke.computeEnvelope(t,_.noteSecondsStart,P*F,_.noteSizeStart),s=Ke.computeEnvelope(t,_.noteSecondsEnd,P*B,_.noteSizeEnd);if(_.prevSlideStart){e+=(Ke.computeEnvelope(t,_.prevNoteSecondsStart,P*F,_.prevNoteSize)-e)*_.prevSlideRatioStart}if(_.prevSlideEnd){s+=(Ke.computeEnvelope(t,_.prevNoteSecondsEnd,P*B,_.prevNoteSize)-s)*_.prevSlideRatioEnd}if(_.nextSlideStart){e+=(Ke.computeEnvelope(t,0,P*F,_.nextNoteSize)-e)*_.nextSlideRatioStart}if(_.nextSlideEnd){s+=(Ke.computeEnvelope(t,0,P*B,_.nextNoteSize)-s)*_.nextSlideRatioEnd}const i=this.tempDrumSetControlPoint;i.type=0,i.gain=qe.getRoundedSettingValueFromLinearGain(.5),i.freq=qe.getRoundedSettingValueFromHz(8e3),i.toCoefficients(Xe.tempFilterStartCoefficients,this.samplesPerSecond,e*(1+e),1),i.toCoefficients(Xe.tempFilterEndCoefficients,this.samplesPerSecond,s*(1+s),1),h.noteFilters.length==h.noteFilterCount&&(h.noteFilters[h.noteFilterCount]=new Se),h.noteFilters[h.noteFilterCount].loadCoefficientsWithGradient(Xe.tempFilterStartCoefficients,Xe.tempFilterEndCoefficients,1/l,!0),h.noteFilterCount++}if(G=Math.min(3,G),1==y.type){let s=1,i=0,n=0;const o=v.arpeggiates;if(h.pitchCount>1&&o){const s=Math.floor((this.tick+this.part*e.ticksPerPart)/e.rhythms[t.rhythm].ticksPerArpeggio);n=h.pitches[r(h.pitchCount,t.rhythm,s)]-h.pitches[0]}const a=e.algorithms[y.algorithm].carrierCount;for(let t=0;t<e.operatorCount;t++){const r=e.algorithms[y.algorithm].associatedCarrier[t]-1,c=h.pitches[o?0:t<h.pitchCount?t:r<h.pitchCount?r:0],u=e.operatorFrequencies[y.operators[t].frequency].mult,p=e.operatorCarrierInterval[r]+n,d=$+(c+T)*k+p,f=$+(c+E)*k+p,m=je.frequencyFromPitch(d),b=je.frequencyFromPitch(f),w=e.operatorFrequencies[y.operators[t].frequency].hzOffset,g=u*m+w,v=u*b+w,x=V[5+t],M=j[5+t];let P,I;1!=x||1!=M?(P=Math.pow(2,Math.log2(g/m)*x)*m,I=Math.pow(2,Math.log2(v/b)*M)*b):(P=g,I=v),h.phaseDeltas[t]=P*S,h.phaseDeltaScales[t]=Math.pow(I/P,1/l);const F=Xe.operatorAmplitudeCurve(y.operators[t].amplitude),B=F*e.operatorFrequencies[y.operators[t].frequency].amplitudeSign;let L=B,C=B;if(t<a){let e;e=null!=h.prevPitchExpressions[t]?h.prevPitchExpressions[t]:Math.pow(2,-(d-A)/q);const s=Math.pow(2,-(f-A)/q);h.prevPitchExpressions[t]=s,L*=e,C*=s,i+=F}else L*=1.5*e.sineWaveLength,C*=1.5*e.sineWaveLength,s*=1-Math.min(1,y.operators[t].amplitude/15);L*=V[9+t],C*=j[9+t],h.operatorExpressions[t]=L,h.operatorExpressionDeltas[t]=(C-L)/l}s*=(Math.pow(2,2-1.4*y.feedbackAmplitude/15)-1)/3,s*=1-Math.min(1,Math.max(0,i-1)/2),s=1+3*s;const c=U*s*G*N*z*V[0],u=U*s*G*O*R*j[0];h.expression=c,h.expressionDelta=(u-c)/l;const p=.3*e.sineWaveLength*y.feedbackAmplitude/15;let d=p*V[13],f=p*j[13];h.feedbackMult=d,h.feedbackDelta=(f-d)/l}else{const s=Math.pow(2,(E-T)*k/12),i=Math.pow(s,1/l);let o=h.pitches[0];if(h.pitchCount>1&&(v.arpeggiates||v.customInterval)){const s=Math.floor((this.tick+this.part*e.ticksPerPart)/e.rhythms[t.rhythm].ticksPerArpeggio);if(v.customInterval){const e=h.pitches[1+r(h.pitchCount-1,t.rhythm,s)]-h.pitches[0];C=Math.pow(2,e/12),h.specialIntervalExpressionMult=Math.pow(2,-e/q)}else o=h.pitches[r(h.pitchCount,t.rhythm,s)]}const a=$+(o+T)*k,c=$+(o+E)*k;let u;u=null!=h.prevPitchExpressions[0]?h.prevPitchExpressions[0]:Math.pow(2,-(a-A)/q);const p=Math.pow(2,-(c-A)/q);h.prevPitchExpressions[0]=p;let d=U*G;if(2==y.type&&(d*=e.chipNoises[y.chipNoise].expression),0==y.type&&(d*=e.chipWaves[y.chipWave].expression),6==y.type){const t=n(y.pulseWidth),e=t*V[2],s=t*j[2];h.pulseWidth=e,h.pulseWidthDelta=(s-e)/l}7==y.type&&(d*=Math.pow(2,.7*(1-y.stringSustain/(e.stringSustainRange-1))));const f=je.frequencyFromPitch(a);if(0==y.type||5==y.type||7==y.type){const t=e.unisons[y.unison],s=7==y.type?1:t.voices/2;d*=t.expression*s;const n=V[4],o=j[4],r=Math.pow(2,(t.offset+t.spread)*n/12),a=Math.pow(2,(t.offset+t.spread)*o/12),c=Math.pow(2,(t.offset-t.spread)*n/12)*C,u=Math.pow(2,(t.offset-t.spread)*o/12)*C;h.phaseDeltas[0]=f*S*r,h.phaseDeltas[1]=f*S*c,h.phaseDeltaScales[0]=i*Math.pow(a/r,1/l),h.phaseDeltaScales[1]=i*Math.pow(u/c,1/l)}else h.phaseDeltas[0]=f*S,h.phaseDeltaScales[0]=i;let m=1,w=1;if(8==y.type){const t=1/Math.sqrt(e.supersawVoiceCount),i=y.supersawDynamism/e.supersawDynamismMax,o=1-Math.pow(Math.max(0,1-i*V[33]),.2),r=1-Math.pow(Math.max(0,1-i*j[33]),.2),a=Math.pow(2,Math.log2(t)*o),c=Math.pow(2,Math.log2(t)*r),u=Math.sqrt((1/Math.pow(a,2)-1)/(e.supersawVoiceCount-1)),p=Math.sqrt((1/Math.pow(c,2)-1)/(e.supersawVoiceCount-1));h.supersawDynamism=u,h.supersawDynamismDelta=(p-u)/l;const d=-1==h.supersawDelayIndex;if(d){let t=0;for(let s=0;s<e.supersawVoiceCount;s++)h.phases[s]=t,t+=-Math.log(Math.random());const s=1+(e.supersawVoiceCount-1)*u;let i=0;for(let s=0;s<e.supersawVoiceCount;s++){const e=0==s?1:u,n=h.phases[s]/t;h.phases[s]=n,i+=(n-.5)*e}let n=1,o=0;for(let t=e.supersawVoiceCount-1;t>=0;t--){const e=1-h.phases[t],r=e-o;if(i<0){const t=-i/s;if(t<r){n=o+t;break}}i+=r*s-(0==t?1:u),o=e}for(let t=0;t<e.supersawVoiceCount;t++)h.phases[t]+=n;for(let t=1;t<e.supersawVoiceCount-1;t++){const s=t+Math.floor(Math.random()*(e.supersawVoiceCount-t)),i=h.phases[t];h.phases[t]=h.phases[s],h.phases[s]=i}}const b=y.supersawSpread/e.supersawSpreadMax,g=.5*(b*V[34]+b*j[34]),v=Math.pow(1-Math.sqrt(Math.max(0,1-g)),1.75);for(let t=0;t<e.supersawVoiceCount;t++){const s=0==t?0:Math.pow(((t+1>>1)-.5+.025*((2&t)-1))/(e.supersawVoiceCount>>1),1.1)*(2*(1&t)-1);h.supersawUnisonDetunes[t]=Math.pow(2,v*s/12)}const x=y.supersawShape/e.supersawShapeMax,k=x*V[35],M=x*j[35];h.supersawShape=k,h.supersawShapeDelta=(M-k)/l;const P=n(y.pulseWidth),I=P*V[2],F=P*j[2],B=null!=h.supersawPrevPhaseDelta?h.supersawPrevPhaseDelta:f*S,L=f*S*s;h.supersawPrevPhaseDelta=L;const C=I/B,D=F/L;h.supersawDelayLength=C,h.supersawDelayLengthDelta=(D-C)/l;const T=Math.ceil(Math.max(C,D))+2;if(null==h.supersawDelayLine||h.supersawDelayLine.length<=T){const t=Math.ceil(.5*this.samplesPerSecond/je.frequencyFromPitch(24)),e=new Float32Array(Xe.fittingPowerOfTwo(Math.max(t,T)));if(!d&&null!=h.supersawDelayLine){const t=h.supersawDelayLine.length-1>>0,s=h.supersawDelayIndex;for(let i=0;i<h.supersawDelayLine.length;i++)e[i]=h.supersawDelayLine[s+i&t]}h.supersawDelayLine=e,h.supersawDelayIndex=h.supersawDelayLine.length}else d&&(h.supersawDelayLine.fill(0),h.supersawDelayIndex=h.supersawDelayLine.length);const E=e.pwmBaseExpression/e.supersawBaseExpression;m*=(1+(E-1)*k)/Math.sqrt(1+(e.supersawVoiceCount-1)*u*u),w*=(1+(E-1)*M)/Math.sqrt(1+(e.supersawVoiceCount-1)*p*p)}const x=d*N*z*u*V[0]*m,M=d*O*R*p*j[0]*w;if(h.expression=x,h.expressionDelta=(M-x)/l,7==y.type){let t;if(null!=h.prevStringDecay)t=h.prevStringDecay;else{const s=h.envelopeComputer.envelopeStarts[3];t=1-Math.min(1,s*y.stringSustain/(e.stringSustainRange-1))}const s=h.envelopeComputer.envelopeEnds[3];let i=1-Math.min(1,s*y.stringSustain/(e.stringSustainRange-1));h.prevStringDecay=i;const n=e.unisons[y.unison];for(let t=h.pickedStrings.length;t<n.voices;t++)h.pickedStrings[t]=new He;if(h.atNoteStart&&!g.continues&&!h.forceContinueAtStart)for(const t of h.pickedStrings)t.delayIndex=-1;for(let e=0;e<n.voices;e++)h.pickedStrings[e].update(this,b,h,e,l,t,i,y.stringSustainType)}}}static getLFOAmplitude(t,s){let i=0;for(const n of e.vibratos[t.vibrato].periodsSeconds)i+=Math.sin(2*Math.PI*s/n);return i}static getInstrumentSynthFunction(t){if(1==t.type){const s=t.algorithm+"_"+t.feedbackType;if(null==Xe.fmSynthFunctionCache[s]){const i=[];for(const s of Xe.fmSourceTemplate)if(-1!=s.indexOf("// CARRIER OUTPUTS")){const n=[];for(let s=0;s<e.algorithms[t.algorithm].carrierCount;s++)n.push("operator"+s+"Scaled");i.push(s.replace("/*operator#Scaled*/",n.join(" + ")))}else if(-1!=s.indexOf("// INSERT OPERATOR COMPUTATION HERE"))for(let s=e.operatorCount-1;s>=0;s--)for(const n of Xe.operatorSourceTemplate)if(-1!=n.indexOf("/* + operator@Scaled*/")){let h="";for(const i of e.algorithms[t.algorithm].modulatedBy[s])h+=" + operator"+(i-1)+"Scaled";const o=e.feedbacks[t.feedbackType].indices[s];if(o.length>0){h+=" + feedbackMult * (";const t=[];for(const e of o)t.push("operator"+(e-1)+"Output");h+=t.join(" + ")+")"}i.push(n.replace(/\#/g,s+"").replace("/* + operator@Scaled*/",h))}else i.push(n.replace(/\#/g,s+""));else if(-1!=s.indexOf("#"))for(let t=0;t<e.operatorCount;t++)i.push(s.replace(/\#/g,t+""));else i.push(s);const n="return (synth, bufferIndex, runLength, tone, instrument) => {"+i.join("\n")+"}";Xe.fmSynthFunctionCache[s]=new Function("Config","Synth",n)(e,Xe)}return Xe.fmSynthFunctionCache[s]}if(0==t.type)return Xe.chipSynth;if(5==t.type)return Xe.harmonicsSynth;if(6==t.type)return Xe.pulseWidthSynth;if(8==t.type)return Xe.supersawSynth;if(7==t.type)return Xe.pickedStringSynth;if(2==t.type)return Xe.noiseSynth;if(3==t.type)return Xe.spectrumSynth;if(4==t.type)return Xe.drumsetSynth;throw new Error("Unrecognized instrument type: "+t.type)}static chipSynth(t,e,s,i,n){const h=t.tempMonoInstrumentSampleBuffer,o=n.wave,r=o.length-1,a=i.specialIntervalExpressionMult*n.unison.sign;1!=n.unison.voices||n.chord.customInterval||(i.phases[1]=i.phases[0]);let l=i.phaseDeltas[0]*r,c=i.phaseDeltas[1]*r;const u=+i.phaseDeltaScales[0],p=+i.phaseDeltaScales[1];let d=+i.expression;const f=+i.expressionDelta;let m=i.phases[0]%1*r,y=i.phases[1]%1*r;const b=i.noteFilters,w=0|i.noteFilterCount;let g=+i.initialNoteFilterInput1,v=+i.initialNoteFilterInput2;const x=Xe.applyFilters,k=0|m,M=0|y,S=k%r,P=M%r,I=m-k,F=y-M;let B=+o[S],L=+o[P];B+=(o[S+1]-B)*I,L+=(o[P+1]-L)*F;const C=e+s;for(let t=e;t<C;t++){m+=l,y+=c;const e=0|m,s=0|y,i=e%r,n=s%r;let k=o[i],M=o[n];const S=m-e,P=y-s;k+=(o[i+1]-k)*S,M+=(o[n+1]-M)*P;const I=(k-B)/l,F=(M-L)/c;B=k,L=M;const C=I+F*a,D=x(C,g,v,w,b);v=g,g=C,l*=u,c*=p;const T=D*d;d+=f,h[t]+=T}i.phases[0]=m/r,i.phases[1]=y/r,i.phaseDeltas[0]=l/r,i.phaseDeltas[1]=c/r,i.expression=d,t.sanitizeFilters(b),i.initialNoteFilterInput1=g,i.initialNoteFilterInput2=v}static harmonicsSynth(t,e,s,i,n){const h=t.tempMonoInstrumentSampleBuffer,o=n.wave,r=o.length-1,a=i.specialIntervalExpressionMult*n.unison.sign;1!=n.unison.voices||n.chord.customInterval||(i.phases[1]=i.phases[0]);let l=i.phaseDeltas[0]*r,c=i.phaseDeltas[1]*r;const u=+i.phaseDeltaScales[0],p=+i.phaseDeltaScales[1];let d=+i.expression;const f=+i.expressionDelta;let m=i.phases[0]%1*r,y=i.phases[1]%1*r;const b=i.noteFilters,w=0|i.noteFilterCount;let g=+i.initialNoteFilterInput1,v=+i.initialNoteFilterInput2;const x=Xe.applyFilters,k=0|m,M=0|y,S=k%r,P=M%r,I=m-k,F=y-M;let B=+o[S],L=+o[P];B+=(o[S+1]-B)*I,L+=(o[P+1]-L)*F;const C=e+s;for(let t=e;t<C;t++){m+=l,y+=c;const e=0|m,s=0|y,i=e%r,n=s%r;let k=o[i],M=o[n];const S=m-e,P=y-s;k+=(o[i+1]-k)*S,M+=(o[n+1]-M)*P;const I=(k-B)/l,F=(M-L)/c;B=k,L=M;const C=I+F*a,D=x(C,g,v,w,b);v=g,g=C,l*=u,c*=p;const T=D*d;d+=f,h[t]+=T}i.phases[0]=m/r,i.phases[1]=y/r,i.phaseDeltas[0]=l/r,i.phaseDeltas[1]=c/r,i.expression=d,t.sanitizeFilters(b),i.initialNoteFilterInput1=g,i.initialNoteFilterInput2=v}static pickedStringSynth(t,s,i,n,h){const o=h.unison.voices;let r=Xe.pickedStringFunctionCache[o];if(null==r){let t="return (synth, bufferIndex, runLength, tone, instrumentState) => {";t+="\n\t\t\t\tconst data = synth.tempMonoInstrumentSampleBuffer;\n\t\t\t\t\n\t\t\t\tlet pickedString# = tone.pickedStrings[#];\n\t\t\t\tlet allPassSample# = +pickedString#.allPassSample;\n\t\t\t\tlet allPassPrevInput# = +pickedString#.allPassPrevInput;\n\t\t\t\tlet sustainFilterSample# = +pickedString#.sustainFilterSample;\n\t\t\t\tlet sustainFilterPrevOutput2# = +pickedString#.sustainFilterPrevOutput2;\n\t\t\t\tlet sustainFilterPrevInput1# = +pickedString#.sustainFilterPrevInput1;\n\t\t\t\tlet sustainFilterPrevInput2# = +pickedString#.sustainFilterPrevInput2;\n\t\t\t\tlet fractionalDelaySample# = +pickedString#.fractionalDelaySample;\n\t\t\t\tconst delayLine# = pickedString#.delayLine;\n\t\t\t\tconst delayBufferMask# = (delayLine#.length - 1) >> 0;\n\t\t\t\tlet delayIndex# = pickedString#.delayIndex|0;\n\t\t\t\tdelayIndex# = (delayIndex# & delayBufferMask#) + delayLine#.length;\n\t\t\t\tlet delayLength# = +pickedString#.prevDelayLength;\n\t\t\t\tconst delayLengthDelta# = +pickedString#.delayLengthDelta;\n\t\t\t\tlet allPassG# = +pickedString#.allPassG;\n\t\t\t\tlet sustainFilterA1# = +pickedString#.sustainFilterA1;\n\t\t\t\tlet sustainFilterA2# = +pickedString#.sustainFilterA2;\n\t\t\t\tlet sustainFilterB0# = +pickedString#.sustainFilterB0;\n\t\t\t\tlet sustainFilterB1# = +pickedString#.sustainFilterB1;\n\t\t\t\tlet sustainFilterB2# = +pickedString#.sustainFilterB2;\n\t\t\t\tconst allPassGDelta# = +pickedString#.allPassGDelta;\n\t\t\t\tconst sustainFilterA1Delta# = +pickedString#.sustainFilterA1Delta;\n\t\t\t\tconst sustainFilterA2Delta# = +pickedString#.sustainFilterA2Delta;\n\t\t\t\tconst sustainFilterB0Delta# = +pickedString#.sustainFilterB0Delta;\n\t\t\t\tconst sustainFilterB1Delta# = +pickedString#.sustainFilterB1Delta;\n\t\t\t\tconst sustainFilterB2Delta# = +pickedString#.sustainFilterB2Delta;\n\t\t\t\t\n\t\t\t\tlet expression = +tone.expression;\n\t\t\t\tconst expressionDelta = +tone.expressionDelta;\n\t\t\t\t\n\t\t\t\tconst unisonSign = tone.specialIntervalExpressionMult * instrumentState.unison.sign;\n\t\t\t\tconst delayResetOffset# = pickedString#.delayResetOffset|0;\n\t\t\t\t\n\t\t\t\tconst filters = tone.noteFilters;\n\t\t\t\tconst filterCount = tone.noteFilterCount|0;\n\t\t\t\tlet initialFilterInput1 = +tone.initialNoteFilterInput1;\n\t\t\t\tlet initialFilterInput2 = +tone.initialNoteFilterInput2;\n\t\t\t\tconst applyFilters = Synth.applyFilters;\n\t\t\t\t\n\t\t\t\tconst stopIndex = bufferIndex + runLength;\n\t\t\t\tfor (let sampleIndex = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\n\t\t\t\t\tconst targetSampleTime# = delayIndex# - delayLength#;\n\t\t\t\t\tconst lowerIndex# = (targetSampleTime# + 0.125) | 0; // Offset to improve stability of all-pass filter.\n\t\t\t\t\tconst upperIndex# = lowerIndex# + 1;\n\t\t\t\t\tconst fractionalDelay# = upperIndex# - targetSampleTime#;\n\t\t\t\t\tconst fractionalDelayG# = (1.0 - fractionalDelay#) / (1.0 + fractionalDelay#); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\n\t\t\t\t\tconst prevInput# = delayLine#[lowerIndex# & delayBufferMask#];\n\t\t\t\t\tconst input# = delayLine#[upperIndex# & delayBufferMask#];\n\t\t\t\t\tfractionalDelaySample# = fractionalDelayG# * input# + prevInput# - fractionalDelayG# * fractionalDelaySample#;\n\t\t\t\t\t\n\t\t\t\t\tallPassSample# = fractionalDelaySample# * allPassG# + allPassPrevInput# - allPassG# * allPassSample#;\n\t\t\t\t\tallPassPrevInput# = fractionalDelaySample#;\n\t\t\t\t\t\n\t\t\t\t\tconst sustainFilterPrevOutput1# = sustainFilterSample#;\n\t\t\t\t\tsustainFilterSample# = sustainFilterB0# * allPassSample# + sustainFilterB1# * sustainFilterPrevInput1# + sustainFilterB2# * sustainFilterPrevInput2# - sustainFilterA1# * sustainFilterSample# - sustainFilterA2# * sustainFilterPrevOutput2#;\n\t\t\t\t\tsustainFilterPrevOutput2# = sustainFilterPrevOutput1#;\n\t\t\t\t\tsustainFilterPrevInput2# = sustainFilterPrevInput1#;\n\t\t\t\t\tsustainFilterPrevInput1# = allPassSample#;\n\t\t\t\t\t\n\t\t\t\t\tdelayLine#[delayIndex# & delayBufferMask#] += sustainFilterSample#;\n\t\t\t\t\tdelayLine#[(delayIndex# + delayResetOffset#) & delayBufferMask#] = 0.0;\n\t\t\t\t\tdelayIndex#++;\n\t\t\t\t\t\n\t\t\t\t\tconst inputSample = (";const s=[];for(let t=0;t<o;t++)s.push("fractionalDelaySample"+t+(1==t?" * unisonSign":""));t+=s.join(" + "),t+=") * expression;\n\t\t\t\t\tconst sample = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\n\t\t\t\t\tinitialFilterInput2 = initialFilterInput1;\n\t\t\t\t\tinitialFilterInput1 = inputSample;\n\t\t\t\t\tdata[sampleIndex] += sample;\n\t\t\t\t\t\n\t\t\t\t\texpression += expressionDelta;\n\t\t\t\t\tdelayLength# += delayLengthDelta#;\n\t\t\t\t\tallPassG# += allPassGDelta#;\n\t\t\t\t\tsustainFilterA1# += sustainFilterA1Delta#;\n\t\t\t\t\tsustainFilterA2# += sustainFilterA2Delta#;\n\t\t\t\t\tsustainFilterB0# += sustainFilterB0Delta#;\n\t\t\t\t\tsustainFilterB1# += sustainFilterB1Delta#;\n\t\t\t\t\tsustainFilterB2# += sustainFilterB2Delta#;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// Avoid persistent denormal or NaN values in the delay buffers and filter history.\n\t\t\t\tconst epsilon = (1.0e-24);\n\t\t\t\tif (!Number.isFinite(allPassSample#) || Math.abs(allPassSample#) < epsilon) allPassSample# = 0.0;\n\t\t\t\tif (!Number.isFinite(allPassPrevInput#) || Math.abs(allPassPrevInput#) < epsilon) allPassPrevInput# = 0.0;\n\t\t\t\tif (!Number.isFinite(sustainFilterSample#) || Math.abs(sustainFilterSample#) < epsilon) sustainFilterSample# = 0.0;\n\t\t\t\tif (!Number.isFinite(sustainFilterPrevOutput2#) || Math.abs(sustainFilterPrevOutput2#) < epsilon) sustainFilterPrevOutput2# = 0.0;\n\t\t\t\tif (!Number.isFinite(sustainFilterPrevInput1#) || Math.abs(sustainFilterPrevInput1#) < epsilon) sustainFilterPrevInput1# = 0.0;\n\t\t\t\tif (!Number.isFinite(sustainFilterPrevInput2#) || Math.abs(sustainFilterPrevInput2#) < epsilon) sustainFilterPrevInput2# = 0.0;\n\t\t\t\tif (!Number.isFinite(fractionalDelaySample#) || Math.abs(fractionalDelaySample#) < epsilon) fractionalDelaySample# = 0.0;\n\t\t\t\tpickedString#.allPassSample = allPassSample#;\n\t\t\t\tpickedString#.allPassPrevInput = allPassPrevInput#;\n\t\t\t\tpickedString#.sustainFilterSample = sustainFilterSample#;\n\t\t\t\tpickedString#.sustainFilterPrevOutput2 = sustainFilterPrevOutput2#;\n\t\t\t\tpickedString#.sustainFilterPrevInput1 = sustainFilterPrevInput1#;\n\t\t\t\tpickedString#.sustainFilterPrevInput2 = sustainFilterPrevInput2#;\n\t\t\t\tpickedString#.fractionalDelaySample = fractionalDelaySample#;\n\t\t\t\tpickedString#.delayIndex = delayIndex#;\n\t\t\t\tpickedString#.prevDelayLength = delayLength#;\n\t\t\t\tpickedString#.allPassG = allPassG#;\n\t\t\t\tpickedString#.sustainFilterA1 = sustainFilterA1#;\n\t\t\t\tpickedString#.sustainFilterA2 = sustainFilterA2#;\n\t\t\t\tpickedString#.sustainFilterB0 = sustainFilterB0#;\n\t\t\t\tpickedString#.sustainFilterB1 = sustainFilterB1#;\n\t\t\t\tpickedString#.sustainFilterB2 = sustainFilterB2#;\n\t\t\t\t\n\t\t\t\ttone.expression = expression;\n\t\t\t\t\n\t\t\t\tsynth.sanitizeFilters(filters);\n\t\t\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\n\t\t\t\ttone.initialNoteFilterInput2 = initialFilterInput2;\n\t\t\t}",t=t.replace(/^.*\#.*$/gm,(t=>{const e=[];for(let s=0;s<o;s++)e.push(t.replace(/\#/g,String(s)));return e.join("\n")})),r=new Function("Config","Synth",t)(e,Xe),Xe.pickedStringFunctionCache[o]=r}r(t,s,i,n,h)}static effectsSynth(t,s,i,n,h,o){const r=m(o.effects),a=y(o.effects),l=o.eqFilterCount>0,c=b(o.effects),u=w(o.effects),p=g(o.effects),d=v(o.effects);let f=0;r&&(f|=1),f<<=1,a&&(f|=1),f<<=1,l&&(f|=1),f<<=1,c&&(f|=1),f<<=1,u&&(f|=1),f<<=1,p&&(f|=1),f<<=1,d&&(f|=1);let x=Xe.effectsFunctionCache[f];if(null==x){let t="return (synth, outputDataL, outputDataR, bufferIndex, runLength, instrumentState) => {";const s=u||d||p;t+="\n\t\t\t\tconst tempMonoInstrumentSampleBuffer = synth.tempMonoInstrumentSampleBuffer;\n\t\t\t\t\n\t\t\t\tlet mixVolume = +instrumentState.mixVolume;\n\t\t\t\tconst mixVolumeDelta = +instrumentState.mixVolumeDelta;",s&&(t+="\n\t\t\t\t\n\t\t\t\tlet delayInputMult = +instrumentState.delayInputMult;\n\t\t\t\tconst delayInputMultDelta = +instrumentState.delayInputMultDelta;"),r&&(t+="\n\t\t\t\t\n\t\t\t\tconst distortionBaseVolume = +Config.distortionBaseVolume;\n\t\t\t\tlet distortion = instrumentState.distortion;\n\t\t\t\tconst distortionDelta = instrumentState.distortionDelta;\n\t\t\t\tlet distortionDrive = instrumentState.distortionDrive;\n\t\t\t\tconst distortionDriveDelta = instrumentState.distortionDriveDelta;\n\t\t\t\tconst distortionFractionalResolution = 4.0;\n\t\t\t\tconst distortionOversampleCompensation = distortionBaseVolume / distortionFractionalResolution;\n\t\t\t\tconst distortionFractionalDelay1 = 1.0 / distortionFractionalResolution;\n\t\t\t\tconst distortionFractionalDelay2 = 2.0 / distortionFractionalResolution;\n\t\t\t\tconst distortionFractionalDelay3 = 3.0 / distortionFractionalResolution;\n\t\t\t\tconst distortionFractionalDelayG1 = (1.0 - distortionFractionalDelay1) / (1.0 + distortionFractionalDelay1); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\n\t\t\t\tconst distortionFractionalDelayG2 = (1.0 - distortionFractionalDelay2) / (1.0 + distortionFractionalDelay2); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\n\t\t\t\tconst distortionFractionalDelayG3 = (1.0 - distortionFractionalDelay3) / (1.0 + distortionFractionalDelay3); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\n\t\t\t\tconst distortionNextOutputWeight1 = Math.cos(Math.PI * distortionFractionalDelay1) * 0.5 + 0.5;\n\t\t\t\tconst distortionNextOutputWeight2 = Math.cos(Math.PI * distortionFractionalDelay2) * 0.5 + 0.5;\n\t\t\t\tconst distortionNextOutputWeight3 = Math.cos(Math.PI * distortionFractionalDelay3) * 0.5 + 0.5;\n\t\t\t\tconst distortionPrevOutputWeight1 = 1.0 - distortionNextOutputWeight1;\n\t\t\t\tconst distortionPrevOutputWeight2 = 1.0 - distortionNextOutputWeight2;\n\t\t\t\tconst distortionPrevOutputWeight3 = 1.0 - distortionNextOutputWeight3;\n\t\t\t\t\n\t\t\t\tlet distortionFractionalInput1 = +instrumentState.distortionFractionalInput1;\n\t\t\t\tlet distortionFractionalInput2 = +instrumentState.distortionFractionalInput2;\n\t\t\t\tlet distortionFractionalInput3 = +instrumentState.distortionFractionalInput3;\n\t\t\t\tlet distortionPrevInput = +instrumentState.distortionPrevInput;\n\t\t\t\tlet distortionNextOutput = +instrumentState.distortionNextOutput;"),a&&(t+="\n\t\t\t\t\n\t\t\t\tlet bitcrusherPrevInput = +instrumentState.bitcrusherPrevInput;\n\t\t\t\tlet bitcrusherCurrentOutput = +instrumentState.bitcrusherCurrentOutput;\n\t\t\t\tlet bitcrusherPhase = +instrumentState.bitcrusherPhase;\n\t\t\t\tlet bitcrusherPhaseDelta = +instrumentState.bitcrusherPhaseDelta;\n\t\t\t\tconst bitcrusherPhaseDeltaScale = +instrumentState.bitcrusherPhaseDeltaScale;\n\t\t\t\tlet bitcrusherScale = +instrumentState.bitcrusherScale;\n\t\t\t\tconst bitcrusherScaleScale = +instrumentState.bitcrusherScaleScale;\n\t\t\t\tlet bitcrusherFoldLevel = +instrumentState.bitcrusherFoldLevel;\n\t\t\t\tconst bitcrusherFoldLevelScale = +instrumentState.bitcrusherFoldLevelScale;"),l&&(t+="\n\t\t\t\t\n\t\t\t\tlet filters = instrumentState.eqFilters;\n\t\t\t\tconst filterCount = instrumentState.eqFilterCount|0;\n\t\t\t\tlet initialFilterInput1 = +instrumentState.initialEqFilterInput1;\n\t\t\t\tlet initialFilterInput2 = +instrumentState.initialEqFilterInput2;\n\t\t\t\tconst applyFilters = Synth.applyFilters;"),t+="\n\t\t\t\t\n\t\t\t\tlet eqFilterVolume = +instrumentState.eqFilterVolume;\n\t\t\t\tconst eqFilterVolumeDelta = +instrumentState.eqFilterVolumeDelta;",c&&(t+="\n\t\t\t\t\n\t\t\t\tconst panningMask = synth.panningDelayBufferMask >>> 0;\n\t\t\t\tconst panningDelayLine = instrumentState.panningDelayLine;\n\t\t\t\tlet panningDelayPos = instrumentState.panningDelayPos & panningMask;\n\t\t\t\tlet   panningVolumeL      = +instrumentState.panningVolumeL;\n\t\t\t\tlet   panningVolumeR      = +instrumentState.panningVolumeR;\n\t\t\t\tconst panningVolumeDeltaL = +instrumentState.panningVolumeDeltaL;\n\t\t\t\tconst panningVolumeDeltaR = +instrumentState.panningVolumeDeltaR;\n\t\t\t\tlet   panningOffsetL      = +instrumentState.panningOffsetL;\n\t\t\t\tlet   panningOffsetR      = +instrumentState.panningOffsetR;\n\t\t\t\tconst panningOffsetDeltaL = 1.0 - instrumentState.panningOffsetDeltaL;\n\t\t\t\tconst panningOffsetDeltaR = 1.0 - instrumentState.panningOffsetDeltaR;"),u&&(t+="\n\t\t\t\t\n\t\t\t\tconst chorusMask = synth.chorusDelayBufferMask >>> 0;\n\t\t\t\tconst chorusDelayLineL = instrumentState.chorusDelayLineL;\n\t\t\t\tconst chorusDelayLineR = instrumentState.chorusDelayLineR;\n\t\t\t\tinstrumentState.chorusDelayLineDirty = true;\n\t\t\t\tlet chorusDelayPos = instrumentState.chorusDelayPos & chorusMask;\n\t\t\t\t\n\t\t\t\tlet chorusVoiceMult = +instrumentState.chorusVoiceMult;\n\t\t\t\tconst chorusVoiceMultDelta = +instrumentState.chorusVoiceMultDelta;\n\t\t\t\tlet chorusCombinedMult = +instrumentState.chorusCombinedMult;\n\t\t\t\tconst chorusCombinedMultDelta = +instrumentState.chorusCombinedMultDelta;\n\t\t\t\t\n\t\t\t\tconst chorusDuration = +Config.chorusPeriodSeconds;\n\t\t\t\tconst chorusAngle = Math.PI * 2.0 / (chorusDuration * synth.samplesPerSecond);\n\t\t\t\tconst chorusRange = synth.samplesPerSecond * Config.chorusDelayRange;\n\t\t\t\tconst chorusOffset0 = synth.chorusDelayBufferSize - Config.chorusDelayOffsets[0][0] * chorusRange;\n\t\t\t\tconst chorusOffset1 = synth.chorusDelayBufferSize - Config.chorusDelayOffsets[0][1] * chorusRange;\n\t\t\t\tconst chorusOffset2 = synth.chorusDelayBufferSize - Config.chorusDelayOffsets[0][2] * chorusRange;\n\t\t\t\tconst chorusOffset3 = synth.chorusDelayBufferSize - Config.chorusDelayOffsets[1][0] * chorusRange;\n\t\t\t\tconst chorusOffset4 = synth.chorusDelayBufferSize - Config.chorusDelayOffsets[1][1] * chorusRange;\n\t\t\t\tconst chorusOffset5 = synth.chorusDelayBufferSize - Config.chorusDelayOffsets[1][2] * chorusRange;\n\t\t\t\tlet chorusPhase = instrumentState.chorusPhase % (Math.PI * 2.0);\n\t\t\t\tlet chorusTap0Index = chorusDelayPos + chorusOffset0 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[0][0]);\n\t\t\t\tlet chorusTap1Index = chorusDelayPos + chorusOffset1 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[0][1]);\n\t\t\t\tlet chorusTap2Index = chorusDelayPos + chorusOffset2 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[0][2]);\n\t\t\t\tlet chorusTap3Index = chorusDelayPos + chorusOffset3 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[1][0]);\n\t\t\t\tlet chorusTap4Index = chorusDelayPos + chorusOffset4 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[1][1]);\n\t\t\t\tlet chorusTap5Index = chorusDelayPos + chorusOffset5 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[1][2]);\n\t\t\t\tchorusPhase += chorusAngle * runLength;\n\t\t\t\tconst chorusTap0End = chorusDelayPos + chorusOffset0 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[0][0]) + runLength;\n\t\t\t\tconst chorusTap1End = chorusDelayPos + chorusOffset1 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[0][1]) + runLength;\n\t\t\t\tconst chorusTap2End = chorusDelayPos + chorusOffset2 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[0][2]) + runLength;\n\t\t\t\tconst chorusTap3End = chorusDelayPos + chorusOffset3 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[1][0]) + runLength;\n\t\t\t\tconst chorusTap4End = chorusDelayPos + chorusOffset4 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[1][1]) + runLength;\n\t\t\t\tconst chorusTap5End = chorusDelayPos + chorusOffset5 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[1][2]) + runLength;\n\t\t\t\tconst chorusTap0Delta = (chorusTap0End - chorusTap0Index) / runLength;\n\t\t\t\tconst chorusTap1Delta = (chorusTap1End - chorusTap1Index) / runLength;\n\t\t\t\tconst chorusTap2Delta = (chorusTap2End - chorusTap2Index) / runLength;\n\t\t\t\tconst chorusTap3Delta = (chorusTap3End - chorusTap3Index) / runLength;\n\t\t\t\tconst chorusTap4Delta = (chorusTap4End - chorusTap4Index) / runLength;\n\t\t\t\tconst chorusTap5Delta = (chorusTap5End - chorusTap5Index) / runLength;"),p&&(t+="\n\t\t\t\t\n\t\t\t\tlet echoMult = +instrumentState.echoMult;\n\t\t\t\tconst echoMultDelta = +instrumentState.echoMultDelta;\n\t\t\t\t\n\t\t\t\tconst echoDelayLineL = instrumentState.echoDelayLineL;\n\t\t\t\tconst echoDelayLineR = instrumentState.echoDelayLineR;\n\t\t\t\tconst echoMask = (echoDelayLineL.length - 1) >>> 0;\n\t\t\t\tinstrumentState.echoDelayLineDirty = true;\n\t\t\t\t\n\t\t\t\tlet echoDelayPos = instrumentState.echoDelayPos & echoMask;\n\t\t\t\tconst echoDelayOffsetStart = (echoDelayLineL.length - instrumentState.echoDelayOffsetStart) & echoMask;\n\t\t\t\tconst echoDelayOffsetEnd   = (echoDelayLineL.length - instrumentState.echoDelayOffsetEnd) & echoMask;\n\t\t\t\tlet echoDelayOffsetRatio = +instrumentState.echoDelayOffsetRatio;\n\t\t\t\tconst echoDelayOffsetRatioDelta = +instrumentState.echoDelayOffsetRatioDelta;\n\t\t\t\t\n\t\t\t\tconst echoShelfA1 = +instrumentState.echoShelfA1;\n\t\t\t\tconst echoShelfB0 = +instrumentState.echoShelfB0;\n\t\t\t\tconst echoShelfB1 = +instrumentState.echoShelfB1;\n\t\t\t\tlet echoShelfSampleL = +instrumentState.echoShelfSampleL;\n\t\t\t\tlet echoShelfSampleR = +instrumentState.echoShelfSampleR;\n\t\t\t\tlet echoShelfPrevInputL = +instrumentState.echoShelfPrevInputL;\n\t\t\t\tlet echoShelfPrevInputR = +instrumentState.echoShelfPrevInputR;"),d&&(t+="\n\t\t\t\t\n\t\t\t\tconst reverbMask = Config.reverbDelayBufferMask >>> 0; //TODO: Dynamic reverb buffer size.\n\t\t\t\tconst reverbDelayLine = instrumentState.reverbDelayLine;\n\t\t\t\tinstrumentState.reverbDelayLineDirty = true;\n\t\t\t\tlet reverbDelayPos = instrumentState.reverbDelayPos & reverbMask;\n\t\t\t\t\n\t\t\t\tlet reverb = +instrumentState.reverbMult;\n\t\t\t\tconst reverbDelta = +instrumentState.reverbMultDelta;\n\t\t\t\t\n\t\t\t\tconst reverbShelfA1 = +instrumentState.reverbShelfA1;\n\t\t\t\tconst reverbShelfB0 = +instrumentState.reverbShelfB0;\n\t\t\t\tconst reverbShelfB1 = +instrumentState.reverbShelfB1;\n\t\t\t\tlet reverbShelfSample0 = +instrumentState.reverbShelfSample0;\n\t\t\t\tlet reverbShelfSample1 = +instrumentState.reverbShelfSample1;\n\t\t\t\tlet reverbShelfSample2 = +instrumentState.reverbShelfSample2;\n\t\t\t\tlet reverbShelfSample3 = +instrumentState.reverbShelfSample3;\n\t\t\t\tlet reverbShelfPrevInput0 = +instrumentState.reverbShelfPrevInput0;\n\t\t\t\tlet reverbShelfPrevInput1 = +instrumentState.reverbShelfPrevInput1;\n\t\t\t\tlet reverbShelfPrevInput2 = +instrumentState.reverbShelfPrevInput2;\n\t\t\t\tlet reverbShelfPrevInput3 = +instrumentState.reverbShelfPrevInput3;"),t+="\n\t\t\t\t\n\t\t\t\tconst stopIndex = bufferIndex + runLength;\n\t\t\t\tfor (let sampleIndex = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\n\t\t\t\t\tlet sample = tempMonoInstrumentSampleBuffer[sampleIndex];\n\t\t\t\t\ttempMonoInstrumentSampleBuffer[sampleIndex] = 0.0;",r&&(t+="\n\t\t\t\t\t\n\t\t\t\t\tconst distortionReverse = 1.0 - distortion;\n\t\t\t\t\tconst distortionNextInput = sample * distortionDrive;\n\t\t\t\t\tsample = distortionNextOutput;\n\t\t\t\t\tdistortionNextOutput = distortionNextInput / (distortionReverse * Math.abs(distortionNextInput) + distortion);\n\t\t\t\t\tdistortionFractionalInput1 = distortionFractionalDelayG1 * distortionNextInput + distortionPrevInput - distortionFractionalDelayG1 * distortionFractionalInput1;\n\t\t\t\t\tdistortionFractionalInput2 = distortionFractionalDelayG2 * distortionNextInput + distortionPrevInput - distortionFractionalDelayG2 * distortionFractionalInput2;\n\t\t\t\t\tdistortionFractionalInput3 = distortionFractionalDelayG3 * distortionNextInput + distortionPrevInput - distortionFractionalDelayG3 * distortionFractionalInput3;\n\t\t\t\t\tconst distortionOutput1 = distortionFractionalInput1 / (distortionReverse * Math.abs(distortionFractionalInput1) + distortion);\n\t\t\t\t\tconst distortionOutput2 = distortionFractionalInput2 / (distortionReverse * Math.abs(distortionFractionalInput2) + distortion);\n\t\t\t\t\tconst distortionOutput3 = distortionFractionalInput3 / (distortionReverse * Math.abs(distortionFractionalInput3) + distortion);\n\t\t\t\t\tdistortionNextOutput += distortionOutput1 * distortionNextOutputWeight1 + distortionOutput2 * distortionNextOutputWeight2 + distortionOutput3 * distortionNextOutputWeight3;\n\t\t\t\t\tsample += distortionOutput1 * distortionPrevOutputWeight1 + distortionOutput2 * distortionPrevOutputWeight2 + distortionOutput3 * distortionPrevOutputWeight3;\n\t\t\t\t\tsample *= distortionOversampleCompensation;\n\t\t\t\t\tdistortionPrevInput = distortionNextInput;\n\t\t\t\t\tdistortion += distortionDelta;\n\t\t\t\t\tdistortionDrive += distortionDriveDelta;"),a&&(t+="\n\t\t\t\t\t\n\t\t\t\t\tbitcrusherPhase += bitcrusherPhaseDelta;\n\t\t\t\t\tif (bitcrusherPhase < 1.0) {\n\t\t\t\t\t\tbitcrusherPrevInput = sample;\n\t\t\t\t\t\tsample = bitcrusherCurrentOutput;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tbitcrusherPhase = bitcrusherPhase % 1.0;\n\t\t\t\t\t\tconst ratio = bitcrusherPhase / bitcrusherPhaseDelta;\n\t\t\t\t\t\t\n\t\t\t\t\t\tconst lerpedInput = sample + (bitcrusherPrevInput - sample) * ratio;\n\t\t\t\t\t\tbitcrusherPrevInput = sample;\n\t\t\t\t\t\t\n\t\t\t\t\t\tconst bitcrusherWrapLevel = bitcrusherFoldLevel * 4.0;\n\t\t\t\t\t\tconst wrappedSample = (((lerpedInput + bitcrusherFoldLevel) % bitcrusherWrapLevel) + bitcrusherWrapLevel) % bitcrusherWrapLevel;\n\t\t\t\t\t\tconst foldedSample = bitcrusherFoldLevel - Math.abs(bitcrusherFoldLevel * 2.0 - wrappedSample);\n\t\t\t\t\t\tconst scaledSample = foldedSample / bitcrusherScale;\n\t\t\t\t\t\tconst oldValue = bitcrusherCurrentOutput;\n\t\t\t\t\t\tconst newValue = (((scaledSample > 0 ? scaledSample + 1 : scaledSample)|0)-.5) * bitcrusherScale;\n\t\t\t\t\t\t\n\t\t\t\t\t\tsample = oldValue + (newValue - oldValue) * ratio;\n\t\t\t\t\t\tbitcrusherCurrentOutput = newValue;\n\t\t\t\t\t}\n\t\t\t\t\tbitcrusherPhaseDelta *= bitcrusherPhaseDeltaScale;\n\t\t\t\t\tbitcrusherScale *= bitcrusherScaleScale;\n\t\t\t\t\tbitcrusherFoldLevel *= bitcrusherFoldLevelScale;"),l&&(t+="\n\t\t\t\t\t\n\t\t\t\t\tconst inputSample = sample;\n\t\t\t\t\tsample = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\n\t\t\t\t\tinitialFilterInput2 = initialFilterInput1;\n\t\t\t\t\tinitialFilterInput1 = inputSample;"),t+="\n\t\t\t\t\t\n\t\t\t\t\tsample *= eqFilterVolume;\n\t\t\t\t\teqFilterVolume += eqFilterVolumeDelta;",t+=c?"\n\t\t\t\t\t\n\t\t\t\t\tpanningDelayLine[panningDelayPos] = sample;\n\t\t\t\t\tconst panningRatioL  = panningOffsetL % 1;\n\t\t\t\t\tconst panningRatioR  = panningOffsetR % 1;\n\t\t\t\t\tconst panningTapLA   = panningDelayLine[(panningOffsetL) & panningMask];\n\t\t\t\t\tconst panningTapLB   = panningDelayLine[(panningOffsetL + 1) & panningMask];\n\t\t\t\t\tconst panningTapRA   = panningDelayLine[(panningOffsetR) & panningMask];\n\t\t\t\t\tconst panningTapRB   = panningDelayLine[(panningOffsetR + 1) & panningMask];\n\t\t\t\t\tconst panningTapL    = panningTapLA + (panningTapLB - panningTapLA) * panningRatioL;\n\t\t\t\t\tconst panningTapR    = panningTapRA + (panningTapRB - panningTapRA) * panningRatioR;\n\t\t\t\t\tlet sampleL = panningTapL * panningVolumeL;\n\t\t\t\t\tlet sampleR = panningTapR * panningVolumeR;\n\t\t\t\t\tpanningDelayPos = (panningDelayPos + 1) & panningMask;\n\t\t\t\t\tpanningVolumeL += panningVolumeDeltaL;\n\t\t\t\t\tpanningVolumeR += panningVolumeDeltaR;\n\t\t\t\t\tpanningOffsetL += panningOffsetDeltaL;\n\t\t\t\t\tpanningOffsetR += panningOffsetDeltaR;":"\n\t\t\t\t\t\n\t\t\t\t\tlet sampleL = sample;\n\t\t\t\t\tlet sampleR = sample;",u&&(t+="\n\t\t\t\t\t\n\t\t\t\t\tconst chorusTap0Ratio = chorusTap0Index % 1;\n\t\t\t\t\tconst chorusTap1Ratio = chorusTap1Index % 1;\n\t\t\t\t\tconst chorusTap2Ratio = chorusTap2Index % 1;\n\t\t\t\t\tconst chorusTap3Ratio = chorusTap3Index % 1;\n\t\t\t\t\tconst chorusTap4Ratio = chorusTap4Index % 1;\n\t\t\t\t\tconst chorusTap5Ratio = chorusTap5Index % 1;\n\t\t\t\t\tconst chorusTap0A = chorusDelayLineL[(chorusTap0Index) & chorusMask];\n\t\t\t\t\tconst chorusTap0B = chorusDelayLineL[(chorusTap0Index + 1) & chorusMask];\n\t\t\t\t\tconst chorusTap1A = chorusDelayLineL[(chorusTap1Index) & chorusMask];\n\t\t\t\t\tconst chorusTap1B = chorusDelayLineL[(chorusTap1Index + 1) & chorusMask];\n\t\t\t\t\tconst chorusTap2A = chorusDelayLineL[(chorusTap2Index) & chorusMask];\n\t\t\t\t\tconst chorusTap2B = chorusDelayLineL[(chorusTap2Index + 1) & chorusMask];\n\t\t\t\t\tconst chorusTap3A = chorusDelayLineR[(chorusTap3Index) & chorusMask];\n\t\t\t\t\tconst chorusTap3B = chorusDelayLineR[(chorusTap3Index + 1) & chorusMask];\n\t\t\t\t\tconst chorusTap4A = chorusDelayLineR[(chorusTap4Index) & chorusMask];\n\t\t\t\t\tconst chorusTap4B = chorusDelayLineR[(chorusTap4Index + 1) & chorusMask];\n\t\t\t\t\tconst chorusTap5A = chorusDelayLineR[(chorusTap5Index) & chorusMask];\n\t\t\t\t\tconst chorusTap5B = chorusDelayLineR[(chorusTap5Index + 1) & chorusMask];\n\t\t\t\t\tconst chorusTap0 = chorusTap0A + (chorusTap0B - chorusTap0A) * chorusTap0Ratio;\n\t\t\t\t\tconst chorusTap1 = chorusTap1A + (chorusTap1B - chorusTap1A) * chorusTap1Ratio;\n\t\t\t\t\tconst chorusTap2 = chorusTap2A + (chorusTap2B - chorusTap2A) * chorusTap2Ratio;\n\t\t\t\t\tconst chorusTap3 = chorusTap3A + (chorusTap3B - chorusTap3A) * chorusTap3Ratio;\n\t\t\t\t\tconst chorusTap4 = chorusTap4A + (chorusTap4B - chorusTap4A) * chorusTap4Ratio;\n\t\t\t\t\tconst chorusTap5 = chorusTap5A + (chorusTap5B - chorusTap5A) * chorusTap5Ratio;\n\t\t\t\t\tchorusDelayLineL[chorusDelayPos] = sampleL * delayInputMult;\n\t\t\t\t\tchorusDelayLineR[chorusDelayPos] = sampleR * delayInputMult;\n\t\t\t\t\tsampleL = chorusCombinedMult * (sampleL + chorusVoiceMult * (chorusTap1 - chorusTap0 - chorusTap2));\n\t\t\t\t\tsampleR = chorusCombinedMult * (sampleR + chorusVoiceMult * (chorusTap4 - chorusTap3 - chorusTap5));\n\t\t\t\t\tchorusDelayPos = (chorusDelayPos + 1) & chorusMask;\n\t\t\t\t\tchorusTap0Index += chorusTap0Delta;\n\t\t\t\t\tchorusTap1Index += chorusTap1Delta;\n\t\t\t\t\tchorusTap2Index += chorusTap2Delta;\n\t\t\t\t\tchorusTap3Index += chorusTap3Delta;\n\t\t\t\t\tchorusTap4Index += chorusTap4Delta;\n\t\t\t\t\tchorusTap5Index += chorusTap5Delta;\n\t\t\t\t\tchorusVoiceMult += chorusVoiceMultDelta;\n\t\t\t\t\tchorusCombinedMult += chorusCombinedMultDelta;"),p&&(t+="\n\t\t\t\t\t\n\t\t\t\t\tconst echoTapStartIndex = (echoDelayPos + echoDelayOffsetStart) & echoMask;\n\t\t\t\t\tconst echoTapEndIndex   = (echoDelayPos + echoDelayOffsetEnd  ) & echoMask;\n\t\t\t\t\tconst echoTapStartL = echoDelayLineL[echoTapStartIndex];\n\t\t\t\t\tconst echoTapEndL   = echoDelayLineL[echoTapEndIndex];\n\t\t\t\t\tconst echoTapStartR = echoDelayLineR[echoTapStartIndex];\n\t\t\t\t\tconst echoTapEndR   = echoDelayLineR[echoTapEndIndex];\n\t\t\t\t\tconst echoTapL = (echoTapStartL + (echoTapEndL - echoTapStartL) * echoDelayOffsetRatio) * echoMult;\n\t\t\t\t\tconst echoTapR = (echoTapStartR + (echoTapEndR - echoTapStartR) * echoDelayOffsetRatio) * echoMult;\n\t\t\t\t\t\n\t\t\t\t\techoShelfSampleL = echoShelfB0 * echoTapL + echoShelfB1 * echoShelfPrevInputL - echoShelfA1 * echoShelfSampleL;\n\t\t\t\t\techoShelfSampleR = echoShelfB0 * echoTapR + echoShelfB1 * echoShelfPrevInputR - echoShelfA1 * echoShelfSampleR;\n\t\t\t\t\techoShelfPrevInputL = echoTapL;\n\t\t\t\t\techoShelfPrevInputR = echoTapR;\n\t\t\t\t\tsampleL += echoShelfSampleL;\n\t\t\t\t\tsampleR += echoShelfSampleR;\n\t\t\t\t\t\n\t\t\t\t\techoDelayLineL[echoDelayPos] = sampleL * delayInputMult;\n\t\t\t\t\techoDelayLineR[echoDelayPos] = sampleR * delayInputMult;\n\t\t\t\t\techoDelayPos = (echoDelayPos + 1) & echoMask;\n\t\t\t\t\techoDelayOffsetRatio += echoDelayOffsetRatioDelta;\n\t\t\t\t\techoMult += echoMultDelta;"),d&&(t+="\n\t\t\t\t\t\n\t\t\t\t\t// Reverb, implemented using a feedback delay network with a Hadamard matrix and lowpass filters.\n\t\t\t\t\t// good ratios:    0.555235 + 0.618033 + 0.818 +   1.0 = 2.991268\n\t\t\t\t\t// Delay lengths:  3041     + 3385     + 4481  +  5477 = 16384 = 2^14\n\t\t\t\t\t// Buffer offsets: 3041    -> 6426   -> 10907 -> 16384\n\t\t\t\t\tconst reverbDelayPos1 = (reverbDelayPos +  3041) & reverbMask;\n\t\t\t\t\tconst reverbDelayPos2 = (reverbDelayPos +  6426) & reverbMask;\n\t\t\t\t\tconst reverbDelayPos3 = (reverbDelayPos + 10907) & reverbMask;\n\t\t\t\t\tconst reverbSample0 = (reverbDelayLine[reverbDelayPos]);\n\t\t\t\t\tconst reverbSample1 = reverbDelayLine[reverbDelayPos1];\n\t\t\t\t\tconst reverbSample2 = reverbDelayLine[reverbDelayPos2];\n\t\t\t\t\tconst reverbSample3 = reverbDelayLine[reverbDelayPos3];\n\t\t\t\t\tconst reverbTemp0 = -(reverbSample0 + sampleL) + reverbSample1;\n\t\t\t\t\tconst reverbTemp1 = -(reverbSample0 + sampleR) - reverbSample1;\n\t\t\t\t\tconst reverbTemp2 = -reverbSample2 + reverbSample3;\n\t\t\t\t\tconst reverbTemp3 = -reverbSample2 - reverbSample3;\n\t\t\t\t\tconst reverbShelfInput0 = (reverbTemp0 + reverbTemp2) * reverb;\n\t\t\t\t\tconst reverbShelfInput1 = (reverbTemp1 + reverbTemp3) * reverb;\n\t\t\t\t\tconst reverbShelfInput2 = (reverbTemp0 - reverbTemp2) * reverb;\n\t\t\t\t\tconst reverbShelfInput3 = (reverbTemp1 - reverbTemp3) * reverb;\n\t\t\t\t\treverbShelfSample0 = reverbShelfB0 * reverbShelfInput0 + reverbShelfB1 * reverbShelfPrevInput0 - reverbShelfA1 * reverbShelfSample0;\n\t\t\t\t\treverbShelfSample1 = reverbShelfB0 * reverbShelfInput1 + reverbShelfB1 * reverbShelfPrevInput1 - reverbShelfA1 * reverbShelfSample1;\n\t\t\t\t\treverbShelfSample2 = reverbShelfB0 * reverbShelfInput2 + reverbShelfB1 * reverbShelfPrevInput2 - reverbShelfA1 * reverbShelfSample2;\n\t\t\t\t\treverbShelfSample3 = reverbShelfB0 * reverbShelfInput3 + reverbShelfB1 * reverbShelfPrevInput3 - reverbShelfA1 * reverbShelfSample3;\n\t\t\t\t\treverbShelfPrevInput0 = reverbShelfInput0;\n\t\t\t\t\treverbShelfPrevInput1 = reverbShelfInput1;\n\t\t\t\t\treverbShelfPrevInput2 = reverbShelfInput2;\n\t\t\t\t\treverbShelfPrevInput3 = reverbShelfInput3;\n\t\t\t\t\treverbDelayLine[reverbDelayPos1] = reverbShelfSample0 * delayInputMult;\n\t\t\t\t\treverbDelayLine[reverbDelayPos2] = reverbShelfSample1 * delayInputMult;\n\t\t\t\t\treverbDelayLine[reverbDelayPos3] = reverbShelfSample2 * delayInputMult;\n\t\t\t\t\treverbDelayLine[reverbDelayPos ] = reverbShelfSample3 * delayInputMult;\n\t\t\t\t\treverbDelayPos = (reverbDelayPos + 1) & reverbMask;\n\t\t\t\t\tsampleL += reverbSample1 + reverbSample2 + reverbSample3;\n\t\t\t\t\tsampleR += reverbSample0 + reverbSample2 - reverbSample3;\n\t\t\t\t\treverb += reverbDelta;"),t+="\n\t\t\t\t\t\n\t\t\t\t\toutputDataL[sampleIndex] += sampleL * mixVolume;\n\t\t\t\t\toutputDataR[sampleIndex] += sampleR * mixVolume;\n\t\t\t\t\tmixVolume += mixVolumeDelta;",s&&(t+="\n\t\t\t\t\t\n\t\t\t\t\tdelayInputMult += delayInputMultDelta;"),t+="\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tinstrumentState.mixVolume = mixVolume;\n\t\t\t\tinstrumentState.eqFilterVolume = eqFilterVolume;\n\t\t\t\t\n\t\t\t\t// Avoid persistent denormal or NaN values in the delay buffers and filter history.\n\t\t\t\tconst epsilon = (1.0e-24);",s&&(t+="\n\t\t\t\t\n\t\t\t\tinstrumentState.delayInputMult = delayInputMult;"),r&&(t+="\n\t\t\t\t\n\t\t\t\tinstrumentState.distortion = distortion;\n\t\t\t\tinstrumentState.distortionDrive = distortionDrive;\n\t\t\t\t\n\t\t\t\tif (!Number.isFinite(distortionFractionalInput1) || Math.abs(distortionFractionalInput1) < epsilon) distortionFractionalInput1 = 0.0;\n\t\t\t\tif (!Number.isFinite(distortionFractionalInput2) || Math.abs(distortionFractionalInput2) < epsilon) distortionFractionalInput2 = 0.0;\n\t\t\t\tif (!Number.isFinite(distortionFractionalInput3) || Math.abs(distortionFractionalInput3) < epsilon) distortionFractionalInput3 = 0.0;\n\t\t\t\tif (!Number.isFinite(distortionPrevInput) || Math.abs(distortionPrevInput) < epsilon) distortionPrevInput = 0.0;\n\t\t\t\tif (!Number.isFinite(distortionNextOutput) || Math.abs(distortionNextOutput) < epsilon) distortionNextOutput = 0.0;\n\t\t\t\t\n\t\t\t\tinstrumentState.distortionFractionalInput1 = distortionFractionalInput1;\n\t\t\t\tinstrumentState.distortionFractionalInput2 = distortionFractionalInput2;\n\t\t\t\tinstrumentState.distortionFractionalInput3 = distortionFractionalInput3;\n\t\t\t\tinstrumentState.distortionPrevInput = distortionPrevInput;\n\t\t\t\tinstrumentState.distortionNextOutput = distortionNextOutput;"),a&&(t+="\n\t\t\t\t\t\n\t\t\t\tif (Math.abs(bitcrusherPrevInput) < epsilon) bitcrusherPrevInput = 0.0;\n\t\t\t\tif (Math.abs(bitcrusherCurrentOutput) < epsilon) bitcrusherCurrentOutput = 0.0;\n\t\t\t\tinstrumentState.bitcrusherPrevInput = bitcrusherPrevInput;\n\t\t\t\tinstrumentState.bitcrusherCurrentOutput = bitcrusherCurrentOutput;\n\t\t\t\tinstrumentState.bitcrusherPhase = bitcrusherPhase;\n\t\t\t\tinstrumentState.bitcrusherPhaseDelta = bitcrusherPhaseDelta;\n\t\t\t\tinstrumentState.bitcrusherScale = bitcrusherScale;\n\t\t\t\tinstrumentState.bitcrusherFoldLevel = bitcrusherFoldLevel;"),l&&(t+="\n\t\t\t\t\t\n\t\t\t\tsynth.sanitizeFilters(filters);\n\t\t\t\t// The filter input here is downstream from another filter so we\n\t\t\t\t// better make sure it's safe too.\n\t\t\t\tif (!(initialFilterInput1 < 100) || !(initialFilterInput2 < 100)) {\n\t\t\t\t\tinitialFilterInput1 = 0.0;\n\t\t\t\t\tinitialFilterInput2 = 0.0;\n\t\t\t\t}\n\t\t\t\tif (Math.abs(initialFilterInput1) < epsilon) initialFilterInput1 = 0.0;\n\t\t\t\tif (Math.abs(initialFilterInput2) < epsilon) initialFilterInput2 = 0.0;\n\t\t\t\tinstrumentState.initialEqFilterInput1 = initialFilterInput1;\n\t\t\t\tinstrumentState.initialEqFilterInput2 = initialFilterInput2;"),c&&(t+="\n\t\t\t\t\n\t\t\t\tSynth.sanitizeDelayLine(panningDelayLine, panningDelayPos, panningMask);\n\t\t\t\tinstrumentState.panningDelayPos = panningDelayPos;\n\t\t\t\tinstrumentState.panningVolumeL = panningVolumeL;\n\t\t\t\tinstrumentState.panningVolumeR = panningVolumeR;\n\t\t\t\tinstrumentState.panningOffsetL = panningOffsetL;\n\t\t\t\tinstrumentState.panningOffsetR = panningOffsetR;"),u&&(t+="\n\t\t\t\t\n\t\t\t\tSynth.sanitizeDelayLine(chorusDelayLineL, chorusDelayPos, chorusMask);\n\t\t\t\tSynth.sanitizeDelayLine(chorusDelayLineR, chorusDelayPos, chorusMask);\n\t\t\t\tinstrumentState.chorusPhase = chorusPhase;\n\t\t\t\tinstrumentState.chorusDelayPos = chorusDelayPos;\n\t\t\t\tinstrumentState.chorusVoiceMult = chorusVoiceMult;\n\t\t\t\tinstrumentState.chorusCombinedMult = chorusCombinedMult;"),p&&(t+="\n\t\t\t\t\n\t\t\t\tSynth.sanitizeDelayLine(echoDelayLineL, echoDelayPos, echoMask);\n\t\t\t\tSynth.sanitizeDelayLine(echoDelayLineR, echoDelayPos, echoMask);\n\t\t\t\tinstrumentState.echoDelayPos = echoDelayPos;\n\t\t\t\tinstrumentState.echoMult = echoMult;\n\t\t\t\tinstrumentState.echoDelayOffsetRatio = echoDelayOffsetRatio;\n\t\t\t\t\n\t\t\t\tif (!Number.isFinite(echoShelfSampleL) || Math.abs(echoShelfSampleL) < epsilon) echoShelfSampleL = 0.0;\n\t\t\t\tif (!Number.isFinite(echoShelfSampleR) || Math.abs(echoShelfSampleR) < epsilon) echoShelfSampleR = 0.0;\n\t\t\t\tif (!Number.isFinite(echoShelfPrevInputL) || Math.abs(echoShelfPrevInputL) < epsilon) echoShelfPrevInputL = 0.0;\n\t\t\t\tif (!Number.isFinite(echoShelfPrevInputR) || Math.abs(echoShelfPrevInputR) < epsilon) echoShelfPrevInputR = 0.0;\n\t\t\t\tinstrumentState.echoShelfSampleL = echoShelfSampleL;\n\t\t\t\tinstrumentState.echoShelfSampleR = echoShelfSampleR;\n\t\t\t\tinstrumentState.echoShelfPrevInputL = echoShelfPrevInputL;\n\t\t\t\tinstrumentState.echoShelfPrevInputR = echoShelfPrevInputR;"),d&&(t+="\n\t\t\t\t\n\t\t\t\tSynth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos        , reverbMask);\n\t\t\t\tSynth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos +  3041, reverbMask);\n\t\t\t\tSynth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos +  6426, reverbMask);\n\t\t\t\tSynth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos + 10907, reverbMask);\n\t\t\t\tinstrumentState.reverbDelayPos = reverbDelayPos;\n\t\t\t\tinstrumentState.reverbMult = reverb;\n\t\t\t\t\n\t\t\t\tif (!Number.isFinite(reverbShelfSample0) || Math.abs(reverbShelfSample0) < epsilon) reverbShelfSample0 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfSample1) || Math.abs(reverbShelfSample1) < epsilon) reverbShelfSample1 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfSample2) || Math.abs(reverbShelfSample2) < epsilon) reverbShelfSample2 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfSample3) || Math.abs(reverbShelfSample3) < epsilon) reverbShelfSample3 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput0) || Math.abs(reverbShelfPrevInput0) < epsilon) reverbShelfPrevInput0 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput1) || Math.abs(reverbShelfPrevInput1) < epsilon) reverbShelfPrevInput1 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput2) || Math.abs(reverbShelfPrevInput2) < epsilon) reverbShelfPrevInput2 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput3) || Math.abs(reverbShelfPrevInput3) < epsilon) reverbShelfPrevInput3 = 0.0;\n\t\t\t\tinstrumentState.reverbShelfSample0 = reverbShelfSample0;\n\t\t\t\tinstrumentState.reverbShelfSample1 = reverbShelfSample1;\n\t\t\t\tinstrumentState.reverbShelfSample2 = reverbShelfSample2;\n\t\t\t\tinstrumentState.reverbShelfSample3 = reverbShelfSample3;\n\t\t\t\tinstrumentState.reverbShelfPrevInput0 = reverbShelfPrevInput0;\n\t\t\t\tinstrumentState.reverbShelfPrevInput1 = reverbShelfPrevInput1;\n\t\t\t\tinstrumentState.reverbShelfPrevInput2 = reverbShelfPrevInput2;\n\t\t\t\tinstrumentState.reverbShelfPrevInput3 = reverbShelfPrevInput3;"),t+="}",x=new Function("Config","Synth",t)(e,Xe),Xe.effectsFunctionCache[f]=x}x(t,s,i,n,h,o)}static pulseWidthSynth(t,e,s,i,n){const h=t.tempMonoInstrumentSampleBuffer;let o=i.phaseDeltas[0];const r=+i.phaseDeltaScales[0];let a=+i.expression;const l=+i.expressionDelta;let c=i.phases[0]%1,u=i.pulseWidth;const p=i.pulseWidthDelta,d=i.noteFilters,f=0|i.noteFilterCount;let m=+i.initialNoteFilterInput1,y=+i.initialNoteFilterInput2;const b=Xe.applyFilters,w=e+s;for(let t=e;t<w;t++){const e=c%1,s=(c+u)%1;let i=s-e;if(e<o)i+=.5*((g=e/o)+g-g*g-1);else if(e>1-o){i+=.5*((g=(e-1)/o)+g+g*g+1)}if(s<o)i-=.5*((g=s/o)+g-g*g-1);else if(s>1-o){var g;i-=.5*((g=(s-1)/o)+g+g*g+1)}const n=i,w=b(n,m,y,f,d);y=m,m=n,c+=o,o*=r,u+=p;const v=w*a;a+=l,h[t]+=v}i.phases[0]=c,i.phaseDeltas[0]=o,i.expression=a,i.pulseWidth=u,t.sanitizeFilters(d),i.initialNoteFilterInput1=m,i.initialNoteFilterInput2=y}static supersawSynth(t,s,i,n,h){const o=t.tempMonoInstrumentSampleBuffer,r=0|e.supersawVoiceCount;let a=n.phaseDeltas[0];const l=+n.phaseDeltaScales[0];let c=+n.expression;const u=+n.expressionDelta;let p=n.phases,d=+n.supersawDynamism;const f=+n.supersawDynamismDelta,m=n.supersawUnisonDetunes;let y=+n.supersawShape;const b=+n.supersawShapeDelta;let w=+n.supersawDelayLength;const g=+n.supersawDelayLengthDelta,v=n.supersawDelayLine,x=v.length-1>>0;let k=0|n.supersawDelayIndex;k=(k&x)+v.length;const M=n.noteFilters,S=0|n.noteFilterCount;let P=+n.initialNoteFilterInput1,I=+n.initialNoteFilterInput2;const F=Xe.applyFilters,B=s+i;for(let t=s;t<B;t++){let e=(p[0]+a)%1,s=e-.5*(1+(r-1)*d);if(e<a)s-=.5*((L=e/a)+L-L*L-1);else if(e>1-a){var L;s-=.5*((L=(e-1)/a)+L+L*L+1)}p[0]=e;for(let t=1;t<r;t++){const e=a*m[t];let i=(p[t]+e)%1;if(s+=i*d,i<e){const t=i/e;s-=.5*(t+t-t*t-1)*d}else if(i>1-e){const t=(i-1)/e;s-=.5*(t+t+t*t+1)*d}p[t]=i}v[k&x]=s;const i=k-w,n=0|i,h=n+1,B=i-n,C=v[n&x];k++;const D=s-(C+(v[h&x]-C)*B)*y,T=F(D,P,I,S,M);I=P,P=D,a*=l,d+=f,y+=b,w+=g;const E=T*c;c+=u,o[t]+=E}n.phaseDeltas[0]=a,n.expression=c,n.supersawDynamism=d,n.supersawShape=y,n.supersawDelayLength=w,n.supersawDelayIndex=k,t.sanitizeFilters(M),n.initialNoteFilterInput1=P,n.initialNoteFilterInput2=I}static noiseSynth(t,s,i,n,h){const o=t.tempMonoInstrumentSampleBuffer,r=h.wave;let a=+n.phaseDeltas[0];const l=+n.phaseDeltaScales[0];let c=+n.expression;const u=+n.expressionDelta;let p=n.phases[0]%1*e.chipNoiseLength;0==n.phases[0]&&(p=Math.random()*e.chipNoiseLength);const d=e.chipNoiseLength-1;let f=+n.noiseSample;const m=n.noteFilters,y=0|n.noteFilterCount;let b=+n.initialNoteFilterInput1,w=+n.initialNoteFilterInput2;const g=Xe.applyFilters,v=Math.min(1,a*h.noisePitchFilterMult),x=s+i;for(let t=s;t<x;t++){f+=(r[p&d]-f)*v;const e=f,s=g(e,b,w,y,m);w=b,b=e,p+=a,a*=l;const i=s*c;c+=u,o[t]+=i}n.phases[0]=p/e.chipNoiseLength,n.phaseDeltas[0]=a,n.expression=c,n.noiseSample=f,t.sanitizeFilters(m),n.initialNoteFilterInput1=b,n.initialNoteFilterInput2=w}static spectrumSynth(t,s,i,n,h){const o=t.tempMonoInstrumentSampleBuffer,r=h.wave;let a=128*n.phaseDeltas[0];const l=+n.phaseDeltaScales[0];let c=+n.expression;const u=+n.expressionDelta;let p=+n.noiseSample;const d=n.noteFilters,f=0|n.noteFilterCount;let m=+n.initialNoteFilterInput1,y=+n.initialNoteFilterInput2;const b=Xe.applyFilters;let w=n.phases[0]%1*e.spectrumNoiseLength;0==n.phases[0]&&(w=Xe.findRandomZeroCrossing(r,e.spectrumNoiseLength)+a);const g=e.spectrumNoiseLength-1,v=Math.min(1,a),x=s+i;for(let t=s;t<x;t++){const e=0|w,s=e&g;let i=r[s];const n=w-e;i+=(r[s+1]-i)*n,p+=(i-p)*v;const h=p,x=b(h,m,y,f,d);y=m,m=h,w+=a,a*=l;const k=x*c;c+=u,o[t]+=k}n.phases[0]=w/e.spectrumNoiseLength,n.phaseDeltas[0]=a/128,n.expression=c,n.noiseSample=p,t.sanitizeFilters(d),n.initialNoteFilterInput1=m,n.initialNoteFilterInput2=y}static drumsetSynth(t,s,i,n,h){const o=t.tempMonoInstrumentSampleBuffer;let r=h.getDrumsetWave(n.drumsetPitch);const a=Je.drumsetIndexReferenceDelta(n.drumsetPitch);let l=n.phaseDeltas[0]/a;const c=+n.phaseDeltaScales[0];let u=+n.expression;const p=+n.expressionDelta,d=n.noteFilters,f=0|n.noteFilterCount;let m=+n.initialNoteFilterInput1,y=+n.initialNoteFilterInput2;const b=Xe.applyFilters;let w=n.phases[0]%1*e.spectrumNoiseLength;0==n.phases[0]&&(w=Xe.findRandomZeroCrossing(r,e.spectrumNoiseLength)+l);const g=e.spectrumNoiseLength-1,v=s+i;for(let t=s;t<v;t++){const e=0|w,s=e&g;let i=r[s];const n=w-e;i+=(r[s+1]-i)*n;const h=i,a=b(h,m,y,f,d);y=m,m=h,w+=l,l*=c;const v=a*u;u+=p,o[t]+=v}n.phases[0]=w/e.spectrumNoiseLength,n.phaseDeltas[0]=l*a,n.expression=u,t.sanitizeFilters(d),n.initialNoteFilterInput1=m,n.initialNoteFilterInput2=y}static findRandomZeroCrossing(t,e){let s=Math.random()*e;const i=e-1;let n=s&i,h=t[n];for(let o=128;o>0;o--){const o=n+16&i,r=t[o];if(h*r<=0){for(let o=0;o<16;o++){const o=n+1&i,r=t[o];if(h*r<=0){const t=r-h;s=n,Math.abs(t)>1e-8&&(s+=-h/t),s=Math.max(0,s)%e;break}n=o,h=r}break}n=o,h=r}return s}static instrumentVolumeToVolumeMult(t){return t==e.volumeRange-1?0:Math.pow(2,e.volumeLogScale*t)}static volumeMultToInstrumentVolume(t){return t<=0?e.volumeRange-1:Math.min(e.volumeRange-2,Math.log2(t)/e.volumeLogScale)}static noteSizeToVolumeMult(t){return Math.pow(Math.max(0,t)/e.noteSizeMax,1.5)}static volumeMultToNoteSize(t){return Math.pow(Math.max(0,t),1/1.5)*e.noteSizeMax}static fadeInSettingToSeconds(t){return.0125*(.95*t+.05*t*t)}static secondsToFadeInSetting(t){return Fe(0,e.fadeInRange,Math.round((-.95+Math.sqrt(.9025+.2*t/.0125))/.1))}static fadeOutSettingToTicks(t){return e.fadeOutTicks[t]}static ticksToFadeOutSetting(t){let s=e.fadeOutTicks[0];if(t<=s)return 0;for(let i=1;i<e.fadeOutTicks.length;i++){let n=e.fadeOutTicks[i];if(t<=n)return t<(s+n)/2?i-1:i;s=n}return e.fadeOutTicks.length-1}static detuneToCents(t){return t*(Math.abs(t)+1)/2}static centsToDetune(t){return Math.sign(t)*(Math.sqrt(1+8*Math.abs(t))-1)/2}getSamplesPerTick(){if(null==this.song)return 0;const t=this.song.getBeatsPerMinute()/60,s=e.partsPerBeat*t,i=e.ticksPerPart*s;return this.samplesPerSecond/i}static fittingPowerOfTwo(t){return 1<<32-Math.clz32(Math.ceil(t)-1)}sanitizeFilters(t){let e=!1;for(const s of t){const t=Math.abs(s.output1),i=Math.abs(s.output2);if(!(t<100&&i<100)){e=!0;break}t<Ie&&(s.output1=0),i<Ie&&(s.output2=0)}if(e)for(const e of t)e.output1=0,e.output2=0}static sanitizeDelayLine(t,e,s){for(;;){const i=--e&s,n=Math.abs(t[i]);if(Number.isFinite(n)&&(0==n||n>=Ie))break;t[i]=0}}static applyFilters(t,e,s,i,n){for(let h=0;h<i;h++){const i=n[h],o=i.output1,r=i.output2,a=i.a1,l=i.a2,c=i.b0,u=i.b1,p=i.b2;t=c*t+u*e+p*s-a*o-l*r,i.a1=a+i.a1Delta,i.a2=l+i.a2Delta,i.useMultiplicativeInputCoefficients?(i.b0=c*i.b0Delta,i.b1=u*i.b1Delta,i.b2=p*i.b2Delta):(i.b0=c+i.b0Delta,i.b1=u+i.b1Delta,i.b2=p+i.b2Delta),i.output2=o,i.output1=t,s=r,e=o}return t}}Xe.tempFilterStartCoefficients=new ke,Xe.tempFilterEndCoefficients=new ke,Xe.fmSynthFunctionCache={},Xe.effectsFunctionCache=Array(128).fill(void 0),Xe.pickedStringFunctionCache=Array(3).fill(void 0),Xe.fmSourceTemplate=("\n\t\tconst data = synth.tempMonoInstrumentSampleBuffer;\n\t\tconst sineWave = Config.sineWave;\n\t\t\n\t\t// I'm adding 1000 to the phase to ensure that it's never negative even when modulated by other waves because negative numbers don't work with the modulus operator very well.\n\t\tlet operator#Phase       = +((tone.phases[#] % 1) + 1000) * "+e.sineWaveLength+";\n\t\tlet operator#PhaseDelta  = +tone.phaseDeltas[#] * "+e.sineWaveLength+";\n\t\tlet operator#PhaseDeltaScale = +tone.phaseDeltaScales[#];\n\t\tlet operator#OutputMult  = +tone.operatorExpressions[#];\n\t\tconst operator#OutputDelta = +tone.operatorExpressionDeltas[#];\n\t\tlet operator#Output      = +tone.feedbackOutputs[#];\n\t\tlet feedbackMult         = +tone.feedbackMult;\n\t\tconst feedbackDelta      = +tone.feedbackDelta;\n\t\tlet expression = +tone.expression;\n\t\tconst expressionDelta = +tone.expressionDelta;\n\t\t\n\t\tconst filters = tone.noteFilters;\n\t\tconst filterCount = tone.noteFilterCount|0;\n\t\tlet initialFilterInput1 = +tone.initialNoteFilterInput1;\n\t\tlet initialFilterInput2 = +tone.initialNoteFilterInput2;\n\t\tconst applyFilters = Synth.applyFilters;\n\t\t\n\t\tconst stopIndex = bufferIndex + runLength;\n\t\tfor (let sampleIndex = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\n\t\t\t// INSERT OPERATOR COMPUTATION HERE\n\t\t\tconst fmOutput = (/*operator#Scaled*/); // CARRIER OUTPUTS\n\t\t\t\n\t\t\tconst inputSample = fmOutput;\n\t\t\tconst sample = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\n\t\t\tinitialFilterInput2 = initialFilterInput1;\n\t\t\tinitialFilterInput1 = inputSample;\n\t\t\t\n\t\t\tfeedbackMult += feedbackDelta;\n\t\t\toperator#OutputMult += operator#OutputDelta;\n\t\t\toperator#Phase += operator#PhaseDelta;\n\t\t\toperator#PhaseDelta *= operator#PhaseDeltaScale;\n\t\t\t\n\t\t\tconst output = sample * expression;\n\t\t\texpression += expressionDelta;\n\t\t\t\n\t\t\tdata[sampleIndex] += output;\n\t\t}\n\t\t\n\t\ttone.phases[#] = operator#Phase / "+e.sineWaveLength+";\n\t\ttone.phaseDeltas[#] = operator#PhaseDelta / "+e.sineWaveLength+";\n\t\ttone.operatorExpressions[#] = operator#OutputMult;\n\t\ttone.feedbackOutputs[#] = operator#Output;\n\t\ttone.feedbackMult = feedbackMult;\n\t\ttone.expression = expression;\n\t\t\n\t\tsynth.sanitizeFilters(filters);\n\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\n\t\ttone.initialNoteFilterInput2 = initialFilterInput2;\n\t").split("\n"),Xe.operatorSourceTemplate=("\n\t\t\tconst operator#PhaseMix = operator#Phase/* + operator@Scaled*/;\n\t\t\tconst operator#PhaseInt = operator#PhaseMix|0;\n\t\t\tconst operator#Index    = operator#PhaseInt & "+e.sineWaveMask+";\n\t\t\tconst operator#Sample   = sineWave[operator#Index];\n\t\t\toperator#Output         = operator#Sample + (sineWave[operator#Index + 1] - operator#Sample) * (operator#PhaseMix - operator#PhaseInt);\n\t\t\tconst operator#Scaled   = operator#OutputMult * operator#Output;\n\t").split("\n");const{button:Ze,div:ts,p:es,h2:ss}=N;class is{constructor(t,e){let s;switch(this.u=t,this.st=Ze({class:"cancelButton"}),this.k=()=>{this.u.undo()},this.cleanUp=()=>{this.st.removeEventListener("click",this.k)},e){case"scale":s=ts(ss("Scale"),es("This setting limits the available pitches for adding notes. You may think that there's no point in limiting your choices, but the set of pitches you use has a strong influence on the mood and feel of your song, and these scales serve as guides to help you choose appropriate pitches. Don't worry, you can change the scale at any time, so you're not locked into it. Try making little melodies using all the available pitches of a scale to get a sense for how it sounds."),es('Most of the scales have a major version, marked with a smiley face, and a minor version, marked with a sad face. Assuming your song uses all pitches in the scale and especially "tonic" pitches (the brown rows in the pattern editor) then major scales tend to sound more playful or optimistic, whereas minor scales sound more serious or sad.'));break;case"key":s=ts(ss("Song Key"),es('This setting can shift the frequency of every note in your entire song up or down, keeping the "tonic" pitches (the brown rows in the pattern editor) aligned with the selected "key" pitch.'),es('If you\'ve already placed some notes but they don\'t emphasize "tonic" pitches then the selected key isn\'t very meaningful. You can select the "Detect Key" option in the key menu to automatically align the most emphasized notes with "tonic" pitches.'));break;case"tempo":s=ts(ss("Song Tempo"),es('This setting controls the speed of your song, measured in beats-per-minute. A "beat" is the duration of the little gray rectangles in the pattern editor. (In conventional music notation, a "quarter note" is usually equivalent to "beat".)'));break;case"reverb":s=ts(ss("Reverb"),es('Reverb is like a continuous echo effect. A little bit helps instruments sound more natural. Adding a lot of reverb can add sense of depth or mystery, but too much reverb can kinda "smear" sounds so that it\'s harder to distinguish notes or instruments, especially for lower "bass" notes.'));break;case"rhythm":s=ts(ss("Rhythm"),es("This setting determines how beats are divided. The pattern editor helps you align notes to fractions of a beat based on this setting."),es("If you've already placed some notes but they don't align with the selected rhythm, you can select the \"Snap Notes To Rhythm\" option in the rhythm menu to force the notes in the currently selected pattern(s) to align with the selected rhythm."));break;case"instrumentIndex":s=ts(ss("Instrument Number"),es('In the "Channel Settings" option from BeepBox\'s "Edit" menu, there are a few ways to enable multiple instruments per channel.'),es("First, you could enable multiple simultaneous instruments per channel. All of the channel's instruments will play all of the notes in the channel at the same time, and you can click an instrument number to view and edit its settings."),es("Second, you could enable different instruments per pattern. Only one of the instruments will play at any given time, but you can click the instrument number to change which instrument is used for the currently selected pattern(s)."),es("Finally, you can enable them both, in which case you can click an instrument number once to view it, and again to toggle whether the instrument is used for the currently selected pattern(s)."),es("Either way, you can click the + button to add more instruments to a channel, and you can press shift and a number key on your keyboard to select an instrument as if you had clicked the corresponding button here."));break;case"instrumentVolume":s=ts(ss("Instrument Volume"),es("This setting controls the volume of the selected instrument without affecting the volume of the other instruments. This allows you to balance the loudness of each instrument relative to each other."));break;case"pan":s=ts(ss("Instrument Panning"),es("If you're listening through headphones or some other stereo sound system, this controls the position of the instrument and where the sound is coming from, ranging from left to right."),es("As a suggestion, composers often put lead melodies, drums, and basses in the center, and spread other instruments toward either side. If too many instruments seem like they're coming from the same place, it can feel crowded and harder to distinguish individual sounds, especially if they cover a similar pitch range."));break;case"instrumentType":s=ts(ss("Instrument Type"),es("BeepBox comes with many instrument presets, try them out! You can also create your own custom instruments!"),es("There are also options for copying and pasting instrument settings and for generating random instruments at the top of the instrument type menu."));break;case"eqFilter":s=ts(ss("EQ Filter"),es("Filters are a way of emphasizing or diminishing different parts of a sound. Musical notes have a fundamental (base) frequency, but the sound of a musical note also has parts at higher frequencies and filters can adjust the volume of each of these parts based on their frequency."),es("Click in the filter editor to insert, delete, or drag a filter control point. The horizontal position of the point determines which frequencies it affects, and the vertical position determines how the volume is affected at that frequency."),es('Insert a new point on the left side of the filter editor to add a "high-pass" filter point, which additionally reduces the volume of lower frequencies, or insert a new point on the right side to add a "low-pass" filter point which reduces the volume of higher frequencies.'),es('You can also enable a "Note Filter" as an effect. EQ and note filters are mostly the same, but have different purposes. EQ filters are for overall adjustments, whereas note filters are for dynamic control and can be moved with envelopes. Note filters also change how the distortion effect sounds.'));break;case"noteFilter":s=ts(ss("Note Filter"),es("Note filters are mostly the same as EQ filters, but have a different purpose. EQ filters are for overall adjustments, whereas note filters are for dynamic control and can be moved with envelopes. Note filters also change how the distortion effect sounds."),es("Filters are a way of emphasizing or diminishing different parts of a sound. Musical notes have a fundamental (base) frequency, but the sound of a musical note also has parts at higher frequencies and filters can adjust the volume of each of these parts based on their frequency."),es("Click in the filter editor to insert, delete, or drag a filter control point. The horizontal position of the point determines which frequencies it affects, and the vertical position determines how the volume is affected at that frequency."),es('Insert a new point on the left side of the filter editor to add a "high-pass" filter point, which additionally reduces the volume of lower frequencies, or insert a new point on the right side to add a "low-pass" filter point which reduces the volume of higher frequencies.'));break;case"fadeInOut":s=ts(ss("Fade In/Out"),es("This setting controls how long it takes for notes to reach full volume at the beginning or decay to silence at the end."),es("An instant fade-in sounds like instruments that are played by hitting or plucking, whereas slower fade-ins sound like instruments that are played by blowing air."),es("You can also make the fade-out start before the note ends to leave a gap before the next note starts, or after the note ends to allow the sound of the end of the note to overlap with the start of the next note."));break;case"transition":s=ts(ss("Transition"),es("Usually, when one note ends at the same time another begins, the old note will fade out and the new note will fade in based on the fade in/out settings, but this setting can override that, connecting the end of one note to the beginning of the next."),es('The "interrupt" transition makes the wave suddenly change from the old note\'s frequency to the new note\'s frequency without any fading, but still restarts envelopes at the beginning of the new note. The "continue" transition is similar but it doesn\'t even restart envelopes, and can be used to make each of the notes in a chord start or stop at different times!'),es('The "slide" transition makes the pitch shift quickly but not instantaneously from the old note\'s frequency to the new note\'s frequency, and softly restarts envelopes. The "slide in pattern" transition is the same except it doesn\'t connect the last note in a pattern to the first note in the next pattern.'));break;case"chipWave":s=ts(ss("Chip Wave"),es("BeepBox comes with some sound waves based on classic electronic sound chips, as well as several unique waves. This is the basic source of the sound of the instrument, which is modified by the other instrument settings."));break;case"chipNoise":s=ts(ss("Noise"),es("BeepBox comes with several basic noise sounds. These do not have any distinct musical pitch, and can be used like drums to create beats and emphasize your song's rhythm."));break;case"supersawDynamism":s=ts(ss("Supersaw Dynamism"),es("A supersaw is a combination of many sawtooth waves, and this setting controls the contribution of extra sawtooth waves."),es('At the low end of the slider, only the first wave is contributing to the sound, which sounds like an ordinary static sawtooth wave. At the maximum setting, all of the waves are contributing equally and the resulting tone can randomly shift depending on how the waves line up with each other, similar to the "unison" and "chorus" settings.'));break;case"supersawSpread":s=ts(ss("Supersaw Spread"),es("A supersaw is a combination of many sawtooth waves, and this setting controls the distance between their frequencies. The dynamism setting must be used for the extra waves to have any effect."),es('At the low end of the spread slider, all of the voices have the same frequency but random phase, resulting in a different sound every time a note starts. In the middle, the waves all have slightly different frequencies that shift in and out of phase over time similar to the "unison" and "chorus" settings, creating a classic supersaw sound. At the extreme end, the frequencies are so far apart they sound dissonant.'));break;case"supersawShape":s=ts(ss("Supersaw Shape"),es("This supersaw instrument includes an option to change the shape of the waves from sawtooth waves to pulse waves. Use this setting to morph between the two shapes."),es("When a pulse wave shape is used, you can also control the pulse width with a separate setting."));break;case"pulseWidth":s=ts(ss("Pulse Wave Width"),es("This setting controls the shape and sound of a pulse wave. At the minimum width, it sounds light and buzzy. At the maximum width, it is shaped like a classic square wave."));break;case"unison":s=ts(ss("Unison"),es("This instrument can play two identical waves at different frequencies. When two waves play at slightly different frequencies, they move in and out of phase with each other over time as different parts of the waves line up. This creates a dynamic, shifting sound. Pianos are a common example of this kind of sound, because each piano key strikes multiple strings that are tuned to slightly different frequencies."),es('The distance between two frequencies is called an "interval", and this setting controls how large it is. If the interval is too wide, then the waves may sound out-of-tune and "dissonant". However, if the interval is even larger, then the two frequencies can even be distinct pitches.'));break;case"chords":s=ts(ss("Chords"),es("When multiple different notes occur at the same time, this is called a chord. Chords can be created in BeepBox's pattern editor by adding notes above or below another note."),es('This setting determines how chords are played. The standard option is "simultaneous" which starts playing all of the pitches in a chord at the same instant. The "strum" option is similar, but plays the notes starting at slightly different times. The "arpeggio" option is used in "chiptune" style music and plays a single tone that rapidly alternates between all of the pitches in the chord.'),es('Some BeepBox instruments have an option called "custom interval" which uses the chord notes to control the interval between the waves of a single tone. This can create strange sound effects when combined with FM modulators.'));break;case"vibrato":s=ts(ss("Vibrato"),es("This setting causes the frequency of a note to wobble slightly. Singers and violinists often use vibrato."));break;case"algorithm":s=ts(ss("FM Algorithm"),es("FM Synthesis is a mysterious but powerful technique for crafting sounds, popularized by Yamaha keyboards and the Sega Genesis/Mega Drive. It may seem confusing, but try playing around with the options until you get a feel for it, or check out some of the preset examples!"),es("This FM synthesizer uses up to four waves, numbered 1, 2, 3, and 4. Each wave may have its own frequency and volume."),es('There are two kinds of waves: "carrier" waves play a tone out loud, but "modulator" waves distort other waves instead. Wave 1 is always a carrier and plays a tone, but other waves may distort it. The "Algorithm" setting determines which waves are modulators, and which other waves those modulators distort. For example, "1←2" means that wave 2 modulates wave 1, and wave 1 plays out loud.'));break;case"feedbackType":s=ts(ss("Feedback Type"),es("Modulators distort in one direction (like 1←2), but you can also use the feedback setting to make any wave distort in the opposite direction (1→2), or even itself (1⟲)."));break;case"feedbackVolume":s=ts(ss("Feedback Distortion"),es("This setting controls the amount of feedback distortion based on the feedback type setting."));break;case"operatorFrequency":s=ts(ss("Operator Frequency"),es('This setting controls the frequency of an individual FM wave, relative to the fundamental frequency of the note. The multiplier 1× is the same as the fundamental frequency, whereas 2x would be an octave (12 semitones) above it. The frequencies with a "~" are slightly detuned and shift in and out of phase over time compared to the other frequencies.'),es('Try different combinations of a "carrier" wave and a "modulator" wave with different frequencies to get a feel for how they sound together.'));break;case"operatorVolume":s=ts(ss("Operator Volume"),es('This setting controls the volume of "carrier" waves, or the amount of distortion that "modulator" waves apply to other waves.'));break;case"spectrum":s=ts(ss("Spectrum"),es("This setting allows you to draw your own noise spectrum! This is good for making drum sounds."),es("If you only use certain frequencies and a soft fade in/out, it's also possible to make howling wind sounds or even musical wind instruments."),es("The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies."));break;case"harmonics":s=ts(ss("Harmonics"),es("This setting allows you to design your own sound wave! Most musical waves are actually a combination of sine waves at certain frequencies, and this lets you control the volume of each sine wave individually."),es("The left side of the harmonics editor controls the sine wave volumes at lower frequencies, and the right side controls higher frequencies."));break;case"effects":s=ts(ss("Effects"),es("BeepBox has many different kinds of special effects you can add to instruments. You can turn on multiple effects at once, and they can be configured individually. Try them all out!"));break;case"drumsetEnvelope":s=ts(ss("Drumset Envelope"),es("This drumset comes with a low-pass filter, and this setting can dynamically change the low-pass filter frequency over time. Each row in the pattern editor can have a different envelope shape."));break;case"drumsetSpectrum":s=ts(ss("Drumset Spectrum"),es("This setting allows you to draw your own noise spectrum! This is good for making drumsets. Each row in the pattern editor gets its own spectrum."),es("The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies."));break;case"chorus":s=ts(ss("Chorus"),es("The chorus effect combines multiple copies of the instrument's sound and adds a bit of vibrato to simulate an ensemble of instruments or voices. Drag the slider to control how much chorus is added."));break;case"echoSustain":s=ts(ss("Echo Volume"),es("The echo effect repeats the instrument's sound after a delay. Each echo is a little bit quieter than the last, and this setting controls how much quieter."));break;case"echoDelay":s=ts(ss("Echo Delay"),es("The echo effect repeats the instrument's sound after a delay, and this setting controls how long the delay is."));break;case"pitchShift":s=ts(ss("Pitch Shift"),es("This setting makes instruments play higher or lower pitches than the ones displayed in the pattern editor. Be careful that you don't confuse yourself!"),es("You can combine this with envelopes to bend pitch over time, or play multiple simultaneous instruments with different pitch shifts for interesting layered sounds."),es('The intervals created by this setting are in "just intonation" which means they stay in phase with the original pitch instead of shifting in and out of phase over time. If you want the shifting, add the detune effect!'));break;case"detune":s=ts(ss("Detune"),es('This setting slightly adjusts the frequency of notes played by the instrument. You can use a little bit to add a pleasing shifting sound similar to the "unison" feature when combined with other instruments. If you use too much, then the instrument may sound unpleasantly out-of-tune.'));break;case"distortion":s=ts(ss("Distortion"),es("This is the famous electric guitar effect! However, there are some things to be aware of."),es('First, most chords don\'t sound right when combined with heavy distortion. The only chords commonly used with distorted electric guitars are "power chords" which consist of a root note, a "fifth" note above that, and/or any octaves of those two notes.'),es("Second, the distortion sound depends a lot on filtering. In particular, I recommend enabling the note filter effect, and adding both high-pass and low-pass points to the note filter. (Note filters are applied first, then distortion which transforms the sound based on that filtering, then the EQ filter is applied last.)"),es("Finally, I recommend adjusting the fade-out setting to allow the end of each note to overlap a little bit with the beginning of the next, but not too much!"));break;case"bitcrusherQuantization":s=ts(ss("Bitcrusher Quantization"),es("This effect makes stuff sounds harsher, artificial, and \"low quality\", which is great if that's what you're going for!"));break;case"bitcrusherFreq":s=ts(ss("Frequency Quantization"),es("The bitcrusher effect comes with an additional frequency quantization effect! This is a fun one to play with, especially when combined with the note filter effect."),es("Every other notch on this slider is aligned with the currently selected key of the song, and the in-between notches are aligned with the tritones of the key."));break;case"envelopes":s=ts(ss("Envelopes"),es("Envelopes are a way to dynamically adjust various other settings over time, usually based on how long the note lasts. Press the + button to add an envelope, then use the menus below to select which setting to control and the curve of the envelope. Try different combinations to see how they sound!"),es('Most envelope curves restart from the beginning every time a new note plays. The "note size" option is based on the note width as drawn in the pattern editor.'),es("Envelope curves move in the range from 0 to 1 (or vice versa), where 0 means as quiet as possible and 1 is the same as the corresponding position selected in the instrument settings above. If multiple envelopes are targetting the same setting, they are multiplied before applying to the setting."));break;default:throw new Error("Unhandled TipPrompt type: "+e)}this.container=ts({class:"prompt",style:"width: 300px;"},s,this.st),setTimeout((()=>this.st.focus())),this.st.addEventListener("click",this.k)}}class ns{constructor(){this.it=!0}nt(){this.it=!1}isNoop(){return this.it}commit(){}}class hs extends ns{constructor(t){super(),this.ht=t,this.ot=!t}undo(){this.ht?(this.rt(),this.ot=!0):(this.lt(),this.ot=!1)}redo(){this.ht?(this.lt(),this.ot=!1):(this.rt(),this.ot=!0)}ct(){return this.ot}rt(){throw new Error("Change.doForwards(): Override me.")}lt(){throw new Error("Change.doBackwards(): Override me.")}}class os extends ns{constructor(){super()}append(t){t.isNoop()||this.nt()}}class rs extends hs{constructor(t){super(!1),this.ut=null==t?[]:t.concat()}append(t){t.isNoop()||(this.ut[this.ut.length]=t,this.nt())}rt(){for(let t=0;t<this.ut.length;t++)this.ut[t].redo()}lt(){for(let t=this.ut.length-1;t>=0;t--)this.ut[t].undo()}}function as(t,e){const s=t.every((t=>-1!=e.indexOf(t))),i=e.every((e=>-1!=t.indexOf(e)));return s&&i&&e.length==t.length}function ls(t,e,s){const i=new Set(t);t.length=0,t.push(...i);for(let i=0;i<t.length;i++)t[i]>=e.channels[s].instruments.length&&(t.splice(i,1),i--);t.length>e.getMaxInstrumentsPerPattern(s)&&(t.length=e.getMaxInstrumentsPerPattern(s)),t.length<=0&&(t[0]=0)}function cs(t,e){for(const s of t.notes)for(const t of s.pitches)for(const i of s.pins){const s=(t+i.interval)%12;e[s]||(e[s]=!0)}}function us(t){for(let e=1;e<t.length-1;){const s=t[e-1],i=t[e],n=t[e+1],h=i.time-s.time,o=n.time-i.time;(i.interval-s.interval)*o==(n.interval-i.interval)*h&&(i.size-s.size)*o==(n.size-i.size)*h?t.splice(e,1):e++}}function ps(t,s,i,n,h){const o=new Ne(-1,i,n,e.noteSizeMax,!1);o.pins.length=0,o.pitches.length=0;const r=n-i;for(const e of t.pitches)o.pitches.push(e);for(let e=0;e<t.pins.length;e++){const i=t.pins[e],n=i.time+s;if(n<0){if(e+1>=t.pins.length)throw new Error("Error converting pins in note overflow.");const h=t.pins[e+1],r=h.time+s;if(r>0){const t=-n/(r-n);o.pins.push(Ee(Math.round(i.interval+t*(h.interval-i.interval)),0,Math.round(i.size+t*(h.size-i.size))))}}else if(n<=r)o.pins.push(Ee(i.interval,n,i.size));else{if(e<1)throw new Error("Error converting pins in note overflow.");const h=t.pins[e-1],a=h.time+s;if(a<r){const t=(r-a)/(n-a);o.pins.push(Ee(Math.round(h.interval+t*(i.interval-h.interval)),r,Math.round(h.size+t*(i.size-h.size))))}}}const a=o.pins[0].interval;for(let t=0;t<o.pitches.length;t++)o.pitches[t]+=a;for(let t=0;t<o.pins.length;t++)o.pins[t].interval-=a;let l=!1;if(0==o.start)o.continuesLastPattern=s<0||t.continuesLastPattern;else if(o.continuesLastPattern=!1,h.length>0&&t.continuesLastPattern){const t=h[h.length-1];if(t.end==o.start&&Xe.adjacentNotesHaveMatchingPitches(t,o)){l=!0;const e=t.pins[t.pins.length-1].interval,s=t.end-t.start;for(let i=1;i<o.pins.length;i++){const n=o.pins[i],h=Ee(n.interval+e,n.time+s,n.size);t.pins.push(h),t.end=t.start+h.time}us(t.pins)}}l||h.push(o)}class ds extends os{constructor(t,s,i){super();const n=[],h=[];for(let o=0;o<t.song.getChannelCount();o++){const r=t.song.channels[o],a=new Ge;o<t.song.pitchChannelCount?n.push(a):h.push(a),a.muted=r.muted,a.octave=r.octave;for(const t of r.instruments)a.instruments.push(t);const l=e.partsPerBeat*t.song.beatsPerBar,c=e.partsPerBeat*s;let u=-1,p=null;for(let e=0;e<t.song.barCount;e++){const s=t.song.getPattern(o,e);if(null!=s){const t=e*l;for(const e of s.notes){const n=e.start+t+i,h=e.end+t+i,o=Math.floor(n/c),r=Math.ceil(h/c);for(let t=o;t<r;t++){const i=t*c,o=Math.max(0,n-i),r=Math.min(c,h-i);if(o<r){if(u!=t||null==p){for(u++;u<t;)a.bars[u]=0,u++;p=new Oe,a.patterns.push(p),a.bars[u]=a.patterns.length,p.instruments.length=0,p.instruments.push(...s.instruments)}ps(e,n-i-o,o,r,p.notes)}}}}}}Li(n),Li(h),this.append(new Fi(t,n,h))}}class fs extends hs{constructor(t,e){super(!1),this.u=t,this.dt=e,this.ft=this.dt.start,this.yt=this.dt.end,this.bt=this.dt.start,this.wt=this.dt.end,this.gt=this.dt.pins,this.vt=[],this.xt=this.dt.pitches,this.kt=[],this.Mt=this.dt.continuesLastPattern,this.St=this.dt.continuesLastPattern}Pt(t){for(let t=0;t<this.vt.length-1;)this.vt[t].time>=this.vt[t+1].time?this.vt.splice(t,1):t++;us(this.vt);const e=this.vt[0].interval,s=this.vt[0].time;for(let t=0;t<this.xt.length;t++)this.kt[t]=this.xt[t]+e;for(let t=0;t<this.vt.length;t++)this.vt[t].interval-=e,this.vt[t].time-=s;this.bt=this.ft+s,this.wt=this.bt+this.vt[this.vt.length-1].time,null!=t&&(this.St=t),0!=this.bt&&(this.St=!1),this.rt(),this.nt()}rt(){this.dt.pins=this.vt,this.dt.pitches=this.kt,this.dt.start=this.bt,this.dt.end=this.wt,this.dt.continuesLastPattern=this.St,null!=this.u&&this.u.notifier.changed()}lt(){this.dt.pins=this.gt,this.dt.pitches=this.xt,this.dt.start=this.ft,this.dt.end=this.yt,this.dt.continuesLastPattern=this.Mt,null!=this.u&&this.u.notifier.changed()}}class ms extends ns{constructor(t){super();const e=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];e.preset!=e.type&&(e.preset=e.type,t.notifier.changed(),this.nt())}}class ys extends ns{constructor(t,s){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];if(i.preset!=s){const n=M.valueToPreset(s);if(null!=n)if(null!=n.customType)i.type=n.customType,!e.instrumentTypeHasSpecialInterval[i.type]&&e.chords[i.chord].customInterval&&(i.chord=0),i.clearInvalidEnvelopeTargets();else if(null!=n.settings){const s=i.volume,h=i.pan,o=b(i.effects);i.fromJsonObject(n.settings,t.song.getChannelIsNoise(t.channel),1),i.volume=s,i.pan=h,o&&i.pan!=e.panCenter&&(i.effects=4|i.effects)}i.preset=s,t.notifier.changed(),this.nt()}}}class bs extends ns{constructor(t){function s(t){let e=0;for(const s of t)e+=s.weight;let s=Math.random()*e;for(const e of t)if(s-=e.weight,s<=0)return e.item;return t[Math.random()*t.length|0].item}function i(t,e,i,n){const h=[];for(let s=t;s<=e;s++)h.push({item:s,weight:1/(Math.pow((s-i)/n,2)+1)});return s(h)}super();class n{constructor(t,e,s,i,n,h){this.chance=t,this.type=e,this.minFreq=s,this.maxFreq=i,this.centerHz=n,this.centerGain=h}}function h(t,s){t.reset();const n=[];for(const h of s){if(Math.random()>h.chance)continue;const s=new qe;s.type=h.type,s.freq=i(h.minFreq,h.maxFreq,qe.getRoundedSettingValueFromHz(h.centerHz),1/e.filterFreqStep),s.gain=i(0,e.filterGainRange-1,e.filterGainCenter+h.centerGain,2/e.filterGainStep),2==s.type&&s.gain==e.filterGainCenter||(n.includes(s.freq)||(n.push(s.freq),t.controlPoints[t.controlPointCount]=s,t.controlPointCount++))}}const o=t.song.getChannelIsNoise(t.channel),r=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];r.effects&=4,r.envelopeCount=0;const a=qe.getRoundedSettingValueFromHz(700),l=e.filterFreqRange-1;if(h(r.eqFilter,[new n(.8,0,a,l,4e3,-1),new n(.4,1,0,a-1,250,-1),new n(.5,2,0,l,2e3,0),new n(.4,2,0,l,1400,0),new n(.3,2,0,l,1e3,0),new n(.2,2,0,l,500,0)]),o){const c=s([{item:2,weight:1},{item:3,weight:3}]);function u(t){let s=0;for(const e of t)e>s&&(s=e);for(let i=0;i<t.length;i++)t[i]=e.harmonicsMax*t[i]/s}switch(r.preset=r.type=c,r.fadeIn=Math.random()<.8?0:i(0,e.fadeInRange-1,0,2),r.fadeOut=i(0,e.fadeOutTicks.length-1,e.fadeOutNeutral,2),Math.random()<.1&&(r.effects|=1024,r.transition=e.transitions.dictionary[s([{item:"normal",weight:30},{item:"interrupt",weight:1},{item:"slide",weight:2}])].index),Math.random()<.2&&(r.effects|=2048,r.chord=e.chords.dictionary[s([{item:"strum",weight:2},{item:"arpeggio",weight:1}])].index),Math.random()<.1&&(r.pitchShift=i(0,e.pitchShiftRange-1,e.pitchShiftCenter,2),r.pitchShift!=e.pitchShiftCenter&&(r.effects|=128,r.addEnvelope(e.instrumentAutomationTargets.dictionary.pitchShift.index,0,e.envelopes.dictionary[s([{item:"flare 1",weight:2},{item:"flare 2",weight:1},{item:"flare 3",weight:1},{item:"twang 1",weight:16},{item:"twang 2",weight:8},{item:"twang 3",weight:4},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"decay 1",weight:4},{item:"decay 2",weight:2},{item:"decay 3",weight:1}])].index))),Math.random()<.1&&(r.effects|=512,r.vibrato=i(0,e.echoSustainRange-1,e.echoSustainRange>>1,2),r.vibrato=e.vibratos.dictionary[s([{item:"light",weight:2},{item:"delayed",weight:2},{item:"heavy",weight:1},{item:"shaky",weight:2}])].index),Math.random()<.8&&(r.effects|=32,h(r.noteFilter,[new n(1,0,a,l,8e3,-1)]),r.addEnvelope(e.instrumentAutomationTargets.dictionary.noteFilterAllFreqs.index,0,e.envelopes.dictionary[s([{item:"punch",weight:4},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:8},{item:"twang 2",weight:8},{item:"twang 3",weight:8},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:4},{item:"decay 2",weight:4},{item:"decay 3",weight:4}])].index)),Math.random()<.1&&(r.effects|=8,r.distortion=i(1,e.distortionRange-1,e.distortionRange-1,2)),Math.random()<.1&&(r.effects|=16,r.bitcrusherFreq=i(0,e.bitcrusherFreqRange-1,e.bitcrusherFreqRange>>1,2),r.bitcrusherQuantization=i(0,e.bitcrusherQuantizationRange-1,e.bitcrusherQuantizationRange>>1,2)),Math.random()<.1&&(r.effects|=2,r.chorus=i(1,e.chorusRange-1,e.chorusRange-1,1)),Math.random()<.1&&(r.echoSustain=i(0,e.echoSustainRange-1,e.echoSustainRange>>1,2),r.echoDelay=i(0,e.echoDelayRange-1,e.echoDelayRange>>1,2),0==r.echoSustain&&0==r.echoDelay||(r.effects|=64)),Math.random()<.5&&(r.effects|=1,r.reverb=i(1,e.reverbRange-1,1,1)),c){case 2:r.chipNoise=Math.random()*e.chipNoises.length|0;break;case 3:{const p=[()=>{const t=[];for(let s=0;s<e.spectrumControlPoints;s++)t[s]=Math.random()<.5?Math.random():0;return t},()=>{let t=1;const s=[t];for(let i=1;i<e.spectrumControlPoints;i++)t*=Math.pow(2,Math.random()-.52),s[i]=t;return s},()=>{let t=1;const s=[t];for(let i=1;i<e.spectrumControlPoints;i++)t*=Math.pow(2,Math.random()-.52),s[i]=t*Math.random();return s}],d=(0,p[Math.random()*p.length|0])();u(d);for(let f=0;f<e.spectrumControlPoints;f++)r.spectrumWave.spectrum[f]=Math.round(d[f]);r.spectrumWave.markCustomWaveDirty()}break;default:throw new Error("Unhandled noise instrument type in random generator.")}}else{const y=s([{item:0,weight:4},{item:6,weight:4},{item:8,weight:5},{item:5,weight:5},{item:7,weight:5},{item:3,weight:1},{item:1,weight:5}]);function b(t){let s=0;for(const e of t)e>s&&(s=e);for(let i=0;i<t.length;i++)t[i]=e.harmonicsMax*t[i]/s}switch(r.preset=r.type=y,r.fadeIn=Math.random()<.5?0:i(0,e.fadeInRange-1,0,2),r.fadeOut=i(0,e.fadeOutTicks.length-1,e.fadeOutNeutral,2),0!=y&&5!=y&&7!=y||(r.unison=e.unisons.dictionary[s([{item:"none",weight:10},{item:"shimmer",weight:5},{item:"hum",weight:4},{item:"honky tonk",weight:3},{item:"dissonant",weight:1},{item:"fifth",weight:1},{item:"octave",weight:2},{item:"bowed",weight:2},{item:"piano",weight:5}])].index),Math.random()<.1&&(r.effects|=1024,r.transition=e.transitions.dictionary[s([{item:"interrupt",weight:1},{item:"slide",weight:2}])].index),Math.random()<.2&&(r.effects|=2048,r.chord=e.chords.dictionary[s([{item:"strum",weight:2},{item:"arpeggio",weight:1}])].index),Math.random()<.05&&(r.pitchShift=i(0,e.pitchShiftRange-1,e.pitchShiftCenter,1),r.pitchShift!=e.pitchShiftCenter&&(r.effects|=128,r.addEnvelope(e.instrumentAutomationTargets.dictionary.pitchShift.index,0,e.envelopes.dictionary[s([{item:"flare 1",weight:2},{item:"flare 2",weight:1},{item:"flare 3",weight:1},{item:"twang 1",weight:16},{item:"twang 2",weight:8},{item:"twang 3",weight:4},{item:"decay 1",weight:4},{item:"decay 2",weight:2},{item:"decay 3",weight:1}])].index))),Math.random()<.25&&(r.effects|=512,r.vibrato=i(0,e.echoSustainRange-1,e.echoSustainRange>>1,2),r.vibrato=e.vibratos.dictionary[s([{item:"light",weight:2},{item:"delayed",weight:2},{item:"heavy",weight:1},{item:"shaky",weight:2}])].index),Math.random()<.1&&(r.effects|=8,r.distortion=i(1,e.distortionRange-1,e.distortionRange-1,2)),m(r.effects)&&Math.random()<.8?(r.effects|=32,h(r.noteFilter,[new n(1,0,a,l,2e3,-1),new n(.9,1,0,a-1,500,-1),new n(.4,2,0,l,1400,0)])):Math.random()<.5&&(r.effects|=32,h(r.noteFilter,[new n(1,0,a,l,8e3,-1)]),r.addEnvelope(e.instrumentAutomationTargets.dictionary.noteFilterAllFreqs.index,0,e.envelopes.dictionary[s([{item:"punch",weight:6},{item:"flare 1",weight:2},{item:"flare 2",weight:4},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:4},{item:"twang 3",weight:4},{item:"swell 1",weight:4},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:2},{item:"decay 3",weight:2}])].index)),Math.random()<.1&&(r.effects|=16,r.bitcrusherFreq=i(0,e.bitcrusherFreqRange-1,0,2),r.bitcrusherQuantization=i(0,e.bitcrusherQuantizationRange-1,e.bitcrusherQuantizationRange>>1,2)),Math.random()<.1&&(r.effects|=2,r.chorus=i(1,e.chorusRange-1,e.chorusRange-1,1)),Math.random()<.1&&(r.echoSustain=i(0,e.echoSustainRange-1,e.echoSustainRange>>1,2),r.echoDelay=i(0,e.echoDelayRange-1,e.echoDelayRange>>1,2),0==r.echoSustain&&0==r.echoDelay||(r.effects|=64)),Math.random()<.5&&(r.effects|=1,r.reverb=i(1,e.reverbRange-1,1,1)),y){case 0:r.chipWave=Math.random()*e.chipWaves.length|0;break;case 6:case 8:8==y&&(r.supersawDynamism=i(0,e.supersawDynamismMax,e.supersawDynamismMax,2),r.supersawSpread=i(0,e.supersawSpreadMax,Math.ceil(e.supersawSpreadMax/3),4),r.supersawShape=i(0,e.supersawShapeMax,0,4)),r.pulseWidth=i(0,e.pulseWidthRange-1,e.pulseWidthRange-1,2),Math.random()<.6&&r.addEnvelope(e.instrumentAutomationTargets.dictionary.pulseWidth.index,0,e.envelopes.dictionary[s([{item:"punch",weight:6},{item:"flare 1",weight:2},{item:"flare 2",weight:4},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:4},{item:"twang 3",weight:4},{item:"swell 1",weight:4},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:2},{item:"decay 3",weight:2}])].index);break;case 7:case 5:{7==y&&(r.stringSustain=Math.random()*e.stringSustainRange|0);const w=[()=>{const t=[];for(let s=0;s<e.harmonicsControlPoints;s++)t[s]=Math.random()<.4?Math.random():0;return t[8*Math.random()|0]=Math.pow(Math.random(),.25),t},()=>{let t=1;const s=[t];for(let i=1;i<e.harmonicsControlPoints;i++)t*=Math.pow(2,Math.random()-.55),s[i]=t;return s},()=>{let t=1;const s=[t];for(let i=1;i<e.harmonicsControlPoints;i++)t*=Math.pow(2,Math.random()-.55),s[i]=t*Math.random();return s}],g=(0,w[Math.random()*w.length|0])();b(g);for(let v=0;v<e.harmonicsControlPoints;v++)r.harmonicsWave.harmonics[v]=Math.round(g[v]);r.harmonicsWave.markCustomWaveDirty()}break;case 3:{const x=[];for(let k=0;k<e.spectrumControlPoints;k++){const M=0==k||7==k||11==k||14==k||16==k||18==k||21==k;x[k]=M?Math.pow(Math.random(),.25):.5*Math.pow(Math.random(),3)}b(x);for(let S=0;S<e.spectrumControlPoints;S++)r.spectrumWave.spectrum[S]=Math.round(x[S]);r.spectrumWave.markCustomWaveDirty()}break;case 1:{r.algorithm=Math.random()*e.algorithms.length|0,r.feedbackType=Math.random()*e.feedbacks.length|0;const P=e.algorithms[r.algorithm];for(let I=0;I<P.carrierCount;I++)r.operators[I].frequency=i(0,e.operatorFrequencies.length-1,0,3),r.operators[I].amplitude=i(0,e.operatorAmplitudeMax,e.operatorAmplitudeMax-1,2);for(let F=P.carrierCount;F<e.operatorCount;F++)r.operators[F].frequency=i(3,e.operatorFrequencies.length-1,0,3),r.operators[F].amplitude=Math.pow(Math.random(),2)*e.operatorAmplitudeMax|0,r.envelopeCount<e.maxEnvelopeCount&&Math.random()<.4&&r.addEnvelope(e.instrumentAutomationTargets.dictionary.operatorAmplitude.index,F,e.envelopes.dictionary[s([{item:"punch",weight:2},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:2},{item:"twang 3",weight:2},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:2},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:1},{item:"decay 3",weight:1}])].index),r.envelopeCount<e.maxEnvelopeCount&&Math.random()<.05&&r.addEnvelope(e.instrumentAutomationTargets.dictionary.operatorFrequency.index,F,e.envelopes.dictionary[s([{item:"punch",weight:4},{item:"flare 1",weight:4},{item:"flare 2",weight:2},{item:"flare 3",weight:1},{item:"twang 1",weight:16},{item:"twang 2",weight:2},{item:"twang 3",weight:1},{item:"swell 1",weight:4},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"decay 1",weight:2},{item:"decay 2",weight:1},{item:"decay 3",weight:1}])].index);r.feedbackAmplitude=Math.pow(Math.random(),3)*e.operatorAmplitudeMax|0,r.envelopeCount<e.maxEnvelopeCount&&Math.random()<.4&&r.addEnvelope(e.instrumentAutomationTargets.dictionary.feedbackAmplitude.index,0,e.envelopes.dictionary[s([{item:"punch",weight:2},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:2},{item:"twang 3",weight:2},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:2},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:1},{item:"decay 3",weight:1}])].index)}break;default:throw new Error("Unhandled pitched instrument type in random generator.")}}t.notifier.changed(),this.nt()}}class ws extends ns{constructor(t,e){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.transition!=e&&(this.nt(),s.transition=e,s.preset=s.type,t.notifier.changed())}}class gs extends ns{constructor(t,e){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()],i=s.effects,n=0!=(i&1<<e),h=n?i&~(1<<e):i|1<<e;s.effects=h,2!=e&&(s.preset=s.type),n&&s.clearInvalidEnvelopeTargets(),this.nt(),t.notifier.changed()}}class vs extends ns{constructor(t,e,s,i,n,h){if(super(),e>t.song.patternsPerChannel)throw new Error("invalid pattern");for(let o=s;o<s+n;o++)for(let s=i;s<i+h;s++)t.song.channels[s].bars[o]!=e&&(t.song.channels[s].bars[o]=e,this.nt());t.notifier.changed()}}class xs extends ns{constructor(t,e,s){if(super(),t.song.barCount!=e){for(const i of t.song.channels)if(s){for(;i.bars.length<e;)i.bars.unshift(0);t.song.barCount>e&&i.bars.splice(0,t.song.barCount-e)}else{for(;i.bars.length<e;)i.bars.push(0);i.bars.length=e}if(s){const s=e-t.song.barCount;t.bar=Math.max(0,t.bar+s),(s<0||t.barScrollPos>0)&&(t.barScrollPos=Math.max(0,t.barScrollPos+s)),t.song.loopStart=Math.max(0,t.song.loopStart+s)}t.bar=Math.min(t.bar,e-1),t.song.loopLength=Math.min(e,t.song.loopLength),t.song.loopStart=Math.min(e-t.song.loopLength,t.song.loopStart),t.song.barCount=e,t.notifier.changed(),this.nt()}}}class ks extends ns{constructor(t,s,i){super();const n=Math.min(e.barCountMax,t.song.barCount+i);if(0!=(i=n-t.song.barCount)){for(const e of t.song.channels)for(;e.bars.length<n;)e.bars.splice(s,0,0);t.song.barCount=n,t.bar+=i,t.barScrollPos+=i,t.song.loopStart>=s?t.song.loopStart+=i:t.song.loopStart+t.song.loopLength>=s&&(t.song.loopLength+=i),t.notifier.changed(),this.nt()}}}class Ms extends ns{constructor(t,e,s){super();for(const i of t.song.channels)i.bars.splice(e,s),0==i.bars.length&&i.bars.push(0);t.song.barCount=Math.max(1,t.song.barCount-s),t.bar=Math.max(0,t.bar-s),t.barScrollPos=Math.max(0,t.barScrollPos-s),t.song.loopStart>=e?t.song.loopStart=Math.max(0,t.song.loopStart-s):t.song.loopStart+t.song.loopLength>e&&(t.song.loopLength-=s),t.song.loopLength=Math.max(1,Math.min(t.song.barCount-t.song.loopStart,t.song.loopLength)),t.notifier.changed(),this.nt()}}class Ss extends ns{constructor(t,e,s,i){super(),t.song.channels.splice(e+i,0,...t.song.channels.splice(e,s-e+1)),t.notifier.changed(),this.nt()}}class Ps extends ns{constructor(t,s,i){if(super(),t.song.pitchChannelCount!=s||t.song.noiseChannelCount!=i){const n=[];function h(s,i,h,o,r,a){for(let l=0;l<s;l++){const s=l+h,c=l+o;if(l<i)n[s]=t.song.channels[c];else{n[s]=new Ge,n[s].octave=r;for(let t=0;t<e.instrumentCountMin;t++){const e=new je(a),i=Mi(a),h=M.valueToPreset(i);e.fromJsonObject(h.settings,a),e.preset=i,e.volume=1,n[s].instruments[t]=e}for(let e=0;e<t.song.patternsPerChannel;e++)n[s].patterns[e]=new Oe;for(let e=0;e<t.song.barCount;e++)n[s].bars[e]=0}}}h(s,t.song.pitchChannelCount,0,0,3,!1),h(i,t.song.noiseChannelCount,s,t.song.pitchChannelCount,0,!0),t.song.pitchChannelCount=s,t.song.noiseChannelCount=i;for(let o=0;o<t.song.getChannelCount();o++)t.song.channels[o]=n[o];t.song.channels.length=t.song.getChannelCount(),t.channel=Math.min(t.channel,s+i-1),t.notifier.changed(),this.nt()}}}class Is extends os{constructor(t,s,i){super();const n=t.song.pitchChannelCount+(i?0:1),h=t.song.noiseChannelCount+(i?1:0);if(n<=e.pitchChannelCountMax&&h<=e.noiseChannelCountMax){const e=i?t.song.pitchChannelCount+t.song.noiseChannelCount:t.song.pitchChannelCount;this.append(new Ps(t,n,h)),this.append(new Ss(t,s,e-1,1))}}}class Fs extends os{constructor(t,s,i){for(super();i>=s;){const e=t.song.getChannelIsNoise(i);t.song.channels.splice(i,1),e?t.song.noiseChannelCount--:t.song.pitchChannelCount--,i--}t.song.pitchChannelCount<e.pitchChannelCountMin&&this.append(new Ps(t,e.pitchChannelCountMin,t.song.noiseChannelCount)),this.append(new Bs(t,Math.max(0,s-1),t.bar)),this.nt(),t.notifier.changed()}}class Bs extends ns{constructor(t,e,s,i=!1){super();const n=t.channel,h=t.bar;t.channel=e,t.bar=s,i||t.selection.scrollToSelectedPattern(),t.notifier.changed(),n==e&&h==s||this.nt()}}class Ls extends ns{constructor(t,e){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.unison!=e&&(this.nt(),s.unison=e,s.preset=s.type,t.notifier.changed())}}class Cs extends ns{constructor(t,e){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.chord!=e&&(this.nt(),s.chord=e,s.preset=s.type,t.notifier.changed())}}class Ds extends ns{constructor(t,e){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.vibrato!=e&&(s.vibrato=e,s.preset=s.type,t.notifier.changed(),this.nt())}}class Ts extends ns{constructor(t,e,s){super(),s.markCustomWaveDirty(),e.preset=e.type,t.notifier.changed(),this.nt()}}class Es extends ns{constructor(t,e,s){super(),s.markCustomWaveDirty(),e.preset=e.type,t.notifier.changed(),this.nt()}}class Ns extends ns{constructor(t,e,s){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.drumsetEnvelopes[e]!=s&&(i.drumsetEnvelopes[e]=s,i.preset=i.type,t.notifier.changed(),this.nt())}}class Os extends ns{constructor(t){super(),this.u=t,this.It=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()]}commit(){this.isNoop()||(this.It.preset=this.It.type,this.u.notifier.changed())}}class zs extends Os{constructor(t,e,s){super(t),this.It.pulseWidth=s,t.notifier.changed(),e!=s&&this.nt()}}class Rs extends Os{constructor(t,e,s){super(t),this.It.supersawDynamism=s,t.notifier.changed(),e!=s&&this.nt()}}class As extends Os{constructor(t,e,s){super(t),this.It.supersawSpread=s,t.notifier.changed(),e!=s&&this.nt()}}class $s extends Os{constructor(t,e,s){super(t),this.It.supersawShape=s,t.notifier.changed(),e!=s&&this.nt()}}class Us extends Os{constructor(t,e,s){super(t),this.It.pitchShift=s,t.notifier.changed(),e!=s&&this.nt()}}class qs extends Os{constructor(t,e,s){super(t),this.It.detune=s,t.notifier.changed(),e!=s&&this.nt()}}class _s extends Os{constructor(t,e,s){super(t),this.It.distortion=s,t.notifier.changed(),e!=s&&this.nt()}}class Vs extends Os{constructor(t,e,s){super(t),this.It.bitcrusherFreq=s,t.notifier.changed(),e!=s&&this.nt()}}class js extends Os{constructor(t,e,s){super(t),this.It.bitcrusherQuantization=s,t.notifier.changed(),e!=s&&this.nt()}}class Gs extends Os{constructor(t,e,s){super(t),this.It.stringSustain=s,t.notifier.changed(),e!=s&&this.nt()}}class Ws extends ns{constructor(t,e){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.stringSustainType!=e&&(s.stringSustainType=e,s.preset=s.type,t.notifier.changed(),this.nt())}}class Hs extends hs{constructor(t,s,i,n,h,o=!1){super(o),this.Ft=[],this.Bt=[],this.Lt=[],this.Ct=[],this.u=t,this.It=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()],this.Dt=o?this.It.preset:this.It.type,this.Tt=o?this.It.type:this.It.preset,this.Et=s,this.Nt=i,this._=n;for(let t=0;t<this.It.envelopeCount;t++){let i=this.It.envelopes[t].target,r=this.It.envelopes[t].index;if(this.Ft.push(i),this.Bt.push(r),o){const t=e.instrumentAutomationTargets[i];t.isFilter&&5==t.effect==h&&(t.maxCount==e.filterMaxPoints?r==n?(i=e.instrumentAutomationTargets.dictionary.none.index,r=0):r>n&&r--:s.controlPointCount<=1&&(i=e.instrumentAutomationTargets.dictionary.none.index,r=0))}this.Lt.push(i),this.Ct.push(r)}this.nt(),this.redo()}rt(){this.Et.controlPoints.splice(this._,0,this.Nt),this.Et.controlPointCount++,this.Et.controlPoints.length=this.Et.controlPointCount,this.It.preset=this.Dt;for(let t=0;t<this.It.envelopeCount;t++)this.It.envelopes[t].target=this.Ft[t],this.It.envelopes[t].index=this.Bt[t];this.u.notifier.changed()}lt(){this.Et.controlPoints.splice(this._,1),this.Et.controlPointCount--,this.Et.controlPoints.length=this.Et.controlPointCount,this.It.preset=this.Tt;for(let t=0;t<this.It.envelopeCount;t++)this.It.envelopes[t].target=this.Lt[t],this.It.envelopes[t].index=this.Ct[t];this.u.notifier.changed()}}class Ks extends hs{constructor(t,e,s,i,n,h){super(!1),this.u=t,this.It=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()],this.Dt=this.It.type,this.Tt=this.It.preset,this.Nt=e,this.Ot=s,this.zt=i,this.Rt=n,this.At=h,this.nt(),this.redo()}rt(){this.Nt.freq=this.zt,this.Nt.gain=this.At,this.It.preset=this.Dt,this.u.notifier.changed()}lt(){this.Nt.freq=this.Ot,this.Nt.gain=this.Rt,this.It.preset=this.Tt,this.u.notifier.changed()}}class Ys extends hs{constructor(t,e,s){super(!1),this.u=t,this.It=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()],this.Dt=this.It.type,this.Tt=this.It.preset,this.$t=this.It.fadeIn,this.Ut=this.It.fadeOut,this.qt=e,this._t=s,this.nt(),this.redo()}rt(){this.It.fadeIn=this.qt,this.It.fadeOut=this._t,this.It.preset=this.Dt,this.u.notifier.changed()}lt(){this.It.fadeIn=this.$t,this.It.fadeOut=this.Ut,this.It.preset=this.Tt,this.u.notifier.changed()}}class Js extends ns{constructor(t,e){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.algorithm!=e&&(s.algorithm=e,s.preset=s.type,t.notifier.changed(),this.nt())}}class Qs extends ns{constructor(t,e){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.feedbackType!=e&&(s.feedbackType=e,s.preset=s.type,t.notifier.changed(),this.nt())}}class Xs extends ns{constructor(t,e,s){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.operators[e].frequency!=s&&(i.operators[e].frequency=s,i.preset=i.type,t.notifier.changed(),this.nt())}}class Zs extends Os{constructor(t,e,s,i){super(t),this.It.operators[e].amplitude=i,t.notifier.changed(),s!=i&&this.nt()}}class ti extends Os{constructor(t,e,s){super(t),this.It.feedbackAmplitude=s,t.notifier.changed(),e!=s&&this.nt()}}class ei extends ns{constructor(t){super();const e=t.song.channels[t.channel],s=t.song.getChannelIsNoise(t.channel),i=t.song.getMaxInstrumentsPerChannel();if(e.instruments.length>=i)return;const n=Mi(s),h=M.valueToPreset(n),o=new je(s);o.fromJsonObject(h.settings,s,1),o.preset=n,o.volume=1,e.instruments.push(o),t.viewedInstrument[t.channel]=e.instruments.length-1,t.notifier.changed(),this.nt()}}class si extends ns{constructor(t){super();const s=t.song.channels[t.channel];if(s.instruments.length<=e.instrumentCountMin)return;const i=t.viewedInstrument[t.channel];if(s.instruments.splice(i,1),t.song.patternInstruments)for(const t of s.patterns){for(let e=0;e<t.instruments.length;e++)t.instruments[e]==i?(t.instruments.splice(e,1),e--):t.instruments[e]>i&&t.instruments[e]--;t.instruments.length<=0&&(t.instruments[0]=0)}t.notifier.changed(),this.nt()}}class ii extends ns{constructor(t,e){super(),t.viewedInstrument[t.channel]!=e&&(t.viewedInstrument[t.channel]=e,t.notifier.changed(),this.nt())}}class ni extends ns{constructor(t,e,s){super();const i=t.song.layeredInstruments,n=t.song.patternInstruments;if(i!=e||n!=s){t.song.layeredInstruments=e,t.song.patternInstruments=s;for(let e=0;e<t.song.getChannelCount();e++){const i=t.song.channels[e];i.instruments.length>t.song.getMaxInstrumentsPerChannel()&&(i.instruments.length=t.song.getMaxInstrumentsPerChannel());for(let h=0;h<t.song.patternsPerChannel;h++){const o=i.patterns[h];if(!n&&s){for(let t=0;t<i.instruments.length;t++)o.instruments[t]=t;o.instruments.length=i.instruments.length}ls(o.instruments,t.song,e)}}t.notifier.changed(),this.nt()}}}class hi extends ns{constructor(t,e){super(),t.song.key!=e&&(t.song.key=e,t.notifier.changed(),this.nt())}}class oi extends ns{constructor(t,e,s,i,n){super(),this.u=t,this.oldStart=e,this.oldLength=s,this.newStart=i,this.newLength=n,this.u.song.loopStart=this.newStart,this.u.song.loopLength=this.newLength,this.u.notifier.changed(),this.oldStart==this.newStart&&this.oldLength==this.newLength||this.nt()}}class ri extends hs{constructor(t,e,s,i,n=!1){super(n),this.u=t,this.dt=e,this.Vt=s,this._=i,this.nt(),this.redo()}rt(){this.dt.pitches.splice(this._,0,this.Vt),this.u.notifier.changed()}lt(){this.dt.pitches.splice(this._,1),this.u.notifier.changed()}}class ai extends ns{constructor(t,e,s){super(),this.oldValue=e,t.song.channels[t.channel].octave=s,t.notifier.changed(),e!=s&&this.nt()}}class li extends os{constructor(t,e){super(),t.song.rhythm!=e&&(t.song.rhythm=e,t.notifier.changed(),this.nt())}}class ci extends os{constructor(t,e,s,i,n,h){super(),this.append(new Ri(t,e,i,n));let o=0;for(let t=0;t<e.notes.length;t++)if(e.notes[t].start<i){if(e.notes[t].end>i)throw new Error;o=t+1}else if(e.notes[t].start<n)throw new Error;for(;i<n;){for(const h of s){const s=h.start+i,r=h.end+i;if(s>=n)break;const a=new Ne(h.pitches[0],s,r,h.pins[0].size,!1);a.pitches.length=0;for(const t of h.pitches)a.pitches.push(t);a.pins.length=0;for(const t of h.pins)a.pins.push(Ee(t.interval,t.time,t.size));a.continuesLastPattern=!0===h.continuesLastPattern&&0==a.start,e.notes.splice(o++,0,a),a.end>n&&this.append(new zi(t,a,a.start,n))}i+=h}t.notifier.changed(),this.nt()}}class ui extends os{constructor(t,e,s){super(),e.fromJsonObject(s,s.isDrum),t.notifier.changed(),this.nt()}}class pi extends ns{constructor(t,e,s,i){super(),as(s,i.instruments)||(i.instruments.length=0,i.instruments.push(...s),ls(i.instruments,t.song,e),this.nt(),t.notifier.changed())}}class di extends ns{constructor(t,e){if(super(),t.song.patternsPerChannel!=e){for(let s=0;s<t.song.getChannelCount();s++){const i=t.song.channels[s].bars,n=t.song.channels[s].patterns;for(let t=0;t<i.length;t++)i[t]>e&&(i[t]=0);for(let t=n.length;t<e;t++)n[t]=new Oe;n.length=e}t.song.patternsPerChannel=e,t.notifier.changed(),this.nt()}}}class fi extends hs{constructor(t,e,s){super(!1),this.jt=null,this.Gt=null;const i=t.song;if(0!=i.channels[e].bars[s])return;this.u=t,this.Wt=s,this.Ht=e,this.Kt=i.patternsPerChannel,this.Yt=i.patternsPerChannel,this.Jt=t.recentPatternInstruments[e].concat();let n=null,h=null;for(let t=1;t<=i.patternsPerChannel;t++){let s=!1;for(let n=0;n<i.barCount;n++)if(i.channels[e].bars[n]==t){s=!0;break}if(s)continue;null==h&&(h=t);if(0==i.channels[e].patterns[t-1].notes.length){n=t;break}}if(null!=n)this.Qt=n,this.Gt=i.channels[e].patterns[n-1].instruments.concat();else if(i.patternsPerChannel<i.barCount)this.Yt=i.patternsPerChannel+1,this.Qt=i.patternsPerChannel+1;else{if(null==h)throw new Error;this.Qt=h,this.jt=i.channels[e].patterns[h-1].notes,this.Gt=i.channels[e].patterns[h-1].instruments.concat()}this.nt(),this.rt()}rt(){const t=this.u.song;for(let e=t.patternsPerChannel;e<this.Yt;e++)for(let s=0;s<t.getChannelCount();s++)t.channels[s].patterns[e]=new Oe;t.patternsPerChannel=this.Yt;const e=t.channels[this.Ht].patterns[this.Qt-1];e.notes=[],e.instruments.length=0,e.instruments.push(...this.Jt),t.channels[this.Ht].bars[this.Wt]=this.Qt,this.u.notifier.changed()}lt(){const t=this.u.song,e=t.channels[this.Ht].patterns[this.Qt-1];null!=this.jt&&(e.notes=this.jt),null!=this.Gt&&(e.instruments.length=0,e.instruments.push(...this.Gt)),t.channels[this.Ht].bars[this.Wt]=0;for(let e=0;e<t.getChannelCount();e++)t.channels[e].patterns.length=this.Kt;t.patternsPerChannel=this.Kt,this.u.notifier.changed()}}class mi extends fs{constructor(t,e,s,i,n){super(t,e),i-=this.ft;const h=this.gt[s].time,o=Math.min(h,i),r=Math.max(h,i);let a=!1;for(let t=0;t<this.gt.length;t++){const h=e.pins[t],l=h.time;l<o?this.vt.push(Ee(h.interval,l,h.size)):l>r&&(a||(this.vt.length>0&&(n=e.continuesLastPattern),this.vt.push(Ee(this.gt[s].interval,i,this.gt[s].size)),a=!0),this.vt.push(Ee(h.interval,l,h.size)))}a||(n=e.continuesLastPattern,this.vt.push(Ee(this.gt[s].interval,i,this.gt[s].size))),this.Pt(n)}}class yi extends fs{constructor(t,s,i,n,h,o){super(t,s),i-=this.ft,n-=this.ft,h-=s.pitches[o];let r,a,l,c,u=!1,p=!1,d=0,f=e.noteSizeMax,m=!0;for(n>i?(r=0,a=1,l=s.pins.length,c=t=>{this.vt.push(t)}):(r=s.pins.length-1,a=-1,l=-1,c=t=>{this.vt.unshift(t)});r!=l;r+=a){const t=s.pins[r],e=t.time;for(;;)if(u){if(p){if(e*a==n*a)break;t.interval!=d&&(m=!1),c(Ee(m?h:t.interval,e,t.size));break}if(e*a<=n*a&&(d=t.interval,f=t.size),e*a<n*a)break;c(Ee(h,n,f)),p=!0}else{if(e*a<=i*a&&(d=t.interval,f=t.size),e*a<i*a){c(Ee(t.interval,e,t.size));break}c(Ee(d,i,f)),u=!0}}p||c(Ee(h,n,f)),this.Pt()}}class bi extends rs{constructor(t,s){super();const i=e.partsPerBeat/e.rhythms[t.song.rhythm].stepsPerBeat,n=function(s){let n=e.rhythms[t.song.rhythm].roundUpThresholds;if(null!=n){const t=Math.floor(s/e.partsPerBeat)*e.partsPerBeat,h=s-t;let o=t;for(const t of n){if(!(h>=t))break;o+=i}return o}return Math.round(s/i)*i};let h=0;for(;h<s.notes.length;){const e=s.notes[h];n(e.start)>=n(e.end)?this.append(new Oi(t,s,e,h,!0)):(this.append(new wi(t,e,n)),h++)}}}class wi extends fs{constructor(t,e,s){super(t,e);for(const t of this.gt)this.vt.push(Ee(t.interval,s(t.time+this.ft)-this.ft,t.size));this.Pt()}}class gi extends os{constructor(t,s,i){super();let n=Math.round(s%t.song.beatsPerBar*e.partsPerBeat);if(n<0&&(n+=t.song.beatsPerBar*e.partsPerBeat),0!=n){switch(i){case"wrapAround":{const s=e.partsPerBeat*t.song.beatsPerBar;for(const e of t.song.channels)for(const t of e.patterns){const e=[];for(let i=1;i>=0;i--){const h=i*s;for(const i of t.notes){const t=i.start+n,o=i.end+n,r=Math.max(0,t-h),a=Math.min(s,o-h);r<a&&ps(i,t-h-r,r,a,e)}}t.notes=e}}break;case"overflow":{let e=t.song.barCount,i=t.song.loopStart,h=t.song.loopLength;if(this.append(new ds(t,t.song.beatsPerBar,n)),s<0){let s=!0;for(const e of t.song.channels)0!=e.bars[0]&&(s=!1);if(s){for(const e of t.song.channels)e.bars.shift();t.song.barCount--}else e++,i++,t.bar++}for(;t.song.barCount<e;){for(const e of t.song.channels)e.bars.push(0);t.song.barCount++}t.song.loopStart=i,t.song.loopLength=h}break;default:throw new Error("Unrecognized beats-per-bar conversion strategy.")}t.notifier.changed(),this.nt()}}}class vi extends os{constructor(t,s,i){if(super(),t.song.beatsPerBar!=s){switch(i){case"splice":if(t.song.beatsPerBar>s){const i=new rs;for(let n=0;n<t.song.getChannelCount();n++)for(let h=0;h<t.song.channels[n].patterns.length;h++)i.append(new Ri(t,t.song.channels[n].patterns[h],s*e.partsPerBeat,t.song.beatsPerBar*e.partsPerBeat))}break;case"stretch":{const e=function(e){return Math.round(e*s/t.song.beatsPerBar)};for(let s=0;s<t.song.getChannelCount();s++)for(let i=0;i<t.song.channels[s].patterns.length;i++){const n=t.song.channels[s].patterns[i];let h=0;for(;h<n.notes.length;){const s=n.notes[h];e(s.start)>=e(s.end)?this.append(new Oi(t,n,s,h,!0)):(this.append(new wi(t,s,e)),h++)}}this.append(new Ci(t,t.song.tempo,t.song.tempo*s/t.song.beatsPerBar))}break;case"overflow":this.append(new ds(t,s,0)),t.song.loopStart=0,t.song.loopLength=t.song.barCount;break;default:throw new Error("Unrecognized beats-per-bar conversion strategy.")}t.song.beatsPerBar=s,t.notifier.changed(),this.nt()}}}class xi extends os{constructor(t,e){super(),t.song.scale!=e&&(t.song.scale=e,t.notifier.changed(),this.nt())}}class ki extends os{constructor(t){super();const s=t.song,i=e.keys[s.key].basePitch,n=[0,0,0,0,0,0,0,0,0,0,0,0];for(let t=0;t<s.pitchChannelCount;t++)for(let h=0;h<s.barCount;h++){const o=s.getPattern(t,h);if(null!=o)for(const t of o.notes){const s=t.pins[0];for(let h=1;h<t.pins.length;h++){const o=t.pins[h];if(s.interval==o.interval){let h=o.time-s.time;h+=Math.max(0,Math.min(e.partsPerBeat,o.time+t.start)-(s.time+t.start)),h*=o.size+s.size;for(const e of t.pitches){n[(i+s.interval+e)%12]+=h}}}}}let h=0,o=0;for(let t=0;t<12;t++){const e=n[t]*(3*n[(t+7)%12]+n[(t+4)%12]+n[(t+3)%12]);o<e&&(o=e,h=t)}if(h!=s.key){const e=s.key-h,i=Math.abs(e);for(let n=0;n<s.pitchChannelCount;n++)for(const h of s.channels[n].patterns)for(let s=0;s<i;s++)this.append(new Ui(t,n,h,e>0,!0));s.key=h,t.notifier.changed(),this.nt()}}}function Mi(t){const e=[];for(let s=0;s<M.presetCategories.length;s++){const i=M.presetCategories[s];if("Novelty Presets"!=i.name)for(let n=0;n<i.presets.length;n++){const h=i.presets[n];null!=h.settings&&1==h.isNoise==t&&e.push((s<<6)+n)}}return e[Math.random()*e.length|0]}function Si(t){for(let e=0;e<t.channels.length;e++)for(const s of t.channels[e].instruments){const i=t.getChannelIsNoise(e),n=e==t.pitchChannelCount?M.nameToPresetValue(Math.random()>.5?"chip noise":"standard drumset"):Mi(i),h=M.valueToPreset(n);s.fromJsonObject(h.settings,i,1),s.preset=n,s.volume=1}}class Pi extends os{constructor(t,e){if(super(),t.song.fromBase64String(e),""==e){this.append(new _i(t,0,0)),t.selection.resetBoxSelection(),Si(t.song),t.song.scale=t.prefs.defaultScale;for(let e=0;e<=t.song.channels.length;e++)t.viewedInstrument[e]=0,t.recentPatternInstruments[e]=[0];t.viewedInstrument.length=t.song.channels.length}else this.append(new Ii(t));t.notifier.changed(),this.nt()}}class Ii extends ns{constructor(t){super();const e=Math.min(t.channel,t.song.getChannelCount()-1),s=Math.max(0,Math.min(t.song.barCount-1,t.bar));t.channel==e&&t.bar==s||(t.bar=s,t.channel=e,this.nt()),t.selection.scrollToSelectedPattern(),t.notifier.changed()}}class Fi extends os{constructor(t,s,i){super();const n=t.song;function h(t,e){for(;t.length>e;){let e=t.length-1,s=0;for(let i=0;i<t.length-1;i++){let n=0;for(const e of t[i].bars)0==e&&n++;n>=s&&(e=i,s=n)}t.splice(e,1)}}for(h(s,e.pitchChannelCountMax),h(i,e.noiseChannelCountMax);s.length<e.pitchChannelCountMin;)s.push(new Ge);for(;i.length<e.noiseChannelCountMin;)i.push(new Ge);n.barCount=1,n.patternsPerChannel=8;const o=s.concat(i);for(let t=0;t<o.length;t++){const e=o[t];n.barCount=Math.max(n.barCount,e.bars.length),n.patternsPerChannel=Math.max(n.patternsPerChannel,e.patterns.length),n.channels[t]=e}n.channels.length=o.length,n.pitchChannelCount=s.length,n.noiseChannelCount=i.length,n.barCount=Math.min(e.barCountMax,n.barCount),n.patternsPerChannel=Math.min(e.barCountMax,n.patternsPerChannel);for(let t=0;t<n.channels.length;t++){const e=n.channels[t];for(let t=0;t<e.bars.length;t++)(e.bars[t]>n.patternsPerChannel||e.bars[t]<0)&&(e.bars[t]=0);for(;e.bars.length<n.barCount;)e.bars.push(0);e.bars.length=n.barCount,e.instruments.length>n.getMaxInstrumentsPerChannel()&&(e.instruments.length=n.getMaxInstrumentsPerChannel());for(const s of e.patterns)ls(s.instruments,n,t);for(;e.patterns.length<n.patternsPerChannel;)e.patterns.push(new Oe);e.patterns.length=n.patternsPerChannel}n.loopStart=Math.max(0,Math.min(n.barCount-1,n.loopStart)),n.loopLength=Math.min(n.barCount-n.loopStart,n.loopLength),this.append(new Ii(t)),t.notifier.changed(),this.nt()}}function Bi(t,e){if(t.length!=e.length)return!1;for(let s=0;s<t.length;s++){const i=t[s],n=e[s];if(n.start!=i.start||n.end!=i.end||n.pitches.length!=i.pitches.length||n.pins.length!=i.pins.length)return!1;for(let t=0;t<i.pitches.length;t++)if(n.pitches[t]!=i.pitches[t])return!1;for(let t=0;t<i.pins.length;t++)if(n.pins[t].interval!=i.pins[t].interval||n.pins[t].time!=i.pins[t].time||n.pins[t].size!=i.pins[t].size)return!1}return!0}function Li(t){for(const e of t){const t=[];for(let s=0;s<e.bars.length;s++){if(0==e.bars[s])continue;const i=e.patterns[e.bars[s]-1];let n=!1;for(let h=0;h<t.length;h++){const o=t[h];if(as(i.instruments,o.instruments)&&o.notes.length==i.notes.length&&Bi(i.notes,o.notes)){n=!0,e.bars[s]=h+1;break}}n||(t.push(i),e.bars[s]=t.length)}for(let s=0;s<t.length;s++)e.patterns[s]=t[s];e.patterns.length=t.length}}class Ci extends ns{constructor(t,s,i){super(),t.song.tempo=Math.max(e.tempoMin,Math.min(e.tempoMax,Math.round(i))),t.notifier.changed(),s!=i&&this.nt()}}class Di extends Os{constructor(t,e,s){super(t),this.It.echoDelay=s,t.notifier.changed(),e!=s&&this.nt()}}class Ti extends Os{constructor(t,e,s){super(t),this.It.echoSustain=s,t.notifier.changed(),e!=s&&this.nt()}}class Ei extends Os{constructor(t,e,s){super(t),this.It.chorus=s,t.notifier.changed(),e!=s&&this.nt()}}class Ni extends Os{constructor(t,e,s){super(t),this.It.reverb=s,t.notifier.changed(),e!=s&&this.nt()}}class Oi extends hs{constructor(t,e,s,i,n=!1){super(n),this.u=t,this.Xt=e,this.dt=s,this._=i,this.nt(),this.redo()}rt(){this.Xt.notes.splice(this._,0,this.dt),this.u.notifier.changed()}lt(){this.Xt.notes.splice(this._,1),this.u.notifier.changed()}}class zi extends fs{constructor(t,e,s,i){super(t,e);const n=(this.ft<0||e.continuesLastPattern)&&0==s;s-=this.ft,i-=this.ft;let h,o=!1,r=this.gt[0].size,a=this.gt[0].interval,l=!0;for(h=0;h<this.gt.length;h++){const t=this.gt[h];if(t.time<s)r=t.size,a=t.interval;else{if(t.time>s&&!o&&(this.vt.push(Ee(a,s,r)),o=!0),!(t.time<=i))break;if(this.vt.push(Ee(t.interval,t.time,t.size)),t.time==i){l=!1;break}}}l&&this.vt.push(Ee(this.gt[h].interval,i,this.gt[h].size)),this.Pt(n)}}class Ri extends rs{constructor(t,e,s,i,n){super();let h=0;for(;h<e.notes.length;){const o=e.notes[h];if(o==n&&null!=n)h++;else if(o.end<=s)h++;else{if(o.start>=i)break;if(o.start<s&&o.end>i){const n=o.clone();this.append(new zi(t,o,o.start,s)),h++,this.append(new Oi(t,e,n,h,!1)),this.append(new zi(t,n,i,n.end)),h++}else o.start<s?(this.append(new zi(t,o,o.start,s)),h++):o.end>i?(this.append(new zi(t,o,i,o.end)),h++):this.append(new Oi(t,e,o,h,!0))}}}}class Ai extends rs{constructor(t,e){super();let s=0;for(;s<e.notes.length;){const i=e.notes[s];if(i.start<t.selection.patternSelectionStart&&t.selection.patternSelectionStart<i.end){const n=i.clone();this.append(new zi(t,i,i.start,t.selection.patternSelectionStart)),s++,this.append(new Oi(t,e,n,s,!1)),this.append(new zi(t,n,t.selection.patternSelectionStart,n.end))}else if(i.start<t.selection.patternSelectionEnd&&t.selection.patternSelectionEnd<i.end){const n=i.clone();this.append(new zi(t,i,i.start,t.selection.patternSelectionEnd)),s++,this.append(new Oi(t,e,n,s,!1)),this.append(new zi(t,n,t.selection.patternSelectionEnd,n.end)),s++}else s++}}}class $i extends hs{constructor(t,s,i,n,h=!1,o=!1){super(!1),this.u=t,this.dt=i,this.gt=i.pins,this.vt=[],this.xt=i.pitches,this.kt=[];const r=t.song.getChannelIsNoise(s);if(r!=t.song.getChannelIsNoise(t.channel))return;const a=r?e.drumCount-1:e.maxPitch;for(let s=0;s<this.xt.length;s++){let i=this.xt[s];if(o&&!r)i=n?Math.min(a,i+12):Math.max(0,i-12);else if(n){for(let s=i+1;s<=a;s++)if(r||h||e.scales[t.song.scale].flags[s%12]){i=s;break}}else for(let s=i-1;s>=0;s--)if(r||h||e.scales[t.song.scale].flags[s%12]){i=s;break}let l=!1;for(let t=0;t<this.kt.length;t++)if(this.kt[t]==i){l=!0;break}l||this.kt.push(i)}let l=0,c=a;for(let t=1;t<this.kt.length;t++){const e=this.kt[0]-this.kt[t];l<e&&(l=e),c>e+a&&(c=e+a)}for(const s of this.gt){let i=s.interval+this.xt[0];if(i<l&&(i=l),i>c&&(i=c),o&&!r)i=n?Math.min(c,i+12):Math.max(l,i-12);else if(n){for(let s=i+1;s<=c;s++)if(r||h||e.scales[t.song.scale].flags[s%12]){i=s;break}}else for(let s=i-1;s>=l;s--)if(r||h||e.scales[t.song.scale].flags[s%12]){i=s;break}i-=this.kt[0],this.vt.push(Ee(i,s.time,s.size))}if(0!=this.vt[0].interval)throw new Error("wrong pin start interval");for(let t=1;t<this.vt.length-1;)this.vt[t-1].interval==this.vt[t].interval&&this.vt[t].interval==this.vt[t+1].interval&&this.vt[t-1].size==this.vt[t].size&&this.vt[t].size==this.vt[t+1].size?this.vt.splice(t,1):t++;this.rt(),this.nt()}rt(){this.dt.pins=this.vt,this.dt.pitches=this.kt,this.u.notifier.changed()}lt(){this.dt.pins=this.gt,this.dt.pitches=this.xt,this.u.notifier.changed()}}class Ui extends rs{constructor(t,e,s,i,n=!1,h=!1){super(),t.selection.patternSelectionActive&&this.append(new Ai(t,s));for(const o of s.notes)t.selection.patternSelectionActive&&(o.end<=t.selection.patternSelectionStart||o.start>=t.selection.patternSelectionEnd)||this.append(new $i(t,e,o,i,n,h))}}class qi extends ns{constructor(t,e,s,i,n){super(),t.selection.boxSelectionX0=e,t.selection.boxSelectionX1=s,t.selection.boxSelectionY0=i,t.selection.boxSelectionY1=n,t.notifier.changed(),this.nt()}}class _i extends hs{constructor(t,e,s){super(!1),this.u=t,this.ft=t.selection.patternSelectionStart,this.yt=t.selection.patternSelectionEnd,this.Zt=t.selection.patternSelectionActive,this.bt=e,this.wt=s,this.te=e<s,this.rt(),this.nt()}rt(){this.u.selection.patternSelectionStart=this.bt,this.u.selection.patternSelectionEnd=this.wt,this.u.selection.patternSelectionActive=this.te,this.u.notifier.changed()}lt(){this.u.selection.patternSelectionStart=this.ft,this.u.selection.patternSelectionEnd=this.yt,this.u.selection.patternSelectionActive=this.Zt,this.u.notifier.changed()}}class Vi extends rs{constructor(t,s,i,n,h){if(super(),0==n&&0==h)return;t.selection.patternSelectionActive&&this.append(new Ai(t,i));const o=t.selection.patternSelectionStart,r=t.selection.patternSelectionEnd,a=Math.max(0,Math.min(t.song.beatsPerBar*e.partsPerBeat,o+n)),l=Math.max(0,Math.min(t.song.beatsPerBar*e.partsPerBeat,r+n));a==l?this.append(new Ri(t,i,o,r)):n<0?this.append(new Ri(t,i,a,Math.min(o,l))):this.append(new Ri(t,i,Math.max(r,a),l)),this.append(new _i(t,a,l));const c=[];let u=0,p=0;for(;p<i.notes.length;){const e=i.notes[p];e.end<=o||e.start>=r?(p++,e.end<=a&&(u=p)):(c.push(e.clone()),this.append(new Oi(t,i,e,p,!0)))}for(const e of c)if(e.start+=n,e.end+=n,!(e.end<=a||e.start>=l)){this.append(new Oi(t,i,e,u++,!1)),this.append(new zi(t,e,Math.max(e.start,a),Math.min(l,e.end)));for(let i=0;i<Math.abs(h);i++)this.append(new $i(t,s,e,h>0,t.prefs.notesOutsideScale))}}}class ji extends os{constructor(t,s,i,n,h){super();for(let o=n;o<n+h;o++){const n={};for(let h=s;h<s+i;h++){const r=t.song.channels[o].bars[h];if(0!=r){if(null==n[String(r)]){let a=!1;for(let e=0;e<t.song.barCount;e++)if((e<s||e>=s+i)&&t.song.channels[o].bars[e]==r){a=!0;break}if(a){const s=t.song.getPattern(o,h);this.append(new vs(t,0,h,o,1,1)),this.append(new fi(t,o,h));const i=t.song.getPattern(o,h);if(null==i)throw new Error;this.append(new ci(t,i,s.notes,0,e.partsPerBeat*t.song.beatsPerBar,e.partsPerBeat*t.song.beatsPerBar)),i.instruments.length=0,i.instruments.push(...s.instruments),n[String(r)]=t.song.channels[o].bars[h]}else n[String(r)]=r}this.append(new vs(t,n[String(r)],h,o,1,1))}}}}}class Gi extends ns{constructor(t,s,i){super(),t.selection.patternSelectionActive&&new Ai(t,s);const n=e.maxPitch;for(const e of s.notes){if(t.selection.patternSelectionActive&&(e.end<=t.selection.patternSelectionStart||e.start>=t.selection.patternSelectionEnd))continue;const s=[],h=[];for(let t=0;t<e.pitches.length;t++){const n=e.pitches[t],h=i[n%12]+(n-n%12);-1==s.indexOf(h)&&s.push(h)}let o=0,r=n;for(let t=1;t<s.length;t++){const e=s[0]-s[t];o<e&&(o=e),r>e+n&&(r=e+n)}for(const t of e.pins){let n=t.interval+e.pitches[0];n<o&&(n=o),n>r&&(n=r);const a=i[n%12]+(n-n%12);h.push(Ee(a-s[0],t.time,t.size))}if(0!=h[0].interval)throw new Error("wrong pin start interval");for(let t=1;t<h.length-1;)h[t-1].interval==h[t].interval&&h[t].interval==h[t+1].interval&&h[t-1].size==h[t].size&&h[t].size==h[t+1].size?h.splice(t,1):t++;e.pitches=s,e.pins=h}this.nt(),t.notifier.changed()}}class Wi extends ns{constructor(t,e,s){super(),t.song.channels[t.channel].instruments[t.getCurrentInstrument()].volume=s,t.notifier.changed(),e!=s&&this.nt()}}class Hi extends ns{constructor(t,e,s){super(),t.song.channels[t.channel].instruments[t.getCurrentInstrument()].pan=s,t.notifier.changed(),e!=s&&this.nt()}}class Ki extends hs{constructor(t,e,s,i,n,h){super(!1),this.u=t,this.dt=e,this.gt=e.pins,this.vt=[];let o=!1;for(const t of e.pins)t.time<s?h?this.vt.push(Ee(t.interval,t.time,i)):this.vt.push(t):t.time==s?(this.vt.push(Ee(n,s,i)),o=!0):(h||o||(this.vt.push(Ee(n,s,i)),o=!0),h?this.vt.push(Ee(t.interval,t.time,i)):this.vt.push(t));us(this.vt),this.rt(),this.nt()}rt(){this.dt.pins=this.vt,this.u.notifier.changed()}lt(){this.dt.pins=this.gt,this.u.notifier.changed()}}class Yi extends ns{constructor(t,e){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.chipWave!=e&&(s.chipWave=e,s.preset=s.type,t.notifier.changed(),this.nt())}}class Ji extends ns{constructor(t,e){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.chipNoise!=e&&(s.chipNoise=e,s.preset=s.type,t.notifier.changed(),this.nt())}}class Qi extends ns{constructor(t){super();const e=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];e.addEnvelope(0,0,0),e.preset=e.type,t.notifier.changed(),this.nt()}}class Xi extends ns{constructor(t,e){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.envelopeCount--;for(let t=e;t<s.envelopeCount;t++)s.envelopes[t].target=s.envelopes[t+1].target,s.envelopes[t].index=s.envelopes[t+1].index,s.envelopes[t].envelope=s.envelopes[t+1].envelope;s.preset=s.type,t.notifier.changed(),this.nt()}}class Zi extends ns{constructor(t,e,s,i){super();const n=t.song.channels[t.channel].instruments[t.getCurrentInstrument()],h=n.envelopes[e].target,o=n.envelopes[e].index;h==s&&o==i||(n.envelopes[e].target=s,n.envelopes[e].index=i,n.preset=n.type,t.notifier.changed(),this.nt())}}class tn extends ns{constructor(t,e,s){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.envelopes[e].envelope!=s&&(i.envelopes[e].envelope=s,i.preset=i.type,t.notifier.changed(),this.nt())}}class en{constructor(){this.valid=!1,this.prevNote=null,this.curNote=null,this.nextNote=null,this.pitch=0,this.pitchIndex=-1,this.curIndex=0,this.start=0,this.end=0,this.part=0,this.exactPart=0,this.nearPinIndex=0,this.pins=[]}}class sn{constructor(t,s,i){this.u=t,this.ee=s,this.se=i,this.ie=O.pattern({id:"patternEditorNoteBackground"+this.se,x:"0",y:"0",patternUnits:"userSpaceOnUse"}),this.ne=O.pattern({id:"patternEditorDrumBackground"+this.se,x:"0",y:"0",patternUnits:"userSpaceOnUse"}),this.he=O.rect({x:"0",y:"0","pointer-events":"none",fill:"url(#patternEditorNoteBackground"+this.se+")"}),this.oe=O.svg(),this.re=O.rect({x:"0",y:"0",width:"4",fill:_.playhead,"pointer-events":"none"}),this.ae=O.rect({fill:_.boxSelectionFill,stroke:_.hoverPreview,"stroke-width":2,"stroke-dasharray":"5, 3","pointer-events":"none",visibility:"hidden"}),this.le=O.path({fill:"none",stroke:_.hoverPreview,"stroke-width":"2","pointer-events":"none"}),this.ce=O.svg({style:`background-color: ${_.editorBackground}; touch-action: none; position: absolute;`,width:"100%",height:"100%"},O.defs(this.ie,this.ne),this.he,this.ae,this.oe,this.le,this.re),this.container=N.div({style:"height: 100%; overflow:hidden; position: relative; flex-grow: 1;"},this.ce),this.ue=[],this.pe=O.rect(),this.de=-1,this.fe=0,this.me=0,this.ye=!1,this.be=!1,this.we=!1,this.ge=!1,this.ve=!1,this.xe=[],this.ke=0,this.Me=0,this.Se=!1,this.Pe=!1,this.Ie=0,this.Fe=!1,this.Be=!1,this.Le=!1,this.Ce=0,this.De=0,this.Te=0,this.Ee=!1,this.Ne=null,this.Oe=null,this.ze=!1,this.Re=new en,this.Xt=null,this.Ae=0,this.$e=0,this.Ue=-1,this.qe=-1,this._e=-1,this.Ve=-1,this.je=!1,this.Ge=!1,this.We=-1,this.He=-1,this.Ke=-1,this.Ye=-1,this.resetCopiedPins=()=>{const t=this.Je();this.xe.length=this.u.song.getChannelCount();for(let s=0;s<this.u.song.pitchChannelCount;s++)this.xe[s]=[Ee(0,0,e.noteSizeMax),Ee(0,t,e.noteSizeMax)];for(let s=this.u.song.pitchChannelCount;s<this.u.song.getChannelCount();s++)this.xe[s]=[Ee(0,0,e.noteSizeMax),Ee(0,t,0)]},this.Qe=t=>{this.ve&&!this.Pe&&!this.we&&this.ye&&performance.now()>this.Ie+1e3&&this.Re.valid&&this.u.lastChangeWas(this.Ne)&&(this.Ne.undo(),this.Pe=!0,this.Xe(),this.u.notifier.notifyWatchers());const e=Math.floor(this.u.synth.playhead);if(this.u.synth.playing&&(null!=this.Xt&&this.u.song.getPattern(this.u.channel,Math.floor(this.u.synth.playhead))==this.Xt||Math.floor(this.u.synth.playhead)==this.u.bar+this.se)){this.re.setAttribute("visibility","visible");const t=this.u.synth.playhead-e;Math.abs(t-this.Ae)>.1?this.Ae=t:this.Ae+=.2*(t-this.Ae),this.re.setAttribute("x",""+k(this.Ae*this.Ze-2))}else this.re.setAttribute("visibility","hidden");this.u.synth.playing&&(this.u.synth.recording||this.u.prefs.autoFollow)&&this.Ye!=e&&(new Bs(this.u,this.u.channel,e),this.u.notifier.notifyWatchers()),this.Ye=e,this.u.currentPatternIsDirty&&this.ts(),window.requestAnimationFrame(this.Qe)},this.es=t=>{this.be||(this.be=!0,this.ve=!1)},this.ss=t=>{this.be&&(this.be=!1)},this.ns=t=>{t.preventDefault();const e=this.ce.getBoundingClientRect();this.fe=((t.clientX||t.pageX)-e.left)*this.Ze/(e.right-e.left),this.me=((t.clientY||t.pageY)-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.ve=!1,this.Se=t.ctrlKey||t.metaKey,this.Pe=t.shiftKey,this.Xe()},this.os=t=>{t.preventDefault();const e=this.ce.getBoundingClientRect();this.fe=(t.touches[0].clientX-e.left)*this.Ze/(e.right-e.left),this.me=(t.touches[0].clientY-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.ve=!0,this.Se=t.ctrlKey||t.metaKey,this.Pe=t.shiftKey,this.Ie=performance.now(),this.Xe()},this.rs=t=>{const e=this.ce.getBoundingClientRect();this.fe=((t.clientX||t.pageX)-e.left)*this.Ze/(e.right-e.left),this.me=((t.clientY||t.pageY)-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.ve=!1,this.ls()},this.cs=t=>{if(!this.ye)return;t.preventDefault();const e=this.ce.getBoundingClientRect();this.fe=(t.touches[0].clientX-e.left)*this.Ze/(e.right-e.left),this.me=(t.touches[0].clientY-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.ls()},this.us=t=>{if(!this.Re.valid)return;const s=this.u.lastChangeWas(this.Ne);if(this.ye&&s&&null!=this.Ne)if(this.Le)this.u.record(this.Ne),this.Ne=null;else if(this.Fe||this.Be||this.Pe)this.ps(this.Ne),this.Ne=null;else if(this.we||null==this.Re.curNote||!this.Ne.isNoop()||this.Fe||this.Be||this.Le||this.Pe)this.u.record(this.Ne),this.Ne=null;else{if(null==this.Xt)throw new Error;const t=new rs;if(t.append(new _i(this.u,0,0)),-1==this.Re.pitchIndex){if(this.Re.curNote.pitches.length==e.maxChordSize&&t.append(new ri(this.u,this.Re.curNote,this.Re.curNote.pitches[0],0,!0)),t.append(new ri(this.u,this.Re.curNote,this.Re.pitch,this.Re.curNote.pitches.length)),this.ds(this.Re.curNote),this.u.prefs.enableNotePreview&&!this.u.synth.playing){const t=Math.min(e.partsPerBeat,this.Re.end-this.Re.start);this.u.performance.setTemporaryPitches(this.Re.curNote.pitches,t)}}else 1==this.Re.curNote.pitches.length?t.append(new Oi(this.u,this.Xt,this.Re.curNote,this.Re.curIndex,!0)):t.append(new ri(this.u,this.Re.curNote,this.Re.pitch,this.Re.curNote.pitches.indexOf(this.Re.pitch),!0));this.u.record(t)}this.ye=!1,this.we=!1,this.Fe=!1,this.Be=!1,this.Le=!1,this.ze=!1,this.fs(),this.ys()};for(let t=0;t<e.pitchesPerOctave;t++){const e=O.rect();e.setAttribute("x","1"),e.setAttribute("fill",0==t?_.tonic:_.pitchBackground),this.ie.appendChild(e),this.ue[t]=e}this.pe.setAttribute("x","1"),this.pe.setAttribute("y","1"),this.pe.setAttribute("fill",_.pitchBackground),this.ne.appendChild(this.pe),this.ee?(this.fs(),this.ys(),window.requestAnimationFrame(this.Qe),this.ce.addEventListener("mousedown",this.ns),document.addEventListener("mousemove",this.rs),document.addEventListener("mouseup",this.us),this.ce.addEventListener("mouseover",this.es),this.ce.addEventListener("mouseout",this.ss),this.ce.addEventListener("touchstart",this.os),this.ce.addEventListener("touchmove",this.cs),this.ce.addEventListener("touchend",this.us),this.ce.addEventListener("touchcancel",this.us)):(this.re.style.display="none",this.ce.appendChild(O.rect({x:0,y:0,width:1e4,height:1e4,fill:_.editorBackground,style:"opacity: 0.5;"}))),this.resetCopiedPins()}bs(){return this.u.song.getChannelIsNoise(this.u.channel)?e.drumCount-1:e.maxPitch}Je(){const t=e.rhythms[this.u.song.rhythm].stepsPerBeat;return t%4==0?e.partsPerBeat/2:t%3==0?e.partsPerBeat/3:t%2==0?e.partsPerBeat/2:e.partsPerBeat}ws(){return e.partsPerBeat/e.rhythms[this.u.song.rhythm].stepsPerBeat}gs(t){const e=this.ws();return Math.floor(t/e)*e}fs(){if(this.Re=new en,this.fe<0||this.fe>this.Ze||this.me<0||this.me>this.hs||this.de<=0)return;const t=this.ws();if(this.Re.exactPart=this.fe/this.vs,this.Re.part=Math.floor(Math.max(0,Math.min(this.u.song.beatsPerBar*e.partsPerBeat-t,this.Re.exactPart))/t)*t,null!=this.Xt)for(const t of this.Xt.notes)if(t.end<=this.Re.exactPart)this.Re.prevNote=t,this.Re.curIndex++;else if(t.start<=this.Re.exactPart&&t.end>this.Re.exactPart)this.Re.curNote=t;else if(t.start>this.Re.exactPart){this.Re.nextNote=t;break}let s=this.xs(this.me);if(null!=this.Re.curNote){this.Re.start=this.Re.curNote.start,this.Re.end=this.Re.curNote.end,this.Re.pins=this.Re.curNote.pins;let t,e=0,i=0,n=this.Re.curNote.pins[0];for(let s=1;s<this.Re.curNote.pins.length;s++){t=n,n=this.Re.curNote.pins[s];const h=this.vs*(this.Re.curNote.start+t.time),o=this.vs*(this.Re.curNote.start+n.time);if(this.fe>o)continue;if(this.fe<h)throw new Error;const r=(this.fe-h)/(o-h),a=Math.sqrt(1/Math.sqrt(4)-Math.pow(r-.5,2))-.5,l=Math.abs(n.interval-t.interval);e=t.interval*(1-r)+n.interval*r,i=a*l+.95;break}let h=Number.MAX_VALUE,o=-Number.MAX_VALUE,r=Number.MAX_VALUE;for(const t of this.Re.curNote.pins){h>t.interval&&(h=t.interval),o<t.interval&&(o=t.interval);const e=Math.abs(this.Re.curNote.start+t.time-this.fe/this.vs);r>e&&(r=e,this.Re.nearPinIndex=this.Re.curNote.pins.indexOf(t))}if(s-=e,this.Re.pitch=this.ks(s,-h,this.bs()-o),!this.u.song.getChannelIsNoise(this.u.channel)){let t=i;for(let e=0;e<this.Re.curNote.pitches.length;e++){const i=Math.abs(this.Re.curNote.pitches[e]-s+.5);i>t||(t=i,this.Re.pitch=this.Re.curNote.pitches[e])}}for(let t=0;t<this.Re.curNote.pitches.length;t++)if(this.Re.curNote.pitches[t]==this.Re.pitch){this.Re.pitchIndex=t;break}}else{this.Re.pitch=this.ks(s,0,this.bs());const t=this.Ms[this.Ms.length-1].time,i=Math.floor(this.Re.part/e.partsPerBeat),n=this.Je(),h=this.Re.part%e.partsPerBeat;if(1==t)this.Re.start=this.Re.part;else if(t>e.partsPerBeat)this.Re.start=i*e.partsPerBeat;else if(t==e.partsPerBeat)this.Re.start=i*e.partsPerBeat,n<e.partsPerBeat&&h>n&&(this.Re.start+=Math.floor(h/n)*n);else{this.Re.start=i*e.partsPerBeat;let s=e.partsPerBeat%t==0?t:Math.min(t,n);for(;s<n&&e.partsPerBeat%s!=0;)s++;this.Re.start+=Math.floor(h/s)*s}this.Re.end=this.Re.start+t;let o=0,r=this.u.song.beatsPerBar*e.partsPerBeat;if(null!=this.Re.prevNote&&(o=this.Re.prevNote.end),null!=this.Re.nextNote&&(r=this.Re.nextNote.start),this.Re.start<o?(this.Re.start=o,this.Re.end=this.Re.start+t,this.Re.end>r&&(this.Re.end=r)):this.Re.end>r&&(this.Re.end=r,this.Re.start=this.Re.end-t,this.Re.start<o&&(this.Re.start=o)),this.Re.end-this.Re.start==t)this.Re.pins=this.Ms;else{this.Re.pins=[];for(const t of this.Ms){if(!(t.time<=this.Re.end-this.Re.start)){this.Re.pins.push(Ee(0,this.Re.end-this.Re.start,t.size));break}if(this.Re.pins.push(Ee(0,t.time,t.size)),t.time==this.Re.end-this.Re.start)break}}}this.Re.valid=!0}Ss(){return this.Re.valid&&this.u.selection.patternSelectionActive&&this.u.selection.patternSelectionStart<=this.Re.exactPart&&this.Re.exactPart<=this.u.selection.patternSelectionEnd}Ps(){return this.Re.valid&&this.u.selection.patternSelectionActive&&-1==this.Re.pitchIndex&&this.u.selection.patternSelectionStart-3<=this.Re.exactPart&&this.Re.exactPart<=this.u.selection.patternSelectionStart+1.25}Is(){return this.Re.valid&&this.u.selection.patternSelectionActive&&-1==this.Re.pitchIndex&&this.u.selection.patternSelectionEnd-1.25<=this.Re.exactPart&&this.Re.exactPart<=this.u.selection.patternSelectionEnd+3}xs(t){return Math.max(0,Math.min(this.Fs-1,this.Fs-t/this.de))+this.$e}ks(t,s,i){t<s&&(t=s),t>i&&(t=i);const n=this.u.prefs.notesOutsideScale?e.scales.dictionary.expert.flags:e.scales[this.u.song.scale].flags;if(n[Math.floor(t)%e.pitchesPerOctave]||this.u.song.getChannelIsNoise(this.u.channel))return Math.floor(t);{let h=Math.floor(t)+1,o=Math.floor(t)-1;for(;!n[h%e.pitchesPerOctave];)h++;for(;!n[o%e.pitchesPerOctave];)o--;if(h>i)return o<s?s:o;if(o<s)return h;let r=h,a=o+1;return h%e.pitchesPerOctave!=0&&h%e.pitchesPerOctave!=7||(r-=.5),o%e.pitchesPerOctave!=0&&o%e.pitchesPerOctave!=7||(a+=.5),t-a>r-t?h:o}}ds(t){this.Ms=[];for(const e of t.pins)this.Ms.push(Ee(0,e.time,e.size));for(let t=1;t<this.Ms.length-1;)this.Ms[t-1].size==this.Ms[t].size&&this.Ms[t].size==this.Ms[t+1].size?this.Ms.splice(t,1):t++;this.xe[this.u.channel]=this.Ms}movePlayheadToMouse(){return!!this.be&&(this.u.synth.playhead=this.u.bar+this.se+this.fe/this.Ze,!0)}Xe(){this.u.prefs.enableNotePreview&&this.u.synth.maintainLiveInput(),this.ye=!0,this.ke=this.fe,this.Me=this.me,this.fs(),this.ys();const t=new rs;if(this.Ne=t,this.ze=this.u.lastChangeWas(this.Oe),this.u.setProspectiveChange(this.Ne),this.Ps())this.Fe=!0;else if(this.Is())this.Be=!0;else if(this.Pe)if(this.u.selection.patternSelectionActive&&-1==this.Re.pitchIndex||this.Ss())t.append(new _i(this.u,0,0));else if(null!=this.Re.curNote)t.append(new _i(this.u,this.Re.curNote.start,this.Re.curNote.end));else{const s=Math.max(0,Math.min((this.u.song.beatsPerBar-1)*e.partsPerBeat,Math.floor(this.Re.exactPart/e.partsPerBeat)*e.partsPerBeat)),i=s+e.partsPerBeat;t.append(new _i(this.u,s,i))}else if(this.Ss())this.Le=!0;else if(this.Re.valid&&null==this.Re.curNote){t.append(new _i(this.u,0,0));const s=new Ne(this.Re.pitch,this.Re.start,this.Re.end,e.noteSizeMax,this.u.song.getChannelIsNoise(this.u.channel));s.pins=[];for(const t of this.Re.pins)s.pins.push(Ee(0,t.time,t.size));t.append(new fi(this.u,this.u.channel,this.u.bar));const i=this.u.getCurrentPattern(this.se);if(null==i)throw new Error;if(t.append(new Oi(this.u,i,s,this.Re.curIndex)),this.u.prefs.enableNotePreview&&!this.u.synth.playing){const t=Math.min(e.partsPerBeat,this.Re.end-this.Re.start);this.u.performance.setTemporaryPitches([this.Re.pitch],t)}}H+=Math.round(50*Math.random()),window.localStorage.setItem("money",String(H)),1==Math.round(10*Math.random())&&(K+=Math.round(3*Math.random()),window.localStorage.setItem("gems",String(K))),this.Bs(),console.log(H)}ls(){this.u.prefs.enableNotePreview&&this.be&&this.u.synth.maintainLiveInput();const t=this.u.lastChangeWas(this.Ne);if(!this.we&&this.ye&&this.Re.valid&&t){const t=this.fe-this.ke,e=this.me-this.Me;Math.sqrt(t*t+e*e)>5&&(this.we=!0,this.ge=Math.abs(t)>=Math.abs(e))}if(this.we&&this.ye&&this.Re.valid&&t){this.Ne.undo();const t=new rs;this.Ne=t,this.u.setProspectiveChange(this.Ne);const s=this.ws(),i=this.gs(this.fe/this.vs);if(this.Fe)t.append(new _i(this.u,Math.max(0,Math.min(this.u.song.beatsPerBar*e.partsPerBeat,i)),this.u.selection.patternSelectionEnd)),this.Bs();else if(this.Be)t.append(new _i(this.u,this.u.selection.patternSelectionStart,Math.max(0,Math.min(this.u.song.beatsPerBar*e.partsPerBeat,i)))),this.Bs();else if(this.Le){const t=this.u.getCurrentPattern(this.se);if(this.we&&null!=t){this.Ne.undo();const i=new rs;this.Ne=i,this.u.setProspectiveChange(this.Ne);const n=e.scales[this.u.song.scale].flags.filter((t=>t)).length,h=this.u.song.getChannelIsNoise(this.u.channel)?1:12/n,o=Math.round((this.fe-this.ke)/(this.vs*s))*s,r=Math.round((this.Me-this.me)/(this.de*h));i.append(new Vi(this.u,this.u.channel,t,o,r))}}else if(this.Pe){if(this.we){let s=Math.max(0,Math.min((this.u.song.beatsPerBar-1)*e.partsPerBeat,Math.floor(this.Re.exactPart/e.partsPerBeat)*e.partsPerBeat)),n=s+e.partsPerBeat;if(null!=this.Re.curNote&&(s=Math.max(s,this.Re.curNote.start),n=Math.min(n,this.Re.curNote.end)),i<s){s=0;const t=this.u.getCurrentPattern(this.se);if(null!=t)for(let e=0;e<t.notes.length;e++)t.notes[e].start<=i&&(s=t.notes[e].start),t.notes[e].end<=i&&(s=t.notes[e].end);for(let t=0;t<=this.u.song.beatsPerBar;t++){const n=t*e.partsPerBeat;s<=n&&n<=i&&(s=n)}}if(i>n){n=e.partsPerBeat*this.u.song.beatsPerBar;const t=this.u.getCurrentPattern(this.se);if(null!=t)for(let e=0;e<t.notes.length;e++){if(t.notes[e].start>=i){n=t.notes[e].start;break}if(t.notes[e].end>=i){n=t.notes[e].end;break}}for(let t=0;t<=this.u.song.beatsPerBar;t++){const s=t*e.partsPerBeat;i<s&&s<n&&(n=s)}}t.append(new _i(this.u,s,n)),this.Bs()}}else if(null==this.Re.curNote){let n,h;t.append(new _i(this.u,0,0)),i<this.Re.start?(n=!0,h=this.Re.start-i):(n=!1,h=i-this.Re.start+s);let o,r,a=s;for(let t=s;t<=this.u.song.beatsPerBar*e.partsPerBeat;t+=s){if(1==s){if(t<5);else if(t<=e.partsPerBeat/2){if(t%3!=0&&t%4!=0)continue}else if(t<=1.5*e.partsPerBeat){if(t%6!=0&&t%8!=0)continue}else if(t%e.partsPerBeat!=0)continue}else if(t>=5*s&&t%e.partsPerBeat!=0&&t!=3*e.partsPerBeat/4&&t!=3*e.partsPerBeat/2&&t!=4*e.partsPerBeat/3)continue;const i=t;if(i==h){a=i;break}if(i<h&&(a=i),i>h){a<h-s&&(a=i);break}}n?(r=this.Re.start,o=r-a):(o=this.Re.start,r=o+a);const l=o<0;if(o<0&&(o=0),r>this.u.song.beatsPerBar*e.partsPerBeat&&(r=this.u.song.beatsPerBar*e.partsPerBeat),o<r){t.append(new fi(this.u,this.u.channel,this.u.bar));const s=this.u.getCurrentPattern(this.se);if(null==s)throw new Error;let i;for(t.append(new Ri(this.u,s,o,r)),i=0;i<s.notes.length&&!(s.notes[i].start>=r);i++);const h=new Ne(this.Re.pitch,o,r,e.noteSizeMax,this.u.song.getChannelIsNoise(this.u.channel));h.continuesLastPattern=l,t.append(new Oi(this.u,s,h,i)),this.ds(h),this.Ce=n?o:r,this.De=this.Re.pitch,this.Te=h.pins[n?0:1].size,this.Ee=!0}this.Xt=this.u.getCurrentPattern(this.se)}else if(this.ge){t.append(new _i(this.u,0,0));const i=(this.fe-this.ke)/this.vs,n=this.Re.curNote.pins[this.Re.nearPinIndex];let h=Math.round((this.Re.curNote.start+n.time+i)/s)*s;const o=h<0;if(h<0&&(h=0),h>this.u.song.beatsPerBar*e.partsPerBeat&&(h=this.u.song.beatsPerBar*e.partsPerBeat),null==this.Xt)throw new Error;if(h<=this.Re.curNote.start&&this.Re.nearPinIndex==this.Re.curNote.pins.length-1||h>=this.Re.curNote.end&&0==this.Re.nearPinIndex)t.append(new Oi(this.u,this.Xt,this.Re.curNote,this.Re.curIndex,!0)),this.Ee=!1;else{const e=Math.min(this.Re.curNote.start,h),s=Math.max(this.Re.curNote.end,h);this.Ce=h,this.De=this.Re.curNote.pitches[-1==this.Re.pitchIndex?0:this.Re.pitchIndex]+this.Re.curNote.pins[this.Re.nearPinIndex].interval,this.Te=this.Re.curNote.pins[this.Re.nearPinIndex].size,this.Ee=!0,t.append(new Ri(this.u,this.Xt,e,s,this.Re.curNote)),t.append(new mi(this.u,this.Re.curNote,this.Re.nearPinIndex,h,o)),this.ds(this.Re.curNote)}}else if(-1==this.Re.pitchIndex){t.append(new _i(this.u,0,0));const i=Math.max(this.Re.curNote.start,Math.min(this.Re.curNote.end,Math.round(this.fe/(this.vs*s))*s))-this.Re.curNote.start;let n,h=this.Re.curNote.pins[0],o=0,r=0;for(let t=1;t<this.Re.curNote.pins.length;t++){if(n=h,h=this.Re.curNote.pins[t],i>h.time)continue;if(i<n.time)throw new Error;const s=(i-n.time)/(h.time-n.time);o=Math.round(n.size*(1-s)+h.size*s+(this.Me-this.me)/(75/e.noteSizeMax)),o<0&&(o=0),o>e.noteSizeMax&&(o=e.noteSizeMax),r=this.ks(Math.round(n.interval*(1-s)+h.interval*s+this.Re.curNote.pitches[0]),0,this.bs())-this.Re.curNote.pitches[0];break}this.Ce=this.Re.curNote.start+i,this.De=this.Re.curNote.pitches[-1==this.Re.pitchIndex?0:this.Re.pitchIndex]+r,this.Te=o,this.Ee=!0,t.append(new Ki(this.u,this.Re.curNote,i,o,r,this.Se)),this.ds(this.Re.curNote)}else{if(t.append(new _i(this.u,0,0)),this.Te=this.Re.curNote.pins[this.Re.nearPinIndex].size,null==this.Xt)throw new Error;let n,h;this.fe>=this.ke?(n=Math.max(this.Re.curNote.start,this.Re.part),h=i+s):(n=Math.min(this.Re.curNote.end,this.Re.part+s),h=i),h<0&&(h=0),h>this.u.song.beatsPerBar*e.partsPerBeat&&(h=this.u.song.beatsPerBar*e.partsPerBeat),h>this.Re.curNote.end&&t.append(new Ri(this.u,this.Xt,this.Re.curNote.start,h,this.Re.curNote)),h<this.Re.curNote.start&&t.append(new Ri(this.u,this.Xt,h,this.Re.curNote.end,this.Re.curNote));let o=Number.MAX_VALUE,r=-Number.MAX_VALUE;for(const t of this.Re.curNote.pitches)o>t&&(o=t),r<t&&(r=t);o-=this.Re.curNote.pitches[this.Re.pitchIndex],r-=this.Re.curNote.pitches[this.Re.pitchIndex];const a=this.ks(this.xs(this.me),-o,this.bs()-r);t.append(new yi(this.u,this.Re.curNote,n,h,a,this.Re.pitchIndex)),this.ds(this.Re.curNote),this.Ce=h,this.De=a,this.Ee=!0}}this.ye&&this.Re.valid&&t||(this.fs(),this.ys())}ps(t){this.Oe=t,this.u.hasRedoHistory()||this.u.record(this.Oe,this.ze)}ys(){if(this.ve)if(!this.ye||!this.Re.valid||!this.we||!this.Ee||this.Pe||this.Fe||this.Be||this.Le)this.le.setAttribute("visibility","hidden");else{this.le.setAttribute("visibility","visible");const t=this.vs*this.Ce,s=this.Ls(this.De-this.$e),i=this.de/2,n=80,h=60;let o="";const r=e.noteSizeMax;o+="M "+k(t)+" "+k(s-i*(this.Te/r))+" ",o+="L "+k(t)+" "+k(s-i*(this.Te/r)-h)+" ",o+="M "+k(t)+" "+k(s+i*(this.Te/r))+" ",o+="L "+k(t)+" "+k(s+i*(this.Te/r)+h)+" ",o+="M "+k(t)+" "+k(s-i*(this.Te/r))+" ",o+="L "+k(t+n)+" "+k(s-i*(this.Te/r))+" ",o+="M "+k(t)+" "+k(s+i*(this.Te/r))+" ",o+="L "+k(t+n)+" "+k(s+i*(this.Te/r))+" ",o+="M "+k(t)+" "+k(s-i*(this.Te/r))+" ",o+="L "+k(t-n)+" "+k(s-i*(this.Te/r))+" ",o+="M "+k(t)+" "+k(s+i*(this.Te/r))+" ",o+="L "+k(t-n)+" "+k(s+i*(this.Te/r))+" ",this.le.setAttribute("d",o)}else if(this.be&&!this.ye&&this.Re.valid)if(this.le.setAttribute("visibility","visible"),this.Ps()){const t=this.vs*this.u.selection.patternSelectionStart,e=k(t-4),s=k(t+4),i=this.Ls(-.5);this.le.setAttribute("d","M "+e+" 0 L "+e+" "+i+" L "+s+" "+i+" L "+s+" 0 z")}else if(this.Is()){const t=this.vs*this.u.selection.patternSelectionEnd,e=k(t-4),s=k(t+4),i=this.Ls(-.5);this.le.setAttribute("d","M "+e+" 0 L "+e+" "+i+" L "+s+" "+i+" L "+s+" 0 z")}else if(this.Ss()){const t=k(this.vs*this.u.selection.patternSelectionStart-2),e=k(this.vs*this.u.selection.patternSelectionEnd+2),s=this.Ls(-.5);this.le.setAttribute("d","M "+t+" 0 L "+t+" "+s+" L "+e+" "+s+" L "+e+" 0 z")}else this.Cs(this.le,this.Re.pitch,this.Re.start,this.Re.pins,this.de/2+1,!0,this.$e);else this.le.setAttribute("visibility","hidden")}Bs(){this.u.selection.patternSelectionActive?(this.ae.setAttribute("visibility","visible"),this.ae.setAttribute("x",String(this.vs*this.u.selection.patternSelectionStart)),this.ae.setAttribute("width",String(this.vs*(this.u.selection.patternSelectionEnd-this.u.selection.patternSelectionStart)))):this.ae.setAttribute("visibility","hidden")}render(){const t=this.u.getCurrentPattern(this.se);this.Xt!=t&&null!=this.Xt&&(this.Ne=null,this.us(null)),this.Xt=t,this.Ze=this.container.clientWidth,this.hs=this.container.clientHeight,this.vs=this.Ze/(this.u.song.beatsPerBar*e.partsPerBeat),this.Fs=this.u.song.getChannelIsNoise(this.u.channel)?e.drumCount:this.u.getVisiblePitchCount(),this.de=this.hs/this.Fs,this.$e=this.u.getBaseVisibleOctave(this.u.channel)*e.pitchesPerOctave,this.We==this.u.song.rhythm&&this.He==this.u.song.pitchChannelCount&&this.Ke==this.u.song.noiseChannelCount||(this.We=this.u.song.rhythm,this.He=this.u.song.pitchChannelCount,this.Ke=this.u.song.noiseChannelCount,this.resetCopiedPins()),this.Ms=this.xe[this.u.channel],this.Ue==this.Ze&&this.qe==this.hs||(this.Ue=this.Ze,this.qe=this.hs,this.he.setAttribute("width",""+this.Ze),this.he.setAttribute("height",""+this.hs),this.re.setAttribute("height",""+this.hs),this.ae.setAttribute("y","0"),this.ae.setAttribute("height",""+this.hs));const s=this.Ze/this.u.song.beatsPerBar;if(this._e!=s||this.Ve!=this.de){this._e=s,this.Ve=this.de,this.ie.setAttribute("width",""+s),this.ie.setAttribute("height",""+this.de*e.pitchesPerOctave),this.ne.setAttribute("width",""+s),this.ne.setAttribute("height",""+this.de),this.pe.setAttribute("width",""+(s-2)),this.pe.setAttribute("height",""+(this.de-2));for(let t=0;t<e.pitchesPerOctave;t++){const i=this.ue[t],n=(e.pitchesPerOctave-t)%e.pitchesPerOctave;i.setAttribute("width",""+(s-2)),i.setAttribute("y",""+(n*this.de+1)),i.setAttribute("height",""+(this.de-2))}}this.ee&&(this.ye||this.fs(),this.ys(),this.Bs()),this.je!=this.u.prefs.showFifth&&(this.je=this.u.prefs.showFifth,this.ue[7].setAttribute("fill",this.u.prefs.showFifth?_.fifthNote:_.pitchBackground));for(let t=0;t<e.pitchesPerOctave;t++)this.ue[t].style.visibility=e.scales[this.u.song.scale].flags[t]?"visible":"hidden";this.u.song.getChannelIsNoise(this.u.channel)?this.Ge||(this.Ge=!0,this.he.setAttribute("fill","url(#patternEditorDrumBackground"+this.se+")")):this.Ge&&(this.Ge=!1,this.he.setAttribute("fill","url(#patternEditorNoteBackground"+this.se+")")),this.ts()}ts(){if(this.oe=function(t){const e=t.cloneNode(!1);return t.parentNode.replaceChild(e,t),e}(this.oe),this.u.prefs.showChannels)for(let t=this.u.song.getChannelCount()-1;t>=0;t--){if(t==this.u.channel)continue;if(this.u.song.getChannelIsNoise(t)!=this.u.song.getChannelIsNoise(this.u.channel))continue;const s=this.u.song.getPattern(t,this.u.bar+this.se);if(null==s)continue;const i=this.u.getBaseVisibleOctave(t)*e.pitchesPerOctave;for(const e of s.notes)for(const s of e.pitches){const n=O.path();n.setAttribute("fill",_.getChannelColor(this.u.song,t).secondaryNote),n.setAttribute("pointer-events","none"),this.Cs(n,s,e.start,e.pins,.19*this.de,!1,i),this.oe.appendChild(n)}}if(null!=this.Xt){const t=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()],e=t.getChord(),s=t.getTransition(),i=e.customInterval||e.arpeggiates||e.strumParts>0||s.slides;for(const t of this.Xt.notes)for(let e=0;e<t.pitches.length;e++){const s=t.pitches[e];let n=O.path();n.setAttribute("fill",_.getChannelColor(this.u.song,this.u.channel).secondaryNote),n.setAttribute("pointer-events","none"),this.Cs(n,s,t.start,t.pins,this.de/2+1,!1,this.$e),this.oe.appendChild(n),n=O.path(),n.setAttribute("fill",_.getChannelColor(this.u.song,this.u.channel).primaryNote),n.setAttribute("pointer-events","none"),this.Cs(n,s,t.start,t.pins,this.de/2+1,!0,this.$e),this.oe.appendChild(n);let h=2;if(t.continuesLastPattern){const e=Math.min(this.de,20);let i;i="M "+k(this.vs*t.start+h)+" "+k(this.Ls(s-this.$e)-.1*e),i+="L "+k(this.vs*t.start+h)+" "+k(this.Ls(s-this.$e)+.1*e),i+="L "+k(this.vs*t.start+h+4)+" "+k(this.Ls(s-this.$e)+.1*e),i+="L "+k(this.vs*t.start+h+4)+" "+k(this.Ls(s-this.$e)+.3*e),i+="L "+k(this.vs*t.start+h+12)+" "+k(this.Ls(s-this.$e)),i+="L "+k(this.vs*t.start+h+4)+" "+k(this.Ls(s-this.$e)-.3*e),i+="L "+k(this.vs*t.start+h+4)+" "+k(this.Ls(s-this.$e)-.1*e);const n=O.path();n.setAttribute("d",i),n.setAttribute("fill",_.invertedText),this.oe.appendChild(n),h+=12}if(t.pitches.length>1&&i){const i=O.text();i.setAttribute("x",""+k(this.vs*t.start+h)),i.setAttribute("y",""+k(this.Ls(s-this.$e))),i.setAttribute("width","30"),i.setAttribute("fill",_.invertedText),i.setAttribute("text-anchor","start"),i.setAttribute("dominant-baseline","central"),i.setAttribute("pointer-events","none"),i.textContent=""+(e+1),this.oe.appendChild(i)}}}this.u.currentPatternIsDirty=!1}Cs(t,s,i,n,h,o,r){const a=this.vs*(n[n.length-1].time+n[0].time),l=.5*Math.min(2,a-1);let c=n[0],u="M "+k(this.vs*(i+c.time)+l)+" "+k(this.Ls(s-r)+h*(o?c.size/e.noteSizeMax:1))+" ";for(let t=1;t<n.length;t++){let a=c;c=n[t];let p=this.vs*(i+a.time)+(1==t?l:0),d=this.vs*(i+c.time)-(t==n.length-1?l:0),f=this.Ls(s+a.interval-r),m=this.Ls(s+c.interval-r),y=o?a.size/e.noteSizeMax:1,b=o?c.size/e.noteSizeMax:1;u+="L "+k(p)+" "+k(f-h*y)+" ",a.interval>c.interval&&(u+="L "+k(p+1)+" "+k(f-h*y)+" "),a.interval<c.interval&&(u+="L "+k(d-1)+" "+k(m-h*b)+" "),u+="L "+k(d)+" "+k(m-h*b)+" "}for(let t=n.length-2;t>=0;t--){let a=c;c=n[t];let p=this.vs*(i+a.time)-(t==n.length-2?l:0),d=this.vs*(i+c.time)+(0==t?l:0),f=this.Ls(s+a.interval-r),m=this.Ls(s+c.interval-r),y=o?a.size/e.noteSizeMax:1,b=o?c.size/e.noteSizeMax:1;u+="L "+k(p)+" "+k(f+h*y)+" ",a.interval<c.interval&&(u+="L "+k(p-1)+" "+k(f+h*y)+" "),a.interval>c.interval&&(u+="L "+k(d+1)+" "+k(m+h*b)+" "),u+="L "+k(d)+" "+k(m+h*b)+" "}u+="z",t.setAttribute("d",u)}Ls(t){return this.de*(this.Fs-t-.5)}}class nn{constructor(t){this.u=t,this.container=N.div({class:"envelopeEditor"}),this.Ds=[],this.Ts=[],this.Es=[],this.Ns=[],this.Os=0,this.zs=-1,this.Rs=-1,this.As=0,this.$s=t=>{const s=this.Ts.indexOf(t.target),i=this.Es.indexOf(t.target);if(-1!=s){const t=parseInt(this.Ts[s].value),i=t%e.instrumentAutomationTargets.length,n=t/e.instrumentAutomationTargets.length>>>0;this.u.record(new Zi(this.u,s,i,n))}else-1!=i&&this.u.record(new tn(this.u,i,this.Es[i].selectedIndex))},this.Us=t=>{const e=this.Ns.indexOf(t.target);-1!=e&&this.u.record(new Xi(this.u,e))},this.container.addEventListener("change",this.$s),this.container.addEventListener("click",this.Us)}qs(t,s){let i=e.instrumentAutomationTargets[t].displayName;return e.instrumentAutomationTargets[t].maxCount>1&&(-1!=i.indexOf("#")?i=i.replace("#",String(s+1)):i+=" "+(s+1)),N.option({value:t+s*e.instrumentAutomationTargets.length},i)}_s(t,s){for(let i=0;i<t.childElementCount;i++){const n=t.children[i],h=parseInt(n.value),o=h%e.instrumentAutomationTargets.length,r=h/e.instrumentAutomationTargets.length>>>0;n.hidden=!s.supportsEnvelopeTarget(o,r)}}render(){const t=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()];if(this.u.prefs.alwaysShowSettings||t.preset==t.type){for(let s=this.Ds.length;s<t.envelopeCount;s++){const t=N.select();for(let s=0;s<e.instrumentAutomationTargets.length;s++){const i=e.instrumentAutomationTargets[s].interleave;for(let n=0;n<e.instrumentAutomationTargets[s].maxCount;n++)t.appendChild(this.qs(s,n)),i&&t.appendChild(this.qs(s+1,n));i&&s++}const i=N.select();for(let t=0;t<e.envelopes.length;t++)i.appendChild(N.option({value:t},e.envelopes[t].name));const n=N.button({type:"button",class:"delete-envelope"}),h=N.div({class:"envelope-row"},N.div({class:"selectContainer",style:"width: 0; flex: 1;"},t),N.div({class:"selectContainer",style:"width: 0; flex: 0.7;"},i),n);this.container.appendChild(h),this.Ds[s]=h,this.Ts[s]=t,this.Es[s]=i,this.Ns[s]=n}for(let e=this.Os;e<t.envelopeCount;e++)this.Ds[e].style.display="",this._s(this.Ts[e],t);for(let e=t.envelopeCount;e<this.Os;e++)this.Ds[e].style.display="none";if(this.zs!=t.eqFilter.controlPointCount||this.Rs!=t.noteFilter.controlPointCount||this.Vs!=t.type||this.As!=t.effects)for(let e=0;e<this.Os;e++)this._s(this.Ts[e],t);for(let s=0;s<t.envelopeCount;s++)this.Ts[s].value=String(t.envelopes[s].target+t.envelopes[s].index*e.instrumentAutomationTargets.length),this.Es[s].selectedIndex=t.envelopes[s].envelope;this.Os=t.envelopeCount,this.zs=t.eqFilter.controlPointCount,this.Rs=t.noteFilter.controlPointCount,this.Vs=t.type,this.As=t.effects}}}class hn{constructor(t){this.u=t,this.Ze=120,this.hs=26,this.js=O.path({fill:_.uiWidgetBackground,"pointer-events":"none"}),this.Gs=O.path({fill:"none",stroke:"currentColor","stroke-width":1,"stroke-dasharray":"3, 2","pointer-events":"none"}),this.Ws=O.path({fill:"none",stroke:"currentColor","stroke-width":2,"pointer-events":"none"}),this.ce=O.svg({style:`background-color: ${_.editorBackground}; touch-action: none; cursor: crosshair;`,width:"100%",height:"100%",viewBox:"0 0 "+this.Ze+" "+this.hs,preserveAspectRatio:"none"},this.js,this.Gs,this.Ws),this.container=N.div({class:"fadeInOut",style:"height: 100%;"},this.ce),this.fe=0,this.ke=0,this.ye=!1,this.we=!1,this.Hs=!1,this.Ne=null,this.Ks=-1,this.Ys=-1,this.ns=t=>{t.preventDefault();const e=this.ce.getBoundingClientRect();this.fe=(t.clientX||t.pageX)-e.left,this.Xe()},this.os=t=>{t.preventDefault();const e=this.ce.getBoundingClientRect();this.fe=t.touches[0].clientX-e.left,this.Xe()},this.rs=t=>{if(null==this.container.offsetParent)return;const e=this.ce.getBoundingClientRect();this.fe=(t.clientX||t.pageX)-e.left,isNaN(this.fe)&&(this.fe=0),this.ls()},this.cs=t=>{if(null==this.container.offsetParent)return;if(!this.ye)return;t.preventDefault();const e=this.ce.getBoundingClientRect();this.fe=t.touches[0].clientX-e.left,isNaN(this.fe)&&(this.fe=0),this.ls()},this.us=t=>{if(null!=this.container.offsetParent){if(this.ye&&this.u.lastChangeWas(this.Ne)&&null!=this.Ne)if(this.we)this.u.record(this.Ne);else{const t=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()];this.Hs?this.u.record(new Ys(this.u,this.Js(this.fe),t.fadeOut)):this.u.record(new Ys(this.u,t.fadeIn,this.Qs(this.fe)))}this.Ne=null,this.we=!1,this.ye=!1}};const s=this.Xs(e.fadeOutNeutral);this.Gs.setAttribute("d",`M ${s} 0 L ${s} ${this.hs}`),this.container.addEventListener("mousedown",this.ns),document.addEventListener("mousemove",this.rs),document.addEventListener("mouseup",this.us),this.container.addEventListener("touchstart",this.os),this.container.addEventListener("touchmove",this.cs),this.container.addEventListener("touchend",this.us),this.container.addEventListener("touchcancel",this.us)}Zs(t){return 1+.4*(this.Ze-2)*t/(e.fadeInRange-1)}Js(t){return Fe(0,e.fadeInRange,Math.round((t-1)*(e.fadeInRange-1)/(.4*this.Ze-2)))}Xs(t){return 1+(this.Ze-2)*(.5+.5*t/(e.fadeOutTicks.length-1))}Qs(t){return Fe(0,e.fadeOutTicks.length,Math.round((e.fadeOutTicks.length-1)*((t-1)/(this.Ze-2)-.5)/.5))}Xe(){isNaN(this.fe)&&(this.fe=0),this.ke=this.fe,this.ye=!0,this.we=!1;const t=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()],e=this.Zs(t.fadeIn),s=this.Xs(t.fadeOut);this.Hs=this.ke<(e+s)/2,this.Ne=new rs,this.u.setProspectiveChange(this.Ne)}ls(){if(null!=this.Ne&&this.u.lastChangeWas(this.Ne)?this.Ne.undo():this.ye=!1,this.Ne=null,this.ye){const t=new rs;if(this.Ne=t,this.u.setProspectiveChange(this.Ne),Math.abs(this.fe-this.ke)>4&&(this.we=!0),this.we){const e=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()];this.Hs?t.append(new Ys(this.u,this.Js(this.Zs(e.fadeIn)+this.fe-this.ke),e.fadeOut)):t.append(new Ys(this.u,e.fadeIn,this.Qs(this.Xs(e.fadeOut)+this.fe-this.ke)))}}}render(){const t=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()];if(this.Ks==t.fadeIn&&this.Ys==t.fadeOut)return;const s=this.Zs(t.fadeIn),i=this.Xs(t.fadeOut);this.Ws.setAttribute("d",`M ${s} 0 L ${s} ${this.hs} M ${i} 0 L ${i} ${this.hs}`);const n=this.Xs(e.fadeOutNeutral);let h="";h+=`M 0 ${this.hs} `,h+=`L ${s} 0 `,Xe.fadeOutSettingToTicks(t.fadeOut)>0?(h+=`L ${n} 0 `,h+=`L ${i} ${this.hs} `):(h+=`L ${i} 0 `,h+=`L ${n} ${this.hs} `),h+="z",this.js.setAttribute("d",h)}}class on{constructor(t,e=!1){this.u=t,this.Ze=120,this.hs=26,this.ti=O.path({fill:_.uiWidgetBackground,"pointer-events":"none"}),this.ei=O.path({fill:"currentColor","pointer-events":"none"}),this.Gs=O.path({fill:"none",stroke:"currentColor","stroke-width":1,"stroke-dasharray":"3, 2","pointer-events":"none"}),this.si=O.circle({fill:"white",stroke:"none","pointer-events":"none",r:4}),this.ce=O.svg({style:`background-color: ${_.editorBackground}; touch-action: none;`,width:"100%",height:"100%",viewBox:"0 0 "+this.Ze+" "+this.hs,preserveAspectRatio:"none"},this.ti,this.Gs,this.si,this.ei),this.ii=N.div({style:"position: absolute; bottom: 0; left: 2px; font-size: 8px; line-height: 1; pointer-events: none;"}),this.container=N.div({class:"filterEditor",style:"height: 100%; position: relative;"},this.ce,this.ii),this.ni=2,this.hi=!1,this.oi=!1,this.fe=0,this.me=0,this.be=!1,this.ye=!1,this.we=!1,this.ri=!1,this.ai=!1,this.li=2,this.ci=0,this.ui=0,this.pi=0,this.Ne=null,this.di=-1,this.fi=-1,this.mi=-1,this.yi=-1,this.bi=-1,this.es=t=>{this.be=!0},this.ss=t=>{this.be=!1,this.wi()},this.ns=t=>{t.preventDefault(),this.oi=!1;const e=this.ce.getBoundingClientRect();this.fe=((t.clientX||t.pageX)-e.left)*this.Ze/(e.right-e.left),this.me=((t.clientY||t.pageY)-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.Xe()},this.os=t=>{t.preventDefault(),this.oi=!0;const e=this.ce.getBoundingClientRect();this.fe=(t.touches[0].clientX-e.left)*this.Ze/(e.right-e.left),this.me=(t.touches[0].clientY-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.Xe()},this.rs=t=>{if(null==this.container.offsetParent)return;const e=this.ce.getBoundingClientRect();this.fe=((t.clientX||t.pageX)-e.left)*this.Ze/(e.right-e.left),this.me=((t.clientY||t.pageY)-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.ye||this.gi(),this.ls()},this.cs=t=>{if(null==this.container.offsetParent)return;this.ye&&t.preventDefault();const e=this.ce.getBoundingClientRect();this.fe=(t.touches[0].clientX-e.left)*this.Ze/(e.right-e.left),this.me=(t.touches[0].clientY-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.ye||this.gi(),this.ls()},this.us=t=>{if(null!=this.container.offsetParent){if(this.ye&&this.u.lastChangeWas(this.Ne)&&null!=this.Ne){if(this.ri||this.we||this.oi)this.u.record(this.Ne);else if(this.ci<this.Et.controlPointCount&&-1!=this.ci){const t=this.Et.controlPoints[this.ci];this.u.record(new Hs(this.u,this.Et,t,this.ci,this.hi,!0))}this.wi()}this.Ne=null,this.we=!1,this.ai=!1,this.ye=!1,this.gi()}},this.hi=e,this.container.addEventListener("mousedown",this.ns),this.container.addEventListener("mouseover",this.es),this.container.addEventListener("mouseout",this.ss),document.addEventListener("mousemove",this.rs),document.addEventListener("mouseup",this.us),this.container.addEventListener("touchstart",this.os),this.container.addEventListener("touchmove",this.cs),this.container.addEventListener("touchend",this.us),this.container.addEventListener("touchcancel",this.us)}vi(t){return e.filterFreqRange*t/this.Ze-.5}xi(t){return this.Ze*(t+.5)/e.filterFreqRange}ki(t){return(e.filterGainRange-1)*(1-(t-.5)/(this.hs-1))}Mi(t){return(this.hs-1)*(1-t/(e.filterGainRange-1))+.5}Xe(){this.ye=!0;const t=new rs;this.Ne=t,this.u.setProspectiveChange(this.Ne),this.gi(),this.ls()}gi(){this.ui=this.vi(this.fe),this.pi=this.ki(this.me),this.ri=!0,this.ci=-1;let t=Number.POSITIVE_INFINITY;for(let s=0;s<this.Et.controlPointCount;s++){const i=this.Et.controlPoints[s],n=Math.sqrt(Math.pow(this.xi(i.freq)-this.fe,2)+Math.pow(this.Mi(i.gain)-this.me,2));(n<=13||this.Et.controlPointCount>=e.filterMaxPoints)&&n<t&&(t=n,this.ci=s,this.ri=!1)}if(this.ri){const t=this.fe/this.Ze;this.li=t<.2?1:t<.8?2:0}}ls(){if(null!=this.Ne&&this.u.lastChangeWas(this.Ne)?this.Ne.undo():this.ye=!1,this.Ne=null,this.ai=!1,this.ye){const t=new rs;if(this.Ne=t,this.u.setProspectiveChange(this.Ne),this.ri){const s=Math.max(0,Math.min(e.filterGainRange-1,Math.round(this.ki(this.me)))),i=this.Si(this.Et,this.vi(this.fe),-1);if(i>=0&&i<e.filterFreqRange){const e=new qe;e.type=this.li,e.freq=i,e.gain=s,t.append(new Hs(this.u,this.Et,e,this.Et.controlPointCount,this.hi))}else this.ai=!0}else if(this.ci>=this.Et.controlPointCount||-1==this.ci)this.Ne=null,this.ye=!1;else{const s=this.vi(this.fe)-this.ui,i=this.ki(this.me)-this.pi,n=this.Et.controlPoints[this.ci],h=Math.max(0,Math.min(e.filterGainRange-1,Math.round(n.gain+i))),o=this.Si(this.Et,n.freq+s,this.ci);0==Math.round(s)&&0==Math.round(i)&&o==n.freq&&h==n.gain||(this.we=!0),o>=0&&o<e.filterFreqRange?t.append(new Ks(this.u,n,n.freq,o,n.gain,h)):(t.append(new Hs(this.u,this.Et,n,this.ci,this.hi,!0)),this.ai=!0)}}(this.ye||this.be)&&this.wi()}Si(t,e,s){const i=Math.round(e);let n=i,h=i,o=i<=e;for(;;){let e=!1;const i=o?n:h;for(let n=0;n<t.controlPointCount;n++)if(n!=s&&t.controlPoints[n].freq==i){e=!0;break}if(!e)return i;o=!o,o&&n--,o||h++}}static Pi(t,e,s,i=!1){return`M ${t-s} ${e} a ${s} ${s} 0 1 ${i?1:0} ${2*s} 0 a ${s} ${s} 0 1 ${i?1:0} ${2*-s} 0 `}wi(){this.si.style.display="none",this.ii.textContent="";let t="",s="";for(let i=0;i<this.Et.controlPointCount;i++){const n=this.Et.controlPoints[i],h=this.xi(n.freq),o=this.Mi(n.gain);t+=on.Pi(h,o,this.ni),1==n.type?s+="M 0 "+o+" L "+h+" "+o+" ":0==n.type&&(s+="M "+this.Ze+" "+o+" L "+h+" "+o+" "),this.ci==i&&this.be&&!this.ye&&(this.si.setAttribute("cx",String(h)),this.si.setAttribute("cy",String(o)),this.si.style.display=""),(this.ci==i||this.ri&&this.ye&&i==this.Et.controlPointCount-1)&&(this.be||this.ye)&&!this.ai&&(this.ii.textContent=i+1+": "+e.filterTypeNames[n.type])}this.ei.setAttribute("d",t),this.Gs.setAttribute("d",s),this.ri&&!this.ye&&this.be&&(this.ii.textContent="+ "+e.filterTypeNames[this.li]);const i=[];for(let t=0;t<this.Et.controlPointCount;t++){const e=this.Et.controlPoints[t],s=new ke;e.toCoefficients(s,44800),i.push(s)}const n=new Me;let h="M 0 "+this.hs+" ";for(let t=-1;t<=e.filterFreqRange;t++){const s=qe.getHzFromSettingValue(t),o=2*Math.PI*s/44800,r=Math.cos(o),a=Math.sin(o);let l=1;for(const t of i)n.analyzeComplex(t,r,a),l*=n.magnitude();const c=Math.log2(l)/e.filterGainStep+e.filterGainCenter,u=this.Mi(c);h+="L "+k(this.xi(t))+" "+k(u)+" "}h+="L "+this.Ze+" "+this.hs+" L 0 "+this.hs+" z ",this.ti.setAttribute("d",h)}render(){const t=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()],s=this.hi?t.noteFilter:t.eqFilter;this.Et!=s&&(this.Ne=null,this.ye=!1),this.Et=s,this.ye||this.gi();let i=0,n=0,h=0;for(let t=0;t<s.controlPointCount;t++){const o=s.controlPoints[t];i=3*i+o.type,n=n*e.filterFreqRange+o.freq,h=h*e.filterGainRange+o.gain}this.di==this.ci&&this.fi==s.controlPointCount&&this.mi==i&&this.yi==n&&this.bi==h||(this.di=this.ci,this.fi=s.controlPointCount,this.mi=i,this.yi=n,this.bi=h,this.wi())}}class rn{constructor(t,e){this.Ii=document.createTextNode(""),this.ii=N.div({class:"channelBoxLabel"},this.Ii),this.container=N.div({class:"channelBox",style:`margin: 1px; height: ${an.patternHeight-2}px;`},this.ii),this.Fi=-1,this.container.style.background=_.uiWidgetBackground,this.ii.style.color=e}setWidth(t){this.container.style.width=t-2+"px"}setIndex(t,e,s){this.Fi!=t&&(this.Fi=t,this.Ii.data=String(t)),this.ii.style.color=e?_.invertedText:s,this.container.style.background=e?s:0==t?"none":_.uiWidgetBackground}}class an{constructor(t,e){this.u=t,this.index=e,this.Bi=-1,this.Li=[],this.container=N.div({class:"channelRow"})}render(){const t=this.u.getBarWidth();if(this.Li.length!=this.u.song.barCount){for(let e=this.Li.length;e<this.u.song.barCount;e++){const s=new rn(this.index,_.getChannelColor(this.u.song,this.index).secondaryChannel);s.setWidth(t),this.container.appendChild(s.container),this.Li[e]=s}for(let t=this.u.song.barCount;t<this.Li.length;t++)this.container.removeChild(this.Li[t].container);this.Li.length=this.u.song.barCount}if(this.Bi!=t){this.Bi=t;for(let e=0;e<this.Li.length;e++)this.Li[e].setWidth(t)}for(let t=0;t<this.Li.length;t++){const e=this.u.song.getPattern(this.index,t),s=t==this.u.bar&&this.index==this.u.channel,i=null==e||0==e.notes.length,n=this.Li[t];if(t<this.u.song.barCount){const e=_.getChannelColor(this.u.song,this.index);n.setIndex(this.u.song.channels[this.index].bars[t],s,i&&!s?e.secondaryChannel:e.primaryChannel),n.container.style.visibility="visible"}else n.container.style.visibility="hidden"}}}an.patternHeight=28;class ln{constructor(t){this.u=t,this.Ci=N.div({style:`background: ${_.editorBackground}; position: sticky; bottom: 0; left: 0; width: 32px; height: 30px;`}),this.container=N.div({class:"muteEditor"}),this.Di=[],this.Us=t=>{const e=this.Di.indexOf(t.target);-1!=e&&(this.u.song.channels[e].muted=!this.u.song.channels[e].muted,this.u.notifier.changed())},this.container.addEventListener("click",this.Us)}render(){if(this.u.prefs.enableChannelMuting){if(this.Di.length!=this.u.song.getChannelCount()){for(let t=this.Di.length;t<this.u.song.getChannelCount();t++){const e=N.button({class:"mute-button",title:"Mute (M), Mute All (⇧M), Solo (S), Exclude (⇧S)",style:`height: ${an.patternHeight-4}px; margin: 2px;`});this.container.appendChild(e),this.Di[t]=e}for(let t=this.u.song.getChannelCount();t<this.Di.length;t++)this.container.removeChild(this.Di[t]);this.Di.length=this.u.song.getChannelCount(),this.container.appendChild(this.Ci)}for(let t=0;t<this.u.song.getChannelCount();t++)this.u.song.channels[t].muted?this.Di[t].classList.add("muted"):this.Di[t].classList.remove("muted")}}}class cn{constructor(t){this.u=t,this.Ti=N.div({style:"display: flex; flex-direction: column; background:var(--editor-background); "}),this.Ei=O.rect({fill:_.playhead,x:0,y:0,width:4,height:128}),this.Ni=O.rect({fill:"none",stroke:_.hoverPreview,"stroke-width":2,"pointer-events":"none",x:1,y:1,width:30,height:30}),this.Oi=O.path({fill:_.invertedText,stroke:_.invertedText,"stroke-width":1,"pointer-events":"none"}),this.zi=O.path({fill:_.invertedText,stroke:_.invertedText,"stroke-width":1,"pointer-events":"none"}),this.ae=O.rect({fill:_.boxSelectionFill,stroke:_.hoverPreview,"stroke-width":2,"stroke-dasharray":"5, 3","pointer-events":"none",visibility:"hidden",x:1,y:1,width:62,height:62}),this.ce=O.svg({style:"position: absolute; top: 0;"},this.ae,this.Ni,this.Oi,this.zi,this.Ei),this.Ri=N.select({class:"trackSelectBox",style:"background: none; border: none; appearance: none; border-radius: initial; box-shadow: none; color: transparent; position: absolute; touch-action: none;"}),this.container=N.div({class:"noSelection",style:"position: relative; overflow: hidden;"},this.Ti,this.ce,this.Ri),this.Ai=[],this.fe=0,this.me=0,this.$i=0,this.Ui=0,this.qi=0,this._i=0,this.be=!1,this.Vi=!1,this.we=!1,this.ji=32,this.Gi=-1,this.Wi=-1,this.Hi=0,this.Ki=-1,this.oi=x,this.Yi=()=>{this.u.selection.setPattern(this.Ri.selectedIndex)},this.Qe=t=>{const e=this.ji*this.u.synth.playhead-2;this.Ki!=e&&(this.Ki=e,this.Ei.setAttribute("x",""+e)),window.requestAnimationFrame(this.Qe)},this.Ji=t=>{this.Vi=!0,this.we=!0,this.Qi(t),this.$i=this.qi,this.Ui=this._i},this.Xi=t=>{this.Qi(t),this.$i==this.qi&&this.Ui==this._i||t.preventDefault(),this.Vi&&this.Zi(),this.ys()},this.tn=t=>{this.Vi=!1,this.we=!1,this.ys()},this.es=t=>{this.be||(this.be=!0)},this.ss=t=>{this.be&&(this.be=!1)},this.ns=t=>{t.preventDefault(),this.Vi=!0,this.en(t),this.$i=this.qi,this.Ui=this._i,t.shiftKey?(this.we=!0,this.u.selection.setTrackSelection(this.u.selection.boxSelectionX0,this.qi,this.u.selection.boxSelectionY0,this._i),this.u.selection.selectionUpdated()):(this.we=!1,this.u.channel==this._i&&this.u.bar==this.qi||(this.u.selection.setChannelBar(this._i,this.qi),this.we=!0),this.u.selection.resetBoxSelection())},this.rs=t=>{this.en(t),this.Vi&&(this.$i==this.qi&&this.Ui==this._i||(this.we=!0),this.Zi()),this.ys()},this.sn=t=>{if(this.Vi&&!this.we&&this.u.channel==this._i&&this.u.bar==this.qi){const t=this.me%an.patternHeight<an.patternHeight/2,e=this.u.song.patternsPerChannel;this.u.selection.setPattern((this.u.song.channels[this._i].bars[this.qi]+(t?1:e))%(e+1))}this.Vi=!1,this.we=!1,this.ys()},window.requestAnimationFrame(this.Qe),this.ce.addEventListener("mousedown",this.ns),document.addEventListener("mousemove",this.rs),document.addEventListener("mouseup",this.sn),this.ce.addEventListener("mouseover",this.es),this.ce.addEventListener("mouseout",this.ss),this.Ri.addEventListener("change",this.Yi),this.Ri.addEventListener("touchstart",this.Ji),this.Ri.addEventListener("touchmove",this.Xi),this.Ri.addEventListener("touchend",this.tn),this.Ri.addEventListener("touchcancel",this.tn);let e=!1;document.addEventListener("mousedown",(()=>{e||(this.oi=!1,this.ys()),e=!0}),!0),document.addEventListener("touchstart",(()=>{e||(this.oi=!0,this.ys()),e=!0}),!0)}movePlayheadToMouse(){return!!this.be&&(this.u.synth.playhead=this.qi+this.fe%this.ji/this.ji,!0)}Zi(){this.u.selection.setTrackSelection(this.u.selection.boxSelectionX0,this.qi,this.u.selection.boxSelectionY0,this._i),this.u.selection.selectionUpdated()}Qi(t){const e=this.ce.getBoundingClientRect();this.fe=t.touches[0].clientX-e.left,this.me=t.touches[0].clientY-e.top,isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.qi=Math.floor(Math.min(this.u.song.barCount-1,Math.max(0,this.fe/this.ji))),this._i=Math.floor(Math.min(this.u.song.getChannelCount()-1,Math.max(0,this.me/an.patternHeight)))}en(t){const e=this.ce.getBoundingClientRect();this.fe=(t.clientX||t.pageX)-e.left,this.me=(t.clientY||t.pageY)-e.top,this.qi=Math.floor(Math.min(this.u.song.barCount-1,Math.max(0,this.fe/this.ji))),this._i=Math.floor(Math.min(this.u.song.getChannelCount()-1,Math.max(0,this.me/an.patternHeight)))}ys(){let t=this._i,e=this.qi;this.oi&&(e=this.u.bar,t=this.u.channel);const s=e==this.u.bar&&t==this.u.channel;if(!this.be||this.Vi||s?this.Ni.style.visibility="hidden":(this.Ni.setAttribute("x",""+(1+this.ji*e)),this.Ni.setAttribute("y",""+(1+an.patternHeight*t)),this.Ni.setAttribute("height",""+(an.patternHeight-2)),this.Ni.setAttribute("width",""+(this.ji-2)),this.Ni.style.visibility="visible"),(this.be||this.oi)&&s){const s=this.me%an.patternHeight<an.patternHeight/2,i=this.ji*(e+.8),n=an.patternHeight*(t+.5),h=.1*an.patternHeight,o=.4*an.patternHeight,r=.175*an.patternHeight;this.Oi.setAttribute("fill",s&&!this.oi?_.hoverPreview:_.invertedText),this.zi.setAttribute("fill",s||this.oi?_.invertedText:_.hoverPreview),this.Oi.setAttribute("d",`M ${i} ${n-o} L ${i+r} ${n-h} L ${i-r} ${n-h} z`),this.zi.setAttribute("d",`M ${i} ${n+o} L ${i+r} ${n+h} L ${i-r} ${n+h} z`),this.Oi.style.visibility="visible",this.zi.style.visibility="visible"}else this.Oi.style.visibility="hidden",this.zi.style.visibility="hidden";this.Ri.style.left=this.ji*this.u.bar+"px",this.Ri.style.width=this.ji+"px",this.Ri.style.top=an.patternHeight*this.u.channel+"px",this.Ri.style.height=an.patternHeight+"px";const i=this.u.song.patternsPerChannel+1;for(let t=this.Hi;t<i;t++)this.Ri.appendChild(N.option({value:t},t));for(let t=i;t<this.Hi;t++)this.Ri.removeChild(this.Ri.lastChild);this.Hi=i;const n=this.u.song.channels[this.u.channel].bars[this.u.bar];this.Ri.selectedIndex!=n&&(this.Ri.selectedIndex=n)}render(){if(this.ji=this.u.getBarWidth(),this.Ai.length!=this.u.song.getChannelCount()){for(let t=this.Ai.length;t<this.u.song.getChannelCount();t++){const e=new an(this.u,t);this.Ai[t]=e,this.Ti.appendChild(e.container)}for(let t=this.u.song.getChannelCount();t<this.Ai.length;t++)this.Ti.removeChild(this.Ai[t].container);this.Ai.length=this.u.song.getChannelCount(),this.Vi=!1}for(let t=0;t<this.u.song.getChannelCount();t++)this.Ai[t].render();const t=this.ji*this.u.song.barCount;this.Gi!=t&&(this.Gi=t,this.Ti.style.width=t+"px",this.container.style.width=t+"px",this.ce.setAttribute("width",t+""),this.Vi=!1);const e=this.u.song.getChannelCount()*an.patternHeight;this.Wi!=e&&(this.Wi=e,this.ce.setAttribute("height",""+e),this.Ei.setAttribute("height",""+e),this.container.style.height=e+"px"),this.Ri.style.display=this.oi?"":"none",this.u.selection.boxSelectionActive?(this.ae.setAttribute("x",String(this.ji*this.u.selection.boxSelectionBar+1)),this.ae.setAttribute("y",String(an.patternHeight*this.u.selection.boxSelectionChannel+1)),this.ae.setAttribute("width",String(this.ji*this.u.selection.boxSelectionWidth-2)),this.ae.setAttribute("height",String(an.patternHeight*this.u.selection.boxSelectionHeight-2)),this.ae.setAttribute("visibility","visible")):this.ae.setAttribute("visibility","hidden"),this.ys()}}const{button:un,label:pn,div:dn,form:fn,h2:mn,input:yn}=N;class bn{constructor(t){this.u=t,this.nn=yn({type:"file",accept:".json,application/json,.mid,.midi,audio/midi,audio/x-midi"}),this.v=un({class:"okayButton",style:"width:45%;"},"Okay"),this.g=un({class:"cancelButton"}),this.hn=fn({style:"display: flex; gap: 10px;"},pn({class:"layout-option"},yn({type:"radio",name:"layout",value:"small"}),O('\t\t\t\t\t<svg viewBox="-4 -1 28 22">\n\t\t\t\t\t\t<rect x="0" y="0" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1"/>\n\t\t\t\t\t\t<rect x="2" y="2" width="11" height="10" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="14" y="2" width="4" height="16" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="2" y="13" width="11" height="5" fill="currentColor"/>\n\t\t\t\t\t</svg>\n\t\t\t\t'),dn("Small")),pn({class:"layout-option"},yn({type:"radio",name:"layout",value:"long"}),O('\t\t\t\t\t<svg viewBox="-1 -1 28 22">\n\t\t\t\t\t\t<rect x="0" y="0" width="26" height="20" fill="none" stroke="currentColor" stroke-width="1"/>\n\t\t\t\t\t\t<rect x="2" y="2" width="12" height="10" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="15" y="2" width="4" height="10" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="20" y="2" width="4" height="10" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="2" y="13" width="22" height="5" fill="currentColor"/>\n\t\t\t\t\t</svg>\n\t\t\t\t'),dn("Long")),pn({class:"layout-option"},yn({type:"radio",name:"layout",value:"tall"}),O('\t\t\t\t\t<svg viewBox="-1 -1 28 22">\n\t\t\t\t\t\t<rect x="0" y="0" width="26" height="20" fill="none" stroke="currentColor" stroke-width="1"/>\n\t\t\t\t\t\t<rect x="11" y="2" width="8" height="16" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="20" y="2" width="4" height="16" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="2" y="2" width="8" height="16" fill="currentColor"/>\n\t\t\t\t\t</svg>\n\t\t\t\t'),dn("Tall"))),this.container=dn({class:"prompt noSelection",style:"width: 300px;"},mn("Layout"),this.hn,dn({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.v),this.g),this.k=()=>{this.u.undo()},this.cleanUp=()=>{this.v.removeEventListener("click",this.rn),this.g.removeEventListener("click",this.k),this.container.removeEventListener("keydown",this.P)},this.P=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.rn()},this.rn=()=>{this.u.prefs.shitbox4layout=this.hn.elements.layout.value,this.u.prefs.save(),j.setLayout(this.u.prefs.shitbox4layout),this.k()},this.nn.select(),setTimeout((()=>this.nn.focus())),this.v.addEventListener("click",this.rn),this.g.addEventListener("click",this.k),this.container.addEventListener("keydown",this.P),this.hn.elements.layout.value=this.u.prefs.shitbox4layout}}class wn{constructor(t){this.u=t,this.hs=20,this.an=0,this.ln=1,this.cn=2,this.un=O.path({fill:"none",stroke:_.loopAccent,"stroke-width":4}),this.si=O.path({fill:_.hoverPreview,"pointer-events":"none"}),this.ce=O.svg({style:"touch-action: pan-y; position: absolute;",height:this.hs},this.un,this.si),this.container=N.div({class:"loopEditor"},this.ce),this.ji=32,this.pn=null,this.Re={startBar:-1,mode:-1},this.fe=0,this.dn=0,this.fn=0,this.mn=!1,this.yn=!1,this.ye=!1,this.be=!1,this.bn=-1,this.wn=-1,this.gn=0,this.Bi=-1,this.es=t=>{this.be||(this.be=!0,this.ys())},this.ss=t=>{this.be&&(this.be=!1,this.ys())},this.ns=t=>{t.preventDefault(),this.ye=!0;const e=this.ce.getBoundingClientRect();this.fe=(t.clientX||t.pageX)-e.left,this.fs(),this.ys(),this.rs(t)},this.os=t=>{this.ye=!0;const e=this.ce.getBoundingClientRect();this.fe=t.touches[0].clientX-e.left,this.fs(),this.ys(),this.dn=t.touches[0].clientX,this.fn=t.touches[0].clientY,this.yn=!1,this.mn=!1},this.rs=t=>{const e=this.ce.getBoundingClientRect();this.fe=(t.clientX||t.pageX)-e.left,this.ls()},this.cs=t=>{if(!this.ye)return;const e=this.ce.getBoundingClientRect();this.fe=t.touches[0].clientX-e.left,this.yn||this.mn||(Math.abs(t.touches[0].clientY-this.fn)>10?this.mn=!0:Math.abs(t.touches[0].clientX-this.dn)>10&&(this.yn=!0)),this.yn&&(this.ls(),t.preventDefault())},this.vn=t=>{t.preventDefault(),this.mn||(this.ls(),this.be=!1,this.us(t),this.ys()),this.ye=!1},this.us=t=>{null!=this.pn&&this.u.record(this.pn),this.pn=null,this.ye=!1,this.fs(),this.xn()},this.kn=()=>{this.xn()},this.fs(),this.xn(),this.u.notifier.watch(this.kn),this.container.addEventListener("mousedown",this.ns),document.addEventListener("mousemove",this.rs),document.addEventListener("mouseup",this.us),this.container.addEventListener("mouseover",this.es),this.container.addEventListener("mouseout",this.ss),this.container.addEventListener("touchstart",this.os),this.container.addEventListener("touchmove",this.cs),this.container.addEventListener("touchend",this.vn),this.container.addEventListener("touchcancel",this.vn)}fs(){const t=this.fe/this.ji;this.Re.startBar=t,t>this.u.song.loopStart-.25&&t<this.u.song.loopStart+this.u.song.loopLength+.25?t-this.u.song.loopStart<.5*this.u.song.loopLength?this.Re.mode=this.an:this.Re.mode=this.ln:this.Re.mode=this.cn}Mn(t){let e=Math.round(t-this.u.song.loopLength/2),s=e+this.u.song.loopLength;return e<0&&(s-=e,e=0),s>this.u.song.barCount&&(e-=s-this.u.song.barCount,s=this.u.song.barCount),{start:e,length:s-e}}ls(){if(this.ye){let t=this.u.song.loopStart,e=this.u.song.loopStart+this.u.song.loopLength;null!=this.pn&&this.u.lastChangeWas(this.pn)&&(t=this.pn.oldStart,e=t+this.pn.oldLength);const s=this.fe/this.ji;let i,n,h;if(this.Re.mode==this.an)i=t+Math.round(s-this.Re.startBar),n=e,i<0&&(i=0),i>=this.u.song.barCount&&(i=this.u.song.barCount),i==n?i=n-1:i>n&&(h=i,i=n,n=h),this.pn=new oi(this.u,t,e-t,i,n-i);else if(this.Re.mode==this.ln)i=t,n=e+Math.round(s-this.Re.startBar),n<0&&(n=0),n>=this.u.song.barCount&&(n=this.u.song.barCount),n==i?n=i+1:n<i&&(h=i,i=n,n=h),this.pn=new oi(this.u,t,e-t,i,n-i);else if(this.Re.mode==this.cn){const i=this.Mn(s);this.pn=new oi(this.u,t,e-t,i.start,i.length)}this.u.synth.jumpIntoLoop(),this.u.prefs.autoFollow&&new Bs(this.u,this.u.channel,Math.floor(this.u.synth.playhead),!0),this.u.setProspectiveChange(this.pn)}else this.fs(),this.ys()}ys(){const t=this.be&&!this.ye;if(this.si.style.visibility=t?"visible":"hidden",t){const t=this.hs/2;let e=this.u.song.loopStart*this.ji,s=(this.u.song.loopStart+this.u.song.loopLength)*this.ji;if(this.Re.mode==this.an)s=this.u.song.loopStart*this.ji+2*t;else if(this.Re.mode==this.ln)e=(this.u.song.loopStart+this.u.song.loopLength)*this.ji-2*t;else{const t=this.Mn(this.Re.startBar);e=t.start*this.ji,s=(t.start+t.length)*this.ji}this.si.setAttribute("d",`M ${e+t} 4 L ${s-t} 4 A ${t-4} ${t-4} 0 0 1 ${s-t} ${this.hs-4} L ${e+t} ${this.hs-4} A ${t-4} ${t-4} 0 0 1 ${e+t} 4 z`)}}xn(){this.ji=this.u.getBarWidth();const t=this.hs/2,e=this.u.song.loopStart*this.ji,s=(this.u.song.loopStart+this.u.song.loopLength)*this.ji;if(this.gn!=this.u.song.barCount||this.Bi!=this.ji){this.gn=this.u.song.barCount,this.Bi=this.ji;const t=this.ji*this.u.song.barCount;this.container.style.width=t+"px",this.ce.setAttribute("width",t+"")}this.bn==e&&this.wn==s||(this.bn=e,this.wn=s,this.un.setAttribute("d",`M ${e+t} 2 L ${s-t} 2 A ${t-2} ${t-2} 0 0 1 ${s-t} ${this.hs-2} L ${e+t} ${this.hs-2} A ${t-2} ${t-2} 0 0 1 ${e+t} 2 z`)),this.ys()}}class gn{constructor(t,s){this.u=t,this.Sn=s,this.Ze=120,this.hs=26,this.Pn=O.path({fill:_.uiWidgetBackground,"pointer-events":"none"}),this.In=O.svg({"pointer-events":"none"}),this.Fn=O.svg({"pointer-events":"none"}),this.Bn=O.path({fill:"none",stroke:"currentColor","stroke-width":2,"pointer-events":"none"}),this.Ln=O.path({fill:"currentColor","pointer-events":"none"}),this.ce=O.svg({style:`background-color: ${_.editorBackground}; touch-action: none; cursor: crosshair;`,width:"100%",height:"100%",viewBox:"0 0 "+this.Ze+" "+this.hs,preserveAspectRatio:"none"},this.Pn,this.In,this.Fn,this.Bn,this.Ln),this.container=N.div({class:"spectrum",style:"height: 100%;"},this.ce),this.fe=0,this.me=0,this.Cn=0,this.Dn=0,this.ye=!1,this.pn=null,this.Tn="",this.je=!0,this.ns=t=>{t.preventDefault(),this.ye=!0;const e=this.ce.getBoundingClientRect();this.fe=((t.clientX||t.pageX)-e.left)*this.Ze/(e.right-e.left),this.me=((t.clientY||t.pageY)-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.Cn=this.vi(this.fe),this.Dn=this.En(this.me),this.ls()},this.os=t=>{t.preventDefault(),this.ye=!0;const e=this.ce.getBoundingClientRect();this.fe=(t.touches[0].clientX-e.left)*this.Ze/(e.right-e.left),this.me=(t.touches[0].clientY-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.Cn=this.vi(this.fe),this.Dn=this.En(this.me),this.ls()},this.rs=t=>{if(null==this.container.offsetParent)return;const e=this.ce.getBoundingClientRect();this.fe=((t.clientX||t.pageX)-e.left)*this.Ze/(e.right-e.left),this.me=((t.clientY||t.pageY)-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.ls()},this.cs=t=>{if(null==this.container.offsetParent)return;if(!this.ye)return;t.preventDefault();const e=this.ce.getBoundingClientRect();this.fe=(t.touches[0].clientX-e.left)*this.Ze/(e.right-e.left),this.me=(t.touches[0].clientY-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.ls()},this.us=t=>{this.ye&&(this.u.record(this.pn),this.pn=null),this.ye=!1};for(let t=0;t<e.spectrumControlPoints;t+=e.spectrumControlPointsPerOctave)this.In.appendChild(O.rect({fill:_.tonic,x:(t+1)*this.Ze/(e.spectrumControlPoints+2)-1,y:0,width:2,height:this.hs}));for(let t=4;t<=e.spectrumControlPoints;t+=e.spectrumControlPointsPerOctave)this.Fn.appendChild(O.rect({fill:_.fifthNote,x:(t+1)*this.Ze/(e.spectrumControlPoints+2)-1,y:0,width:2,height:this.hs}));this.container.addEventListener("mousedown",this.ns),document.addEventListener("mousemove",this.rs),document.addEventListener("mouseup",this.us),this.container.addEventListener("touchstart",this.os),this.container.addEventListener("touchmove",this.cs),this.container.addEventListener("touchend",this.us),this.container.addEventListener("touchcancel",this.us)}vi(t){return(e.spectrumControlPoints+2)*t/this.Ze-1}En(t){return e.spectrumMax*(1-(t-1)/(this.hs-2))}ls(){if(this.ye){const t=this.vi(this.fe),s=this.En(this.me),i=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()],n=null==this.Sn?i.spectrumWave:i.drumsetSpectrumWaves[this.Sn];if(t!=this.Cn){const i=(s-this.Dn)/(t-this.Cn),h=this.Dn-this.Cn*i,o=Math.ceil(Math.min(this.Cn,t)),r=Math.floor(Math.max(this.Cn,t));for(let t=o;t<=r;t++)t<0||t>=e.spectrumControlPoints||(n.spectrum[t]=Math.max(0,Math.min(e.spectrumMax,Math.round(t*i+h))))}n.spectrum[Math.max(0,Math.min(e.spectrumControlPoints-1,Math.round(t)))]=Math.max(0,Math.min(e.spectrumMax,Math.round(s))),this.Cn=t,this.Dn=s,this.pn=new Ts(this.u,i,n),this.u.setProspectiveChange(this.pn)}}render(){const t=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()],s=null==this.Sn?t.spectrumWave:t.drumsetSpectrumWaves[this.Sn],i=t=>(1-t/e.spectrumMax)*(this.hs-1)+1;let n=0,h="M 0 "+k(this.hs)+" ";for(let t=0;t<e.spectrumControlPoints;t++){let o=s.spectrum[t];h+=0!=n||0!=o?"L ":"M ",h+=k((t+1)*this.Ze/(e.spectrumControlPoints+2))+" "+k(i(o))+" ",n=o}const o=i(n);n>0&&(h+="L "+(this.Ze-1)+" "+k(o)+" "),this.Tn!=h&&(this.Tn=h,this.Bn.setAttribute("d",h),this.Pn.setAttribute("d",h+"L "+this.Ze+" "+k(o)+" L "+this.Ze+" "+k(this.hs)+" L 0 "+k(this.hs)+" z "),this.Ln.setAttribute("d","M "+this.Ze+" "+k(o)+" L "+(this.Ze-4)+" "+k(o-4)+" L "+(this.Ze-4)+" "+k(o+4)+" z"),this.Ln.style.display=n>0?"":"none"),this.je!=this.u.prefs.showFifth&&(this.je=this.u.prefs.showFifth,this.Fn.style.display=this.u.prefs.showFifth?"":"none")}}class vn{constructor(t){this.u=t,this.Ze=120,this.hs=26,this.In=O.svg({"pointer-events":"none"}),this.Fn=O.svg({"pointer-events":"none"}),this.Bn=O.path({fill:"none",stroke:"currentColor","stroke-width":2,"pointer-events":"none"}),this.Nn=[],this.On=O.svg({"pointer-events":"none"}),this.ce=O.svg({style:`background-color: ${_.editorBackground}; touch-action: none; cursor: crosshair;`,width:"100%",height:"100%",viewBox:"0 0 "+this.Ze+" "+this.hs,preserveAspectRatio:"none"},this.In,this.Fn,this.Bn,this.On),this.container=N.div({class:"harmonics",style:"height: 100%;"},this.ce),this.fe=0,this.me=0,this.Cn=0,this.Dn=0,this.ye=!1,this.pn=null,this.Tn="",this.je=!0,this.ns=t=>{t.preventDefault(),this.ye=!0;const e=this.ce.getBoundingClientRect();this.fe=((t.clientX||t.pageX)-e.left)*this.Ze/(e.right-e.left),this.me=((t.clientY||t.pageY)-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.Cn=this.vi(this.fe),this.Dn=this.En(this.me),this.ls()},this.os=t=>{t.preventDefault(),this.ye=!0;const e=this.ce.getBoundingClientRect();this.fe=(t.touches[0].clientX-e.left)*this.Ze/(e.right-e.left),this.me=(t.touches[0].clientY-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.Cn=this.vi(this.fe),this.Dn=this.En(this.me),this.ls()},this.rs=t=>{if(null==this.container.offsetParent)return;const e=this.ce.getBoundingClientRect();this.fe=((t.clientX||t.pageX)-e.left)*this.Ze/(e.right-e.left),this.me=((t.clientY||t.pageY)-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.ls()},this.cs=t=>{if(null==this.container.offsetParent)return;if(!this.ye)return;t.preventDefault();const e=this.ce.getBoundingClientRect();this.fe=(t.touches[0].clientX-e.left)*this.Ze/(e.right-e.left),this.me=(t.touches[0].clientY-e.top)*this.hs/(e.bottom-e.top),isNaN(this.fe)&&(this.fe=0),isNaN(this.me)&&(this.me=0),this.ls()},this.us=t=>{this.ye&&(this.u.record(this.pn),this.pn=null),this.ye=!1};for(let t=1;t<=e.harmonicsControlPoints;t*=2)this.In.appendChild(O.rect({fill:_.tonic,x:(t-.5)*(this.Ze-8)/(e.harmonicsControlPoints-1)-1,y:0,width:2,height:this.hs}));for(let t=3;t<=e.harmonicsControlPoints;t*=2)this.Fn.appendChild(O.rect({fill:_.fifthNote,x:(t-.5)*(this.Ze-8)/(e.harmonicsControlPoints-1)-1,y:0,width:2,height:this.hs}));for(let t=0;t<4;t++){const e=O.rect({fill:"currentColor",x:this.Ze-2*t-1,y:0,width:1,height:this.hs});this.Nn.push(e),this.On.appendChild(e)}this.container.addEventListener("mousedown",this.ns),document.addEventListener("mousemove",this.rs),document.addEventListener("mouseup",this.us),this.container.addEventListener("touchstart",this.os),this.container.addEventListener("touchmove",this.cs),this.container.addEventListener("touchend",this.us),this.container.addEventListener("touchcancel",this.us)}vi(t){return(e.harmonicsControlPoints-1)*t/(this.Ze-8)-.5}En(t){return e.harmonicsMax*(1-t/this.hs)}ls(){if(this.ye){const t=this.vi(this.fe),s=this.En(this.me),i=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()],n=i.harmonicsWave;if(t!=this.Cn){const i=(s-this.Dn)/(t-this.Cn),h=this.Dn-this.Cn*i,o=Math.ceil(Math.min(this.Cn,t)),r=Math.floor(Math.max(this.Cn,t));for(let t=o;t<=r;t++)t<0||t>=e.harmonicsControlPoints||(n.harmonics[t]=Math.max(0,Math.min(e.harmonicsMax,Math.round(t*i+h))))}n.harmonics[Math.max(0,Math.min(e.harmonicsControlPoints-1,Math.round(t)))]=Math.max(0,Math.min(e.harmonicsMax,Math.round(s))),this.Cn=t,this.Dn=s,this.pn=new Es(this.u,i,n),this.u.setProspectiveChange(this.pn)}}render(){const t=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()].harmonicsWave,s=t=>(1-t/e.harmonicsMax)*this.hs;let i=k(this.hs),n="";for(let h=0;h<e.harmonicsControlPoints-1;h++){if(0==t.harmonics[h])continue;let o=k((h+.5)*(this.Ze-8)/(e.harmonicsControlPoints-1));n+="M "+o+" "+i+" ",n+="L "+o+" "+k(s(t.harmonics[h]))+" "}const h=s(t.harmonics[e.harmonicsControlPoints-1]);for(let t=0;t<4;t++){const e=this.Nn[t];e.setAttribute("y",k(h)),e.setAttribute("height",k(this.hs-h))}this.Tn!=n&&(this.Tn=n,this.Bn.setAttribute("d",n)),this.je!=this.u.prefs.showFifth&&(this.je=this.u.prefs.showFifth,this.Fn.style.display=this.u.prefs.showFifth?"":"none")}}class xn{constructor(t){this.u=t,this.Ze=512,this.hs=20,this.zn=O.svg({"pointer-events":"none"}),this.Rn=O.rect({fill:_.uiWidgetBackground,x:0,y:2,width:10,height:this.hs-4}),this.An=O.rect({fill:"none",stroke:_.hoverPreview,"stroke-width":2,"pointer-events":"none",x:0,y:1,width:10,height:this.hs-2}),this.$n=O.path({fill:_.hoverPreview,"pointer-events":"none"}),this.Un=O.path({fill:_.hoverPreview,"pointer-events":"none"}),this.ce=O.svg({style:`background-color: ${_.editorBackground}; touch-action: pan-y; position: absolute;`,width:this.Ze,height:this.hs},this.zn,this.Rn,this.An,this.$n,this.Un),this.container=N.div({class:"barScrollBar",style:"width: 512px; height: 20px; overflow: hidden; position: relative;"},this.ce),this.fe=0,this.ye=!1,this.be=!1,this.qn=!1,this._n=-1,this.Vn=-1,this.es=t=>{this.be||(this.be=!0,this.ys())},this.ss=t=>{this.be&&(this.be=!1,this.ys())},this.ns=t=>{t.preventDefault(),this.ye=!0;const e=this.ce.getBoundingClientRect();this.fe=(t.clientX||t.pageX)-e.left,this.ys(),this.fe>=this.u.barScrollPos*this.jn&&this.fe<=(this.u.barScrollPos+this.u.trackVisibleBars)*this.jn&&(this.qn=!0,this.Gn=this.fe)},this.os=t=>{t.preventDefault(),this.ye=!0;const e=this.ce.getBoundingClientRect();this.fe=t.touches[0].clientX-e.left,this.ys(),this.fe>=this.u.barScrollPos*this.jn&&this.fe<=(this.u.barScrollPos+this.u.trackVisibleBars)*this.jn&&(this.qn=!0,this.Gn=this.fe)},this.rs=t=>{const e=this.ce.getBoundingClientRect();this.fe=(t.clientX||t.pageX)-e.left,this.ls()},this.cs=t=>{if(!this.ye)return;t.preventDefault();const e=this.ce.getBoundingClientRect();this.fe=t.touches[0].clientX-e.left,this.ls()},this.us=t=>{!this.qn&&this.ye&&(this.fe<(this.u.barScrollPos+8)*this.jn?(this.u.barScrollPos>0&&this.u.barScrollPos--,this.u.notifier.changed()):(this.u.barScrollPos<this.u.song.barCount-this.u.trackVisibleBars&&this.u.barScrollPos++,this.u.notifier.changed())),this.ye=!1,this.qn=!1,this.ys()};const e=.5*this.hs;this.$n.setAttribute("d",`M 9 ${e} L 20 ${e+6} L 20 ${e-6} z`),this.Un.setAttribute("d",`M ${this.Ze-9} ${e} L ${this.Ze-20} ${e+6} L ${this.Ze-20} ${e-6} z`),this.container.addEventListener("mousedown",this.ns),document.addEventListener("mousemove",this.rs),document.addEventListener("mouseup",this.us),this.container.addEventListener("mouseover",this.es),this.container.addEventListener("mouseout",this.ss),this.container.addEventListener("touchstart",this.os),this.container.addEventListener("touchmove",this.cs),this.container.addEventListener("touchend",this.us),this.container.addEventListener("touchcancel",this.us)}ls(){if(this.qn){for(;this.fe-this.Gn<.5*-this.jn&&this.u.barScrollPos>0;)this.u.barScrollPos--,this.Gn-=this.jn,this.u.notifier.changed();for(;this.fe-this.Gn>.5*this.jn&&this.u.barScrollPos<this.u.song.barCount-this.u.trackVisibleBars;)this.u.barScrollPos++,this.Gn+=this.jn,this.u.notifier.changed()}this.be&&this.ys()}ys(){let t=!1,e=!1,s=!1;this.be&&!this.ye&&(this.fe<this.u.barScrollPos*this.jn?t=!0:this.fe>(this.u.barScrollPos+this.u.trackVisibleBars)*this.jn?e=!0:s=!0),this.$n.style.visibility=t?"visible":"hidden",this.Un.style.visibility=e?"visible":"hidden",this.An.style.visibility=s?"visible":"hidden"}render(){this.jn=(this.Ze-1)/Math.max(this.u.trackVisibleBars,this.u.song.barCount);const t=this._n!=this.u.song.barCount;if(t){for(this._n=this.u.song.barCount;this.zn.firstChild;)this.zn.removeChild(this.zn.firstChild);for(let t=0;t<=this.u.song.barCount;t++){const e=t%16==0?0:t%4==0?this.hs/8:this.hs/3;this.zn.appendChild(O.rect({fill:_.uiWidgetBackground,x:t*this.jn-1,y:e,width:2,height:this.hs-2*e}))}}(t||this.Vn!=this.u.barScrollPos)&&(this.Vn=this.u.barScrollPos,this.Rn.setAttribute("x",String(this.jn*this.u.barScrollPos)),this.Rn.setAttribute("width",String(this.jn*this.u.trackVisibleBars)),this.An.setAttribute("x",String(this.jn*this.u.barScrollPos)),this.An.setAttribute("width",String(this.jn*this.u.trackVisibleBars))),this.ys()}}class kn{constructor(t){this.u=t,this.Ze=20,this.hs=481,this.Wn=4,this.Hn=e.pitchOctaves,this.Kn=(this.hs-this.Wn)/this.Hn,this.Rn=O.rect({fill:_.uiWidgetBackground,x:2,y:0,width:this.Ze-4}),this.An=O.rect({fill:"none",stroke:_.hoverPreview,"stroke-width":2,"pointer-events":"none",x:1,y:0,width:this.Ze-2}),this.Oi=O.path({fill:_.hoverPreview,"pointer-events":"none"}),this.zi=O.path({fill:_.hoverPreview,"pointer-events":"none"}),this.ce=O.svg({style:`background-color: ${_.editorBackground}; touch-action: pan-x; position: absolute;`,width:this.Ze,height:"100%",viewBox:"0 0 20 481",preserveAspectRatio:"none"}),this.container=N.div({id:"octaveScrollBarContainer",style:"width: 20px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0;"},this.ce),this.me=0,this.ye=!1,this.be=!1,this.qn=!1,this.Yn=-1,this.Jn=-1,this.pn=null,this.es=t=>{this.be||(this.be=!0,this.ys())},this.ss=t=>{this.be&&(this.be=!1,this.ys())},this.ns=t=>{t.preventDefault(),this.ye=!0;const e=this.ce.getBoundingClientRect();this.me=((t.clientY||t.pageY)-e.top)*this.hs/(e.bottom-e.top),isNaN(this.me)&&(this.me=0),this.u.song.getChannelIsNoise(this.u.channel)||(this.ys(),this.me>=this.Qn-this.Xn&&this.me<=this.Qn&&(this.qn=!0,this.pn=null,this.Gn=this.me))},this.os=t=>{t.preventDefault(),this.ye=!0;const e=this.ce.getBoundingClientRect();this.me=(t.touches[0].clientY-e.top)*this.hs/(e.bottom-e.top),isNaN(this.me)&&(this.me=0),this.u.song.getChannelIsNoise(this.u.channel)||(this.ys(),this.me>=this.Qn-this.Xn&&this.me<=this.Qn&&(this.qn=!0,this.pn=null,this.Gn=this.me))},this.rs=t=>{const e=this.ce.getBoundingClientRect();this.me=((t.clientY||t.pageY)-e.top)*this.hs/(e.bottom-e.top),isNaN(this.me)&&(this.me=0),this.ls()},this.cs=t=>{if(!this.ye)return;t.preventDefault();const e=this.ce.getBoundingClientRect();this.me=(t.touches[0].clientY-e.top)*this.hs/(e.bottom-e.top),isNaN(this.me)&&(this.me=0),this.ls()},this.us=t=>{if(!this.u.song.getChannelIsNoise(this.u.channel)&&this.ye)if(this.qn)null!=this.pn&&this.u.record(this.pn);else{const t=this.u.getVisibleOctaveCount(),s=e.pitchOctaves-t,i=this.u.lastChangeWas(this.pn),n=i?this.pn.oldValue:this.u.song.channels[this.u.channel].octave,h=this.u.getBaseVisibleOctave(this.u.channel);this.me<this.Qn-.5*this.Xn?h<s&&(this.pn=new ai(this.u,n,Math.floor(h+1+.5*t)),this.u.record(this.pn,i)):h>0&&(this.pn=new ai(this.u,n,Math.floor(h-1+.5*t)),this.u.record(this.pn,i))}this.ye=!1,this.qn=!1,this.ys()},this.kn=()=>{this.Qn=this.hs-this.Kn*this.u.getBaseVisibleOctave(this.u.channel),this.ce.style.visibility=this.u.song.getChannelIsNoise(this.u.channel)?"hidden":"visible";const t=this.u.getVisibleOctaveCount();this.Yn==this.Qn&&this.Jn==t||(this.Yn=this.Qn,this.Jn=t,this.Xn=this.Kn*t+this.Wn,this.Rn.setAttribute("height",String(this.Xn)),this.An.setAttribute("height",String(this.Xn)),this.Rn.setAttribute("y",String(this.Qn-this.Xn)),this.An.setAttribute("y",String(this.Qn-this.Xn))),this.ys()},this.u.notifier.watch(this.kn),this.kn(),this.ce.appendChild(this.Rn);for(let t=0;t<=this.Hn;t++)this.ce.appendChild(O.rect({fill:_.tonic,x:0,y:t*this.Kn,width:this.Ze,height:this.Wn}));this.ce.appendChild(this.An),this.ce.appendChild(this.Oi),this.ce.appendChild(this.zi);const s=.5*this.Ze;this.Oi.setAttribute("d",`M ${s} 9 L ${s+6} 20 L ${s-6} 20 z`),this.zi.setAttribute("d",`M ${s} ${this.hs-9} L ${s+6} ${this.hs-20} L ${s-6} ${this.hs-20} z`),this.container.addEventListener("mousedown",this.ns),document.addEventListener("mousemove",this.rs),document.addEventListener("mouseup",this.us),this.container.addEventListener("mouseover",this.es),this.container.addEventListener("mouseout",this.ss),this.container.addEventListener("touchstart",this.os),this.container.addEventListener("touchmove",this.cs),this.container.addEventListener("touchend",this.us),this.container.addEventListener("touchcancel",this.us)}ls(){if(!this.u.song.getChannelIsNoise(this.u.channel)){if(this.qn){const t=this.u.getVisibleOctaveCount(),s=e.pitchOctaves-t,i=this.u.lastChangeWas(this.pn)?this.pn.oldValue:this.u.song.channels[this.u.channel].octave;let n=this.u.getBaseVisibleOctave(this.u.channel);for(;this.me-this.Gn<.5*-this.Kn&&n<s;)n++,this.Gn-=this.Kn;for(;this.me-this.Gn>.5*this.Kn&&n>0;)n--,this.Gn+=this.Kn;this.pn=new ai(this.u,i,Math.floor(n+.5*t)),this.u.setProspectiveChange(this.pn)}this.be&&this.ys()}}ys(){let t=!1,e=!1,s=!1;this.be&&!this.ye&&(this.me<this.Qn-this.Xn?t=!0:this.me>this.Qn?e=!0:s=!0),this.Oi.style.visibility=t?"inherit":"hidden",this.zi.style.visibility=e?"inherit":"hidden",this.An.style.visibility=s?"inherit":"hidden"}}const Mn=8192,Sn={35:{frequency:0,duration:2,volume:3},36:{frequency:0,duration:2,volume:3},37:{frequency:5,duration:1,volume:3},38:{frequency:4,duration:2,volume:3},39:{frequency:5,duration:2,volume:3},40:{frequency:4,duration:2,volume:3},41:{frequency:1,duration:2,volume:3},42:{frequency:8,duration:1,volume:3},43:{frequency:1,duration:2,volume:3},44:{frequency:8,duration:1,volume:2},45:{frequency:2,duration:2,volume:3},46:{frequency:8,duration:4,volume:3},47:{frequency:2,duration:2,volume:3},48:{frequency:3,duration:2,volume:3},49:{frequency:7,duration:4,volume:3},50:{frequency:3,duration:2,volume:3},51:{frequency:6,duration:4,volume:2},52:{frequency:7,duration:4,volume:3},53:{frequency:6,duration:2,volume:3},54:{frequency:11,duration:2,volume:3},55:{frequency:9,duration:4,volume:3},56:{frequency:7,duration:1,volume:2},57:{frequency:7,duration:4,volume:3},58:{frequency:10,duration:2,volume:2},59:{frequency:6,duration:4,volume:3},69:{frequency:10,duration:2,volume:3},70:{frequency:10,duration:2,volume:3},73:{frequency:10,duration:1,volume:2},74:{frequency:10,duration:2,volume:2}};function Pn(t){return Math.pow(t/127,4)/.3844015376046128}var In=t&&t.Zn||function(t,e,s,i){return new(s||(s=Promise))((function(n,h){function o(t){try{a(i.next(t))}catch(t){h(t)}}function r(t){try{a(i.throw(t))}catch(t){h(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,r)}a((i=i.apply(t,e||[])).next())}))};const Fn=(4294967295*Math.random()>>>0).toString(16);class Bn{constructor(t){this.u=t,this.th=t=>{localStorage.setItem("midiHandlerId",Fn)},this.eh=t=>{if("input"===t.port.type)switch(t.port.state){case"connected":this.sh(t.port);break;case"disconnected":this.ih(t.port)}},this.sh=t=>{t.addEventListener("midimessage",this.nh)},this.ih=t=>{t.removeEventListener("midimessage",this.nh),this.u.performance.clearAllPitches()},this.nh=t=>{if(!this.u.prefs.enableMidi||localStorage.getItem("midiHandlerId")!=Fn)return;const s=this.u.song.getChannelIsNoise(this.u.channel);let[i,n,h]=t.data;if(i&=240,s){const t=Sn[n];if(null==t)return;n=t.frequency}else if(n-=e.keys[this.u.song.key].basePitch,n<0||n>e.maxPitch)return;switch(144==i&&0==h&&(i=128),i){case 144:this.u.synth.preferLowerLatency=!0,this.u.performance.addPerformedPitch(n);break;case 128:this.u.performance.removePerformedPitch(n)}},this.registerMidiAccessHandler()}registerMidiAccessHandler(){return In(this,void 0,void 0,(function*(){if(null!=navigator.requestMIDIAccess)try{const t=yield navigator.requestMIDIAccess();t.inputs.forEach(this.sh),t.addEventListener("statechange",this.eh),this.th(),window.addEventListener("focus",this.th)}catch(t){console.error("Failed to get MIDI access",t)}}))}}class Ln{static keyPosToPitch(t,s,i,n){let h=null,o=null;switch(n){case"wickiHayden":h=5*i+2*s-2;break;case"songScale":const n=e.scales[t.song.scale].flags.map(((t,e)=>t?e:null)).filter((t=>null!=t));h=(i-1+Math.floor(s/n.length))*e.pitchesPerOctave+n[(s+n.length)%n.length];break;case"pianoAtC":h=Ln.hh[i][s],o=e.keys.dictionary.C.basePitch;break;case"pianoAtA":h=Ln.oh[i][s],o=e.keys.dictionary.A.basePitch;break;case"pianoTransposingC":h=Ln.hh[i][s];break;case"pianoTransposingA":h=Ln.oh[i][s]}if(null==h)return null;const r=Math.max(0,t.song.channels[t.channel].octave-1)*e.pitchesPerOctave;let a=0;if(null!=o){a=(o-e.keys[t.song.key].basePitch+144)%12}const l=r+a+h;return l<0||l>e.maxPitch?null:l}constructor(t){this.u=t,this.rh=!1,this.ah=t=>{this.rh&&(this.u.performance.clearAllPitches(),this.rh=!1)},window.addEventListener("blur",this.ah)}handleKeyEvent(t,e){switch(t.code){case"Backquote":this.handleKey(-1,3,e);break;case"Digit1":this.handleKey(0,3,e);break;case"Digit2":this.handleKey(1,3,e);break;case"Digit3":this.handleKey(2,3,e);break;case"Digit4":this.handleKey(3,3,e);break;case"Digit5":this.handleKey(4,3,e);break;case"Digit6":this.handleKey(5,3,e);break;case"Digit7":this.handleKey(6,3,e);break;case"Digit8":this.handleKey(7,3,e);break;case"Digit9":this.handleKey(8,3,e);break;case"Digit0":this.handleKey(9,3,e);break;case"Minus":this.handleKey(10,3,e);break;case"Equal":this.handleKey(11,3,e);break;case"IntlYen":this.handleKey(12,3,e);break;case"KeyQ":this.handleKey(0,2,e);break;case"KeyW":this.handleKey(1,2,e);break;case"KeyE":this.handleKey(2,2,e);break;case"KeyR":this.handleKey(3,2,e);break;case"KeyT":this.handleKey(4,2,e);break;case"KeyY":this.handleKey(5,2,e);break;case"KeyU":this.handleKey(6,2,e);break;case"KeyI":this.handleKey(7,2,e);break;case"KeyO":this.handleKey(8,2,e);break;case"KeyP":this.handleKey(9,2,e);break;case"BracketLeft":this.handleKey(10,2,e);break;case"BracketRight":this.handleKey(11,2,e);break;case"Backslash":"\\"==t.key||"|"==t.key?this.handleKey(12,2,e):this.handleKey(11,1,e);break;case"KeyA":this.handleKey(0,1,e);break;case"KeyS":this.handleKey(1,1,e);break;case"KeyD":this.handleKey(2,1,e);break;case"KeyF":this.handleKey(3,1,e);break;case"KeyG":this.handleKey(4,1,e);break;case"KeyH":this.handleKey(5,1,e);break;case"KeyJ":this.handleKey(6,1,e);break;case"KeyK":this.handleKey(7,1,e);break;case"KeyL":this.handleKey(8,1,e);break;case"Semicolon":this.handleKey(9,1,e);break;case"Quote":this.handleKey(10,1,e);break;case"IntlHash":this.handleKey(11,1,e);break;case"IntlBackslash":this.handleKey(-1,0,e);break;case"KeyZ":this.handleKey(0,0,e);break;case"KeyX":this.handleKey(1,0,e);break;case"KeyC":this.handleKey(2,0,e);break;case"KeyV":this.handleKey(3,0,e);break;case"KeyB":this.handleKey(4,0,e);break;case"KeyN":this.handleKey(5,0,e);break;case"KeyM":this.handleKey(6,0,e);break;case"Comma":this.handleKey(7,0,e);break;case"Period":this.handleKey(8,0,e);break;case"Slash":this.handleKey(9,0,e);break;case"IntlRo":this.handleKey(10,0,e);break;default:return}t.preventDefault()}handleKey(t,s,i){if(this.u.song.getChannelIsNoise(this.u.channel))return void(t>=0&&t<e.drumCount&&(i?(this.u.synth.preferLowerLatency=!0,this.u.performance.addPerformedPitch(t),this.rh=!0):this.u.performance.removePerformedPitch(t)));const n=Ln.keyPosToPitch(this.u,t,s,this.u.prefs.keyboardLayout);null!=n&&(i?(this.u.synth.preferLowerLatency=!0,this.u.performance.addPerformedPitch(n),this.rh=!0):this.u.performance.removePerformedPitch(n))}}Ln.hh=[[0,2,4,5,7,9,11,12,14,16,17],[null,1,3,null,6,8,10,null,13,15,null,18],[12,14,16,17,19,21,23,24,26,28,29,31,33],[null,13,15,null,18,20,22,null,25,27,null,30,32]],Ln.oh=[[0,2,3,5,7,8,10,12,14,15,17],[-1,1,null,4,6,null,9,11,13,null,16,18],[12,14,15,17,19,20,22,24,26,27,29,31,32],[11,13,null,16,18,null,21,23,25,null,28,30,null]];class Cn{constructor(t){this.u=t,this.lh=N.div({style:"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;"}),this.uh=N.div({style:"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;"}),this.ph=N.div({style:`width: 100%; height: 40px; border: 2px solid ${_.primaryText}; position: absolute; box-sizing: border-box; pointer-events: none;`}),this.container=N.div({style:"width: 32px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0; touch-action: none;"},this.lh,this.uh,this.ph),this.hs=481,this.dh=[],this.fh=[],this.me=0,this.ye=!1,this.be=!1,this.mh=-1,this.yh=-1,this.Ge=!1,this.bh=-1,this.wh=-1,this.gh=[],this.es=t=>{this.be||(this.be=!0,this.ys())},this.ss=t=>{this.be&&(this.be=!1,this.ys())},this.ns=t=>{t.preventDefault(),this.u.synth.maintainLiveInput(),this.ye=!0;const e=this.container.getBoundingClientRect();this.me=((t.clientY||t.pageY)-e.top)*this.hs/(e.bottom-e.top),isNaN(this.me)&&(this.me=0),this.xh(),this.kh(),this.ys()},this.rs=t=>{(this.ye||this.be)&&this.u.synth.maintainLiveInput();const e=this.container.getBoundingClientRect();this.me=((t.clientY||t.pageY)-e.top)*this.hs/(e.bottom-e.top),isNaN(this.me)&&(this.me=0),this.xh(),this.ye&&this.kh(),this.ys()},this.sn=t=>{this.ye&&this.Mh(),this.ye=!1,this.ys()},this.os=t=>{t.preventDefault(),this.u.synth.maintainLiveInput(),this.ye=!0;const e=this.container.getBoundingClientRect();this.me=(t.touches[0].clientY-e.top)*this.hs/(e.bottom-e.top),isNaN(this.me)&&(this.me=0),this.xh(),this.kh()},this.cs=t=>{t.preventDefault(),this.u.synth.maintainLiveInput();const e=this.container.getBoundingClientRect();this.me=(t.touches[0].clientY-e.top)*this.hs/(e.bottom-e.top),isNaN(this.me)&&(this.me=0),this.xh(),this.ye&&this.kh()},this.vn=t=>{t.preventDefault(),this.ye=!1,this.Mh()},this.Sh=()=>{window.requestAnimationFrame(this.Sh);let t=!1;const e=this.u.performance.pitchesAreTemporary()?0:this.u.synth.liveInputPitches.length;this.gh.length!=e&&(t=!0);for(let s=0;s<e;s++)this.gh[s]!=this.u.synth.liveInputPitches[s]&&(this.gh[s]=this.u.synth.liveInputPitches[s],t=!0);this.gh.length=e,t&&this.ys()},this.kn=()=>{const t=this.u.song.getChannelIsNoise(this.u.channel);if(this.Fs=t?e.drumCount:this.u.getVisiblePitchCount(),this.de=this.hs/this.Fs,this.xh(),this.ye&&this.kh(),this.u.prefs.showLetters&&(this.yh!=this.u.song.scale||this.bh!=this.u.song.key||this.Ge!=t||this.wh!=this.Fs)){if(this.yh=this.u.song.scale,this.bh=this.u.song.key,this.Ge=t,this.lh.style.display=t?"none":"flex",this.uh.style.display=t?"flex":"none",!t){if(this.wh!=this.Fs){this.lh.innerHTML="";for(let t=0;t<this.Fs;t++){const e=N.div({class:"piano-label",style:"font-weight: bold; -webkit-text-stroke-width: 0; font-size: 11px; font-family: sans-serif; position: absolute; padding-left: 15px;"}),s=N.div({class:"piano-button",style:"background: gray;"},e);this.lh.appendChild(s),this.fh[t]=e,this.dh[t]=s}this.fh.length=this.Fs,this.dh.length=this.Fs,this.wh=this.Fs}for(let t=0;t<this.Fs;t++){const s=(t+e.keys[this.u.song.key].basePitch)%e.pitchesPerOctave,i=e.keys[s].isWhiteKey;if(this.dh[t].style.background=i?_.whitePianoKey:_.blackPianoKey,e.scales[this.u.song.scale].flags[t%e.pitchesPerOctave]){this.dh[t].classList.remove("disabled"),this.fh[t].style.display="";const i=this.fh[t];i.style.color=e.keys[s].isWhiteKey?"black":"white",i.textContent=Cn.getPitchName(s,t)}else this.dh[t].classList.add("disabled"),this.fh[t].style.display="none"}}this.ys()}};for(let t=0;t<e.drumCount;t++){const s=100*(1-t/e.drumCount*.35);this.uh.appendChild(N.div({class:"drum-button",style:`background-size: ${s}% ${s}%;`}))}this.container.addEventListener("mousedown",this.ns),document.addEventListener("mousemove",this.rs),document.addEventListener("mouseup",this.sn),this.container.addEventListener("mouseover",this.es),this.container.addEventListener("mouseout",this.ss),this.container.addEventListener("touchstart",this.os),this.container.addEventListener("touchmove",this.cs),this.container.addEventListener("touchend",this.vn),this.container.addEventListener("touchcancel",this.vn),this.u.notifier.watch(this.kn),this.kn(),window.requestAnimationFrame(this.Sh)}xh(){const t=e.scales[this.u.song.scale].flags,s=Math.max(0,Math.min(this.Fs-1,this.Fs-this.me/this.de));if(t[Math.floor(s)%e.pitchesPerOctave]||this.u.song.getChannelIsNoise(this.u.channel))this.Ph=Math.floor(s);else{let i=Math.floor(s)+1,n=Math.floor(s)-1;for(;!t[i%e.pitchesPerOctave];)i++;for(;!t[n%e.pitchesPerOctave];)n--;let h=i,o=n+1;i%e.pitchesPerOctave!=0&&i%e.pitchesPerOctave!=7||(h-=.5),n%e.pitchesPerOctave!=0&&n%e.pitchesPerOctave!=7||(o+=.5),this.Ph=s-o>h-s?i:n}}kh(){const t=this.u.getBaseVisibleOctave(this.u.channel)*e.pitchesPerOctave,s=this.Ph+t;this.mh!=s&&(this.u.performance.removePerformedPitch(this.mh),this.mh=s,this.u.performance.addPerformedPitch(s))}Mh(){this.u.performance.removePerformedPitch(this.mh),this.mh=-1}ys(){if(this.ph.style.visibility=!this.be||this.ye?"hidden":"visible",this.be&&!this.ye){const t=this.container.getBoundingClientRect(),e=this.de/(this.hs/(t.bottom-t.top));this.ph.style.left="0px",this.ph.style.top=e*(this.Fs-this.Ph-1)+"px",this.ph.style.height=e+"px"}const t=this.u.getBaseVisibleOctave(this.u.channel)*e.pitchesPerOctave,s=(this.u.song.getChannelIsNoise(this.u.channel)?this.uh:this.lh).children;for(let e=0;e<s.length;e++){const i=s[e];-1==this.gh.indexOf(e+t)?i.classList.remove("pressed"):i.classList.add("pressed")}}static getPitchName(t,s){let i;if(e.keys[t].isWhiteKey)i=e.keys[t].name;else{const n=e.blackKeyNameParents[s%e.pitchesPerOctave];i=e.keys[(t+e.pitchesPerOctave+n)%e.pitchesPerOctave].name,1==n?i+="♭":-1==n&&(i+="♯")}return i}}const{button:Dn,div:Tn,span:En,h2:Nn,input:On,br:zn,select:Rn,option:An}=N;class $n{constructor(t){this.u=t,this.Ih=On({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Fh=Rn({style:"width: 100%;"},An({value:"splice"},"Splice beats at end of bars."),An({value:"stretch"},"Stretch notes to fit in bars."),An({value:"overflow"},"Overflow notes across bars.")),this.g=Dn({class:"cancelButton"}),this.v=Dn({class:"okayButton",style:"width:45%;"},"Okay"),this.container=Tn({class:"prompt noSelection",style:"width: 250px;"},Nn("Beats Per Bar"),Tn({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},Tn({style:"text-align: right;"},"Beats per bar:",zn(),En({style:`font-size: smaller; color: ${_.secondaryText};`},"(Multiples of 3 or 4 are recommended)")),this.Ih),Tn({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},Tn({class:"selectContainer",style:"width: 100%;"},this.Fh)),Tn({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.v),this.g),this.k=()=>{this.u.undo()},this.cleanUp=()=>{this.v.removeEventListener("click",this.S),this.g.removeEventListener("click",this.k),this.Ih.removeEventListener("keypress",$n.Bh),this.Ih.removeEventListener("blur",$n.Lh),this.container.removeEventListener("keydown",this.P)},this.P=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.S()},this.S=()=>{window.localStorage.setItem("beatCountStrategy",this.Fh.value),this.u.prompt=null,this.u.record(new vi(this.u,$n.Ch(this.Ih),this.Fh.value),!0)},this.Ih.value=this.u.song.beatsPerBar+"",this.Ih.min=e.beatsPerBarMin+"",this.Ih.max=e.beatsPerBarMax+"";const s=window.localStorage.getItem("beatCountStrategy");null!=s&&(this.Fh.value=s),this.Ih.select(),setTimeout((()=>this.Ih.focus())),this.v.addEventListener("click",this.S),this.g.addEventListener("click",this.k),this.Ih.addEventListener("keypress",$n.Bh),this.Ih.addEventListener("blur",$n.Lh),this.container.addEventListener("keydown",this.P)}static Bh(t){const e=t.which?t.which:t.keyCode;return 46!=e&&e>31&&(e<48||e>57)&&(t.preventDefault(),!0)}static Lh(t){const e=t.target;e.value=String($n.Ch(e))}static Ch(t){return Math.floor(Math.max(Number(t.min),Math.min(Number(t.max),Number(t.value))))}}const{button:Un,div:qn,span:_n,h2:Vn,input:jn,br:Gn,select:Wn,option:Hn}=N;class Kn{constructor(t){this.u=t,this.Ih=jn({style:"width: 3em; margin-left: 1em;",type:"number",step:"0.01",value:"0"}),this.Fh=Wn({style:"width: 100%;"},Hn({value:"overflow"},"Overflow notes across bars."),Hn({value:"wrapAround"},"Wrap notes around within bars.")),this.g=Un({class:"cancelButton"}),this.v=Un({class:"okayButton",style:"width:45%;"},"Okay"),this.container=qn({class:"prompt noSelection",style:"width: 250px;"},Vn("Move Notes Sideways"),qn({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},qn({style:"text-align: right;"},"Beats to move:",Gn(),_n({style:`font-size: smaller; color: ${_.secondaryText};`},"(Negative is left, positive is right)")),this.Ih),qn({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},qn({class:"selectContainer",style:"width: 100%;"},this.Fh)),qn({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.v),this.g),this.k=()=>{this.u.undo()},this.cleanUp=()=>{this.v.removeEventListener("click",this.S),this.g.removeEventListener("click",this.k),this.Ih.removeEventListener("blur",Kn.Lh),this.container.removeEventListener("keydown",this.P)},this.P=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.S()},this.S=()=>{window.localStorage.setItem("moveNotesSidewaysStrategy",this.Fh.value),this.u.prompt=null,this.u.record(new gi(this.u,+this.Ih.value,this.Fh.value),!0)},this.Ih.min=-this.u.song.beatsPerBar+"",this.Ih.max=this.u.song.beatsPerBar+"";const e=window.localStorage.getItem("moveNotesSidewaysStrategy");null!=e&&(this.Fh.value=e),this.Ih.select(),setTimeout((()=>this.Ih.focus())),this.v.addEventListener("click",this.S),this.g.addEventListener("click",this.k),this.Ih.addEventListener("blur",Kn.Lh),this.container.addEventListener("keydown",this.P)}static Lh(t){const s=t.target;let i=+s.value;i=Math.round(i*e.partsPerBeat)/e.partsPerBeat,i=Math.round(100*i)/100,s.value=Math.max(+s.min,Math.min(+s.max,i))+""}}const{button:Yn,div:Jn,span:Qn,h2:Xn,input:Zn,br:th,select:eh,option:sh}=N;class ih{constructor(t){this.u=t,this.Dh=Zn({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Th=eh({style:"width: 100%;"},sh({value:"end"},"Apply change at end of song."),sh({value:"beginning"},"Apply change at beginning of song.")),this.g=Yn({class:"cancelButton"}),this.v=Yn({class:"okayButton",style:"width:45%;"},"Okay"),this.container=Jn({class:"prompt noSelection",style:"width: 250px;"},Xn("Song Length"),Jn({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},Jn({style:"display: inline-block; text-align: right;"},"Bars per song:",th(),Qn({style:`font-size: smaller; color: ${_.secondaryText};`},"(Multiples of 4 are recommended)")),this.Dh),Jn({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},Jn({class:"selectContainer",style:"width: 100%;"},this.Th)),Jn({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.v),this.g),this.k=()=>{this.u.undo()},this.cleanUp=()=>{this.v.removeEventListener("click",this.S),this.g.removeEventListener("click",this.k),this.Dh.removeEventListener("keypress",ih.Bh),this.Dh.removeEventListener("blur",ih.Lh),this.container.removeEventListener("keydown",this.P)},this.P=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.S()},this.S=()=>{window.localStorage.setItem("barCountPosition",this.Th.value);const t=new os;t.append(new xs(this.u,ih.Ch(this.Dh),"beginning"==this.Th.value)),this.u.prompt=null,this.u.record(t,!0)},this.Dh.value=this.u.song.barCount+"",this.Dh.min=e.barCountMin+"",this.Dh.max=e.barCountMax+"";const s=window.localStorage.getItem("barCountPosition");null!=s&&(this.Th.value=s),this.Dh.select(),setTimeout((()=>this.Dh.focus())),this.v.addEventListener("click",this.S),this.g.addEventListener("click",this.k),this.Dh.addEventListener("keypress",ih.Bh),this.Dh.addEventListener("blur",ih.Lh),this.container.addEventListener("keydown",this.P)}static Bh(t){const e=t.which?t.which:t.keyCode;return 46!=e&&e>31&&(e<48||e>57)&&(t.preventDefault(),!0)}static Lh(t){const e=t.target;e.value=String(ih.Ch(e))}static Ch(t){return Math.floor(Math.max(Number(t.min),Math.min(Number(t.max),Number(t.value))))}}const{button:nh,div:hh,h2:oh,p:rh,select:ah,option:lh}=N;class ch{constructor(t){this.u=t,this.Eh=ah({style:"width: 100%;"},lh({value:"acoustic"},"(A) Acoustic"),lh({value:"bright"},"(B) Bright")),this.g=nh({class:"cancelButton"}),this.v=nh({class:"okayButton",style:"width:45%;"},"Okay"),this.container=hh({class:"prompt",style:"width: 300px;"},hh(oh("String Sustain"),rh("This setting controls how quickly the picked string vibration decays."),rh('Unlike most of BeepBox\'s instrument synthesizer features, a picked string cannot change frequency suddenly while maintaining its decay. If a tone\'s pitch changes suddenly (e.g. if the chord type is set to "arpeggio" or the transition type is set to "continues") then the string will be re-picked and start decaying from the beginning again, even if the envelopes don\'t otherwise restart.')),hh({style:{display:e.enableAcousticSustain?void 0:"none"}},rh('BeepBox comes with two slightly different sustain designs. You can select one here and press "Okay" to confirm it.'),hh({class:"selectContainer",style:"width: 100%;"},this.Eh)),hh({style:{display:e.enableAcousticSustain?"flex":"none","flex-direction":"row-reverse","justify-content":"space-between"}},this.v),this.g),this.k=()=>{this.u.undo()},this.cleanUp=()=>{this.v.removeEventListener("click",this.S),this.g.removeEventListener("click",this.k),this.container.removeEventListener("keydown",this.P)},this.P=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.S()},this.S=()=>{if(e.enableAcousticSustain){const t=new os;t.append(new Ws(this.u,e.sustainTypeNames.indexOf(this.Eh.value))),this.u.prompt=null,this.u.record(t,!0)}else this.k()};const s=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()];this.Eh.value=e.sustainTypeNames[s.stringSustainType],setTimeout((()=>this.g.focus())),this.v.addEventListener("click",this.S),this.g.addEventListener("click",this.k),this.container.addEventListener("keydown",this.P)}}const{button:uh,div:ph,label:dh,br:fh,h2:mh,input:yh}=N;class bh{constructor(t){this.u=t,this.Nh=yh({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Oh=yh({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.zh=yh({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Rh=yh({style:"width: 3em; margin-left: 1em;",type:"checkbox"}),this.Ah=yh({style:"width: 3em; margin-left: 1em;",type:"checkbox"}),this.g=uh({class:"cancelButton"}),this.v=uh({class:"okayButton",style:"width:45%;"},"Okay"),this.container=ph({class:"prompt noSelection",style:"width: 250px; text-align: right;"},mh("Channel Settings"),dh({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Pitch channels:",this.Oh),dh({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Drum channels:",this.zh),dh({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Available patterns per channel:",this.Nh),dh({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Simultaneous instruments",fh(),"per channel:",this.Rh),dh({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Different instruments",fh(),"per pattern:",this.Ah),ph({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.v),this.g),this.k=()=>{this.u.undo()},this.cleanUp=()=>{this.v.removeEventListener("click",this.S),this.g.removeEventListener("click",this.k),this.Nh.removeEventListener("keypress",bh.Bh),this.Oh.removeEventListener("keypress",bh.Bh),this.zh.removeEventListener("keypress",bh.Bh),this.Nh.removeEventListener("blur",this.Lh),this.Oh.removeEventListener("blur",this.Lh),this.zh.removeEventListener("blur",this.Lh),this.container.removeEventListener("keydown",this.P)},this.P=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.S()},this.Lh=t=>{const e=t.target;e.value=String(bh.Ch(e))},this.S=()=>{const t=new os;t.append(new ni(this.u,this.Rh.checked,this.Ah.checked)),t.append(new di(this.u,bh.Ch(this.Nh))),t.append(new Ps(this.u,bh.Ch(this.Oh),bh.Ch(this.zh))),this.u.prompt=null,this.u.record(t,!0)},this.Nh.value=this.u.song.patternsPerChannel+"",this.Nh.min="1",this.Nh.max=e.barCountMax+"",this.Oh.value=this.u.song.pitchChannelCount+"",this.Oh.min=e.pitchChannelCountMin+"",this.Oh.max=e.pitchChannelCountMax+"",this.zh.value=this.u.song.noiseChannelCount+"",this.zh.min=e.noiseChannelCountMin+"",this.zh.max=e.noiseChannelCountMax+"",this.Rh.checked=this.u.song.layeredInstruments,this.Ah.checked=this.u.song.patternInstruments,this.Oh.select(),setTimeout((()=>this.Oh.focus())),this.v.addEventListener("click",this.S),this.g.addEventListener("click",this.k),this.Nh.addEventListener("keypress",bh.Bh),this.Oh.addEventListener("keypress",bh.Bh),this.zh.addEventListener("keypress",bh.Bh),this.Nh.addEventListener("blur",this.Lh),this.Oh.addEventListener("blur",this.Lh),this.zh.addEventListener("blur",this.Lh),this.container.addEventListener("keydown",this.P)}static Bh(t){const e=t.which?t.which:t.keyCode;return 46!=e&&e>31&&(e<48||e>57)&&(t.preventDefault(),!0)}static Ch(t){return Math.floor(Math.max(Number(t.min),Math.min(Number(t.max),Number(t.value))))}}function wh(t,e){const s=new ArrayBuffer(e);let i=0,n=Math.min(t.byteLength,s.byteLength);const h=[8,4,2,1];for(const e of h)if(n>=e){const h=o(e,t,s,i,n);i=h.nextOffset,n=h.leftBytes}return s;function o(t,e,s,i,n){let h=Uint8Array;switch(t){case 8:h=Float64Array;break;case 4:h=Float32Array;break;case 2:h=Uint16Array;break;default:h=Uint8Array}const o=new h(e,i,n/t|0),r=new h(s,i,n/t|0);for(let t=0;t<r.length;t++)r[t]=o[t];return{nextOffset:o.byteOffset+o.byteLength,leftBytes:n-r.length*t}}}class gh{constructor(t){this.$h=0,this.Uh=0,this.qh=new ArrayBuffer(t),this._h=new DataView(this.qh)}Vh(t){this.Uh+=t,this.Uh>this.qh.byteLength&&(this.qh=wh(this.qh,Math.max(2*this.qh.byteLength,this.Uh)),this._h=new DataView(this.qh))}getWriteIndex(){return this.$h}rewriteUint32(t,e){this._h.setUint32(t,e>>>0,!1)}writeUint32(t){t>>>=0,this.Vh(4),this._h.setUint32(this.$h,t,!1),this.$h=this.Uh}writeUint24(t){t>>>=0,this.Vh(3),this._h.setUint8(this.$h,t>>16&255),this._h.setUint8(this.$h+1,t>>8&255),this._h.setUint8(this.$h+2,255&t),this.$h=this.Uh}writeUint16(t){t>>>=0,this.Vh(2),this._h.setUint16(this.$h,t,!1),this.$h=this.Uh}writeUint8(t){t>>>=0,this.Vh(1),this._h.setUint8(this.$h,t),this.$h=this.Uh}writeInt8(t){t|=0,this.Vh(1),this._h.setInt8(this.$h,t),this.$h=this.Uh}writeMidi7Bits(t){if((t>>>=0)>=128)throw new Error("7 bit value contained 8th bit!");this.Vh(1),this._h.setUint8(this.$h,t),this.$h=this.Uh}writeMidiVariableLength(t){if((t>>>=0)>268435455)throw new Error("writeVariableLength value too big.");let e=!1;for(let s=0;s<4;s++){const i=t>>>21-7*s&127;0==i&&3!=s||(e=!0),e&&this.writeUint8((3==s?0:128)|i)}}writeMidiAscii(t){this.writeMidiVariableLength(t.length);for(let e=0;e<t.length;e++){const s=t.charCodeAt(e);if(s>127)throw new Error("Trying to write unicode character as ascii.");this.writeUint8(s)}}toCompactArrayBuffer(){return wh(this.qh,this.Uh)}}const{button:vh,div:xh,h2:kh,input:Mh,select:Sh,option:Ph}=N;function Ih(t,e,s){return t+s*(e-t)}function Fh(t,e){if(navigator.msSaveOrOpenBlob)return void navigator.msSaveOrOpenBlob(t,e);const s=document.createElement("a");if(null!=s.download){const i=URL.createObjectURL(t);setTimeout((function(){URL.revokeObjectURL(i)}),6e4),s.href=i,s.download=e,setTimeout((function(){s.dispatchEvent(new MouseEvent("click"))}),0)}else{const e=URL.createObjectURL(t);setTimeout((function(){URL.revokeObjectURL(e)}),6e4),window.open(e,"_blank")||(window.location.href=e)}}class Bh{constructor(t){this.u=t,this.jh=Mh({type:"text",style:"width: 10em;",value:"BeepBox-Song",maxlength:250,autofocus:"autofocus"}),this.Gh=Mh({type:"checkbox"}),this.Wh=Mh({style:"width: 2em;",type:"number",min:"1",max:"4",step:"1"}),this.Hh=Mh({type:"checkbox"}),this.Kh=Sh({style:"width: 100%;"},Ph({value:"wav"},".wav"),Ph({value:"mp3"},".mp3"),Ph({value:"midi"},".mid"),Ph({value:"json"},".json (for any BeepBox version)"),Ph({value:"html"},".html (opens BeepBox)")),this.g=vh({class:"cancelButton"}),this.Yh=vh({class:"exportButton",style:"width:45%;"},"Export"),this.container=xh({class:"prompt noSelection",style:"width: 200px;"},kh("Export Options"),xh({style:"display: flex; flex-direction: row; align-items: center; justify-content: space-between;"},"File name:",this.jh),xh({style:"display: table; width: 100%;"},xh({style:"display: table-row;"},xh({style:"display: table-cell;"},"Intro:"),xh({style:"display: table-cell;"},"Loop Count:"),xh({style:"display: table-cell;"},"Outro:")),xh({style:"display: table-row;"},xh({style:"display: table-cell; vertical-align: middle;"},this.Gh),xh({style:"display: table-cell; vertical-align: middle;"},this.Wh),xh({style:"display: table-cell; vertical-align: middle;"},this.Hh))),xh({style:"text-align: left;"},"File Type:"),xh({class:"selectContainer",style:"width: 100%;"},this.Kh),xh({style:"text-align: left;"},"(Be patient, exporting may take some time...)"),xh({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.Yh),this.g),this.k=()=>{this.u.undo()},this.cleanUp=()=>{this.jh.removeEventListener("input",Bh.Jh),this.Wh.removeEventListener("blur",Bh.Lh),this.Yh.removeEventListener("click",this.Qh),this.g.removeEventListener("click",this.k),this.container.removeEventListener("keydown",this.P)},this.P=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.Qh()},this.Qh=()=>{switch(window.localStorage.setItem("exportFormat",this.Kh.value),this.Kh.value){case"wav":this.Xh();break;case"mp3":this.Zh();break;case"midi":this.eo();break;case"json":this.so();break;case"html":this.io();break;default:throw new Error("Unhandled file export type.")}},this.Wh.value="1",0==this.u.song.loopStart?(this.Gh.checked=!1,this.Gh.disabled=!0):(this.Gh.checked=!0,this.Gh.disabled=!1),this.u.song.loopStart+this.u.song.loopLength==this.u.song.barCount?(this.Hh.checked=!1,this.Hh.disabled=!0):(this.Hh.checked=!0,this.Hh.disabled=!1);const e=window.localStorage.getItem("exportFormat");null!=e&&(this.Kh.value=e),this.jh.select(),setTimeout((()=>this.jh.focus())),this.jh.addEventListener("input",Bh.Jh),this.Wh.addEventListener("blur",Bh.Lh),this.Yh.addEventListener("click",this.Qh),this.g.addEventListener("click",this.k),this.container.addEventListener("keydown",this.P)}static Jh(t){const e=t.target,s=/[\+\*\$\?\|\{\}\\\/<>#%!`&'"=:@]/gi;if(s.test(e.value)){let t=e.selectionStart;e.value=e.value.replace(s,""),t--,e.setSelectionRange(t,t)}}static Lh(t){const e=t.target;e.value=Math.floor(Math.max(Number(e.min),Math.min(Number(e.max),Number(e.value))))+""}no(t){const e=new Xe(this.u.song);if(e.samplesPerSecond=t,e.loopRepeatCount=Number(this.Wh.value)-1,!this.Gh.checked)for(let t=0;t<this.u.song.loopStart;t++)e.goToNextBar();const s=Math.ceil(e.getSamplesPerBar()*e.getTotalBars(this.Gh.checked,this.Hh.checked)),i=new Float32Array(s),n=new Float32Array(s);return e.synthesize(i,n,s),{recordedSamplesL:i,recordedSamplesR:n}}Xh(){const t=48e3,{recordedSamplesL:e,recordedSamplesR:s}=this.no(t),i=e.length,n=2*i;let h=0;const o=new ArrayBuffer(44+2*n),r=new DataView(o);r.setUint32(h,1380533830,!1),h+=4,r.setUint32(h,36+2*n,!0),h+=4,r.setUint32(h,1463899717,!1),h+=4,r.setUint32(h,1718449184,!1),h+=4,r.setUint32(h,16,!0),h+=4,r.setUint16(h,1,!0),h+=2,r.setUint16(h,2,!0),h+=2,r.setUint32(h,t,!0),h+=4,r.setUint32(h,192e3,!0),h+=4,r.setUint16(h,4,!0),h+=2,r.setUint16(h,16,!0),h+=2,r.setUint32(h,1684108385,!1),h+=4,r.setUint32(h,2*n,!0),h+=4;{const t=32767;for(let n=0;n<i;n++){let i=Math.floor(Math.max(-1,Math.min(1,e[n]))*t),o=Math.floor(Math.max(-1,Math.min(1,s[n]))*t);r.setInt16(h,i,!0),h+=2,r.setInt16(h,o,!0),h+=2}}Fh(new Blob([o],{type:"audio/wav"}),this.jh.value.trim()+".wav"),this.k()}Zh(){const t=()=>{const{recordedSamplesL:t,recordedSamplesR:e}=this.no(44100),s=1152,i=new window.lamejs.Mp3Encoder(2,44100,192),n=[],h=new Int16Array(t.length),o=new Int16Array(e.length);for(let s=0;s<t.length;s++)h[s]=Math.floor(32767*Math.max(-1,Math.min(1,t[s]))),o[s]=Math.floor(32767*Math.max(-1,Math.min(1,e[s])));for(let t=0;t<h.length;t+=s){const e=h.subarray(t,t+s),r=o.subarray(t,t+s),a=i.encodeBuffer(e,r);a.length>0&&n.push(a)}const r=i.flush();r.length>0&&n.push(r);Fh(new Blob(n,{type:"audio/mp3"}),this.jh.value.trim()+".mp3"),this.k()};if("lamejs"in window)t();else{var e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js",e.onload=t,document.head.appendChild(e)}}eo(){const t=this.u.song,s=2*e.ticksPerPart*e.partsPerBeat,i=2*e.ticksPerPart,n=t.getBeatsPerMinute(),h=Math.round(6e7/n),o=s*t.beatsPerBar,a=24,l=[];if(this.Gh.checked)for(let m=0;m<t.loopStart;m++)l.push(m);for(let y=0;y<Number(this.Wh.value);y++)for(let b=t.loopStart;b<t.loopStart+t.loopLength;b++)l.push(b);if(this.Hh.checked)for(let w=t.loopStart+t.loopLength;w<t.barCount;w++)l.push(w);const c=[{isMeta:!0,channel:-1,midiChannel:-1,isNoise:!1,isDrumset:!1}];let u=0,p=!1;for(let g=0;g<this.u.song.getChannelCount();g++)if(p||4!=this.u.song.channels[g].instruments[0].type){if(u>=16)continue;c.push({isMeta:!1,channel:g,midiChannel:u++,isNoise:this.u.song.getChannelIsNoise(g),isDrumset:!1}),9==u&&u++}else c.push({isMeta:!1,channel:g,midiChannel:9,isNoise:!0,isDrumset:!0}),p=!0;const d=new gh(1024);d.writeUint32(1297377380),d.writeUint32(6),d.writeUint16(1),d.writeUint16(c.length),d.writeUint16(s);for(const v of c){d.writeUint32(1297379947);const{isMeta:x,channel:k,midiChannel:S,isNoise:P,isDrumset:I}=v,F=d.getWriteIndex();d.writeUint32(0);let B=0,L=0;const C=function(t){if(t<B)throw new Error("Midi event time cannot go backwards.");d.writeMidiVariableLength(t-B),B=t},D=function(t,e){if(!(e>=0&&e<=127))throw new Error("Midi control event value out of range: "+e);d.writeUint8(176|S),d.writeMidi7Bits(t),d.writeMidi7Bits(0|e)};if(x){C(0),d.writeUint8(255),d.writeMidi7Bits(1),d.writeMidiAscii("Composed with https://www.beepbox.co"),C(0),d.writeUint8(255),d.writeMidi7Bits(81),d.writeMidiVariableLength(3),d.writeUint24(h),C(0),d.writeUint8(255),d.writeMidi7Bits(88),d.writeMidiVariableLength(4),d.writeUint8(t.beatsPerBar),d.writeUint8(2),d.writeUint8(24),d.writeUint8(8);const T=e.scales[t.scale].flags[3]&&!e.scales[t.scale].flags[4],E=t.key;let N=E;for(1==(1&E)&&(N+=6),T&&(N+=9);N>6;)N-=12;C(0),d.writeUint8(255),d.writeMidi7Bits(89),d.writeMidiVariableLength(2),d.writeInt8(N),d.writeUint8(T?1:0),this.Gh.checked&&(L+=o*t.loopStart),C(L),d.writeUint8(255),d.writeMidi7Bits(6),d.writeMidiAscii("Loop Start");for(let O=0;O<parseInt(this.Wh.value);O++)L+=o*t.loopLength,C(L),d.writeUint8(255),d.writeMidi7Bits(6),d.writeMidiAscii(O<Number(this.Wh.value)-1?"Loop Repeat":"Loop End");if(this.Hh.checked&&(L+=o*(t.barCount-t.loopStart-t.loopLength)),L!=o*l.length)throw new Error("Miscalculated number of bars.")}else{let z=_.getChannelColor(t,k).name+" channel";C(0),d.writeUint8(255),d.writeMidi7Bits(3),d.writeMidiAscii(z),C(0),D(101,0),C(0),D(100,0),C(0),D(6,a),C(0),D(38,0),C(0),D(101,127),C(0),D(100,127);let R=-1;function A(s){const i=t.channels[k].instruments[s],n=M.valueToPreset(i.preset);if(R!=s){if(R=s,C(L),d.writeUint8(255),d.writeMidi7Bits(4),d.writeMidiAscii("Instrument "+(s+1)),!I){let t=81;if(null!=n&&null!=n.midiProgram)t=n.midiProgram;else if(4==i.type)t=116;else if(2==i.type||3==i.type)t=P?116:75;else if(0==i.type)Bh.midiChipInstruments.length>i.chipWave&&(t=Bh.midiChipInstruments[i.chipWave]);else if(6==i.type||1==i.type||5==i.type||8==i.type)t=81;else{if(7!=i.type)throw new Error("Unrecognized instrument type.");t=25}C(L),d.writeUint8(192|S),d.writeMidi7Bits(t)}C(L);let t=(h=Xe.instrumentVolumeToVolumeMult(i.volume),127*Math.pow(.3844015376046128*h,.25));D(7,Math.min(127,Math.round(t))),C(L);let o=63*(i.pan/e.panCenter-1)+64;D(10,Math.min(127,Math.round(o)))}var h}null==t.getPattern(k,0)&&A(0);let $=Mn,U=127,q=!1;const V=P?e.spectrumBasePitch:e.keys[t.key].basePitch,j=P?e.noiseInterval:1;for(const G of l){const W=t.getPattern(k,G);if(null!=W){const H=W.instruments[0],K=t.channels[k].instruments[H],Y=M.valueToPreset(K.preset);A(H);let J=K.getChord().arpeggiates,Q=J?1:e.maxChordSize;K.getChord().customInterval&&(0==K.type||5==K.type?(Q=2,J=!0):1==K.type?Q=e.operatorCount:console.error("Unrecognized instrument type for harmonizing arpeggio: "+K.type));for(let X=0;X<W.notes.length;X++){const Z=W.notes[X],tt=L+Z.start*i;let et=tt,st=Z.pins[0].size,it=Z.pins[0].interval;const nt=[-1,-1,-1,-1],ht=[-1,-1,-1,-1],ot=Math.min(Q,Z.pitches.length),rt=I?Math.max(1,Math.round(90*Z.pins[0].size/e.noteSizeMax)):90;let at=Z.pickMainInterval(),lt=at*j;if(!I){let ut=a,pt=-24;for(let dt=1;dt<Z.pins.length;dt++){const ft=Z.pins[dt].interval*j;ut=Math.min(ut,ft+a),pt=Math.max(pt,ft-a)}lt=Math.min(ut,Math.max(pt,lt))}for(let mt=1;mt<Z.pins.length;mt++){const yt=tt+Z.pins[mt].time*i,bt=Z.pins[mt].size,wt=Z.pins[mt].interval,gt=yt-et;for(let vt=0;vt<gt;vt++){const xt=et+vt,kt=Ih(st,bt,vt/gt),Mt=Ih(it,wt,vt/gt)*j-lt,St=Math.max(0,Math.min(16383,Math.round(8192*(1+Mt/a)))),Pt=Math.min(127,Math.round((f=Xe.noteSizeToVolumeMult(kt),127*Math.pow(f,.25))));St!=$&&(C(xt),d.writeUint8(224|S),d.writeMidi7Bits(127&St),d.writeMidi7Bits(St>>7&127),$=St),Pt==U||I||(C(xt),D(11,Pt),U=Pt);const It=xt==tt;for(let Ft=0;Ft<ot;Ft++){let Bt=Z.pitches[Ft];if(I){Bt+=at;const Lt=[36,41,45,48,40,39,59,49,46,55,69,54];if(Bt<0||Bt>=Lt.length)throw new Error("Could not find corresponding drumset pitch. "+Bt);Bt=Lt[Bt]}else{if(J&&Z.pitches.length>Ft+1&&Ft==ot-1){const Ct=(xt-L)%s,Dt=e.rhythms[t.rhythm].ticksPerArpeggio*i/e.ticksPerPart,Tt=Math.floor(Ct/Dt);Bt=Z.pitches[Ft+r(Z.pitches.length-Ft,t.rhythm,Tt)]}Bt=V+Bt*j+lt,null!=Y&&null!=Y.midiSubharmonicOctaves?Bt+=12*Y.midiSubharmonicOctaves:P&&(Bt+=12*+M.presetCategories.dictionary["Drum Presets"].presets.dictionary["taiko drum"].midiSubharmonicOctaves),P&&(Bt*=2)}Bt=Math.max(0,Math.min(127,Bt)),ht[Ft]=Bt,It||nt[Ft]==ht[Ft]||(C(xt),d.writeUint8(128|S),d.writeMidi7Bits(nt[Ft]),d.writeMidi7Bits(rt))}for(let Et=0;Et<ot;Et++)(It||nt[Et]!=ht[Et])&&(C(xt),d.writeUint8(144|S),d.writeMidi7Bits(ht[Et]),d.writeMidi7Bits(rt),nt[Et]=ht[Et])}et=yt,st=bt,it=wt}const ct=L+Z.end*i;for(let Nt=0;Nt<ot;Nt++)C(ct),d.writeUint8(128|S),d.writeMidi7Bits(nt[Nt]),d.writeMidi7Bits(rt);q=!0}}else q&&(q=!1,127!=U&&(U=127,C(L),D(11,U)),$!=Mn&&($=Mn,C(L),d.writeUint8(224|S),d.writeMidi7Bits(127&$),d.writeMidi7Bits($>>7&127)));L+=o}}C(L),d.writeUint8(255),d.writeMidi7Bits(47),d.writeMidiVariableLength(0),d.rewriteUint32(F,d.getWriteIndex()-F-4)}var f;Fh(new Blob([d.toCompactArrayBuffer()],{type:"audio/midi"}),this.jh.value.trim()+".mid"),this.k()}so(){const t=this.u.song.toJsonObject(this.Gh.checked,Number(this.Wh.value),this.Hh.checked),e=JSON.stringify(t,null,"\t");Fh(new Blob([e],{type:"application/json"}),this.jh.value.trim()+".json"),this.k()}io(){const t=`<!DOCTYPE html><meta charset="utf-8">\n\nYou should be redirected to the song at:<br /><br />\n\n<a id="destination" href="${new URL("#"+this.u.song.toBase64String(),location.href).href}"></a>\n\n<style>\n\t:root {\n\t\tcolor: white;\n\t\tbackground: black;\n\t\tfont-family:\n\t\tsans-serif;\n\t}\n\ta {\n\t\tcolor: #98f;\n\t}\n\ta[href]::before {\n\t\tcontent: attr(href);\n\t}\n</style>\n\n<script>\n\tlocation.assign(document.querySelector("a#destination").href);\n<\/script>\n`;Fh(new Blob([t],{type:"text/html"}),this.jh.value.trim()+".html"),this.k()}}Bh.midiChipInstruments=[74,71,80,70,68,81,81,81,81];class Lh{constructor(t){this.q=0,this._h=t}getReadIndex(){return this.q}readUint32(){if(this.q+4>this._h.byteLength)throw new Error("Reading past the end of the buffer.");const t=this._h.getUint32(this.q,!1);return this.q+=4,t}readUint24(){return this.readUint8()<<16|this.readUint8()<<8|this.readUint8()}readUint16(){if(this.q+2>this._h.byteLength)throw new Error("Reading past the end of the buffer.");const t=this._h.getUint16(this.q,!1);return this.q+=2,t}readUint8(){if(this.q+1>this._h.byteLength)throw new Error("Reading past the end of the buffer.");const t=this._h.getUint8(this.q);return this.q++,t}readInt8(){if(this.q+1>this._h.byteLength)throw new Error("Reading past the end of the buffer.");const t=this._h.getInt8(this.q);return this.q++,t}peakUint8(){if(this.q+1>this._h.byteLength)throw new Error("Reading past the end of the buffer.");return this._h.getUint8(this.q)}readMidi7Bits(){const t=this.readUint8();return t>=128&&console.log("7 bit value contained 8th bit! value "+t+", index "+this.q),127&t}readMidiVariableLength(){let t=0;for(let e=0;e<4;e++){const e=this.readUint8();if(t+=127&e,!(128&e))break;t<<=7}return t}skipBytes(t){this.q+=t}hasMore(){return this._h.byteLength>this.q}getReaderForNextBytes(t){if(this.q+t>this._h.byteLength)throw new Error("Reading past the end of the buffer.");const e=new Lh(new DataView(this._h.buffer,this._h.byteOffset+this.q,t));return this.skipBytes(t),e}}const{button:Ch,p:Dh,div:Th,h2:Eh,input:Nh}=N;class Oh{constructor(t){this.u=t,this.nn=Nh({type:"file",accept:".json,application/json,.mid,.midi,audio/midi,audio/x-midi"}),this.g=Ch({class:"cancelButton"}),this.container=Th({class:"prompt noSelection",style:"width: 300px;"},Eh("Import"),Dh({style:"text-align: left; margin: 0.5em 0;"},"BeepBox songs can be exported and re-imported as .json files. You could also use other means to make .json files for BeepBox as long as they follow the same structure."),Dh({style:"text-align: left; margin: 0.5em 0;"},"BeepBox can also (crudely) import .mid files. There are many tools available for creating .mid files. Shorter and simpler songs are more likely to work well."),this.nn,this.g),this.k=()=>{this.u.undo()},this.cleanUp=()=>{this.nn.removeEventListener("change",this.ho),this.g.removeEventListener("click",this.k)},this.ho=()=>{const t=this.nn.files[0];if(!t)return;const e=t.name.slice(2+(t.name.lastIndexOf(".")-1>>>0)).toLowerCase();if("json"==e){const e=new FileReader;e.addEventListener("load",(t=>{this.u.prompt=null,this.u.goBackToStart(),this.u.record(new Pi(this.u,e.result),!0,!0)})),e.readAsText(t)}else if("midi"==e||"mid"==e){const e=new FileReader;e.addEventListener("load",(t=>{this.u.prompt=null,this.u.goBackToStart(),this.oo(e.result)})),e.readAsArrayBuffer(t)}else console.error("Unrecognized file extension."),this.k()},this.nn.select(),setTimeout((()=>this.nn.focus())),this.nn.addEventListener("change",this.ho),this.g.addEventListener("click",this.k)}oo(t){const s=new Lh(new DataView(t));let i=null;const n=[];for(;s.hasMore();){const z=s.readUint32(),R=s.readUint32();if(1297377380==z)null==i?i=s.getReaderForNextBytes(R):console.error("This MIDI file has more than one header chunk.");else if(1297379947==z){const A=s.getReaderForNextBytes(R);A.hasMore()&&n.push({reader:A,nextEventMidiTick:A.readMidiVariableLength(),ended:!1,runningStatus:-1})}else s.skipBytes(R)}if(null==i)return console.error("No header chunk found in this MIDI file."),void this.k();const h=i.readUint16();i.readUint16();const o=i.readUint16();let r=0;const a=[],l=2==h;if(l)a.push(r);else for(let $=0;$<n.length;$++)a.push($);const c=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],u=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],p=[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],d=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],f=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],m=[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],y=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],b=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],w=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],g=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];let v=5e5,x=8,k=0,S=!1,P=0;for(;;){let U=Number.MAX_VALUE,q=!1;for(const _ of a){const V=n[_];for(;!V.ended&&V.nextEventMidiTick==P;){const j=128&V.reader.peakUint8()?V.reader.readUint8():V.runningStatus,G=240&j,W=15&j;240!=G&&(V.runningStatus=j);let H=!1;switch(G){case 128:{const K=V.reader.readMidi7Bits();V.reader.readMidi7Bits(),b[W].push({midiTick:P,pitch:K,velocity:0,program:-1,instrumentVolume:-1,instrumentPan:-1,on:!1})}break;case 144:{const Y=V.reader.readMidi7Bits(),J=V.reader.readMidi7Bits();if(0==J)b[W].push({midiTick:P,pitch:Y,velocity:0,program:-1,instrumentVolume:-1,instrumentPan:-1,on:!1});else{const Q=Math.max(0,Math.min(e.volumeRange-1,Math.round(Xe.volumeMultToInstrumentVolume(Pn(m[W]))))),X=Math.max(0,Math.min(e.panMax,Math.round(((y[W]-64)/63+1)*e.panCenter)));b[W].push({midiTick:P,pitch:Y,velocity:Math.max(0,Math.min(1,(J+14)/90)),program:f[W],instrumentVolume:Q,instrumentPan:X,on:!0})}}break;case 160:V.reader.readMidi7Bits(),V.reader.readMidi7Bits();break;case 176:{const Z=V.reader.readMidi7Bits(),tt=V.reader.readMidi7Bits();switch(Z){case 6:0==c[W]&&0==u[W]&&(p[W]=tt);break;case 7:m[W]=tt;break;case 10:y[W]=tt;break;case 11:g[W].push({midiTick:P,size:Xe.volumeMultToNoteSize((I=tt,Math.pow(I/127,4)))});break;case 38:0==c[W]&&0==u[W]&&(d[W]=tt);break;case 100:u[W]=tt;break;case 101:c[W]=tt}}break;case 192:{const et=V.reader.readMidi7Bits();f[W]=et}break;case 208:V.reader.readMidi7Bits();break;case 224:{const st=V.reader.readMidi7Bits(),it=((V.reader.readMidi7Bits()<<7|st)/8192-1)*(p[W]+.01*d[W]);w[W].push({midiTick:P,interval:it})}break;case 240:if(255==j){const nt=V.reader.readMidi7Bits(),ht=V.reader.readMidiVariableLength();if(47==nt)H=!0,V.reader.skipBytes(ht);else if(81==nt)v=V.reader.readUint24(),V.reader.skipBytes(ht-3);else if(88==nt){const ot=V.reader.readUint8();let rt=V.reader.readUint8();for(V.reader.readUint8(),V.reader.readUint8(),V.reader.skipBytes(ht-4),x=4*ot;0==(1&x)&&(rt>0||x>e.beatsPerBarMax)&&x>=2*e.beatsPerBarMin;)x>>=1,rt-=1;x=Math.max(e.beatsPerBarMin,Math.min(e.beatsPerBarMax,x))}else 89==nt?(k=V.reader.readInt8(),S=1==V.reader.readUint8(),V.reader.skipBytes(ht-2)):V.reader.skipBytes(ht)}else{if(240!=j&&247!=j)return console.error("Unrecognized event status: "+j),void this.k();{const at=V.reader.readMidiVariableLength();V.reader.skipBytes(at)}}break;default:return console.error("Unrecognized event type: "+G),void this.k()}!H&&V.reader.hasMore()?V.nextEventMidiTick=P+V.reader.readMidiVariableLength():(V.ended=!0,l&&(r++,r<n.length&&(a[0]=r,n[r].nextEventMidiTick+=P,U=Math.min(U,n[r].nextEventMidiTick),q=!0)))}V.ended||(q=!0,U=Math.min(U,V.nextEventMidiTick))}if(!q)break;P=U}var I;const F=Math.max(e.tempoMin,Math.min(e.tempoMax,Math.round(6e7/v))),B=o/e.partsPerBeat,L=e.partsPerBeat*x,C=Math.ceil(P/B/L);function D(t){return Math.round(t/B)}let T=k;for(S&&(T+=3),1==(1&T)&&(T+=6);T<0;)T+=12;T%=12;const E=[],N=[];for(let lt=0;lt<16;lt++){if(0==b[lt].length)continue;const ct=new Ge,ut=M.midiProgramToPresetValue(b[lt][0].program),pt=null==ut?null:M.valueToPreset(ut),dt=9==lt,ft=dt||null!=pt&&1==pt.isNoise,mt=ft?e.spectrumBasePitch:e.keys[T].basePitch,yt=ft?e.noiseInterval:1,bt=ft?.5:1,wt=ft?e.drumCount-1:e.maxPitch;ft?dt?N.unshift(ct):N.push(ct):E.push(ct);let gt=1,vt=0,xt=0,kt=e.panCenter;if(dt){const Mt=[];let St=-1,Pt=null,It=0,Ft=!1;const Bt=M.nameToPresetValue("standard drumset"),Lt=M.valueToPreset(Bt),Ct=new je(!1);Ct.fromJsonObject(Lt.settings,!1,1),Ct.preset=Bt,ct.instruments.push(Ct);for(let Dt=0;Dt<=b[lt].length;Dt++){const Tt=Dt==b[lt].length?null:b[lt][Dt],Et=null==Tt?Number.MAX_SAFE_INTEGER:D(Tt.midiTick);if(Mt.length>0&&Et>It&&(null==Tt||Tt.on)){const Nt=Math.floor(It/L),Ot=Nt*L;if(St!=Nt||null==Pt){for(St++;St<Nt;)ct.bars[St]=0,St++;Pt=new Oe,ct.patterns.push(Pt),ct.bars[St]=ct.patterns.length,Pt.instruments[0]=0,Pt.instruments.length=1}(!Ft||Ct.volume>xt)&&(Ct.volume=xt,Ct.pan=kt,Ft=!0);const zt=[];let Rt=wt,At=0,$t=1;for(const jt of Mt){const Gt=Sn[jt];-1==zt.indexOf(Gt.frequency)&&zt.push(Gt.frequency),$t=Math.max($t,Math.round(Gt.volume*gt)),Rt=Math.min(Rt,Gt.duration),At=Math.max(At,Gt.duration)}const Ut=Math.min(At,Math.max(Rt,2)),qt=It-Ot,_t=Math.min(L,Math.min(Et-Ot,qt+6*Ut)),Vt=new Ne(-1,qt,_t,$t,!0);Vt.pitches.length=0;for(let Wt=0;Wt<Math.min(e.maxChordSize,zt.length);Wt++){const Ht=zt[Wt+Math.max(0,zt.length-e.maxChordSize)];-1==Vt.pitches.indexOf(Ht)&&Vt.pitches.push(Ht)}Pt.notes.push(Vt),Mt.length=0}null!=Tt&&Tt.on&&null!=Sn[Tt.pitch]&&(Mt.push(Tt.pitch),It=Et,gt=Tt.velocity,xt=Tt.instrumentVolume,kt=Tt.instrumentPan)}}else{let Kt=0,Yt=e.noteSizeMax,Jt=0,Qt=0;function Xt(t){for(;Jt<w[lt].length&&w[lt][Jt].midiTick<=t;)Kt=w[lt][Jt].interval,Jt++}function Zt(t){for(;Qt<g[lt].length&&g[lt][Qt].midiTick<=t;)Yt=g[lt][Qt].size,Qt++}const te=[],ee=[];let se=-1,ie=null,ne=0,he=0,oe=0,re=0;for(let le of b[lt]){const ce=le.midiTick,ue=D(ce);if(ee.length>0&&ue>he){const pe=Math.floor(he/L),de=Math.ceil(ue/L);let fe=!1;for(let me=pe;me<de;me++){const ye=me*L,be=me*x*o,we=(me+1)*x*o,ge=Math.max(0,he-ye),ve=Math.min(L,ue-ye),xe=Math.max(be,ne),ke=Math.min(we,ce);if(ge<ve){const Me=M.midiProgramToPresetValue(vt),Se=null==Me?null:M.valueToPreset(Me);if(se!=me||null==ie){for(se++;se<me;)ct.bars[se]=0,se++;if(ie=new Oe,ct.patterns.push(ie),ct.bars[se]=ct.patterns.length,null==te[vt]){const Ue=new je(ft);te[vt]=Ue,null!=Me&&null!=Se&&1==Se.isNoise==ft?(Ue.fromJsonObject(Se.settings,ft,1),Ue.preset=Me):(Ue.setTypeAndReset(ft?2:0,ft),Ue.chord=0),Ue.volume=xt,Ue.pan=kt,ct.instruments.push(Ue)}ie.instruments[0]=ct.instruments.indexOf(te[vt]),ie.instruments.length=1}null!=te[vt]&&(te[vt].volume=Math.min(te[vt].volume,xt),te[vt].pan=Math.min(te[vt].pan,kt));const Pe=new Ne(-1,ge,ve,e.noteSizeMax,!1);Pe.pins.length=0,Pe.continuesLastPattern=fe&&0==ge,fe=!0,Xt(xe),Zt(xe);const Ie=ee[0]*bt-mt,Fe=Math.round((Ie+Kt)/yt),Be=Math.round(Kt-mt);let Le=Ee(0,0,Math.round(gt*Yt));Pe.pins.push(Le);const Ce=[{part:0,pitch:Fe,size:Le.size,keyPitch:!1,keySize:!1}];let De=0,Te=(Ie+Kt)/yt,ze=gt*Yt;for(let qe=ge+1;qe<=ve;qe++){const _e=Math.max(xe,Math.min(ke-1,Math.round(B*(qe+ye)))),Ve=qe-ge,We=qe==ve;Xt(_e),Zt(_e);const He=(Kt+Ie)/yt,Ke=gt*Yt,Ye=Math.round(He),Je=Math.abs(He-Ye)<.01,Qe=Math.abs(Te-Math.round(Te))<.01?Math.abs(He-Te)>=1:Math.floor(He)!=Math.floor(Te),Ze=Je||Qe,ts=Math.round(Ke),es=Math.abs(Ke-ts)<.01,ss=Math.abs(ze-Math.round(ze))?Math.abs(Ke-ze)>=1:Math.floor(Ke)!=Math.floor(ze),is=es||ss;if(Te=He,ze=Ke,Ze||is||We){const ns={part:Ve,pitch:Ye,size:ts,keyPitch:Ze||We,keySize:is||We},hs=Ce[De];let rs=!1,as=Number.MAX_VALUE;if(ns.keyPitch){const ls=(ns.pitch-hs.pitch)/(ns.part-hs.part);let cs=Math.abs(ls),us=!1,ps=Number.MAX_VALUE;for(let ds=De+1;ds<Ce.length;ds++){const fs=Ce[ds];if(fs.keyPitch){const ms=hs.pitch+ls*(fs.part-hs.part),ys=Math.abs(ms-fs.pitch);cs<ys&&(cs=ys,us=!0,ps=ds)}}us&&(rs=!0,as=Math.min(as,ps))}if(ns.keySize){const bs=(ns.size-hs.size)/(ns.part-hs.part);let ws=Math.abs(bs),gs=!1,vs=Number.MAX_VALUE;for(let xs=De+1;xs<Ce.length;xs++){const ks=Ce[xs];if(ks.keySize){const Ms=hs.size+bs*(ks.part-hs.part),Ss=Math.abs(Ms-ks.size);ws<Ss&&(ws=Ss,gs=!0,vs=xs)}}gs&&(rs=!0,as=Math.min(as,vs))}if(rs){const Ps=Ce[as];Pe.pins.push(Ee(Ps.pitch-Fe,Ps.part,Ps.size)),De=as}Ce.push(ns)}}const Re=Ce[Ce.length-1];Pe.pins.push(Ee(Re.pitch-Fe,Re.part,Re.size));let Ae=wt,$e=0;for(const Is of Pe.pins)Ae=Math.min(Ae,wt-Is.interval),$e=Math.min($e,-Is.interval);Pe.pitches.length=0;for(let Fs=0;Fs<Math.min(e.maxChordSize,ee.length);Fs++){let Bs=ee[Fs+Math.max(0,ee.length-e.maxChordSize)]*bt;null!=Se&&null!=Se.midiSubharmonicOctaves&&(Bs-=12*Se.midiSubharmonicOctaves);const Ls=Math.max($e,Math.min(Ae,Math.round((Bs+Be)/yt)));if(-1==Pe.pitches.indexOf(Ls)){Pe.pitches.push(Ls);const Cs=Pe.end-Pe.start;oe+=Ls*Cs,re+=Cs}}ie.notes.push(Pe)}}}-1!=ee.indexOf(le.pitch)&&ee.splice(ee.indexOf(le.pitch),1),le.on&&(ee.push(le.pitch),gt=le.velocity,vt=le.program,xt=le.instrumentVolume,kt=le.instrumentPan),ne=ce,he=ue}const ae=oe/re;ct.octave=ft?0:Math.max(0,Math.min(e.pitchOctaves-1,Math.floor(ae/12)))}for(;ct.bars.length<C;)ct.bars.push(0)}function O(t,e){for(;t.length>e;){let e=t.length-2,s=t.length-1,i=Number.MAX_VALUE,n=Number.MAX_VALUE;for(let h=0;h<t.length-1;h++)for(let o=h+1;o<t.length;o++){const r=t[h],a=t[o];let l=0,c=0;for(let t=0;t<r.bars.length&&t<a.bars.length;t++)0!=r.bars[t]&&0!=a.bars[t]&&l++,0==r.bars[t]&&0==a.bars[t]&&c++;l<=i&&(l<i||c<n)&&(e=h,s=o,i=l,n=c)}const h=t[e],o=t[s],r=h.instruments.length,a=h.patterns.length;for(const t of o.instruments)h.instruments.push(t);for(const t of o.patterns)t.instruments[0]+=r,h.patterns.push(t);for(let t=0;t<h.bars.length&&t<o.bars.length;t++)0==h.bars[t]&&0!=o.bars[t]&&(h.bars[t]=o.bars[t]+a);t.splice(s,1)}}O(E,e.pitchChannelCountMax),O(N,e.noiseChannelCountMax);this.u.goBackToStart();for(const Ds of this.u.song.channels)Ds.muted=!1;this.u.prompt=null,this.u.record(new class extends os{constructor(t){super();const e=t.song;e.tempo=F,e.beatsPerBar=x,e.key=T,e.scale=11,e.rhythm=1,e.layeredInstruments=!1,e.patternInstruments=E.some((t=>t.instruments.length>1))||N.some((t=>t.instruments.length>1)),Li(E),Li(N),this.append(new Fi(t,E,N)),e.loopStart=0,e.loopLength=e.barCount,this.nt(),t.notifier.changed()}}(this.u),!0,!0)}}const zh="songVersion: ";function Rh(t){return JSON.parse(t.substring(13))}function Ah(t){return zh+JSON.stringify(t)}function $h(){return(Math.random()*(-1>>>0)>>>0).toString(32)}function Uh(t){console.warn(t),window.alert('Whoops, the song data appears to have been corrupted! Please try to recover the last working version of the song from the "Recover Recent Song..." option in BeepBox\'s "File" menu.')}function qh(t,e){return e.versions[0].time-t.versions[0].time}function _h(t,e){return e.time-t.time}class Vh{constructor(){this.ro=new We}static getAllRecoveredSongs(){const t=[],e={};for(let s=0;s<localStorage.length;s++){const i=localStorage.key(s);if(0==i.indexOf(zh)){const s=Rh(i);let n=e[s.uid];null==n&&(n={versions:[]},e[s.uid]=n,t.push(n)),n.versions.push(s)}}for(const e of t)e.versions.sort(_h);return t.sort(qh),t}saveVersion(t,e){const s=Math.round(Date.now());clearTimeout(this.ao),this.ao=setTimeout((()=>{try{this.ro.fromBase64String(e)}catch(t){return void Uh(t)}const i=Vh.getAllRecoveredSongs();let n=null;for(const e of i)e.versions[0].uid==t&&(n=e);null==n&&(n={versions:[]},i.unshift(n));let h=n.versions,o=1e3;if(h.length>0){const t=h[0].time;o=h[0].work+Math.min(18e4,s-t)}const r={uid:t,time:s,work:o},a=Ah(r);h.unshift(r),localStorage.setItem(a,e);let l=6e4;const c=Math.pow(2,.5);for(var u=1;u<h.length;u++){if(h[u].work-(u==h.length-1?0:h[u+1].work)<l){let t=u;if(u<h.length-1){const e=h[u].time,s=h[u-1].time;e-h[u+1].time<.5*(s-e)&&(t=u+1)}localStorage.removeItem(Ah(h[t]));break}l*=c}for(;i.length>8;){let t=null,e=Number.POSITIVE_INFINITY;for(let n=Math.round(4);n<i.length;n++){const h=i[n],o=1/((s-h.versions[0].time)/432e5+1),r=(h.versions[0].work+3e5)*o;e>r&&(e=r,t=h)}for(const e of t.versions)localStorage.removeItem(Ah(e));i.splice(i.indexOf(t),1)}}),750)}}const{button:jh,div:Gh,h2:Wh,p:Hh,select:Kh,option:Yh,iframe:Jh}=N;class Qh{constructor(t){this.u=t,this.lo=Gh(),this.g=jh({class:"cancelButton"}),this.container=Gh({class:"prompt",style:"width: 300px;"},Wh("Song Recovery"),Gh({style:"max-height: 385px; overflow-y: auto;"},Hh("This is a TEMPORARY list of songs you have recently modified. Please keep your own backups of songs you care about!"),this.lo,Hh('(If "Display Song Data in URL" is enabled in your preferences, then you may also be able to find song versions in your browser history. However, song recovery won\'t work if you were browsing in private/incognito mode.)')),this.g),this.k=()=>{this.u.undo()},this.cleanUp=()=>{this.g.removeEventListener("click",this.k)},this.g.addEventListener("click",this.k);const e=Vh.getAllRecoveredSongs();0==e.length&&this.lo.appendChild(Hh("There are no recovered songs available yet. Try making a song!"));for(const t of e){const e=Kh({style:"width: 100%;"});for(const s of t.versions)e.appendChild(Yh({value:s.time},new Date(s.time).toLocaleString()));const s=Jh({style:"width: 100%; height: 60px; border: none; display: block;"});s.src="player/#song="+window.localStorage.getItem(Ah(t.versions[0]));const i=Gh({style:"margin: 4px 0;"},Gh({class:"selectContainer",style:"width: 100%; margin: 2px 0;"},e),s);this.lo.appendChild(i),e.addEventListener("change",(()=>{const i=t.versions[e.selectedIndex];s.contentWindow.location.replace("player/#song="+window.localStorage.getItem(Ah(i))),s.contentWindow.dispatchEvent(new Event("hashchange"))}))}}}const{button:Xh,label:Zh,div:to,p:eo,a:so,h2:io,input:no,select:ho,option:oo}=N;class ro{constructor(t){this.u=t,this.co=ho({style:"width: 100%;"},oo({value:"useCapsLockForNotes"},"simple shortcuts, use caps lock to play notes"),oo({value:"pressControlForShortcuts"},"simple notes, press "+M.ctrlName+" for shortcuts")),this.uo=ho({style:"width: 100%;"},oo({value:"wickiHayden"},"Wicki-Hayden"),oo({value:"songScale"},"selected song scale"),oo({value:"pianoAtC"},"piano starting at C :)"),oo({value:"pianoAtA"},"piano starting at A :("),oo({value:"pianoTransposingC"},"piano transposing C :) to song key"),oo({value:"pianoTransposingA"},"piano transposing A :( to song key")),this.po=to({style:"display: grid; row-gap: 4px; margin: 4px auto; font-size: 10px;"}),this.do=no({style:"width: 2em; margin-left: 1em;",type:"checkbox"}),this.fo=no({style:"width: 2em; margin-left: 1em;",type:"checkbox"}),this.mo=no({style:"width: 2em; margin-left: 1em;",type:"checkbox"}),this.yo=no({style:"width: 2em; margin-left: 1em;",type:"checkbox"}),this.bo=no({style:"width: 2em; margin-left: 1em;",type:"checkbox"}),this.wo=no({style:"width: 2em; margin-left: 1em;",type:"checkbox"}),this.v=Xh({class:"okayButton",style:"width:45%;"},"Okay"),this.g=Xh({class:"cancelButton"}),this.container=to({class:"prompt noSelection recordingSetupPrompt",style:"width: 333px; text-align: right; max-height: 90%;"},io("Note Recording Setup"),to({style:"display: grid; overflow-y: auto; overflow-x: hidden; flex-shrink: 1;"},eo("BeepBox can record notes as you perform them. You can start recording by pressing Ctrl+Space (or "+M.ctrlSymbol+"P)."),Zh({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Add ● record button next to ▶ play button:",this.fo),Zh({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Snap recorded notes to the song's rhythm:",this.mo),Zh({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Ignore notes not in the song's scale:",this.yo),eo("While recording, you can perform notes on your keyboard!"),Zh({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Keyboard layout:",to({class:"selectContainer",style:"width: 65%; margin-left: 1em;"},this.uo)),this.po,eo("When not recording, you can use the computer keyboard either for shortcuts (like C and V for copy and paste) or for performing notes, depending on this mode:"),Zh({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},to({class:"selectContainer",style:"width: 100%;"},this.co)),eo("Performing music takes practice! Try slowing the tempo and using this metronome to help you keep a rhythm."),Zh({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Hear metronome while recording:",this.wo),Zh({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Count-in 1 bar of metronome before recording:",this.bo),eo("If you have a ",so({href:"https://caniuse.com/midi",target:"_blank"},"compatible browser")," on a device connected to a MIDI keyboard, you can use it to perform notes in BeepBox! (Or you could buy ",so({href:"https://imitone.com/",target:"_blank"},"Imitone")," or ",so({href:"https://vochlea.com/",target:"_blank"},"Dubler")," to hum notes into a microphone while wearing headphones!)"),Zh({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Enable MIDI performance:",this.do),eo("The range of pitches available to play via your computer keyboard is affected by the octave scrollbar of the currently selected channel."),eo('Recorded notes often overlap such that one note ends after the next note already started. In BeepBox, these notes get split into multiple notes which may sound different when re-played than they did when you were recording. To fix the sound, you can either manually clean up the notes in the pattern editor, or you could try enabling the "transition type" effect on the instrument and setting it to "continue".'),to({style:`width: 100%; height: 80px; background: linear-gradient(rgba(0,0,0,0), ${_.editorBackground}); position: sticky; bottom: 0; pointer-events: none;`})),to({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.v),this.g),this.k=()=>{this.u.undo()},this.cleanUp=()=>{this.v.removeEventListener("click",this.rn),this.g.removeEventListener("click",this.k),this.container.removeEventListener("keydown",this.P)},this.P=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.rn()},this.rn=()=>{this.u.prefs.pressControlForShortcuts="pressControlForShortcuts"==this.co.value,this.u.prefs.keyboardLayout=this.uo.value,this.u.prefs.enableMidi=this.do.checked,this.u.prefs.showRecordButton=this.fo.checked,this.u.prefs.snapRecordedNotesToRhythm=this.mo.checked,this.u.prefs.ignorePerformedNotesNotInScale=this.yo.checked,this.u.prefs.metronomeCountIn=this.bo.checked,this.u.prefs.metronomeWhileRecording=this.wo.checked,this.u.prefs.save(),this.k()},this.vo=()=>{for(;this.po.firstChild;)this.po.removeChild(this.po.firstChild);const t=[12,12,11,10],s=e.scales[this.u.song.scale].flags;for(let i=0;i<4;i++){const n=to({style:"display: flex;"});this.po.appendChild(n);const h=to({style:"width: "+12*i+"px; height: 20px; flex-shrink: 0;"});n.appendChild(h);for(let h=0;h<t[i];h++){const t=to({style:"width: 20px; height: 20px; margin: 0 2px; box-sizing: border-box; flex-shrink: 0; display: flex; justify-content: center; align-items: center;"});n.appendChild(t);const o=Ln.keyPosToPitch(this.u,h,3-i,this.uo.value);if(null!=o){const i=o%12;s[i]?0==i?t.style.background=_.tonic:7==i&&this.u.prefs.showFifth?t.style.background=_.fifthNote:t.style.background=_.pitchBackground:t.style.border="2px solid "+_.pitchBackground;const n=(i+e.keys[this.u.song.key].basePitch)%e.pitchesPerOctave;t.textContent=Cn.getPitchName(n,i)}}}},this.co.value=this.u.prefs.pressControlForShortcuts?"pressControlForShortcuts":"useCapsLockForNotes",this.uo.value=this.u.prefs.keyboardLayout,this.do.checked=this.u.prefs.enableMidi,this.fo.checked=this.u.prefs.showRecordButton,this.mo.checked=this.u.prefs.snapRecordedNotesToRhythm,this.yo.checked=this.u.prefs.ignorePerformedNotesNotInScale,this.bo.checked=this.u.prefs.metronomeCountIn,this.wo.checked=this.u.prefs.metronomeWhileRecording,setTimeout((()=>this.fo.focus())),this.v.addEventListener("click",this.rn),this.g.addEventListener("click",this.k),this.container.addEventListener("keydown",this.P),this.vo(),this.uo.addEventListener("change",this.vo)}}const{button:ao,div:lo,input:co,select:uo,span:po,optgroup:fo,option:mo}=N;function yo(t,e){for(let s=0;s<e.length;s++)t.appendChild(mo({value:s},e[s]));return t}function bo(t){const e=uo();e.appendChild(fo({label:"Edit"},mo({value:"copyInstrument"},"Copy Instrument (⇧C)"),mo({value:"pasteInstrument"},"Paste Instrument (⇧V)"),mo({value:"randomPreset"},"Random Preset (R)"),mo({value:"randomGenerated"},"Random Generated (⇧R)")));const s=fo({label:M.presetCategories[0].name});t?(s.appendChild(mo({value:2},M.valueToPreset(2).name)),s.appendChild(mo({value:3},M.valueToPreset(3).name)),s.appendChild(mo({value:4},M.valueToPreset(4).name))):(s.appendChild(mo({value:0},M.valueToPreset(0).name)),s.appendChild(mo({value:6},M.valueToPreset(6).name)),s.appendChild(mo({value:8},M.valueToPreset(8).name)),s.appendChild(mo({value:5},M.valueToPreset(5).name)),s.appendChild(mo({value:7},M.valueToPreset(7).name)),s.appendChild(mo({value:3},M.valueToPreset(3).name)),s.appendChild(mo({value:1},M.valueToPreset(1).name))),e.appendChild(s);for(let s=1;s<M.presetCategories.length;s++){const i=M.presetCategories[s],n=fo({label:i.name});let h=!1;for(let e=0;e<i.presets.length;e++){const o=i.presets[e];1==o.isNoise==t&&(n.appendChild(mo({value:(s<<6)+e},o.name)),h=!0)}h&&e.appendChild(n)}return e}function wo(t,e){const s=e.toString();t.value!=s&&(t.value=s)}class go{constructor(t,e,s){this.input=t,this.u=e,this.xo=s,this.pn=null,this.ko=0,this.Mo=0,this.So=()=>{this.u.lastChangeWas(this.pn)||(this.Mo=this.ko),this.pn=this.xo(this.Mo,parseInt(this.input.value)),this.u.setProspectiveChange(this.pn)},this.Po=()=>{this.u.record(this.pn),this.pn=null},t.addEventListener("input",this.So),t.addEventListener("change",this.Po)}updateValue(t){this.ko=t,this.input.value=String(t)}}class vo{constructor(t){this.u=t,this.prompt=null,this.uo=new Ln(this.u),this.Io=new sn(this.u,!1,-1),this.Fo=new sn(this.u,!0,0),this.Bo=new sn(this.u,!1,1),this.Lo=new ln(this.u),this.Co=new cn(this.u),this.Do=new wn(this.u),this.To=new kn(this.u),this.Eo=new Cn(this.u),this.No=ao({class:"playButton",type:"button",title:"Play (Space)"},po("Play")),this.Oo=ao({class:"pauseButton",style:"display: none;",type:"button",title:"Pause (Space)"},"Pause"),this.zo=ao({class:"recordButton",style:"display: none;",type:"button",title:"Record (Ctrl+Space)"},po("Record")),this.Ro=ao({class:"stopButton",style:"display: none;",type:"button",title:"Stop Recording (Space)"},"Stop Recording"),this.Ao=ao({class:"prevBarButton",type:"button",title:"Previous Bar (left bracket)"}),this.$o=ao({class:"nextBarButton",type:"button",title:"Next Bar (right bracket)"}),this.Uo=co({title:"main volume",style:"width: 5em; flex-grow: 1; margin: 0;",type:"range",min:"0",max:"75",value:"50",step:"1"}),this.qo=uo({style:"width: 100%;"},mo({selected:!0,disabled:!0,hidden:!1},"File"),mo({value:"new"},"+ New Blank Song"),mo({value:"import"},"↑ Import Song... ("+M.ctrlSymbol+"O)"),mo({value:"export"},"↓ Export Song... ("+M.ctrlSymbol+"S)"),mo({value:"copyUrl"},"⎘ Copy Song URL"),mo({value:"shareUrl"},"⤳ Share Song URL"),mo({value:"shortenUrl"},"… Shorten Song URL"),mo({value:"viewPlayer"},"▶ View in Song Player"),mo({value:"copyEmbed"},"⎘ Copy HTML Embed Code"),mo({value:"songRecovery"},"⚠ Recover Recent Song...")),this._o=uo({style:"width: 100%;"},mo({selected:!0,disabled:!0,hidden:!1},"Edit"),mo({value:"undo"},"Undo (Z)"),mo({value:"redo"},"Redo (Y)"),mo({value:"copy"},"Copy Pattern (C)"),mo({value:"pasteNotes"},"Paste Pattern Notes (V)"),mo({value:"pasteNumbers"},"Paste Pattern Numbers ("+M.ctrlSymbol+"⇧V)"),mo({value:"insertBars"},"Insert Bar (⏎)"),mo({value:"deleteBars"},"Delete Selected Bars (⌫)"),mo({value:"insertChannel"},"Insert Channel ("+M.ctrlSymbol+"⏎)"),mo({value:"deleteChannel"},"Delete Selected Channels ("+M.ctrlSymbol+"⌫)"),mo({value:"selectAll"},"Select All (A)"),mo({value:"selectChannel"},"Select Channel (⇧A)"),mo({value:"duplicatePatterns"},"Duplicate Reused Patterns (D)"),mo({value:"transposeUp"},"Move Notes Up (+ or ⇧+)"),mo({value:"transposeDown"},"Move Notes Down (- or ⇧-)"),mo({value:"moveNotesSideways"},"Move All Notes Sideways..."),mo({value:"beatsPerBar"},"Change Beats Per Bar..."),mo({value:"barCount"},"Change Song Length..."),mo({value:"channelSettings"},"Channel Settings... (Q)")),this.Vo=uo({style:"width: 100%;"},mo({selected:!0,disabled:!0,hidden:!1},"Preferences"),mo({value:"autoPlay"},"Auto Play on Load"),mo({value:"autoFollow"},"Show And Play The Same Bar"),mo({value:"enableNotePreview"},"Hear Preview of Added Notes"),mo({value:"showLetters"},"Show Piano Keys"),mo({value:"showFifth"},'Highlight "Fifth" of Song Key'),mo({value:"notesOutsideScale"},"Allow Adding Notes Not in Scale"),mo({value:"setDefaultScale"},"Use Current Scale as Default"),mo({value:"showChannels"},"Show Notes From All Channels"),mo({value:"showScrollBar"},"Show Octave Scroll Bar"),mo({value:"alwaysShowSettings"},"Customize All Instruments"),mo({value:"instrumentCopyPaste"},"Instrument Copy/Paste Buttons"),mo({value:"enableChannelMuting"},"Enable Channel Muting"),mo({value:"displayBrowserUrl"},"Display Song Data in URL"),mo({value:"colorTheme"},"Set Theme..."),mo({value:"recordingSetup"},"Set Up Note Recording...")),this.jo=yo(uo(),e.scales.map((t=>t.name))),this.Go=yo(uo(),e.keys.map((t=>t.name)).reverse()),this.Wo=new go(co({style:"margin: 0; width: 4em; flex-grow: 1; vertical-align: middle;",type:"range",min:"0",max:"14",value:"7",step:"1"}),this.u,((t,e)=>new Ci(this.u,t,Math.round(120*Math.pow(2,(-4+e)/9))))),this.Ho=co({style:"width: 3em; margin-left: 0.4em; vertical-align: middle;",type:"number",step:"1"}),this.Ko=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.chorusRange-1,value:"0",step:"1"}),this.u,((t,e)=>new Ei(this.u,t,e))),this.Yo=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("chorus")},"Chorus:"),this.Ko.input),this.Qo=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.reverbRange-1,value:"0",step:"1"}),this.u,((t,e)=>new Ni(this.u,t,e))),this.Xo=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("reverb")},"Reverb:"),this.Qo.input),this.Zo=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.echoSustainRange-1,value:"0",step:"1"}),this.u,((t,e)=>new Ti(this.u,t,e))),this.tr=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("echoSustain")},"Echo:"),this.Zo.input),this.er=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.echoDelayRange-1,value:"0",step:"1"}),this.u,((t,e)=>new Di(this.u,t,e))),this.sr=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("echoDelay")},"Echo Delay:"),this.er.input),this.ir=yo(uo(),e.rhythms.map((t=>t.name))),this.nr=bo(!1),this.hr=bo(!0),this.rr=yo(uo(),e.algorithms.map((t=>t.name))),this.ar=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("algorithm")},"Algorithm:"),lo({class:"selectContainer"},this.rr)),this.lr=[],this.cr=ao({type:"button",class:"add-instrument last-button"}),this.ur=ao({type:"button",class:"remove-instrument"}),this.pr=lo({class:"instrument-bar"},this.ur,this.cr),this.dr=lo({class:"selectRow",style:"display: none;"},po({class:"tip",onclick:()=>this.Jo("instrumentIndex")},"Instrument:"),this.pr),this.mr=ao({type:"button",class:"copy-instrument",title:"Copy Instrument (⇧C)"},"Copy"),this.yr=ao({type:"button",class:"paste-instrument",title:"Paste Instrument (⇧V)"},"Paste"),this.wr=lo({class:"instrumentCopyPasteRow",style:"display: none;"},this.mr,this.yr),this.gr=new go(co({style:"margin: 0;",type:"range",min:-(e.volumeRange-1),max:"0",value:"0",step:"1"}),this.u,((t,e)=>new Wi(this.u,t,-e))),this.vr=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("instrumentVolume")},"Volume:"),this.gr.input),this.kr=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.panMax,value:e.panCenter,step:"1"}),this.u,((t,e)=>new Hi(this.u,t,e))),this.Mr=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("pan")},"Panning:"),this.kr.input),this.Sr=yo(uo(),e.chipWaves.map((t=>t.name))),this.Pr=yo(uo(),e.chipNoises.map((t=>t.name))),this.Ir=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("chipWave")},"Wave:"),lo({class:"selectContainer"},this.Sr)),this.Fr=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("chipNoise")},"Noise:"),lo({class:"selectContainer"},this.Pr)),this.Br=new hn(this.u),this.Lr=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("fadeInOut")},"Fade In/Out:"),this.Br.container),this.Cr=yo(uo(),e.transitions.map((t=>t.name))),this.Dr=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("transition")},"Transition:"),lo({class:"selectContainer"},this.Cr)),this.Tr=uo(mo({selected:!0,disabled:!0,hidden:!1})),this.Er=new on(this.u),this.Nr=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("eqFilter")},"EQ Filter:"),this.Er.container),this.Or=new on(this.u,!0),this.zr=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("noteFilter")},"Note Filter:"),this.Or.container),this.Rr=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.supersawDynamismMax,value:"0",step:"1"}),this.u,((t,e)=>new Rs(this.u,t,e))),this.Ar=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("supersawDynamism")},"Dynamism:"),this.Rr.input),this.$r=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.supersawSpreadMax,value:"0",step:"1"}),this.u,((t,e)=>new As(this.u,t,e))),this.Ur=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("supersawSpread")},"Spread:"),this.$r.input),this.qr=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.supersawShapeMax,value:"0",step:"1"}),this.u,((t,e)=>new $s(this.u,t,e))),this._r=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("supersawShape")},"Saw↔Pulse:"),this.qr.input),this.Vr=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.pulseWidthRange-1,value:"0",step:"1"}),this.u,((t,e)=>new zs(this.u,t,e))),this.jr=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("pulseWidth")},"Pulse Width:"),this.Vr.input),this.Gr=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.pitchShiftRange-1,value:"0",step:"1"}),this.u,((t,e)=>new Us(this.u,t,e))),this.Wr=[lo({class:"pitchShiftMarker",style:{color:_.tonic}}),lo({class:"pitchShiftMarker",style:{color:_.tonic,left:"50%"}}),lo({class:"pitchShiftMarker",style:{color:_.tonic,left:"100%"}})],this.Hr=[lo({class:"pitchShiftMarker",style:{color:_.fifthNote,left:700/24+"%"}}),lo({class:"pitchShiftMarker",style:{color:_.fifthNote,left:1900/24+"%"}})],this.Kr=lo({style:"display: flex; position: relative;"},this.Gr.input,lo({class:"pitchShiftMarkerContainer"},this.Wr,this.Hr)),this.Yr=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("pitchShift")},"Pitch Shift:"),this.Kr),this.Jr=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.detuneMax,value:"0",step:"1"}),this.u,((t,e)=>new qs(this.u,t,e))),this.Qr=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("detune")},"Detune:"),this.Jr.input),this.Xr=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.distortionRange-1,value:"0",step:"1"}),this.u,((t,e)=>new _s(this.u,t,e))),this.Zr=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("distortion")},"Distortion:"),this.Xr.input),this.ta=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.bitcrusherQuantizationRange-1,value:"0",step:"1"}),this.u,((t,e)=>new js(this.u,t,e))),this.ea=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("bitcrusherQuantization")},"Bit Crush:"),this.ta.input),this.sa=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.bitcrusherFreqRange-1,value:"0",step:"1"}),this.u,((t,e)=>new Vs(this.u,t,e))),this.ia=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("bitcrusherFreq")},"Freq Crush:"),this.sa.input),this.na=new go(co({style:"margin: 0;",type:"range",min:"0",max:e.stringSustainRange-1,value:"0",step:"1"}),this.u,((t,e)=>new Gs(this.u,t,e))),this.ha=po({class:"tip",onclick:()=>this.Jo("stringSustain")},"Sustain:"),this.oa=lo({class:"selectRow"},this.ha,this.na.input),this.ra=yo(uo(),e.unisons.map((t=>t.name))),this.aa=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("unison")},"Unison:"),lo({class:"selectContainer"},this.ra)),this.la=yo(uo(),e.chords.map((t=>t.name))),this.ca=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("chords")},"Chords:"),lo({class:"selectContainer"},this.la)),this.ua=yo(uo(),e.vibratos.map((t=>t.name))),this.pa=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("vibrato")},"Vibrato:"),lo({class:"selectContainer"},this.ua)),this.da=lo({class:"editor-controls"}),this.fa=yo(uo(),e.feedbacks.map((t=>t.name))),this.ma=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("feedbackType")},"Feedback:"),lo({class:"selectContainer"},this.fa)),this.ya=new gn(this.u,null),this.ba=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("spectrum")},"Spectrum:"),this.ya.container),this.wa=new vn(this.u),this.ga=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("harmonics")},"Harmonics:"),this.wa.container),this.va=new nn(this.u),this.xa=lo({class:"editor-controls"}),this.ka=new go(co({type:"range",min:"0",max:e.operatorAmplitudeMax,value:"0",step:"1",title:"Feedback Amplitude"}),this.u,((t,e)=>new ti(this.u,t,e))),this.Ma=lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("feedbackVolume")},"Fdback Vol:"),this.ka.input),this.Sa=ao({type:"button",class:"customize-instrument"},"Customize Instrument"),this.Pa=ao({type:"button",class:"add-envelope"}),this.Ia=lo({class:"editor-controls"},this.Nr,this.Lr,this.Ir,this.Fr,this.ar,this.da,this.ma,this.Ma,this.ba,this.ga,this.xa,this.Ar,this.Ur,this._r,this.jr,this.oa,this.aa,lo({style:"margin: 2px 0; margin-left: 2em; display: flex; align-items: center;"},po({style:"flex-grow: 1; text-align: center;"},po({class:"tip",onclick:()=>this.Jo("effects")},"Effects")),lo({class:"effects-menu"},this.Tr)),this.Dr,this.ca,this.Yr,this.Qr,this.pa,this.zr,this.Zr,this.ea,this.ia,this.Mr,this.Yo,this.tr,this.sr,this.Xo,lo({style:"margin: 2px 0; margin-left: 2em; display: flex; align-items: center;"},po({style:"flex-grow: 1; text-align: center;"},po({class:"tip",onclick:()=>this.Jo("envelopes")},"Envelopes")),this.Pa),this.va.container),this.Fa=lo({class:"editor-controls"},lo({style:`margin: 3px 0; text-align: center; color: ${_.secondaryText};`},"Instrument Settings"),this.dr,this.wr,this.vr,lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("instrumentType")},"Type:"),lo({class:"selectContainer"},this.nr,this.hr)),this.Sa,this.Ia),this.Ba=lo({class:"promptContainer",style:"display: none;"}),this.La=ao({class:"zoomInButton",type:"button",title:"Zoom In"}),this.Ca=ao({class:"zoomOutButton",type:"button",title:"Zoom Out"}),this.Da=lo({style:"flex: 1; height: 100%; display: flex; overflow: hidden; justify-content: center;"},this.Io.container,this.Fo.container,this.Bo.container),this.Ta=lo({class:"pattern-area"},this.Eo.container,this.Da,this.To.container,this.La,this.Ca),this.Ea=lo({class:"trackContainer"},this.Co.container,this.Do.container),this.Na=lo({style:"position: absolute; width: 100%; height: 100%; pointer-events: none;"}),this.Oa=lo({class:"trackAndMuteContainer"},this.Lo.container,this.Ea,this.Na),this.za=new xn(this.u),this.Ra=lo({class:"track-area"},this.Oa,this.za.container),this.Aa=lo({class:"menu-area"},lo({class:"selectContainer menu file"},this.qo),lo({class:"selectContainer menu edit"},this._o),lo({class:"selectContainer menu preferences"},this.Vo)),this.$a=lo({class:"song-settings-area"},lo({class:"editor-controls"},lo({style:`margin: 3px 0; text-align: center; color: ${_.secondaryText};`},"Song Settings"),lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("scale")},"Scale:"),lo({class:"selectContainer"},this.jo)),lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("key")},"Key:"),lo({class:"selectContainer"},this.Go)),lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("tempo")},"Tempo:"),po({style:"display: flex;"},this.Wo.input,this.Ho)),lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("rhythm")},"Rhythm:"),lo({class:"selectContainer"},this.ir)))),this.Ua=lo({class:"instrument-settings-area"},this.Fa),this.qa=lo({class:"settings-area noSelection"},lo({class:"play-pause-area"},lo({class:"playback-bar-controls"},this.No,this.Oo,this.zo,this.Ro,this.Ao,this.$o),lo({class:"playback-volume-controls"},po({class:"volume-speaker"}),this.Uo)),this.Aa,this.$a,this.Ua),this.mainLayer=lo({class:"beepboxEditor",tabIndex:"0"},this.Ta,this.Ra,this.qa,this.Ba),this._a=!1,this.Va=null,this.ja=-1,this.Ga=0,this.Wa=!1,this.Ha=!1,this.Ka=!1,this.Ya=!1,this.Se=!1,this.Ja=!1,this.Qa=[],this.Xa=[],this.Za=[],this.tl=[],this.el=[],this.sl=()=>{this.mainLayer.focus({preventScroll:!0})},this.il=t=>{this.u.synth.recording&&t.target!=this.mainLayer&&t.target!=this.Ro&&t.target!=this.Uo&&this.sl()},this.whenUpdated=()=>{const t=this.u.prefs;this.Lo.container.style.display=t.enableChannelMuting?"":"none";const s=this.Na.getBoundingClientRect();if(this.u.trackVisibleBars=Math.floor((s.right-s.left-(t.enableChannelMuting?32:0))/this.u.getBarWidth()),this.u.trackVisibleChannels=Math.floor((s.bottom-s.top-30)/an.patternHeight),this.za.render(),this.Lo.render(),this.Co.render(),rt.innerText="shitcoins: "+H,at.innerText="gems: "+K,null!=ht&&null!=ht){if(ht.includes("songPlayer")){this.qo.querySelector("[value=viewPlayer]").disabled=!1}else{this.qo.querySelector("[value=viewPlayer]").disabled=!0}if(ht.includes("shortenUrl")){this.qo.querySelector("[value=shortenUrl]").disabled=!1}else{this.qo.querySelector("[value=shortenUrl]").disabled=!0}if(ht.includes("import")){this.qo.querySelector("[value=import]").disabled=!1}else{this.qo.querySelector("[value=import]").disabled=!0}if(ht.includes("export")){this.qo.querySelector("[value=export]").disabled=!1}else{this.qo.querySelector("[value=export]").disabled=!0}if(ht.includes("recovery")){this.qo.querySelector("[value=songRecovery]").disabled=!1}else{this.qo.querySelector("[value=songRecovery]").disabled=!0}if(ht.includes("copyUrl")){this.qo.querySelector("[value=copyUrl]").disabled=!1}else{this.qo.querySelector("[value=copyUrl]").disabled=!0}if(ht.includes("beatsPerBar")){this._o.querySelector("[value=beatsPerBar]").disabled=!1}else{this._o.querySelector("[value=beatsPerBar]").disabled=!0}if(ht.includes("showScrollBar")){this.Vo.querySelector('[value="showScrollBar"]').disabled=!1}else{this.Vo.querySelector('[value="showScrollBar"]').disabled=!0}if(ht.includes("showLetters")){this.Vo.querySelector('[value="showLetters"]').disabled=!1}else{this.Vo.querySelector('[value="showLetters"]').disabled=!0}if(ht.includes("autoPlay")){this.Vo.querySelector('[value="autoPlay"]').disabled=!1}else{this.Vo.querySelector('[value="autoPlay"]').disabled=!0}if(ht.includes("autoFollow")){this.Vo.querySelector('[value="autoFollow"]').disabled=!1}else{this.Vo.querySelector('[value="autoFollow"]').disabled=!0}if(ht.includes("enableNotePreview")){this.Vo.querySelector('[value="enableNotePreview"]').disabled=!1}else{this.Vo.querySelector('[value="enableNotePreview"]').disabled=!0}if(ht.includes("fifthNote")){this.Vo.querySelector('[value="showFifth"]').disabled=!1}else{this.Vo.querySelector('[value="showFifth"]').disabled=!0}if(ht.includes("notesOutsideScale")){this.Vo.querySelector('[value="notesOutsideScale"]').disabled=!1}else{this.Vo.querySelector('[value="notesOutsideScale"]').disabled=!0}if(ht.includes("showChannels")){this.Vo.querySelector('[value="showChannels"]').disabled=!1}else{this.Vo.querySelector('[value="showChannels"]').disabled=!0}if(ht.includes("instrumentCopyPaste")){this.Vo.querySelector('[value="instrumentCopyPaste"]').disabled=!1}else{this.Vo.querySelector('[value="instrumentCopyPaste"]').disabled=!0}if(ht.includes("enableChannelMuting")){this.Vo.querySelector('[value="enableChannelMuting"]').disabled=!1}else{this.Vo.querySelector('[value="enableChannelMuting"]').disabled=!0}if(ht.includes("displayBrowserUrl")){this.Vo.querySelector('[value="displayBrowserUrl"]').disabled=!1}else{this.Vo.querySelector('[value="displayBrowserUrl"]').disabled=!0}if(ht.includes("recordingSetup")){this.Vo.querySelector('[value="recordingSetup"]').disabled=!1}else{this.Vo.querySelector('[value="recordingSetup"]').disabled=!0}if(ht.includes("keyCSharp")){this.Go.querySelector('[value="10"]').disabled=!1}else{this.Go.querySelector('[value="10"]').disabled=!0}if(ht.includes("keyD")){this.Go.querySelector('[value="9"]').disabled=!1}else{this.Go.querySelector('[value="9"]').disabled=!0}if(ht.includes("keyDSharp")){this.Go.querySelector('[value="8"]').disabled=!1}else{this.Go.querySelector('[value="8"]').disabled=!0}if(ht.includes("keyE")){this.Go.querySelector('[value="7"]').disabled=!1}else{this.Go.querySelector('[value="7"]').disabled=!0}if(ht.includes("keyF")){this.Go.querySelector('[value="6"]').disabled=!1}else{this.Go.querySelector('[value="6"]').disabled=!0}if(ht.includes("keyFSharp")){this.Go.querySelector('[value="5"]').disabled=!1}else{this.Go.querySelector('[value="5"]').disabled=!0}if(ht.includes("keyG")){this.Go.querySelector('[value="4"]').disabled=!1}else{this.Go.querySelector('[value="4"]').disabled=!0}if(ht.includes("keyGSharp")){this.Go.querySelector('[value="3"]').disabled=!1}else{this.Go.querySelector('[value="3"]').disabled=!0}if(ht.includes("keyA")){this.Go.querySelector('[value="2"]').disabled=!1}else{this.Go.querySelector('[value="2"]').disabled=!0}if(ht.includes("keyASharp")){this.Go.querySelector('[value="1"]').disabled=!1}else{this.Go.querySelector('[value="1"]').disabled=!0}if(ht.includes("keyB")){this.Go.querySelector('[value="0"]').disabled=!1}else{this.Go.querySelector('[value="0"]').disabled=!0}if(ht.includes("keyCSharp")&&ht.includes("keyCSharp")&&ht.includes("keyD")&&ht.includes("keyDSharp")&&ht.includes("keyE")&&ht.includes("keyF")&&ht.includes("keyFSharp")&&ht.includes("keyG")&&ht.includes("keyGSharp")&&ht.includes("keyA")&&ht.includes("keyASharp")&&ht.includes("keyB")){const t=this.Go.querySelector('[label="Edit"]');t.disabled=!1,t.removeAttribute("hidden")}else{const t=this.Go.querySelector('[label="Edit"]');t.disabled=!0,t.setAttribute("hidden","")}if(ht.includes("easySad")){this.jo.querySelector('[value="1"]').disabled=!1}else{this.jo.querySelector('[value="1"]').disabled=!0}if(ht.includes("islandHappy")){this.jo.querySelector('[value="2"]').disabled=!1}else{this.jo.querySelector('[value="2"]').disabled=!0}if(ht.includes("islandSad")){this.jo.querySelector('[value="3"]').disabled=!1}else{this.jo.querySelector('[value="3"]').disabled=!0}if(ht.includes("bluesHappy")){this.jo.querySelector('[value="4"]').disabled=!1}else{this.jo.querySelector('[value="4"]').disabled=!0}if(ht.includes("bluesSad")){this.jo.querySelector('[value="5"]').disabled=!1}else{this.jo.querySelector('[value="5"]').disabled=!0}if(ht.includes("normalEasy")){this.jo.querySelector('[value="6"]').disabled=!1}else{this.jo.querySelector('[value="6"]').disabled=!0}if(ht.includes("normalSad")){this.jo.querySelector('[value="7"]').disabled=!1}else{this.jo.querySelector('[value="7"]').disabled=!0}if(ht.includes("dblHappy")){this.jo.querySelector('[value="8"]').disabled=!1}else{this.jo.querySelector('[value="8"]').disabled=!0}if(ht.includes("dblSad")){this.jo.querySelector('[value="9"]').disabled=!1}else{this.jo.querySelector('[value="9"]').disabled=!0}if(ht.includes("strange")){this.jo.querySelector('[value="10"]').disabled=!1}else{this.jo.querySelector('[value="10"]').disabled=!0}if(ht.includes("expert")){this.jo.querySelector('[value="11"]').disabled=!1}else{this.jo.querySelector('[value="11"]').disabled=!0}if(ht.includes("easySad")&&ht.includes("islandHappy")&&ht.includes("islandSad")&&ht.includes("bluesHappy")&&ht.includes("bluesSad")&&ht.includes("normalHappy")&&ht.includes("normalSad")&&ht.includes("dblHappy")&&ht.includes("dblSad")&&ht.includes("strange")&&ht.includes("expert")){const t=this.jo.querySelector('[label="Edit"]');t.disabled=!1,t.removeAttribute("hidden")}else{const t=this.jo.querySelector('[label="Edit"]');t.disabled=!0,t.setAttribute("hidden","")}const t=this.qo.querySelector("[value=copyEmbed]");t.disabled=!0,t.setAttribute("hidden","")}if(this.Oa.scrollLeft=this.u.barScrollPos*this.u.getBarWidth(),this.Oa.scrollTop=this.u.channelScrollPos*an.patternHeight,this.Eo.container.style.display=t.showLetters?"":"none",this.To.container.style.display=t.showScrollBar?"":"none",this.za.container.style.display=this.u.song.barCount>this.u.trackVisibleBars?"":"none",this.u.getFullScreen()){const e=5*(this.Da.clientHeight/this.u.getVisiblePitchCount()),s=this.Da.clientWidth/(3*this.u.song.beatsPerBar),i=this.Da.clientWidth/(this.u.song.beatsPerBar+2),n=Math.max(s,Math.min(i,e))*this.u.song.beatsPerBar;this.Io.container.style.width=n+"px",this.Fo.container.style.width=n+"px",this.Bo.container.style.width=n+"px",this.Io.container.style.flexShrink="0",this.Fo.container.style.flexShrink="0",this.Bo.container.style.flexShrink="0",this.Io.container.style.display="",this.Bo.container.style.display="",this.Io.render(),this.Bo.render(),this.La.style.display="",this.Ca.style.display="",this.La.style.right=t.showScrollBar?"24px":"4px",this.Ca.style.right=t.showScrollBar?"24px":"4px"}else this.Fo.container.style.width="",this.Fo.container.style.flexShrink="",this.Io.container.style.display="none",this.Bo.container.style.display="none",this.La.style.display="none",this.Ca.style.display="none";this.Fo.render();const i=[(t.autoPlay?"✓ ":"　")+"Auto Play on Load",(t.autoFollow?"✓ ":"　")+"Show And Play The Same Bar",(t.enableNotePreview?"✓ ":"　")+"Hear Preview of Added Notes",(t.showLetters?"✓ ":"　")+"Show Piano Keys",(t.showFifth?"✓ ":"　")+'Highlight "Fifth" of Song Key',(t.notesOutsideScale?"✓ ":"　")+"Allow Adding Notes Not in Scale",(t.defaultScale==this.u.song.scale?"✓ ":"　")+"Use Current Scale as Default",(t.showChannels?"✓ ":"　")+"Show Notes From All Channels",(t.showScrollBar?"✓ ":"　")+"Show Octave Scroll Bar",(t.alwaysShowSettings?"✓ ":"　")+"Customize All Instruments",(t.instrumentCopyPaste?"✓ ":"　")+"Instrument Copy/Paste Buttons",(t.enableChannelMuting?"✓ ":"　")+"Enable Channel Muting",(t.displayBrowserUrl?"✓ ":"　")+"Display Song Data in URL","　Set Theme...","　Set Up Note Recording..."];for(let t=0;t<i.length;t++){const e=this.Vo.children[t+1];e.textContent!=i[t]&&(e.textContent=i[t])}const h=this.u.song.channels[this.u.channel],o=this.u.getCurrentInstrument(),r=h.instruments[o],a=this.mainLayer.contains(document.activeElement),x=document.activeElement,M=_.getChannelColor(this.u.song,this.u.channel);for(let t=this.Tr.childElementCount-1;t<e.effectOrder.length;t++)this.Tr.appendChild(mo({value:t}));this.Tr.selectedIndex=0;for(let t=0;t<e.effectOrder.length;t++){let s=e.effectOrder[t];const i=(0!=(r.effects&1<<s)?"✓ ":"　")+e.effectNames[s],n=this.Tr.children[t+1];n.textContent!=i&&(n.textContent=i)}if(wo(this.jo,this.u.song.scale),this.jo.title=e.scales[this.u.song.scale].realName,wo(this.Go,e.keys.length-1-this.u.song.key),this.Wo.updateValue(Math.max(0,Math.min(28,Math.round(4+9*Math.log2(this.u.song.tempo/120))))),this.Ho.value=this.u.song.tempo.toString(),wo(this.ir,this.u.song.rhythm),this.u.song.getChannelIsNoise(this.u.channel)?(this.nr.style.display="none",this.hr.style.display="",wo(this.hr,r.preset)):(this.nr.style.display="",this.hr.style.display="none",wo(this.nr,r.preset)),t.instrumentCopyPaste?this.wr.style.display="":this.wr.style.display="none",t.alwaysShowSettings||r.preset==r.type){if(this.Sa.style.display="none",this.Ia.style.display="",2==r.type?(this.Fr.style.display="",wo(this.Pr,r.chipNoise)):this.Fr.style.display="none",3==r.type?(this.ba.style.display="",this.ya.render()):this.ba.style.display="none",5==r.type||7==r.type?(this.ga.style.display="",this.wa.render()):this.ga.style.display="none",7==r.type?(this.oa.style.display="",this.na.updateValue(r.stringSustain),this.ha.textContent=e.enableAcousticSustain?"Sustain ("+e.sustainTypeNames[r.stringSustainType].substring(0,1).toUpperCase()+"):":"Sustain:"):this.oa.style.display="none",4==r.type){this.xa.style.display="",this.Lr.style.display="none";for(let t=0;t<e.drumCount;t++)wo(this.el[t],r.drumsetEnvelopes[t]),this.tl[t].render()}else this.xa.style.display="none",this.Lr.style.display="",this.Br.render();if(0==r.type?(this.Ir.style.display="",wo(this.Sr,r.chipWave)):this.Ir.style.display="none",1==r.type){this.ar.style.display="",this.da.style.display="",this.ma.style.display="",this.Ma.style.display="",wo(this.rr,r.algorithm),wo(this.fa,r.feedbackType),this.ka.updateValue(r.feedbackAmplitude);for(let t=0;t<e.operatorCount;t++){const s=t<e.algorithms[r.algorithm].carrierCount;this.Qa[t].style.color=s?_.primaryText:"",wo(this.Za[t],r.operators[t].frequency),this.Xa[t].updateValue(r.operators[t].amplitude);const i=(s?"Voice ":"Modulator ")+(t+1);this.Za[t].title=i+" Frequency",this.Xa[t].input.title=i+(s?" Volume":" Amplitude")}}else this.ar.style.display="none",this.da.style.display="none",this.ma.style.display="none",this.Ma.style.display="none";if(8==r.type?(this.Ar.style.display="",this.Ur.style.display="",this._r.style.display="",this.Rr.updateValue(r.supersawDynamism),this.$r.updateValue(r.supersawSpread),this.qr.updateValue(r.supersawShape)):(this.Ar.style.display="none",this.Ur.style.display="none",this._r.style.display="none"),6==r.type||8==r.type?(this.jr.style.display="",this.Vr.input.title=k(100*n(r.pulseWidth))+"%",this.Vr.updateValue(r.pulseWidth)):this.jr.style.display="none",l(r.effects)?(this.Dr.style.display="",wo(this.Cr,r.transition)):this.Dr.style.display="none",c(r.effects)?(this.ca.style.display="",wo(this.la,r.chord)):this.ca.style.display="none",u(r.effects)){this.Yr.style.display="",this.Gr.updateValue(r.pitchShift),this.Gr.input.title=r.pitchShift-e.pitchShiftCenter+" semitone(s)";for(const e of this.Hr)e.style.display=t.showFifth?"":"none"}else this.Yr.style.display="none";p(r.effects)?(this.Qr.style.display="",this.Jr.updateValue(r.detune),this.Jr.input.title=Xe.detuneToCents(r.detune-e.detuneCenter)+" cent(s)"):this.Qr.style.display="none",d(r.effects)?(this.pa.style.display="",wo(this.ua,r.vibrato)):this.pa.style.display="none",f(r.effects)?(this.zr.style.display="",this.Or.render()):this.zr.style.display="none",m(r.effects)?(this.Zr.style.display="",this.Xr.updateValue(r.distortion)):this.Zr.style.display="none",y(r.effects)?(this.ea.style.display="",this.ia.style.display="",this.ta.updateValue(r.bitcrusherQuantization),this.sa.updateValue(r.bitcrusherFreq)):(this.ea.style.display="none",this.ia.style.display="none"),b(r.effects)?(this.Mr.style.display="",this.kr.updateValue(r.pan)):this.Mr.style.display="none",w(r.effects)?(this.Yo.style.display="",this.Ko.updateValue(r.chorus)):this.Yo.style.display="none",g(r.effects)?(this.tr.style.display="",this.Zo.updateValue(r.echoSustain),this.sr.style.display="",this.er.updateValue(r.echoDelay),this.er.input.title=Math.round((r.echoDelay+1)*e.echoDelayStepTicks/(e.ticksPerPart*e.partsPerBeat)*1e3)/1e3+" beat(s)"):(this.tr.style.display="none",this.sr.style.display="none"),v(r.effects)?(this.Xo.style.display="",this.Qo.updateValue(r.reverb)):this.Xo.style.display="none",0==r.type||5==r.type||7==r.type?(this.aa.style.display="",wo(this.ra,r.unison)):this.aa.style.display="none",this.va.render()}else this.Sa.style.display="",this.Ia.style.display="none";for(let t=0;t<e.chords.length;t++){let s=!e.instrumentTypeHasSpecialInterval[r.type]&&e.chords[t].customInterval;const i=this.la.children[t];s?i.hasAttribute("hidden")||i.setAttribute("hidden",""):i.removeAttribute("hidden")}if(this.u.song.layeredInstruments||this.u.song.patternInstruments){this.dr.style.display="",this.pr.style.setProperty("--text-color-lit",M.primaryNote),this.pr.style.setProperty("--text-color-dim",M.secondaryNote),this.pr.style.setProperty("--background-color-lit",M.primaryChannel),this.pr.style.setProperty("--background-color-dim",M.secondaryChannel);const t=this.u.song.getMaxInstrumentsPerChannel();for(;this.lr.length<h.instruments.length;){const t=ao(String(this.lr.length+1));this.lr.push(t),this.pr.insertBefore(t,this.ur)}for(let t=this.Ga;t<h.instruments.length;t++)this.lr[t].style.display="";for(let t=h.instruments.length;t<this.Ga;t++)this.lr[t].style.display="none";for(this.Ga=h.instruments.length;this.lr.length>t;)this.pr.removeChild(this.lr.pop());if(this.ur.style.display=h.instruments.length>e.instrumentCountMin?"":"none",this.cr.style.display=h.instruments.length<t?"":"none",h.instruments.length<t?this.ur.classList.remove("last-button"):this.ur.classList.add("last-button"),h.instruments.length>1){if(this.ja!=o){const t=this.lr[this.ja];null!=t&&t.classList.remove("selected-instrument");this.lr[o].classList.add("selected-instrument"),this.ja=o}}else{const t=this.lr[this.ja];null!=t&&t.classList.remove("selected-instrument"),this.ja=-1}if(this.u.song.layeredInstruments&&this.u.song.patternInstruments){for(let t=0;t<h.instruments.length;t++)-1!=this.u.recentPatternInstruments[this.u.channel].indexOf(t)?this.lr[t].classList.remove("deactivated"):this.lr[t].classList.add("deactivated");this.Ja=!0}else if(this.Ja){for(let t=0;t<h.instruments.length;t++)this.lr[t].classList.remove("deactivated");this.Ja=!1}}else this.dr.style.display="none";if(this.Fa.style.color=M.primaryNote,this.Er.render(),this.gr.updateValue(-r.volume),this.Pa.disabled=r.envelopeCount>=e.maxEnvelopeCount,this.Uo.value=String(t.volume),a&&null!=x&&0==x.clientWidth&&this.sl(),this.nl(this.u.prompt),t.autoFollow&&!this.u.synth.playing&&this.u.synth.goToBar(this.u.bar),this.u.addedEffect){const t=this.Pa.getBoundingClientRect(),e=this.Ua.getBoundingClientRect(),s=this.qa.getBoundingClientRect();this.Ua.scrollTop+=Math.max(0,t.top-(e.top+e.height)),this.qa.scrollTop+=Math.max(0,t.top-(s.top+s.height)),this.u.addedEffect=!1}this.u.addedEnvelope&&(this.Ua.scrollTop=this.Ua.scrollHeight,this.qa.scrollTop=this.qa.scrollHeight,this.u.addedEnvelope=!1)},this.updatePlayButton=()=>{this.Wa==this.u.synth.playing&&this.Ha==this.u.synth.recording&&this.Ka==this.u.prefs.showRecordButton&&this.Ya==this.Se||(this.Wa=this.u.synth.playing,this.Ha=this.u.synth.recording,this.Ka=this.u.prefs.showRecordButton,this.Ya=this.Se,document.activeElement!=this.No&&document.activeElement!=this.Oo&&document.activeElement!=this.zo&&document.activeElement!=this.Ro||this.sl(),this.No.style.display="none",this.Oo.style.display="none",this.zo.style.display="none",this.Ro.style.display="none",this.Ao.style.display="",this.$o.style.display="",this.No.classList.remove("shrunk"),this.zo.classList.remove("shrunk"),this.Da.style.pointerEvents="",this.To.container.style.pointerEvents="",this.To.container.style.opacity="",this.Ea.style.pointerEvents="",this.Do.container.style.opacity="",this.Ua.style.pointerEvents="",this.Ua.style.opacity="",this.Aa.style.pointerEvents="",this.Aa.style.opacity="",this.$a.style.pointerEvents="",this.$a.style.opacity="",this.u.synth.recording?(this.Ro.style.display="",this.Ao.style.display="none",this.$o.style.display="none",this.Da.style.pointerEvents="none",this.To.container.style.pointerEvents="none",this.To.container.style.opacity="0.5",this.Ea.style.pointerEvents="none",this.Do.container.style.opacity="0.5",this.Ua.style.pointerEvents="none",this.Ua.style.opacity="0.5",this.Aa.style.pointerEvents="none",this.Aa.style.opacity="0.5",this.$a.style.pointerEvents="none",this.$a.style.opacity="0.5"):this.u.synth.playing?this.Oo.style.display="":this.u.prefs.showRecordButton?(this.No.style.display="",this.zo.style.display="",this.No.classList.add("shrunk"),this.zo.classList.add("shrunk")):this.Se?this.zo.style.display="":this.No.style.display=""),window.requestAnimationFrame(this.updatePlayButton)},this.hl=t=>{this.u.barScrollPos=this.Oa.scrollLeft/this.u.getBarWidth()},this.ol=t=>!t.ctrlKey||(t.preventDefault(),!1),this.rl=t=>{switch(t.keyCode){case 8:case 13:case 38:case 40:case 37:case 39:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:t.stopPropagation()}},this.P=t=>{if(this.Se=t.ctrlKey,this.prompt)return void(27==t.keyCode&&this.u.undo());if(this.u.synth.recording)return t.ctrlKey||t.metaKey||this.uo.handleKeyEvent(t,!0),void((32==t.keyCode||80==t.keyCode&&(t.ctrlKey||t.metaKey))&&(this.al(),t.preventDefault(),this.sl()));const s=this.u.prefs.pressControlForShortcuts!=t.getModifierState("CapsLock"),i=!t.ctrlKey&&!t.metaKey&&s;switch(i&&this.uo.handleKeyEvent(t,!0),t.keyCode){case 27:t.ctrlKey||t.metaKey||(new _i(this.u,0,0),this.u.selection.resetBoxSelection());break;case 32:t.ctrlKey?this.al():t.shiftKey?(this.Co.movePlayheadToMouse()||this.Fo.movePlayheadToMouse())&&(this.u.synth.playing||this.u.performance.play()):this.ll(),t.preventDefault(),this.sl();break;case 80:if(i)break;(t.ctrlKey||t.metaKey)&&(this.al(),t.preventDefault(),this.sl());break;case 90:if(i)break;t.shiftKey?this.u.redo():this.u.undo(),t.preventDefault();break;case 89:if(i)break;this.u.redo(),t.preventDefault();break;case 67:if(i)break;t.shiftKey?this.cl():this.u.selection.copy(),t.preventDefault();break;case 13:t.ctrlKey||t.metaKey?this.u.selection.insertChannel():this.u.selection.insertBars(),t.preventDefault();break;case 8:t.ctrlKey||t.metaKey?this.u.selection.deleteChannel():this.u.selection.deleteBars(),t.preventDefault();break;case 65:if(i)break;t.shiftKey?this.u.selection.selectChannel():this.u.selection.selectAll(),t.preventDefault();break;case 68:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.selection.duplicatePatterns(),t.preventDefault());break;case 70:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.synth.snapToStart(),this.u.prefs.autoFollow&&this.u.selection.setChannelBar(this.u.channel,Math.floor(this.u.synth.playhead)),t.preventDefault());break;case 72:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.synth.goToBar(this.u.bar),this.u.synth.snapToBar(),this.u.prefs.autoFollow&&this.u.selection.setChannelBar(this.u.channel,Math.floor(this.u.synth.playhead)),t.preventDefault());break;case 77:if(i)break;s==(t.ctrlKey||t.metaKey)&&this.u.prefs.enableChannelMuting&&(this.u.selection.muteChannels(t.shiftKey),t.preventDefault());break;case 81:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.Jo("channelSettings"),t.preventDefault());break;case 83:if(i)break;t.ctrlKey||t.metaKey?ht.includes("export")&&(this.Jo("export"),t.preventDefault()):this.u.prefs.enableChannelMuting&&(this.u.selection.soloChannels(t.shiftKey),t.preventDefault());break;case 79:if(i)break;(t.ctrlKey||t.metaKey)&&ht.includes("import")&&(this.Jo("import"),t.preventDefault());break;case 86:if(i)break;(t.ctrlKey||t.metaKey)&&t.shiftKey&&!s?this.u.selection.pasteNumbers():t.shiftKey?this.ul():this.u.selection.pasteNotes(),t.preventDefault();break;case 73:if(i)break;if(s==(t.ctrlKey||t.metaKey)&&t.shiftKey){const s=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()].toJsonObject();delete s.preset,delete s.volume,delete s.pan;const i=s.effects.indexOf(e.effectNames[2]);-1!=i&&s.effects.splice(i,1);for(let t=0;t<s.envelopes.length;t++){const e=s.envelopes[t];"panning"!=e.target&&"none"!=e.target&&"none"!=e.envelope||(s.envelopes.splice(t,1),t--)}this.pl(JSON.stringify(s)),t.preventDefault()}break;case 82:if(i)break;s==(t.ctrlKey||t.metaKey)&&(t.shiftKey?this.dl():this.fl(),t.preventDefault());break;case 219:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.synth.goToPrevBar(),this.u.prefs.autoFollow&&this.u.selection.setChannelBar(this.u.channel,Math.floor(this.u.synth.playhead)),t.preventDefault());break;case 221:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.synth.goToNextBar(),this.u.prefs.autoFollow&&this.u.selection.setChannelBar(this.u.channel,Math.floor(this.u.synth.playhead)),t.preventDefault());break;case 189:case 173:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.selection.transpose(!1,t.shiftKey),t.preventDefault());break;case 187:case 61:case 171:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.selection.transpose(!0,t.shiftKey),t.preventDefault());break;case 38:t.ctrlKey||t.metaKey?this.u.selection.swapChannels(-1):t.shiftKey?(this.u.selection.boxSelectionY1=Math.max(0,this.u.selection.boxSelectionY1-1),this.u.selection.scrollToEndOfSelection(),this.u.selection.selectionUpdated()):(this.u.selection.setChannelBar((this.u.channel-1+this.u.song.getChannelCount())%this.u.song.getChannelCount(),this.u.bar),this.u.selection.resetBoxSelection()),t.preventDefault();break;case 40:t.ctrlKey||t.metaKey?this.u.selection.swapChannels(1):t.shiftKey?(this.u.selection.boxSelectionY1=Math.min(this.u.song.getChannelCount()-1,this.u.selection.boxSelectionY1+1),this.u.selection.scrollToEndOfSelection(),this.u.selection.selectionUpdated()):(this.u.selection.setChannelBar((this.u.channel+1)%this.u.song.getChannelCount(),this.u.bar),this.u.selection.resetBoxSelection()),t.preventDefault();break;case 37:t.shiftKey?(this.u.selection.boxSelectionX1=Math.max(0,this.u.selection.boxSelectionX1-1),this.u.selection.scrollToEndOfSelection(),this.u.selection.selectionUpdated()):(this.u.selection.setChannelBar(this.u.channel,(this.u.bar+this.u.song.barCount-1)%this.u.song.barCount),this.u.selection.resetBoxSelection()),t.preventDefault();break;case 39:t.shiftKey?(this.u.selection.boxSelectionX1=Math.min(this.u.song.barCount-1,this.u.selection.boxSelectionX1+1),this.u.selection.scrollToEndOfSelection(),this.u.selection.selectionUpdated()):(this.u.selection.setChannelBar(this.u.channel,(this.u.bar+1)%this.u.song.barCount),this.u.selection.resetBoxSelection()),t.preventDefault();break;case 48:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.selection.nextDigit("0",t.shiftKey),t.preventDefault());break;case 49:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.selection.nextDigit("1",t.shiftKey),t.preventDefault());break;case 50:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.selection.nextDigit("2",t.shiftKey),t.preventDefault());break;case 51:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.selection.nextDigit("3",t.shiftKey),t.preventDefault());break;case 52:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.selection.nextDigit("4",t.shiftKey),t.preventDefault());break;case 53:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.selection.nextDigit("5",t.shiftKey),t.preventDefault());break;case 54:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.selection.nextDigit("6",t.shiftKey),t.preventDefault());break;case 55:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.selection.nextDigit("7",t.shiftKey),t.preventDefault());break;case 56:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.selection.nextDigit("8",t.shiftKey),t.preventDefault());break;case 57:if(i)break;s==(t.ctrlKey||t.metaKey)&&(this.u.selection.nextDigit("9",t.shiftKey),t.preventDefault());break;default:this.u.selection.digits="",this.u.selection.instrumentDigits=""}i&&(this.u.selection.digits="",this.u.selection.instrumentDigits="")},this.ml=t=>{this.Se=t.ctrlKey,this.uo.handleKeyEvent(t,!1)},this.yl=()=>{this.u.synth.goToPrevBar()},this.bl=()=>{this.u.synth.goToNextBar()},this.ll=()=>{this.u.synth.playing?this.u.performance.pause():(this.u.synth.snapToBar(),this.u.performance.play())},this.al=()=>{this.u.synth.playing?this.u.performance.pause():this.u.performance.record()},this.wl=()=>{this.u.setVolume(Number(this.Uo.value))},this.cl=()=>{const t=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()].toJsonObject();t.isDrum=this.u.song.getChannelIsNoise(this.u.channel),window.localStorage.setItem("instrumentCopy",JSON.stringify(t)),this.sl()},this.ul=()=>{const t=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()],e=JSON.parse(String(window.localStorage.getItem("instrumentCopy")));null!=e&&e.isDrum==this.u.song.getChannelIsNoise(this.u.channel)&&this.u.record(new ui(this.u,t,e)),this.sl()},this.gl=()=>{this.u.record(new Ci(this.u,-1,0|parseInt(this.Ho.value)))},this.vl=()=>{if(isNaN(this.jo.value)){if("forceScale"===this.jo.value)this.u.selection.forceScale();this.u.notifier.changed()}else this.u.record(new xi(this.u,this.jo.selectedIndex))},this.xl=()=>{if(isNaN(this.Go.value)){if("detectKey"===this.Go.value)this.u.record(new ki(this.u));this.u.notifier.changed()}else this.u.record(new hi(this.u,e.keys.length-1-this.Go.selectedIndex))},this.kl=()=>{if(isNaN(this.ir.value)){if("forceRhythm"===this.ir.value)this.u.selection.forceRhythm();this.u.notifier.changed()}else this.u.record(new li(this.u,this.ir.selectedIndex))},this.Ml=()=>{this.Sl(this.nr.value)},this.Pl=()=>{this.Sl(this.hr.value)},this.Il=()=>{this.u.record(new Qs(this.u,this.fa.selectedIndex))},this.Fl=()=>{this.u.record(new Js(this.u,this.rr.selectedIndex))},this.Bl=t=>{if(t.target==this.cr)this.u.record(new ei(this.u));else if(t.target==this.ur)this.u.record(new si(this.u));else{const e=this.lr.indexOf(t.target);-1!=e&&this.u.selection.selectInstrument(e)}this.sl()},this.Ll=()=>{this.u.record(new ms(this.u))},this.Cl=()=>{this.u.record(new Yi(this.u,this.Sr.selectedIndex))},this.Dl=()=>{this.u.record(new Ji(this.u,this.Pr.selectedIndex))},this.Tl=()=>{this.u.record(new ws(this.u,this.Cr.selectedIndex))},this.El=()=>{const t=this.u.song.channels[this.u.channel].instruments[this.u.getCurrentInstrument()],s=t.effects,i=e.effectOrder[this.Tr.selectedIndex-1];this.u.record(new gs(this.u,i)),this.Tr.selectedIndex=0,t.effects>s&&(this.u.addedEffect=!0)},this.Nl=()=>{this.u.record(new Ds(this.u,this.ua.selectedIndex))},this.Ol=()=>{this.u.record(new Ls(this.u,this.ra.selectedIndex))},this.zl=()=>{this.u.record(new Cs(this.u,this.la.selectedIndex))},this.Rl=()=>{this.u.record(new Qi(this.u)),this.sl(),this.u.addedEnvelope=!0},this.Al=()=>{this.u.prefs.visibleOctaves=Math.max(1,this.u.prefs.visibleOctaves-1),this.u.prefs.save(),this.u.notifier.changed(),this.sl()},this.$l=()=>{this.u.prefs.visibleOctaves=Math.min(e.pitchOctaves,this.u.prefs.visibleOctaves+1),this.u.prefs.save(),this.u.notifier.changed(),this.sl()},this.Ul=t=>{switch(this.qo.value){case"new":this.u.goBackToStart();for(const t of this.u.song.channels)t.muted=!1;this.u.record(new Pi(this.u,""),!1,!0);break;case"export":this.Jo("export");break;case"import":this.Jo("import");break;case"copyUrl":this.pl(new URL("#"+this.u.song.toBase64String(),location.href).href);break;case"shareUrl":navigator.share({url:new URL("#"+this.u.song.toBase64String(),location.href).href});break;case"shortenUrl":window.open("https://tinyurl.com/api-create.php?url="+encodeURIComponent(new URL("#"+this.u.song.toBase64String(),location.href).href));break;case"viewPlayer":location.href="player/#song="+this.u.song.toBase64String();break;case"copyEmbed":this.pl(`<iframe width="384" height="60" style="border: none;" src="${new URL("player/#song="+this.u.song.toBase64String(),location.href).href}"></iframe>`);break;case"songRecovery":this.Jo("songRecovery")}this.qo.selectedIndex=0},this.ql=t=>{switch(this._o.value){case"undo":this.u.undo();break;case"redo":this.u.redo();break;case"copy":this.u.selection.copy();break;case"insertBars":this.u.selection.insertBars();break;case"deleteBars":this.u.selection.deleteBars();break;case"insertChannel":this.u.selection.insertChannel();break;case"deleteChannel":this.u.selection.deleteChannel();break;case"pasteNotes":this.u.selection.pasteNotes();break;case"pasteNumbers":this.u.selection.pasteNumbers();break;case"transposeUp":this.u.selection.transpose(!0,!1);break;case"transposeDown":this.u.selection.transpose(!1,!1);break;case"selectAll":this.u.selection.selectAll();break;case"selectChannel":this.u.selection.selectChannel();break;case"duplicatePatterns":this.u.selection.duplicatePatterns();break;case"barCount":this.Jo("barCount");break;case"beatsPerBar":this.Jo("beatsPerBar");break;case"moveNotesSideways":this.Jo("moveNotesSideways");break;case"channelSettings":this.Jo("channelSettings")}this._o.selectedIndex=0},this._l=t=>{switch(this.Vo.value){case"autoPlay":this.u.prefs.autoPlay=!this.u.prefs.autoPlay;break;case"autoFollow":this.u.prefs.autoFollow=!this.u.prefs.autoFollow;break;case"enableNotePreview":this.u.prefs.enableNotePreview=!this.u.prefs.enableNotePreview;break;case"showLetters":this.u.prefs.showLetters=!this.u.prefs.showLetters;break;case"showFifth":this.u.prefs.showFifth=!this.u.prefs.showFifth;break;case"notesOutsideScale":this.u.prefs.notesOutsideScale=!this.u.prefs.notesOutsideScale;break;case"setDefaultScale":this.u.prefs.defaultScale=this.u.song.scale;break;case"showChannels":this.u.prefs.showChannels=!this.u.prefs.showChannels;break;case"showScrollBar":this.u.prefs.showScrollBar=!this.u.prefs.showScrollBar;break;case"alwaysShowSettings":this.u.prefs.alwaysShowSettings=!this.u.prefs.alwaysShowSettings;break;case"instrumentCopyPaste":this.u.prefs.instrumentCopyPaste=!this.u.prefs.instrumentCopyPaste;break;case"enableChannelMuting":this.u.prefs.enableChannelMuting=!this.u.prefs.enableChannelMuting;for(const t of this.u.song.channels)t.muted=!1;break;case"displayBrowserUrl":this.u.toggleDisplayBrowserUrl();break;case"layout":this.Jo("layout");break;case"recordingSetup":this.Jo("recordingSetup");break;case"colorTheme":this.Jo("colorTheme")}this.Vo.selectedIndex=0,this.u.notifier.changed(),this.u.prefs.save()},this.u.notifier.watch(this.whenUpdated),new Bn(this.u),window.addEventListener("resize",this.whenUpdated),window.requestAnimationFrame(this.updatePlayButton),"share"in navigator||this.qo.removeChild(this.qo.querySelector("[value='shareUrl']")),this.jo.appendChild(fo({label:"Edit"},mo({value:"forceScale"},"Snap Notes To Scale"))),this.Go.appendChild(fo({label:"Edit"},mo({value:"detectKey"},"Detect Key"))),this.ir.appendChild(fo({label:"Edit"},mo({value:"forceRhythm"},"Snap Notes To Rhythm"))),this.da.appendChild(lo({class:"selectRow",style:`color: ${_.secondaryText}; height: 1em; margin-top: 0.5em;`},lo({style:"margin-right: .1em; visibility: hidden;"},"1."),lo({style:"width: 3em; margin-right: .3em;",class:"tip",onclick:()=>this.Jo("operatorFrequency")},"Freq:"),lo({class:"tip",onclick:()=>this.Jo("operatorVolume")},"Volume:")));for(let t=0;t<e.operatorCount;t++){const s=t,i=lo({style:`margin-right: .1em; color: ${_.secondaryText};`},t+1+"."),n=yo(uo({style:"width: 100%;",title:"Frequency"}),e.operatorFrequencies.map((t=>t.name))),h=new go(co({type:"range",min:"0",max:e.operatorAmplitudeMax,value:"0",step:"1",title:"Volume"}),this.u,((t,e)=>new Zs(this.u,s,t,e))),o=lo({class:"selectRow"},i,lo({class:"selectContainer",style:"width: 3em; margin-right: .3em;"},n),h.input);this.da.appendChild(o),this.Qa[t]=o,this.Xa[t]=h,this.Za[t]=n,n.addEventListener("change",(()=>{this.u.record(new Xs(this.u,s,n.selectedIndex))}))}this.xa.appendChild(lo({class:"selectRow"},po({class:"tip",onclick:()=>this.Jo("drumsetEnvelope")},"Envelope:"),po({class:"tip",onclick:()=>this.Jo("drumsetSpectrum")},"Spectrum:")));for(let t=e.drumCount-1;t>=0;t--){const s=t,i=new gn(this.u,s);i.container.addEventListener("mousedown",this.sl),this.tl[t]=i;const n=yo(uo({style:"width: 100%;",title:"Filter Envelope"}),e.envelopes.map((t=>t.name)));this.el[t]=n,n.addEventListener("change",(()=>{this.u.record(new Ns(this.u,s,n.selectedIndex))}));const h=lo({class:"selectRow"},lo({class:"selectContainer",style:"width: 5em; margin-right: .3em;"},n),this.tl[t].container);this.xa.appendChild(h)}if(this.qo.addEventListener("change",this.Ul),this._o.addEventListener("change",this.ql),this.Vo.addEventListener("change",this._l),this.Ho.addEventListener("change",this.gl),this.jo.addEventListener("change",this.vl),this.Go.addEventListener("change",this.xl),this.ir.addEventListener("change",this.kl),this.nr.addEventListener("change",this.Ml),this.hr.addEventListener("change",this.Pl),this.rr.addEventListener("change",this.Fl),this.pr.addEventListener("click",this.Bl),this.mr.addEventListener("click",this.cl),this.yr.addEventListener("click",this.ul),this.Sa.addEventListener("click",this.Ll),this.fa.addEventListener("change",this.Il),this.Sr.addEventListener("change",this.Cl),this.Pr.addEventListener("change",this.Dl),this.Cr.addEventListener("change",this.Tl),this.Tr.addEventListener("change",this.El),this.ra.addEventListener("change",this.Ol),this.la.addEventListener("change",this.zl),this.ua.addEventListener("change",this.Nl),this.No.addEventListener("click",this.ll),this.Oo.addEventListener("click",this.ll),this.zo.addEventListener("click",this.al),this.Ro.addEventListener("click",this.al),this.zo.addEventListener("contextmenu",(t=>{t.ctrlKey&&(t.preventDefault(),this.al())})),this.Ro.addEventListener("contextmenu",(t=>{t.ctrlKey&&(t.preventDefault(),this.al())})),this.Ao.addEventListener("click",this.yl),this.$o.addEventListener("click",this.bl),this.Uo.addEventListener("input",this.wl),this.La.addEventListener("click",this.Al),this.Ca.addEventListener("click",this.$l),this.Ta.addEventListener("mousedown",this.sl),this.Ra.addEventListener("mousedown",this.sl),this.Br.container.addEventListener("mousedown",this.sl),this.ya.container.addEventListener("mousedown",this.sl),this.Er.container.addEventListener("mousedown",this.sl),this.Or.container.addEventListener("mousedown",this.sl),this.wa.container.addEventListener("mousedown",this.sl),this.Ho.addEventListener("keydown",this.rl,!1),this.Pa.addEventListener("click",this.Rl),this.Ta.addEventListener("contextmenu",this.ol),this.Ra.addEventListener("contextmenu",this.ol),this.mainLayer.addEventListener("keydown",this.P),this.mainLayer.addEventListener("keyup",this.ml),this.mainLayer.addEventListener("focusin",this.il),this.Ba.addEventListener("click",(t=>{t.target==this.Ba&&this.u.undo()})),this.Oa.addEventListener("scroll",this.hl,{capture:!1,passive:!0}),x){const t=this.Vo.querySelector("[value=autoPlay]");t.disabled=!0,t.setAttribute("hidden","")}if(window.screen.availWidth<710||window.screen.availHeight<710){const t=this.Vo.querySelector("[value=layout]");t.disabled=!0,t.setAttribute("hidden","")}}Jo(t){this.u.openPrompt(t),this.nl(t)}nl(t){if(this.Va!=t&&(this.Va=t,this.prompt&&(this._a&&!(this.prompt instanceof is||this.prompt instanceof ch)&&this.u.performance.play(),this._a=!1,this.Ba.style.display="none",this.Ba.removeChild(this.prompt.container),this.prompt.cleanUp(),this.prompt=null,this.sl()),t)){switch(t){case"export":this.prompt=new Bh(this.u);break;case"import":this.prompt=new Oh(this.u);break;case"songRecovery":this.prompt=new Qh(this.u);break;case"barCount":this.prompt=new ih(this.u);break;case"beatsPerBar":this.prompt=new $n(this.u);break;case"moveNotesSideways":this.prompt=new Kn(this.u);break;case"channelSettings":this.prompt=new bh(this.u);break;case"layout":this.prompt=new bn(this.u);break;case"colorTheme":this.prompt=new be(this.u);break;case"recordingSetup":this.prompt=new ro(this.u);break;case"stringSustain":this.prompt=new ch(this.u);break;default:this.prompt=new is(this.u,t)}this.prompt&&(this.prompt instanceof is||this.prompt instanceof ch||(this._a=this.u.synth.playing,this.u.performance.pause()),this.Ba.style.display="",this.Ba.appendChild(this.prompt.container))}}pl(t){if(navigator.clipboard&&navigator.clipboard.writeText)return void navigator.clipboard.writeText(t).catch((()=>{window.prompt("Copy to clipboard:",t)}));const e=document.createElement("textarea");e.textContent=t,document.body.appendChild(e),e.select();const s=document.execCommand("copy");e.remove(),this.sl(),s||window.prompt("Copy this:",t)}fl(){const t=this.u.song.getChannelIsNoise(this.u.channel);this.u.record(new ys(this.u,Mi(t)))}dl(){this.u.record(new bs(this.u))}Sl(t){if(isNaN(t)){switch(t){case"copyInstrument":this.cl();break;case"pasteInstrument":this.ul();break;case"randomPreset":this.fl();break;case"randomGenerated":this.dl()}this.u.notifier.changed()}else this.u.record(new ys(this.u,parseInt(t)))}}class xo{constructor(t){this.u=t,this.Vl=!1,this.jl=-1,this.Gl=-1,this.Wl=!1,this.Hl=[],this.Kl=-1,this.Yl=-1,this.Jl=null,this.Ql=!1,this.Xl=null,this.Zl=null,this.Sh=()=>{if(window.requestAnimationFrame(this.Sh),this.u.synth.recording){this.tc()&&this.u.notifier.notifyWatchers()}},this.kn=()=>{const t=this.u.song.getChannelIsNoise(this.u.channel),e=this.u.song.channels[this.u.channel].octave;this.u.synth.liveInputChannel==this.u.channel&&this.Vl==t&&this.jl==e&&this.Gl==this.u.song.key||(this.u.synth.liveInputChannel=this.u.channel,this.Vl=t,this.jl=e,this.Gl=this.u.song.key,this.clearAllPitches()),this.u.synth.liveInputInstruments=this.u.recentPatternInstruments[this.u.channel]},this.u.notifier.watch(this.kn),this.kn(),window.requestAnimationFrame(this.Sh)}play(){this.u.synth.play(),this.u.synth.enableMetronome=!1,this.u.synth.countInMetronome=!1,this.u.synth.maintainLiveInput()}pause(){this.clearAllPitches(),null!=this.Zl&&(this.u.song.barCount>this.Kl&&!this.ec()&&(new Ms(this.u,this.u.song.barCount-1,1),new Bs(this.u,this.u.channel,this.u.song.barCount-1)),this.Zl.isNoop()||(this.u.record(this.Zl),this.Zl=null),this.Xl=null),this.u.synth.pause(),this.u.synth.resetEffects(),this.u.synth.enableMetronome=!1,this.u.synth.countInMetronome=!1,this.u.prefs.autoFollow&&this.u.synth.goToBar(this.u.bar),this.u.synth.snapToBar()}record(){this.u.synth.snapToBar();const t=Math.floor(this.u.synth.playhead);t!=this.u.bar&&new Bs(this.u,this.u.channel,t),this.Wl&&(this.clearAllPitches(),this.Wl=!1),this.u.synth.enableMetronome=this.u.prefs.metronomeWhileRecording,this.u.synth.countInMetronome=this.u.prefs.metronomeCountIn,this.u.synth.startRecording(),this.u.synth.maintainLiveInput(),this.Kl=this.u.song.barCount,this.Yl=this.sc(),this.Jl=null,this.Ql=!1,this.Xl=null,this.Hl.length=0,this.Zl=new os,this.u.setProspectiveChange(this.Zl)}abortRecording(){this.Zl=null,this.pause()}pitchesAreTemporary(){return this.Wl}ws(){return this.u.prefs.snapRecordedNotesToRhythm?e.partsPerBeat/e.rhythms[this.u.song.rhythm].stepsPerBeat:1}sc(){const t=this.u.synth.playhead*this.u.song.beatsPerBar*e.partsPerBeat;if(this.u.prefs.snapRecordedNotesToRhythm){const e=this.ws();return Math.round(t/e)*e}return Math.round(t)}ec(){for(let t=0;t<this.u.song.getChannelCount();t++)if(0!=this.u.song.channels[t].bars[this.u.song.barCount-1])return!0;return!1}tc(){if(null==this.Zl)return!1;if(!this.u.lastChangeWas(this.Zl))return this.abortRecording(),!1;if(this.u.synth.countInMetronome)return this.Hl.length=0,this.Ql=!1,!1;const t=this.u.song.beatsPerBar*e.partsPerBeat,s=this.Yl%t,i=Math.floor(this.Yl/t),n=this.Yl;this.Yl=this.sc();const h=this.Yl%t,o=Math.floor(this.Yl/t);if(s==h&&i==o)return!1;if(this.Yl<n)return this.Xl=null,this.Jl=null,!1;let r=!1;for(let n=i;n<=o;n++){n!=i&&(this.Jl=null);const a=n==i?s:0,l=n==o?h:t;if(a==l)break;if(null!=this.Xl&&!this.Ql&&a>0&&this.u.synth.liveInputPitches.length>0)this.Zl.append(new mi(this.u,this.Xl,1,l,this.Xl.continuesLastPattern)),this.u.currentPatternIsDirty=!0;else{null!=this.Xl&&(this.Xl=null);let t=a,s=l;for(;t<l;){let i=!1;if(this.Hl.length>0||this.u.synth.liveInputPitches.length>0){if(null==this.Jl&&(this.u.selection.erasePatternInBar(this.Zl,this.u.synth.liveInputChannel,n),this.Zl.append(new fi(this.u,this.u.synth.liveInputChannel,n)),this.Jl=this.u.song.getPattern(this.u.synth.liveInputChannel,n)),null==this.Jl)throw new Error;for(this.Xl=new Ne(-1,t,s,e.noteSizeMax,this.u.song.getChannelIsNoise(this.u.synth.liveInputChannel)),this.Xl.continuesLastPattern=0==t&&!this.Ql,this.Xl.pitches.length=0;this.Hl.length>0&&!(this.Xl.pitches.length>=e.maxChordSize);){const t=this.Hl.shift();-1==this.u.synth.liveInputPitches.indexOf(t)&&(this.Xl.pitches.push(t),i=!0)}for(let t=0;t<this.u.synth.liveInputPitches.length&&!(this.Xl.pitches.length>=e.maxChordSize);t++)this.Xl.pitches.push(this.u.synth.liveInputPitches[t]);this.Zl.append(new Oi(this.u,this.Jl,this.Xl,this.Jl.notes.length)),i&&(s=t+this.ws(),new zi(this.u,this.Xl,this.Xl.start,s),this.Xl=null),r=!0}this.Ql=i,t=s,s=l}}n==this.u.song.barCount-1&&this.ec()&&(new ks(this.u,this.u.song.barCount,1),this.u.bar--,r=!0)}return r}setTemporaryPitches(t,s){this.tc();for(let e=0;e<t.length;e++)this.u.synth.liveInputPitches[e]=t[e];this.u.synth.liveInputPitches.length=Math.min(t.length,e.maxChordSize),this.u.synth.liveInputDuration=s,this.u.synth.liveInputStarted=!0,this.Wl=!0,this.Ql=!0}addPerformedPitch(t){if(this.u.synth.maintainLiveInput(),this.tc(),this.Wl&&(this.clearAllPitches(),this.Wl=!1),(!this.u.prefs.ignorePerformedNotesNotInScale||e.scales[this.u.song.scale].flags[t%e.pitchesPerOctave])&&-1==this.u.synth.liveInputPitches.indexOf(t)){for(this.u.synth.liveInputPitches.push(t),this.Ql=!0;this.u.synth.liveInputPitches.length>e.maxChordSize;)this.u.synth.liveInputPitches.shift();if(this.u.synth.liveInputDuration=Number.MAX_SAFE_INTEGER,null!=this.Zl){const s=this.Hl.indexOf(t);for(-1!=s&&this.Hl.splice(s,1),this.Hl.push(t);this.Hl.length>4*e.maxChordSize;)this.Hl.shift()}}}removePerformedPitch(t){this.tc();for(let e=0;e<this.u.synth.liveInputPitches.length;e++)this.u.synth.liveInputPitches[e]==t&&(this.u.synth.liveInputPitches.splice(e,1),this.Ql=!0,e--)}clearAllPitches(){this.tc(),this.u.synth.liveInputPitches.length=0,this.Ql=!0}}class ko{constructor(t){this.u=t,this.boxSelectionX0=0,this.boxSelectionY0=0,this.boxSelectionX1=0,this.boxSelectionY1=0,this.digits="",this.instrumentDigits="",this.patternSelectionStart=0,this.patternSelectionEnd=0,this.patternSelectionActive=!1,this.ic=null,this.nc=null,this.hc=null,this.oc=null}toJSON(){return{x0:this.boxSelectionX0,x1:this.boxSelectionX1,y0:this.boxSelectionY0,y1:this.boxSelectionY1,start:this.patternSelectionStart,end:this.patternSelectionEnd}}fromJSON(t){null!=t&&(this.boxSelectionX0=+t.x0,this.boxSelectionX1=+t.x1,this.boxSelectionY0=+t.y0,this.boxSelectionY1=+t.y1,this.patternSelectionStart=+t.start,this.patternSelectionEnd=+t.end,this.digits="",this.instrumentDigits="",this.patternSelectionActive=this.patternSelectionStart<this.patternSelectionEnd)}selectionUpdated(){this.u.notifier.changed(),this.digits="",this.instrumentDigits=""}get boxSelectionBar(){return Math.min(this.boxSelectionX0,this.boxSelectionX1)}get boxSelectionChannel(){return Math.min(this.boxSelectionY0,this.boxSelectionY1)}get boxSelectionWidth(){return Math.abs(this.boxSelectionX0-this.boxSelectionX1)+1}get boxSelectionHeight(){return Math.abs(this.boxSelectionY0-this.boxSelectionY1)+1}get boxSelectionActive(){return this.boxSelectionWidth>1||this.boxSelectionHeight>1}scrollToSelectedPattern(){this.u.barScrollPos=Math.min(this.u.bar,Math.max(this.u.bar-(this.u.trackVisibleBars-1),this.u.barScrollPos)),this.u.channelScrollPos=Math.min(this.u.channel,Math.max(this.u.channel-(this.u.trackVisibleChannels-1),this.u.channelScrollPos))}scrollToEndOfSelection(){this.u.barScrollPos=Math.min(this.boxSelectionX1,Math.max(this.boxSelectionX1-(this.u.trackVisibleBars-1),this.u.barScrollPos)),this.u.channelScrollPos=Math.min(this.boxSelectionY1,Math.max(this.boxSelectionY1-(this.u.trackVisibleChannels-1),this.u.channelScrollPos))}setChannelBar(t,e){if(t==this.u.channel&&e==this.u.bar)return;const s=this.u.lastChangeWas(this.hc);this.hc=new os,this.hc.append(new Bs(this.u,t,e));const i=this.u.getCurrentPattern(0);null!=i&&this.u.song.patternInstruments&&-1==i.instruments.indexOf(this.u.viewedInstrument[this.u.channel])&&(this.u.viewedInstrument[this.u.channel]=i.instruments[0]),this.u.hasRedoHistory()||this.u.record(this.hc,s),this.selectionUpdated()}setPattern(t){this.u.record(new vs(this.u,t,this.boxSelectionBar,this.boxSelectionChannel,this.boxSelectionWidth,this.boxSelectionHeight))}nextDigit(t,e){const s=this.u.song.channels[this.u.channel];if(e){"0"==t&&(t="10"),this.instrumentDigits+=t;var i=parseInt(this.instrumentDigits);if(0!=i&&i<=s.instruments.length)return void this.selectInstrument(i-1);if(this.instrumentDigits=t,0!=(i=parseInt(this.instrumentDigits))&&i<=s.instruments.length)return void this.selectInstrument(i-1);this.instrumentDigits=""}else{this.digits.length>0&&this.digits!=String(s.bars[this.boxSelectionBar])&&(this.digits=""),this.digits+=t;let e=parseInt(this.digits);if(e<=this.u.song.patternsPerChannel)return void this.setPattern(e);if(this.digits=t,e=parseInt(this.digits),e<=this.u.song.patternsPerChannel)return void this.setPattern(e);this.digits=""}}insertBars(){this.u.record(new ks(this.u,this.boxSelectionBar+this.boxSelectionWidth,this.boxSelectionWidth));const t=this.boxSelectionWidth;this.boxSelectionX0+=t,this.boxSelectionX1+=t}insertChannel(){const t=new os,e=this.boxSelectionChannel+this.boxSelectionHeight,s=this.u.song.getChannelIsNoise(e-1);t.append(new Is(this.u,e,s)),t.isNoop()||(this.boxSelectionY0=this.boxSelectionY1=e,t.append(new Bs(this.u,e,this.u.bar)),this.u.record(t))}deleteBars(){const t=new os;if(this.u.selection.patternSelectionActive){this.boxSelectionActive&&t.append(new ji(this.u,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const e of this.rc())for(const s of this.ac(e))t.append(new Ri(this.u,s,this.u.selection.patternSelectionStart,this.u.selection.patternSelectionEnd));t.append(new _i(this.u,0,0))}else{t.append(new Ms(this.u,this.boxSelectionBar,this.boxSelectionWidth));const e=this.boxSelectionWidth;this.boxSelectionX0=Math.max(0,this.boxSelectionX0-e),this.boxSelectionX1=Math.max(0,this.boxSelectionX1-e)}this.u.record(t)}deleteChannel(){this.u.record(new Fs(this.u,this.boxSelectionChannel,this.boxSelectionChannel+this.boxSelectionHeight-1)),this.boxSelectionY0=this.boxSelectionY1=this.u.channel}*rc(){for(let t=this.boxSelectionChannel;t<this.boxSelectionChannel+this.boxSelectionHeight;t++)yield t}*lc(){for(let t=this.boxSelectionBar;t<this.boxSelectionBar+this.boxSelectionWidth;t++)yield t}*ac(t){const e={};for(const s of this.lc()){const i=this.u.song.channels[t].bars[s];if(0==i)continue;if(e[String(i)])continue;e[String(i)]=!0;const n=this.u.song.getPattern(t,s);if(null==n)throw new Error;yield n}}cc(t,e){const s=Array.from(t.instruments).map((t=>t>>>0));return ls(s,this.u.song,e),s}uc(t,e){for(let s=0;s<this.u.song.barCount;s++)if(this.u.song.channels[t].bars[s]==e)return!1;return!0}copy(){const t=[];for(const e of this.rc()){const s={},i=[];for(const t of this.lc()){const n=this.u.song.channels[e].bars[t];if(i.push(n),null==s[String(n)]){const i=this.u.song.getPattern(e,t);let h=this.u.recentPatternInstruments[e],o=[];if(null!=i)if(h=i.instruments.concat(),this.patternSelectionActive)for(const t of i.cloneNotes())t.end<=this.patternSelectionStart||t.start>=this.patternSelectionEnd||(t.start-=this.patternSelectionStart,t.end-=this.patternSelectionStart,(t.start<0||t.end>this.patternSelectionEnd-this.patternSelectionStart)&&new zi(null,t,Math.max(t.start,0),Math.min(this.patternSelectionEnd-this.patternSelectionStart,t.end)),o.push(t));else o=i.notes;s[String(n)]={instruments:h,notes:o}}}const n={isNoise:this.u.song.getChannelIsNoise(e),patterns:s,bars:i};t.push(n)}const s={partDuration:this.patternSelectionActive?this.patternSelectionEnd-this.patternSelectionStart:this.u.song.beatsPerBar*e.partsPerBeat,channels:t};window.localStorage.setItem("selectionCopy",JSON.stringify(s))}pasteNotes(){const t=JSON.parse(String(window.localStorage.getItem("selectionCopy")));if(null==t)return;const s=t.channels||[],i=t.partDuration>>>0,n=new os,h=this.boxSelectionActive,o=h?this.boxSelectionHeight:Math.min(s.length,this.u.song.getChannelCount()-this.boxSelectionChannel);for(let t=0;t<o;t++){const r=s[t%s.length],a=this.boxSelectionChannel+t,l=!!r.isNoise,c=r.patterns||{},u=r.bars||[];if(0==u.length)continue;if(l!=this.u.song.getChannelIsNoise(a))continue;const p=h?this.boxSelectionWidth:Math.min(u.length,this.u.song.barCount-this.boxSelectionBar);if(h||1!=u.length||1!=s.length)if(this.patternSelectionActive){const t={},e={};n.append(new ji(this.u,this.boxSelectionBar,p,this.boxSelectionChannel,o));for(let s=0;s<p;s++){const h=this.boxSelectionBar+s,o=u[s%u.length]>>>0,r=this.u.song.channels[a].bars[h],l=[o,r].join(",");if(0==o&&0==r)continue;if(null!=t[l]){n.append(new vs(this.u,t[l],h,a,1,1));continue}if(0==r){n.append(new fi(this.u,a,h));const t=c[String(o)],e=this.cc(t,a),s=this.u.song.getPattern(a,h);n.append(new pi(this.u,a,e,s))}else{const t=this.u.song.getPattern(a,h);if(null==t)throw new Error;if(e[String(r)]){n.append(new vs(this.u,0,h,a,1,1)),n.append(new fi(this.u,a,h));const e=this.u.song.getPattern(a,h);if(null==e)throw new Error;for(const s of t.cloneNotes())n.append(new Oi(this.u,e,s,e.notes.length,!1))}else e[String(r)]=!0}const p=this.u.song.getPattern(a,h);if(null==p)throw new Error;if(0==o)n.append(new Ri(this.u,p,this.patternSelectionStart,this.patternSelectionEnd));else{const t=c[String(o)];n.append(new ci(this.u,p,t.notes,this.patternSelectionStart,this.patternSelectionEnd,i))}t[l]=this.u.song.channels[a].bars[h]}}else{for(let t=0;t<p;t++)this.erasePatternInBar(n,a,this.boxSelectionBar+t);const t={};for(let s=0;s<p;s++){const h=this.boxSelectionBar+s,o=u[s%u.length]>>>0,r=String(o);if(0==o)continue;if(null!=t[r]){n.append(new vs(this.u,t[r],h,a,1,1));continue}const l=c[String(o)],p=this.cc(l,a),d=this.u.song.channels[a].patterns[o-1];if(null!=d&&i==e.partsPerBeat*this.u.song.beatsPerBar&&Bi(l.notes,d.notes)&&as(p,d.instruments))n.append(new vs(this.u,o,h,a,1,1));else{null!=d&&this.uc(a,o)?n.append(new vs(this.u,o,h,a,1,1)):n.append(new fi(this.u,a,h));const t=this.u.song.getPattern(a,h);if(null==t)throw new Error;n.append(new ci(this.u,t,l.notes,this.patternSelectionActive?this.patternSelectionStart:0,this.patternSelectionActive?this.patternSelectionEnd:e.partsPerBeat*this.u.song.beatsPerBar,i)),n.append(new pi(this.u,a,p,t))}t[r]=this.u.song.channels[a].bars[h]}}else{const t=u[0]>>>0,s=this.boxSelectionBar,h=this.u.song.channels[a].bars[s];if(0==t&&0==h)continue;const o=c[String(t)],r=this.cc(o,a);if(0==h){const e=this.u.song.channels[a].patterns[t-1];null!=e&&!this.patternSelectionActive&&(Bi(o.notes,e.notes)&&as(r,e.instruments)||this.uc(a,t))?n.append(new vs(this.u,t,s,a,1,1)):n.append(new fi(this.u,a,s))}const l=this.u.song.getPattern(a,s);if(null==l)throw new Error;n.append(new ci(this.u,l,o.notes,this.patternSelectionActive?this.patternSelectionStart:0,this.patternSelectionActive?this.patternSelectionEnd:e.partsPerBeat*this.u.song.beatsPerBar,i)),0==h&&n.append(new pi(this.u,a,r,l))}}this.u.record(n)}erasePatternInBar(t,e,s){const i=this.u.song.channels[e].bars[s];0!=i&&(t.append(new vs(this.u,0,s,e,1,1)),this.uc(e,i)&&(this.u.song.channels[e].patterns[i-1].notes.length=0))}pasteNumbers(){const t=JSON.parse(String(window.localStorage.getItem("selectionCopy")));if(null==t)return;const e=t.channels||[],s=new os,i=this.boxSelectionActive,n=i?this.boxSelectionHeight:Math.min(e.length,this.u.song.getChannelCount()-this.boxSelectionChannel);for(let t=0;t<n;t++){const n=e[t%e.length],h=this.boxSelectionChannel+t,o=n.bars||[];if(0==o.length)continue;const r=i?this.boxSelectionWidth:Math.min(o.length,this.u.song.barCount-this.boxSelectionBar);for(let t=0;t<r;t++){const e=o[t%o.length]>>>0,i=this.boxSelectionBar+t;e>this.u.song.patternsPerChannel&&s.append(new di(this.u,e)),s.append(new vs(this.u,e,i,h,1,1))}}this.u.record(s)}selectAll(){new _i(this.u,0,0),0==this.boxSelectionBar&&0==this.boxSelectionChannel&&this.boxSelectionWidth==this.u.song.barCount&&this.boxSelectionHeight==this.u.song.getChannelCount()?this.setTrackSelection(this.u.bar,this.u.bar,this.u.channel,this.u.channel):this.setTrackSelection(0,this.u.song.barCount-1,0,this.u.song.getChannelCount()-1),this.selectionUpdated()}selectChannel(){new _i(this.u,0,0),0==this.boxSelectionBar&&this.boxSelectionWidth==this.u.song.barCount?this.setTrackSelection(this.u.bar,this.u.bar,this.boxSelectionY0,this.boxSelectionY1):this.setTrackSelection(0,this.u.song.barCount-1,this.boxSelectionY0,this.boxSelectionY1),this.selectionUpdated()}duplicatePatterns(){this.u.record(new ji(this.u,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight))}muteChannels(t){if(t){let t=!1;for(let e=0;e<this.u.song.channels.length;e++)if(this.u.song.channels[e].muted){t=!0;break}for(let e=0;e<this.u.song.channels.length;e++)this.u.song.channels[e].muted=!t}else{let t=!1;for(const e of this.rc())if(!this.u.song.channels[e].muted){t=!0;break}for(const e of this.rc())this.u.song.channels[e].muted=t}this.u.notifier.changed()}soloChannels(t){let e=!0;for(let s=0;s<this.u.song.channels.length;s++){const i=s<this.boxSelectionChannel||s>=this.boxSelectionChannel+this.boxSelectionHeight?!t:t;if(this.u.song.channels[s].muted!=i){e=!1;break}}if(e)for(let t=0;t<this.u.song.channels.length;t++)this.u.song.channels[t].muted=!1;else for(let e=0;e<this.u.song.channels.length;e++)this.u.song.channels[e].muted=e<this.boxSelectionChannel||e>=this.boxSelectionChannel+this.boxSelectionHeight?!t:t;this.u.notifier.changed()}forceRhythm(){const t=new os;this.boxSelectionActive&&t.append(new ji(this.u,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const e of this.rc())for(const s of this.ac(e))t.append(new bi(this.u,s));this.u.record(t)}forceScale(){const t=new os;this.boxSelectionActive&&t.append(new ji(this.u,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));const s=[!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];for(const t of this.rc())if(!this.u.song.getChannelIsNoise(t))for(const e of this.ac(t))cs(e,s);const i=function(t,s){const i=e.scales[s].flags,n=[],h=[];for(let e=0;e<12;e++)t[e]&&n.push(e),i[e]&&h.push(e);const o=n.length>h.length,r=o?h:n,a=o?n:h,l=["root","second","second","third","third","fourth","tritone","fifth","sixth","sixth","seventh","seventh","root"];let c=Number.MAX_SAFE_INTEGER,u=[];const p=[[0]];for(;p.length>0;){const t=p.pop();if(t.length==r.length){let e=0;for(let s=0;s<t.length;s++)e+=Math.abs(r[s]-a[t[s]]),l[r[s]]!=l[a[t[s]]]&&(e+=.75);c>e&&(c=e,u=t)}else{const e=t[t.length-1]+1,s=a.length-r.length+t.length;for(let i=e;i<=s;i++)p.push(t.concat(i))}}const d=[];for(let t=0;t<u.length;t++){const e=r[t],s=a[u[t]];d[t]=o?[s,e]:[e,s]}d.push([12,12]),h.push(12);let f=0;const m=[];for(let t=0;t<12;t++){const e=d[f][0],s=d[f][1],i=d[f+1][0],n=d[f+1][1];t==i-1&&f++;const o=(t-e)*(n-s)/(i-e)+s;let r=0,a=Number.MAX_SAFE_INTEGER;for(const e of h){let s=Math.abs(e-o);l[e]!=l[t]&&(s+=.1),a>s&&(a=s,r=e)}m[t]=r}return m}(s,this.u.song.scale);for(const e of this.rc())if(!this.u.song.getChannelIsNoise(e))for(const s of this.ac(e))t.append(new Gi(this.u,s,i));this.u.record(t)}setTrackSelection(t,e,s,i){const n=this.u.lastChangeWas(this.hc);this.hc=new os,this.hc.append(new qi(this.u,t,e,s,i)),this.u.hasRedoHistory()||this.u.record(this.hc,n)}transpose(t,e){const s=this.u.lastChangeWas(this.ic);this.ic=new os,this.boxSelectionActive&&this.ic.append(new ji(this.u,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const s of this.rc())for(const i of this.ac(s))this.ic.append(new Ui(this.u,s,i,t,this.u.prefs.notesOutsideScale,e));this.u.record(this.ic,s)}swapChannels(t){const e=[this.u.song.pitchChannelCount,this.u.song.pitchChannelCount+this.u.song.noiseChannelCount,this.u.song.getChannelCount()];let s=0,i=0;for(const n of e){if(this.boxSelectionChannel<n&&t<0||this.boxSelectionChannel+this.boxSelectionHeight<=n){i=n-1;break}s=n}const n=Math.max(this.boxSelectionChannel,s),h=Math.min(this.boxSelectionChannel+this.boxSelectionHeight-1,i);if(t=Math.max(t,s-n),0!=(t=Math.min(t,i-h))){const e=this.u.lastChangeWas(this.nc);this.nc=new os,this.boxSelectionY0=n+t,this.boxSelectionY1=h+t,this.nc.append(new Ss(this.u,n,h,t)),this.nc.append(new Bs(this.u,Math.max(this.boxSelectionY0,Math.min(this.boxSelectionY1,this.u.channel+t)),this.u.bar)),this.selectionUpdated(),this.u.record(this.nc,e)}}selectInstrument(t){if(this.u.viewedInstrument[this.u.channel]==t){if(this.u.song.layeredInstruments&&this.u.song.patternInstruments){const e=this.u.lastChangeWas(this.oc);this.oc=new os;const s=this.u.recentPatternInstruments[this.u.channel];if(this.u.notifier.changed(),-1==s.indexOf(t)){s.push(t);const e=this.u.song.getMaxInstrumentsPerPattern(this.u.channel);s.length>e&&s.splice(0,s.length-e)}else s.splice(s.indexOf(t),1),0==s.length&&(s[0]=0);this.boxSelectionActive&&this.oc.append(new ji(this.u,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const t of this.rc())for(const e of this.ac(t))this.oc.append(new pi(this.u,t,s,e));this.u.record(this.oc,e)}}else{const e=this.u.lastChangeWas(this.oc);if(this.oc=new os,this.oc.append(new ii(this.u,t)),!this.u.song.layeredInstruments&&this.u.song.patternInstruments){this.boxSelectionActive&&this.oc.append(new ji(this.u,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));const s=[t];for(const t of this.rc())for(const e of this.ac(t))this.oc.append(new pi(this.u,t,s,e));this.u.record(this.oc,e)}else this.u.hasRedoHistory()||this.u.record(this.oc,e)}}resetBoxSelection(){this.boxSelectionX0=this.boxSelectionX1=this.u.bar,this.boxSelectionY0=this.boxSelectionY1=this.u.channel}}class Mo{constructor(){this.volume=75,this.visibleOctaves=Mo.defaultVisibleOctaves,this.reload()}reload(){this.autoPlay="true"==window.localStorage.getItem("shitbox4autoPlay"),this.autoFollow="false"!=window.localStorage.getItem("shitbox4autoFollow"),this.enableNotePreview="false"!=window.localStorage.getItem("shitbox4enableNotePreview"),this.showFifth="true"==window.localStorage.getItem("shitbox4showFifth"),this.notesOutsideScale="true"==window.localStorage.getItem("shitbox4notesOutsideScale"),this.showLetters="true"==window.localStorage.getItem("shitbox4showLetters"),this.showChannels="true"==window.localStorage.getItem("shitbox4showChannels"),this.showScrollBar="true"==window.localStorage.getItem("shitbox4showScrollBar"),this.alwaysShowSettings="true"==window.localStorage.getItem("shitbox4alwaysShowSettings"),this.instrumentCopyPaste="true"==window.localStorage.getItem("shitbox4instrumentCopyPaste"),this.enableChannelMuting="true"==window.localStorage.getItem("shitbox4enableChannelMuting"),this.displayBrowserUrl="false"!=window.localStorage.getItem("shitbox4displayBrowserUrl"),this.pressControlForShortcuts="true"==window.localStorage.getItem("shitbox4pressControlForShortcuts"),this.enableMidi="false"!=window.localStorage.getItem("shitbox4enableMidi"),this.showRecordButton="true"==window.localStorage.getItem("shitbox4showRecordButton"),this.snapRecordedNotesToRhythm="true"==window.localStorage.getItem("shitbox4snapRecordedNotesToRhythm"),this.ignorePerformedNotesNotInScale="true"==window.localStorage.getItem("shitbox4ignorePerformedNotesNotInScale"),this.metronomeCountIn="false"!=window.localStorage.getItem("shitbox4metronomeCountIn"),this.metronomeWhileRecording="false"!=window.localStorage.getItem("shitbox4metronomeWhileRecording"),this.keyboardLayout=window.localStorage.getItem("shitbox4keyboardLayout")||"wickiHayden",this.shitbox4layout=window.localStorage.getItem("shitbox4layout")||"small",this.shitbox4colorTheme=window.localStorage.getItem("shitbox4colorTheme")||"shitbox4 classic",this.visibleOctaves=window.localStorage.getItem("shitbox4visibleOctaves")>>>0||Mo.defaultVisibleOctaves;const t=e.scales.dictionary[window.localStorage.getItem("defaultScale")];this.defaultScale=null!=t?t.index:0,null!=window.localStorage.getItem("volume")&&(this.volume=Math.min(window.localStorage.getItem("volume")>>>0,75))}save(){window.localStorage.setItem("shitbox4autoPlay",this.autoPlay?"true":"false"),window.localStorage.setItem("shitbox4autoFollow",this.autoFollow?"true":"false"),window.localStorage.setItem("shitbox4enableNotePreview",this.enableNotePreview?"true":"false"),window.localStorage.setItem("shitbox4showFifth",this.showFifth?"true":"false"),window.localStorage.setItem("shitbox4notesOutsideScale",this.notesOutsideScale?"true":"false"),window.localStorage.setItem("shitbox4defaultScale",e.scales[this.defaultScale].name),window.localStorage.setItem("shitbox4showLetters",this.showLetters?"true":"false"),window.localStorage.setItem("shitbox4showChannels",this.showChannels?"true":"false"),window.localStorage.setItem("shitbox4showScrollBar",this.showScrollBar?"true":"false"),window.localStorage.setItem("shitbox4alwaysShowSettings",this.alwaysShowSettings?"true":"false"),window.localStorage.setItem("shitbox4enableChannelMuting",this.enableChannelMuting?"true":"false"),window.localStorage.setItem("shitbox4instrumentCopyPaste",this.instrumentCopyPaste?"true":"false"),window.localStorage.setItem("shitbox4displayBrowserUrl",this.displayBrowserUrl?"true":"false"),window.localStorage.setItem("shitbox4pressControlForShortcuts",this.pressControlForShortcuts?"true":"false"),window.localStorage.setItem("shitbox4enableMidi",this.enableMidi?"true":"false"),window.localStorage.setItem("shitbox4showRecordButton",this.showRecordButton?"true":"false"),window.localStorage.setItem("shitbox4snapRecordedNotesToRhythm",this.snapRecordedNotesToRhythm?"true":"false"),window.localStorage.setItem("shitbox4ignorePerformedNotesNotInScale",this.ignorePerformedNotesNotInScale?"true":"false"),window.localStorage.setItem("shitbox4metronomeCountIn",this.metronomeCountIn?"true":"false"),window.localStorage.setItem("shitbox4metronomeWhileRecording",this.metronomeWhileRecording?"true":"false"),window.localStorage.setItem("shitbox4keyboardLayout",this.keyboardLayout),window.localStorage.setItem("shitbox4shitbox4layout",this.shitbox4layout),window.localStorage.setItem("shitbox4colorTheme",this.shitbox4colorTheme),window.localStorage.setItem("shitbox4volume",String(this.volume)),window.localStorage.setItem("shitbox4visibleOctaves",String(this.visibleOctaves))}}Mo.defaultVisibleOctaves=3;class So{constructor(){this.dc=[],this.fc=!1}watch(t){-1==this.dc.indexOf(t)&&this.dc.push(t)}unwatch(t){const e=this.dc.indexOf(t);-1!=e&&this.dc.splice(e,1)}changed(){this.fc=!0}notifyWatchers(){if(this.fc){this.fc=!1;for(const t of this.dc.concat())t()}}}class Po{constructor(){this.notifier=new So,this.selection=new ko(this),this.prefs=new Mo,this.channel=0,this.bar=0,this.recentPatternInstruments=[],this.viewedInstrument=[],this.trackVisibleBars=16,this.trackVisibleChannels=4,this.barScrollPos=0,this.channelScrollPos=0,this.prompt=null,this.addedEffect=!1,this.addedEnvelope=!1,this.currentPatternIsDirty=!1,this.mc=new Vh,this.yc=null,this.bc=0,this.wc=0,this.gc=!1,this.vc=!1,this.xc=!1,this.kc=()=>{if(this.synth.recording&&this.performance.abortRecording(),null==window.history.state&&""!=window.location.hash){this.bc++,this.Mc();const t={canUndo:!0,sequenceNumber:this.bc,bar:this.bar,channel:this.channel,instrument:this.viewedInstrument[this.channel],recoveryUid:this.Sc,prompt:null,selection:this.selection.toJSON()};try{new Pi(this,window.location.hash)}catch(t){Uh(t)}return this.prompt=t.prompt,this.prefs.displayBrowserUrl?this.Pc(t,this.song.toBase64String()):this.Ic(t,this.song.toBase64String()),this.forgetLastChange(),void this.notifier.notifyWatchers()}const t=this.Fc();if(null==t)throw new Error("History state is null.");if(t.sequenceNumber!=this.bc){this.bar=t.bar,this.channel=t.channel,this.viewedInstrument[this.channel]=t.instrument,this.bc=t.sequenceNumber,this.prompt=t.prompt;try{new Pi(this,this.Bc())}catch(t){Uh(t)}this.Sc=t.recoveryUid,this.selection.fromJSON(t.selection),this.forgetLastChange(),this.notifier.notifyWatchers()}},this.Lc=()=>{this.notifier.notifyWatchers()},this.Cc=()=>{const t=this.song.getChannelCount();for(let e=this.recentPatternInstruments.length;e<t;e++)this.recentPatternInstruments[e]=[0];this.recentPatternInstruments.length=t;for(let e=0;e<t;e++){if(e==this.channel)if(this.song.patternInstruments){const t=this.song.getPattern(this.channel,this.bar);null!=t&&(this.recentPatternInstruments[e]=t.instruments.concat())}else{const t=this.song.channels[this.channel];for(let s=0;s<t.instruments.length;s++)this.recentPatternInstruments[e][s]=s;this.recentPatternInstruments[e].length=t.instruments.length}ls(this.recentPatternInstruments[e],this.song,e)}for(let e=this.viewedInstrument.length;e<t;e++)this.viewedInstrument[e]=0;this.viewedInstrument.length=t;for(let e=0;e<t;e++){if(this.song.patternInstruments&&!this.song.layeredInstruments&&e==this.channel){const t=this.song.getPattern(this.channel,this.bar);null!=t&&(this.viewedInstrument[e]=t.instruments[0])}this.viewedInstrument[e]=Math.min(0|this.viewedInstrument[e],this.song.channels[e].instruments.length-1)}const e=this.getCurrentPattern();null!=e&&this.song.patternInstruments&&(this.recentPatternInstruments[this.channel]=e.instruments.concat()),(!this.synth.playing&&(this.bar<this.selection.boxSelectionBar||this.selection.boxSelectionBar+this.selection.boxSelectionWidth<=this.bar)||this.channel<this.selection.boxSelectionChannel||this.selection.boxSelectionChannel+this.selection.boxSelectionHeight<=this.channel||this.song.barCount<this.selection.boxSelectionBar+this.selection.boxSelectionWidth||t<this.selection.boxSelectionChannel+this.selection.boxSelectionHeight||1==this.selection.boxSelectionWidth&&1==this.selection.boxSelectionHeight)&&this.selection.resetBoxSelection(),this.barScrollPos=Math.max(0,Math.min(this.song.barCount-this.trackVisibleBars,this.barScrollPos)),this.channelScrollPos=Math.max(0,Math.min(this.song.getChannelCount()-this.trackVisibleChannels,this.channelScrollPos))},this.Dc=()=>{let t;this.xc=!1;try{t=this.song.toBase64String()}catch(t){return void Uh(t)}this.gc&&this.bc++,this.vc?this.Mc():this.mc.saveVersion(this.Sc,t);let e={canUndo:!0,sequenceNumber:this.bc,bar:this.bar,channel:this.channel,instrument:this.viewedInstrument[this.channel],recoveryUid:this.Sc,prompt:this.prompt,selection:this.selection.toJSON()};this.gc?this.Ic(e,t):this.Pc(e,t),this.gc=!1,this.vc=!1},this.notifier.watch(this.Cc),_.setTheme(this.prefs.shitbox4colorTheme),j.setLayout(this.prefs.shitbox4layout),null==window.sessionStorage.getItem("currentUndoIndex")&&(window.sessionStorage.setItem("currentUndoIndex","0"),window.sessionStorage.setItem("oldestUndoIndex","0"),window.sessionStorage.setItem("newestUndoIndex","0"));let t=window.location.hash;""==t&&(t=this.Bc());try{this.song=new We(t),""!=t&&null!=t||(Si(this.song),this.song.scale=this.prefs.defaultScale)}catch(t){Uh(t)}t=this.song.toBase64String(),this.synth=new Xe(this.song),this.synth.volume=this.Tc(),this.synth.anticipatePoorPerformance=x;let e=this.Fc();null==e&&(e={canUndo:!1,sequenceNumber:0,bar:0,channel:0,instrument:0,recoveryUid:$h(),prompt:null,selection:this.selection.toJSON()}),null==e.recoveryUid&&(e.recoveryUid=$h()),this.Pc(e,t),window.addEventListener("hashchange",this.kc),window.addEventListener("popstate",this.kc),this.bar=0|e.bar,this.channel=0|e.channel;for(let t=0;t<=this.channel;t++)this.viewedInstrument[t]=0;this.viewedInstrument[this.channel]=0|e.instrument,this.Sc=e.recoveryUid,this.prompt=e.prompt,this.selection.fromJSON(e.selection),this.selection.scrollToSelectedPattern();for(const t of["input","change","click","keyup","keydown","mousedown","mousemove","mouseup","touchstart","touchmove","touchend","touchcancel"])window.addEventListener(t,this.Lc);this.Cc(),this.performance=new xo(this)}toggleDisplayBrowserUrl(){const t=this.Fc();if(null==t)throw new Error("History state is null.");this.prefs.displayBrowserUrl=!this.prefs.displayBrowserUrl,this.Pc(t,this.song.toBase64String())}Fc(){if(this.prefs.displayBrowserUrl)return window.history.state;{const t=JSON.parse(window.sessionStorage.getItem(window.sessionStorage.getItem("currentUndoIndex")));return null==t?null:t.state}}Bc(){if(this.prefs.displayBrowserUrl)return window.location.hash;{const t=JSON.parse(window.sessionStorage.getItem(window.sessionStorage.getItem("currentUndoIndex")));return null==t?"":t.hash}}Pc(t,e){this.prefs.displayBrowserUrl?window.history.replaceState(t,"","#"+e):(window.sessionStorage.setItem(window.sessionStorage.getItem("currentUndoIndex")||"0",JSON.stringify({state:t,hash:e})),window.history.replaceState(null,"",location.pathname))}Ic(t,e){if(this.prefs.displayBrowserUrl)window.history.pushState(t,"","#"+e);else{let s=Number(window.sessionStorage.getItem("currentUndoIndex")),i=Number(window.sessionStorage.getItem("oldestUndoIndex"));s=(s+1)%Po.Ec,window.sessionStorage.setItem("currentUndoIndex",String(s)),window.sessionStorage.setItem("newestUndoIndex",String(s)),s==i&&(i=(i+1)%Po.Ec,window.sessionStorage.setItem("oldestUndoIndex",String(i))),window.sessionStorage.setItem(String(s),JSON.stringify({state:t,hash:e})),window.history.replaceState(null,"",location.pathname)}this.wc=t.sequenceNumber}hasRedoHistory(){return this.wc>this.bc}Nc(){if(this.prefs.displayBrowserUrl)window.history.forward();else{let t=Number(window.sessionStorage.getItem("currentUndoIndex"));t!=Number(window.sessionStorage.getItem("newestUndoIndex"))&&(t=(t+1)%Po.Ec,window.sessionStorage.setItem("currentUndoIndex",String(t)),setTimeout(this.kc))}}Oc(){if(this.prefs.displayBrowserUrl)window.history.back();else{let t=Number(window.sessionStorage.getItem("currentUndoIndex"));t!=Number(window.sessionStorage.getItem("oldestUndoIndex"))&&(t=(t+Po.Ec-1)%Po.Ec,window.sessionStorage.setItem("currentUndoIndex",String(t)),setTimeout(this.kc))}}record(t,e=!1,s=!1){t.isNoop()?(this.yc=null,e&&this.Oc()):(t.commit(),this.yc=t,this.gc=this.gc||!e,this.vc=this.vc||s,this.xc||(window.requestAnimationFrame(this.Dc),this.xc=!0))}Mc(){this.Sc=$h()}openPrompt(t){this.prompt=t;const e=this.song.toBase64String();this.bc++;const s={canUndo:!0,sequenceNumber:this.bc,bar:this.bar,channel:this.channel,instrument:this.viewedInstrument[this.channel],recoveryUid:this.Sc,prompt:this.prompt,selection:this.selection.toJSON()};this.Ic(s,e)}undo(){const t=this.Fc();(null==t||t.canUndo)&&this.Oc()}redo(){this.Nc()}setProspectiveChange(t){this.yc=t}forgetLastChange(){this.yc=null}lastChangeWas(t){return null!=t&&t==this.yc}goBackToStart(){this.bar=0,this.channel=0,this.barScrollPos=0,this.channelScrollPos=0,this.synth.snapToStart(),this.notifier.changed()}setVolume(t){this.prefs.volume=t,this.prefs.save(),this.synth.volume=this.Tc()}Tc(){return Math.min(1,Math.pow(this.prefs.volume/50,.5))*Math.pow(2,(this.prefs.volume-75)/25)}getCurrentPattern(t=0){return this.song.getPattern(this.channel,this.bar+t)}getCurrentInstrument(t=0){return this.viewedInstrument[this.channel]}getMobileLayout(){return window.innerWidth<=710}getBarWidth(){return this.getMobileLayout()||!this.prefs.enableChannelMuting||this.getFullScreen()?32:30}getFullScreen(){return!this.getMobileLayout()&&"small"!=this.prefs.shitbox4layout}getVisibleOctaveCount(){return this.getFullScreen()?this.prefs.visibleOctaves:Mo.defaultVisibleOctaves}getVisiblePitchCount(){return this.getVisibleOctaveCount()*e.pitchesPerOctave+1}getBaseVisibleOctave(t){const s=this.getVisibleOctaveCount();return Math.max(0,Math.min(e.pitchOctaves-s,Math.ceil(this.song.channels[t].octave-.5*s)))}}Po.Ec=100;const Io=new Po,Fo=new vo(Io);if(document.getElementById("beepboxEditorContainer").appendChild(Fo.mainLayer),Fo.whenUpdated(),Fo.mainLayer.focus(),!x&&Io.prefs.autoPlay){function Co(){document.hidden||(Io.synth.play(),Fo.updatePlayButton(),window.removeEventListener("visibilitychange",Co))}document.hidden?window.addEventListener("visibilitychange",Co):Co()}return"scrollRestoration"in history&&(history.scrollRestoration="manual"),Fo.updatePlayButton(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/service_worker.js",{updateViaCache:"all",scope:"/"}).catch((()=>{})),t.ChangePreset=ys,t.Channel=Ge,t.ColorConfig=_,t.Config=e,t.EditorConfig=M,t.ExportPrompt=Bh,t.Instrument=je,t.Note=Ne,t.Pattern=Oe,t.Song=We,t.SongDocument=Po,t.SongEditor=vo,t.Synth=Xe,Object.defineProperty(t,"zc",{value:!0}),t}({});
//# sourceMappingURL=beepbox_editor.min.js.map